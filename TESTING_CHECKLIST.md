# GPT 自動計時器功能 - 手動測試清單

## 🚀 快速開始

### 前置條件
- ✅ 前端服務：http://localhost:5173
- ✅ 後端服務：http://127.0.0.1:8700
- ⚠️ 需要登入系統並有測試會員資料

### 開啟測試頁面
1. 瀏覽器打開：http://localhost:5173
2. 使用管理員帳號登入
3. 進入「會員管理」頁面
4. 選擇任一會員，進入聊天室

---

## ✅ 測試檢查清單

### 📋 測試 1：基本功能 - 啟動計時器

**步驟：**
1. [ ] 點擊聊天輸入框
2. [ ] 觀察聊天區域右上角

**預期結果：**
- [ ] 看到橘色「手動模式」標籤
- [ ] 標籤包含警告圖示
- [ ] 標籤文字為「手動模式」

**API 驗證（按 F12 > Network）：**
- [ ] 看到 `PUT /api/v1/members/{id}` 請求
- [ ] Request Payload 包含 `{"gpt_enabled": false}`
- [ ] Response Status 為 200

**如果失敗：**
- 檢查 Console 是否有錯誤訊息
- 檢查 Network 面板是否有 API 錯誤
- 確認登入 Token 是否有效

---

### 📋 測試 2：基本功能 - 發送訊息重置計時器

**步驟：**
1. [ ] 在輸入框輸入「測試訊息」
2. [ ] 點擊「傳送」按鈕
3. [ ] 觀察「手動模式」標籤

**預期結果：**
- [ ] 訊息成功發送
- [ ] 「手動模式」標籤仍然顯示（未消失）
- [ ] 訊息出現在聊天記錄中

**API 驗證：**
- [ ] 看到 `POST /api/v1/members/{id}/chat/send` 請求
- [ ] 看到 `PUT /api/v1/members/{id}` 請求
- [ ] PUT 請求的 Payload 為 `{"gpt_enabled": false}`

---

### 📋 測試 3：基本功能 - 10 分鐘自動恢復

**重要提示：** 為了快速測試，建議暫時修改計時器時長。

**快速測試方法（開發環境）：**

1. 打開 `/data2/lili_hotel/frontend/src/components/chat-room/ChatRoomLayout.tsx`
2. 找到第 154 行：
   ```typescript
   const MANUAL_MODE_DURATION = 10 * 60 * 1000; // 10 分鐘
   ```
3. 暫時改為：
   ```typescript
   const MANUAL_MODE_DURATION = 10 * 1000; // 10 秒（測試用）
   ```
4. 儲存檔案（Vite 會自動熱更新）

**測試步驟：**
1. [ ] 點擊輸入框（啟動計時器）
2. [ ] 等待 10 秒（如果使用測試時長）
3. [ ] 觀察標籤是否消失

**預期結果：**
- [ ] 10 秒後「手動模式」標籤自動消失
- [ ] Console 無錯誤訊息

**API 驗證：**
- [ ] 10 秒後看到 `PUT /api/v1/members/{id}` 請求
- [ ] Payload 為 `{"gpt_enabled": true}`

**測試後恢復：**
```typescript
const MANUAL_MODE_DURATION = 10 * 60 * 1000; // 恢復為 10 分鐘
```

---

### 📋 測試 4：多分頁同步 - 啟動同步

**步驟：**
1. [ ] 在瀏覽器開啟第一個分頁（分頁 A）
2. [ ] 進入會員 #123 的聊天室
3. [ ] 複製分頁（Ctrl+Shift+D）得到分頁 B
4. [ ] 確認分頁 B 也顯示會員 #123 的聊天室
5. [ ] 在分頁 A 點擊輸入框
6. [ ] 觀察分頁 B 的變化

**預期結果：**
- [ ] 分頁 A 立即顯示「手動模式」標籤
- [ ] 分頁 B 在 1-2 秒內同步顯示「手動模式」標籤
- [ ] 兩個分頁的標籤顯示一致

**localStorage 驗證（按 F12 > Console）：**

在分頁 A 執行：
```javascript
localStorage.getItem('gpt_timer_123')
```
應該看到類似：
```json
{"memberId":"123","isManualMode":true,"startTime":1701234567890}
```

在分頁 B 執行相同命令，應該看到相同結果。

**如果同步失敗：**
1. 檢查兩個分頁是否在相同的域名
2. 檢查瀏覽器是否支持 storage 事件
3. 嘗試手動觸發：
   ```javascript
   // 分頁 A
   localStorage.setItem('test', 'sync')

   // 分頁 B Console 應該能監聽到
   window.addEventListener('storage', (e) => console.log(e))
   ```

---

### 📋 測試 5：多分頁同步 - 發送訊息同步

**步驟：**
1. [ ] 保持分頁 A 和 B 都開啟
2. [ ] 兩個分頁都應該顯示「手動模式」標籤
3. [ ] 在分頁 B 輸入並發送訊息
4. [ ] 觀察兩個分頁

**預期結果：**
- [ ] 分頁 B 訊息發送成功
- [ ] 分頁 B 的「手動模式」標籤保持顯示
- [ ] 分頁 A 的「手動模式」標籤保持顯示
- [ ] localStorage 的 `startTime` 更新

---

### 📋 測試 6：會員切換 - 離開時恢復

**步驟：**
1. [ ] 在會員 A 的聊天室點擊輸入框
2. [ ] 確認顯示「手動模式」標籤
3. [ ] 點擊側邊欄，切換到會員 B
4. [ ] 等待會員 B 聊天室載入完成
5. [ ] 觀察會員 B 的狀態

**預期結果：**
- [ ] 會員 B 聊天室正常載入
- [ ] 會員 B 沒有「手動模式」標籤
- [ ] Console 無錯誤訊息

**API 驗證：**
- [ ] 切換時看到會員 A 的 `PUT /api/v1/members/{A_id}` 請求
- [ ] Payload 為 `{"gpt_enabled": true}`（恢復 GPT）

---

### 📋 測試 7：會員切換 - 返回時正常

**步驟：**
1. [ ] 從會員 B 返回會員 A
2. [ ] 觀察會員 A 的狀態

**預期結果：**
- [ ] 會員 A 聊天室正常載入
- [ ] 沒有「手動模式」標籤（因為已經恢復）
- [ ] 可以正常聊天

---

### 📋 測試 8：頁面重新整理

**步驟：**
1. [ ] 在會員聊天室點擊輸入框（顯示「手動模式」）
2. [ ] 按 F5 重新整理頁面
3. [ ] 觀察重新載入後的狀態

**預期結果：**
- [ ] 頁面重新載入成功
- [ ] 「手動模式」標籤消失（計時器已重置）
- [ ] 需要重新點擊輸入框才會再次啟動計時器

---

## 🔍 進階驗證

### 驗證 1：檢查 localStorage 資料

打開 Console 執行：
```javascript
// 查看所有計時器
Object.keys(localStorage)
  .filter(key => key.startsWith('gpt_timer_'))
  .map(key => ({
    key,
    value: JSON.parse(localStorage.getItem(key))
  }))
```

### 驗證 2：手動清除計時器

如果需要重置測試環境：
```javascript
// 清除所有計時器
Object.keys(localStorage)
  .filter(key => key.startsWith('gpt_timer_'))
  .forEach(key => localStorage.removeItem(key))

// 刷新頁面
location.reload()
```

### 驗證 3：監控 API 請求

在 Network 面板設置過濾器：
```
method:PUT url:members
```

這樣只會顯示會員更新的 PUT 請求。

### 驗證 4：檢查計時器是否正確清理

在 Console 執行：
```javascript
// 查看當前計時器狀態（應該在組件內部，這裡僅供參考）
// 正常情況下，切換會員或等待時間到時，計時器應該被清除
```

---

## ❌ 常見問題與解決方案

### 問題 1：點擊輸入框沒反應

**可能原因：**
- onFocus 事件未綁定
- JavaScript 錯誤

**解決方法：**
1. 打開 Console 查看錯誤訊息
2. 確認程式碼已正確部署（檢查最後修改時間）
3. 清除瀏覽器快取並重新載入

### 問題 2：標籤不顯示

**可能原因：**
- CSS 樣式問題
- 狀態未正確更新

**解決方法：**
```javascript
// Console 中手動檢查
// 注意：這只是檢查方法，實際狀態在 React 內部
```

### 問題 3：多分頁不同步

**可能原因：**
- 不同域名/端口
- 瀏覽器不支持

**解決方法：**
1. 確認兩個分頁 URL 完全一致
2. 檢查瀏覽器版本（建議 Chrome/Edge 最新版）
3. 測試 storage 事件是否工作：
   ```javascript
   // 分頁 A
   localStorage.setItem('test', Date.now())

   // 分頁 B
   window.addEventListener('storage', e => console.log('Storage event:', e))
   ```

### 問題 4：API 401 錯誤

**可能原因：**
- Token 過期
- 未登入

**解決方法：**
1. 重新登入系統
2. 檢查 localStorage 中的 auth_token
3. 確認 Token 格式正確

### 問題 5：計時器沒有在 10 分鐘後恢復

**檢查步驟：**
1. 確認瀏覽器分頁仍然處於活動狀態
2. 檢查 Console 是否有錯誤
3. 使用 10 秒測試版本驗證功能

---

## 📊 測試結果記錄

**測試日期：** _______________
**測試人員：** _______________
**瀏覽器：** _______________ 版本：_______________

| 測試項目 | 通過 | 失敗 | 備註 |
|---------|------|------|------|
| 測試 1: 啟動計時器 | ☐ | ☐ | |
| 測試 2: 發送訊息重置 | ☐ | ☐ | |
| 測試 3: 自動恢復 | ☐ | ☐ | |
| 測試 4: 多分頁啟動同步 | ☐ | ☐ | |
| 測試 5: 多分頁發送同步 | ☐ | ☐ | |
| 測試 6: 切換離開恢復 | ☐ | ☐ | |
| 測試 7: 切換返回正常 | ☐ | ☐ | |
| 測試 8: 頁面重新整理 | ☐ | ☐ | |

**總結：**
- 通過：___ / 8
- 失敗：___ / 8

**發現的問題：**
1.
2.
3.

**建議改進：**
1.
2.
3.

---

## 📝 補充說明

### 關於 10 分鐘測試

正式測試 10 分鐘功能時：
1. 建議準備計時器或手錶
2. 可以在等待期間進行其他測試
3. 確保瀏覽器分頁保持活動狀態（不要最小化或切換到其他應用太久）

### 關於多分頁測試

- 建議使用相同瀏覽器的不同分頁
- 避免使用無痕模式（localStorage 會隔離）
- 確保兩個分頁都在相同的 http://localhost:5173 域名下

### 測試完成後

記得將 `MANUAL_MODE_DURATION` 恢復為正式的 10 分鐘：
```typescript
const MANUAL_MODE_DURATION = 10 * 60 * 1000; // 10 分鐘
```

---

## 🎯 自動化測試（可選）

如需要自動化測試，可以參考 `/data2/lili_hotel/test_gpt_timer.md` 中的 Playwright 測試範例。

---

## 📞 技術支援

如遇到問題，請提供：
1. 瀏覽器 Console 的完整錯誤訊息
2. Network 面板的 API 請求截圖
3. 重現步驟的詳細描述

祝測試順利！✨
