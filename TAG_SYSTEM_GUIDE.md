# æ¨™ç±¤ç³»çµ±ä½¿ç”¨æŒ‡å— (Tag System Guide)

**ç‰ˆæœ¬**: v1.0
**æ›´æ–°æ—¥æœŸ**: 2025-11-23
**é©ç”¨å°ˆæ¡ˆ**: LiLi Hotel CRM System

---

## ç›®éŒ„

1. [ç³»çµ±æ¦‚è¿°](#ç³»çµ±æ¦‚è¿°)
2. [æ¨™ç±¤é¡å‹](#æ¨™ç±¤é¡å‹)
3. [è³‡æ–™åº«æ¶æ§‹](#è³‡æ–™åº«æ¶æ§‹)
4. [API ç«¯é»èªªæ˜](#api-ç«¯é»èªªæ˜)
5. [æŸ¥è©¢é‚è¼¯](#æŸ¥è©¢é‚è¼¯)
6. [é»æ“Šè¨ˆæ•¸æ©Ÿåˆ¶](#é»æ“Šè¨ˆæ•¸æ©Ÿåˆ¶)
7. [å‰ç«¯æ•´åˆ](#å‰ç«¯æ•´åˆ)
8. [æœ€ä½³å¯¦è¸](#æœ€ä½³å¯¦è¸)
9. [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)

---

## ç³»çµ±æ¦‚è¿°

LiLi Hotel çš„æ¨™ç±¤ç³»çµ±æ¡ç”¨ **ä¸‰è¡¨æ¶æ§‹è¨­è¨ˆ**ï¼Œç”¨æ–¼åˆ†é¡å’Œè¿½è¹¤æœƒå“¡çš„è¡Œç‚ºèˆ‡å±¬æ€§ã€‚ç³»çµ±æ”¯æ´è‡ªå‹•æ¨™ç±¤ç”Ÿæˆã€æ‰‹å‹•æ¨™ç±¤ç®¡ç†ï¼Œä»¥åŠé»æ“Šè¨ˆæ•¸è¿½è¹¤åŠŸèƒ½ã€‚

### æ ¸å¿ƒç‰¹æ€§

- âœ… **é›™é¡å‹æ¨™ç±¤**ï¼šæœƒå“¡æ¨™ç±¤ï¼ˆå±¬æ€§ï¼‰+ äº’å‹•æ¨™ç±¤ï¼ˆè¡Œç‚ºï¼‰
- âœ… **é›™ä¾†æºäº’å‹•æ¨™ç±¤**ï¼šè‡ªå‹•ç”¢ç”Ÿ + æ‰‹å‹•æ–°å¢
- âœ… **è¦–è¦ºåŒ–å€åˆ†**ï¼šç¶ è‰²ï¼ˆæœƒå“¡ï¼‰ã€é»ƒè‰²ï¼ˆè‡ªå‹•äº’å‹•ï¼‰ã€è—è‰²ï¼ˆæ‰‹å‹•äº’å‹•ï¼‰
- âœ… **é»æ“Šè¨ˆæ•¸**ï¼šè¿½è¹¤é‡è¤‡æ¨™ç±¤é»æ“Šæ¬¡æ•¸ï¼ˆæœƒå“¡æ¨™ç±¤æ”¯æ´ç´¯åŠ ï¼‰
- âœ… **å»é‡æ©Ÿåˆ¶**ï¼šåŒåæ¨™ç±¤è‡ªå‹•å»é‡ï¼Œå„ªå…ˆé¡¯ç¤ºè‡ªå‹•ç”¢ç”Ÿæ¨™ç±¤
- âœ… **æ•ˆèƒ½å„ªåŒ–**ï¼šç´¢å¼•æŸ¥è©¢ + æœ€å°åŒ– SQL æŸ¥è©¢æ¬¡æ•¸

---

## æ¨™ç±¤é¡å‹

### 1. æœƒå“¡æ¨™ç±¤ (Member Tags) ğŸŸ¢

**ç”¨é€”**: æ¨™è¨˜æœƒå“¡çš„éœæ…‹å±¬æ€§æˆ–åˆ†é¡
**ä¾†æº**: CRM æ‰‹å‹•æ–°å¢ã€PMS åŒ¯å…¥ã€å•å·ç³»çµ±
**é¡è‰²**: ç¶ è‰²
**è³‡æ–™è¡¨**: `member_tags`

**ç‰¹æ€§**:
- ç›´æ¥é—œè¯æœƒå“¡ï¼ˆmember_idï¼‰
- æ”¯æ´ click_count ç´¯åŠ 
- å¯é—œè¯è¨Šæ¯ä¾†æºï¼ˆmessage_idï¼Œç”¨æ–¼å»é‡ï¼‰

**ç¯„ä¾‹**:
```
VIPæœƒå“¡, å¸¸å®¢, ä¼æ¥­å®¢æˆ¶, éæ•é«”è³ª, ç´ é£Ÿè€…
```

### 2. äº’å‹•æ¨™ç±¤ (Interaction Tags)

äº’å‹•æ¨™ç±¤æœ‰å…©ç¨®ä¾†æºï¼š

#### 2.1 è‡ªå‹•ç”¢ç”Ÿäº’å‹•æ¨™ç±¤ ğŸŸ¡

**ç”¨é€”**: è‡ªå‹•è¿½è¹¤æœƒå“¡èˆ‡è¨Šæ¯äº’å‹•è¡Œç‚º
**ä¾†æº**: è¨Šæ¯æ¨¡æ¿ã€å•å·ç³»çµ±ï¼ˆè‡ªå‹•è§¸ç™¼ï¼‰
**é¡è‰²**: é»ƒè‰²
**è³‡æ–™è¡¨**: `interaction_tags` (å®šç¾©) + `component_interaction_logs` (è§¸ç™¼è¨˜éŒ„)

**ç‰¹æ€§**:
- é€šé ComponentInteractionLog é—œè¯æœƒå“¡ï¼ˆline_uidï¼‰
- ä¸€å€‹æ¨™ç±¤å¯è¢«å¤šå€‹æœƒå“¡è§¸ç™¼
- è¨˜éŒ„è§¸ç™¼æ¬¡æ•¸å’Œè§¸ç™¼æœƒå“¡æ•¸

**ç¯„ä¾‹**:
```
å·²é»æ“Šä¿ƒéŠ·é€£çµ, å·²å¡«å¯«å•å·, å·²è§€çœ‹å½±ç‰‡, å·²ä¸‹è¼‰å„ªæƒ åˆ¸
```

#### 2.2 æ‰‹å‹•æ–°å¢äº’å‹•æ¨™ç±¤ ğŸ”µ

**ç”¨é€”**: CRM ç®¡ç†å“¡æ‰‹å‹•æ¨™è¨˜æœƒå“¡äº’å‹•è¡Œç‚º
**ä¾†æº**: CRM å¾Œå°æ‰‹å‹•æ–°å¢
**é¡è‰²**: è—è‰²
**è³‡æ–™è¡¨**: `member_interaction_tags`

**ç‰¹æ€§**:
- ç›´æ¥é—œè¯æœƒå“¡ï¼ˆmember_idï¼‰
- click_count å›ºå®šç‚º 1ï¼Œä¸ç´¯åŠ 
- å¯é—œè¯è¨Šæ¯ä¾†æºï¼ˆmessage_idï¼‰

**ç¯„ä¾‹**:
```
å·²ç¢ºèªè¨‚æˆ¿, å·²å®Œæˆé€€æˆ¿, å·²åƒåŠ æ´»å‹•, å·²æŠ•è¨´è™•ç†
```

---

## è³‡æ–™åº«æ¶æ§‹

### ä¸‰è¡¨è¨­è¨ˆæ¦‚è¦½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  member_tags    â”‚  æœƒå“¡æ¨™ç±¤ï¼ˆç¶ è‰²ï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id              â”‚
â”‚ member_id       â”‚  FK â†’ members.id
â”‚ tag_name        â”‚
â”‚ tag_source      â”‚  CRM/PMS/å•åˆ¸/å¾Œå°è‡ªè¨‚
â”‚ message_id      â”‚  FK â†’ messages.id (optional)
â”‚ click_count     â”‚  é»æ“Šæ¬¡æ•¸ï¼Œæ”¯æ´ç´¯åŠ 
â”‚ tagged_at       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  interaction_tags    â”‚  äº’å‹•æ¨™ç±¤å®šç¾©ï¼ˆé»ƒè‰²è‡ªå‹•æ¨™ç±¤çš„ä¾†æºï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id                   â”‚
â”‚ tag_name             â”‚
â”‚ tag_source           â”‚  è¨Šæ¯æ¨¡æ¿/å•åˆ¸æ¨¡æ¿
â”‚ trigger_count        â”‚  ç¸½è§¸ç™¼æ¬¡æ•¸
â”‚ trigger_member_count â”‚  è§¸ç™¼æœƒå“¡æ•¸
â”‚ last_triggered_at    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
        â”‚ (é€šé ComponentInteractionLog é—œè¯)
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  component_interaction_logs  â”‚  äº’å‹•è§¸ç™¼è¨˜éŒ„
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id                           â”‚
â”‚ line_id                      â”‚  æœƒå“¡çš„ LINE UID
â”‚ interaction_tag_id           â”‚  FK â†’ interaction_tags.id
â”‚ campaign_id                  â”‚
â”‚ message_id                   â”‚
â”‚ created_at                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  member_interaction_tags    â”‚  æ‰‹å‹•äº’å‹•æ¨™ç±¤ï¼ˆè—è‰²ï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id                          â”‚
â”‚ member_id                   â”‚  FK â†’ members.id
â”‚ tag_name                    â”‚
â”‚ tag_source                  â”‚  å›ºå®šç‚º CRM
â”‚ message_id                  â”‚  FK â†’ messages.id (optional)
â”‚ click_count                 â”‚  å›ºå®šç‚º 1ï¼Œä¸ç´¯åŠ 
â”‚ tagged_at                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç´¢å¼•è¨­è¨ˆ

**é«˜æ•ˆæŸ¥è©¢ç´¢å¼•**:

```sql
-- member_tags
CREATE INDEX idx_member_tags_member_id ON member_tags(member_id);
CREATE UNIQUE INDEX uq_member_tag_message ON member_tags(member_id, tag_name, message_id);

-- member_interaction_tags
CREATE INDEX idx_member_interaction_tags_member_id ON member_interaction_tags(member_id);
CREATE UNIQUE INDEX uq_member_interaction_tag_message ON member_interaction_tags(member_id, tag_name, message_id);

-- component_interaction_logs
CREATE INDEX idx_component_interaction_logs_line_id ON component_interaction_logs(line_id);
CREATE INDEX idx_component_interaction_logs_tag_id ON component_interaction_logs(interaction_tag_id);
```

---

## API ç«¯é»èªªæ˜

### æœƒå“¡æ¨™ç±¤ç®¡ç†

#### 1. æ‰¹é‡æ›´æ–°æœƒå“¡æ¨™ç±¤ï¼ˆå®Œå…¨å–ä»£ï¼‰

**ç«¯é»**: `PUT /api/v1/members/{member_id}/tags`
**èªè­‰**: éœ€è¦ï¼ˆcurrent_userï¼‰

**è«‹æ±‚é«”**:
```json
{
  "tag_names": ["VIPæœƒå“¡", "å¸¸å®¢", "ä¼æ¥­å®¢æˆ¶"]
}
```

**è¡Œç‚º**:
1. åˆªé™¤è©²æœƒå“¡çš„æ‰€æœ‰ç¾æœ‰æœƒå“¡æ¨™ç±¤
2. æ–°å¢æ–°çš„æ¨™ç±¤ï¼Œæ¯å€‹æ¨™ç±¤ click_count åˆå§‹å€¼ç‚º 1

#### 2. æ–°å¢å–®å€‹æœƒå“¡æ¨™ç±¤ï¼ˆæ”¯æ´ click_count ç´¯åŠ ï¼‰

**ç«¯é»**: `POST /api/v1/members/{member_id}/tags/add`
**èªè­‰**: éœ€è¦ï¼ˆcurrent_userï¼‰

**è«‹æ±‚é«”**:
```json
{
  "tag_name": "VIPæœƒå“¡",
  "message_id": 123  // optional
}
```

**è¡Œç‚º**:
- è‹¥ `(member_id, tag_name, message_id)` çµ„åˆå·²å­˜åœ¨ â†’ `click_count = click_count + 1`
- è‹¥ä¸å­˜åœ¨ â†’ æ–°å¢è¨˜éŒ„ï¼Œ`click_count = 1`

**ä½¿ç”¨å ´æ™¯**:
- è¨Šæ¯æ¨¡æ¿ä¸­çš„æ¨™ç±¤æŒ‰éˆ•è¢«é‡è¤‡é»æ“Š
- è¿½è¹¤æœƒå“¡å°åŒä¸€æ¨™ç±¤çš„èˆˆè¶£ç¨‹åº¦

### äº’å‹•æ¨™ç±¤ç®¡ç†

#### 3. æ‰¹é‡æ›´æ–°æ‰‹å‹•äº’å‹•æ¨™ç±¤ï¼ˆå®Œå…¨å–ä»£ï¼‰

**ç«¯é»**: `PUT /api/v1/members/{member_id}/interaction-tags`
**èªè­‰**: æš«æ™‚ç§»é™¤ï¼ˆé–‹ç™¼éšæ®µï¼‰

**è«‹æ±‚é«”**:
```json
{
  "tag_names": ["å·²ç¢ºèªè¨‚æˆ¿", "å·²åƒåŠ æ´»å‹•"]
}
```

**è¡Œç‚º**:
1. åˆªé™¤è©²æœƒå“¡çš„æ‰€æœ‰æ‰‹å‹•äº’å‹•æ¨™ç±¤ï¼ˆMemberInteractionTagï¼‰
2. æ–°å¢æ–°çš„æ¨™ç±¤ï¼Œæ¯å€‹æ¨™ç±¤ click_count å›ºå®šç‚º 1

**æ³¨æ„**: æ­¤ç«¯é»ä¸å½±éŸ¿è‡ªå‹•ç”¢ç”Ÿçš„äº’å‹•æ¨™ç±¤ï¼ˆInteractionTag + ComponentInteractionLogï¼‰

#### 4. æ–°å¢å–®å€‹æ‰‹å‹•äº’å‹•æ¨™ç±¤ï¼ˆä¸ç´¯åŠ ï¼‰

**ç«¯é»**: `POST /api/v1/members/{member_id}/interaction-tags/add`
**èªè­‰**: æš«æ™‚ç§»é™¤ï¼ˆé–‹ç™¼éšæ®µï¼‰

**è«‹æ±‚é«”**:
```json
{
  "tag_name": "å·²ç¢ºèªè¨‚æˆ¿",
  "message_id": 456  // optional
}
```

**è¡Œç‚º**:
- è‹¥ `(member_id, tag_name, message_id)` çµ„åˆå·²å­˜åœ¨ â†’ å¿½ç•¥ï¼Œè¿”å›ã€Œå·²å­˜åœ¨ã€è¨Šæ¯
- è‹¥ä¸å­˜åœ¨ â†’ æ–°å¢è¨˜éŒ„ï¼Œ`click_count = 1`

**æ³¨æ„**: æ‰‹å‹•äº’å‹•æ¨™ç±¤çš„ click_count ä¸ç´¯åŠ ï¼Œå›ºå®šç‚º 1

### æœƒå“¡è©³æƒ…æŸ¥è©¢

#### 5. ç²å–æœƒå“¡è©³æƒ…ï¼ˆåŒ…å«æ‰€æœ‰æ¨™ç±¤ï¼‰

**ç«¯é»**: `GET /api/v1/members/{member_id}`
**èªè­‰**: æš«æ™‚ç§»é™¤ï¼ˆé–‹ç™¼éšæ®µï¼‰

**å›æ‡‰ç¯„ä¾‹**:
```json
{
  "success": true,
  "data": {
    "id": 1,
    "name": "å¼µä¸‰",
    "email": "zhang@example.com",
    "tags": [
      {
        "id": 1,
        "name": "VIPæœƒå“¡",
        "type": "member",
        "source": null
      },
      {
        "id": 2,
        "name": "å·²é»æ“Šä¿ƒéŠ·é€£çµ",
        "type": "interaction",
        "source": "auto"
      },
      {
        "id": 3,
        "name": "å·²ç¢ºèªè¨‚æˆ¿",
        "type": "interaction",
        "source": "manual"
      }
    ]
  }
}
```

---

## æŸ¥è©¢é‚è¼¯

### æœƒå“¡è©³æƒ…é æ¨™ç±¤æŸ¥è©¢æµç¨‹

```python
# æŸ¥è©¢ 1: æœƒå“¡æ¨™ç±¤ï¼ˆç¶ è‰²ï¼‰
member_tags = SELECT id, tag_name
              FROM member_tags
              WHERE member_id = {member_id}
              ORDER BY tag_name

# æŸ¥è©¢ 2: è‡ªå‹•äº’å‹•æ¨™ç±¤ï¼ˆé»ƒè‰²ï¼‰
auto_interaction_tags = SELECT DISTINCT it.id, it.tag_name
                        FROM interaction_tags it
                        JOIN component_interaction_logs cil
                          ON it.id = cil.interaction_tag_id
                        WHERE cil.line_id = {member.line_uid}
                        ORDER BY it.tag_name

# æŸ¥è©¢ 3: æ‰‹å‹•äº’å‹•æ¨™ç±¤ï¼ˆè—è‰²ï¼‰
manual_interaction_tags = SELECT id, tag_name
                          FROM member_interaction_tags
                          WHERE member_id = {member_id}
                          ORDER BY tag_name

# å»é‡é‚è¼¯ï¼ˆè¨˜æ†¶é«”å…§è™•ç†ï¼‰
interaction_tag_names = set()

for auto_tag in auto_interaction_tags:
    if auto_tag.name not in interaction_tag_names:
        tags.append(TagInfo(..., source="auto"))
        interaction_tag_names.add(auto_tag.name)

for manual_tag in manual_interaction_tags:
    if manual_tag.name not in interaction_tag_names:  # å»é‡
        tags.append(TagInfo(..., source="manual"))
        interaction_tag_names.add(manual_tag.name)
```

### å»é‡è¦å‰‡

ç•¶åŒä¸€æ¨™ç±¤åç¨±åŒæ™‚å­˜åœ¨æ–¼è‡ªå‹•å’Œæ‰‹å‹•æ¨™ç±¤æ™‚ï¼š
- âœ… **å„ªå…ˆé¡¯ç¤ºè‡ªå‹•ç”¢ç”Ÿæ¨™ç±¤**ï¼ˆé»ƒè‰²ï¼‰
- âŒ å¿½ç•¥æ‰‹å‹•æ¨™ç±¤ï¼ˆè—è‰²ï¼‰

**åŸå› **: è‡ªå‹•æ¨™ç±¤æœ‰å®Œæ•´çš„è§¸ç™¼æ­·å²è¨˜éŒ„ï¼Œè³‡è¨Šæ›´è±å¯Œ

---

## é»æ“Šè¨ˆæ•¸æ©Ÿåˆ¶

### æœƒå“¡æ¨™ç±¤çš„ click_count

**æ”¯æ´ç´¯åŠ **: âœ…

**å¯¦ä½œæ–¹å¼**:
```sql
INSERT INTO member_tags
  (member_id, tag_name, tag_source, message_id, click_count, tagged_at, created_at)
VALUES
  (1, 'VIPæœƒå“¡', 'CRM', NULL, 1, NOW(), NOW())
ON DUPLICATE KEY UPDATE
  click_count = click_count + 1,
  updated_at = NOW()
```

**ä½¿ç”¨å ´æ™¯**:
- æœƒå“¡å¤šæ¬¡é»æ“Šè¨Šæ¯æ¨¡æ¿ä¸­çš„åŒä¸€æ¨™ç±¤æŒ‰éˆ•
- è¿½è¹¤æœƒå“¡å°ç‰¹å®šåˆ†é¡çš„èˆˆè¶£ç¨‹åº¦
- åˆ†ææœƒå“¡è¡Œç‚ºæ¨¡å¼

**ç¯„ä¾‹**:
```
ç¬¬ 1 æ¬¡é»æ“Šã€ŒVIPæœƒå“¡ã€â†’ click_count = 1
ç¬¬ 2 æ¬¡é»æ“Šã€ŒVIPæœƒå“¡ã€â†’ click_count = 2
ç¬¬ 3 æ¬¡é»æ“Šã€ŒVIPæœƒå“¡ã€â†’ click_count = 3
```

### æ‰‹å‹•äº’å‹•æ¨™ç±¤çš„ click_count

**æ”¯æ´ç´¯åŠ **: âŒï¼ˆå›ºå®šç‚º 1ï¼‰

**åŸå› **: æ‰‹å‹•æ¨™ç±¤ç”± CRM ç®¡ç†å“¡æ–°å¢ï¼Œä¸ä»£è¡¨é‡è¤‡è¡Œç‚º

**å¯¦ä½œæ–¹å¼**:
```python
# æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
if existing_tag:
    return "äº’å‹•æ¨™ç±¤å·²å­˜åœ¨ï¼ˆæ‰‹å‹•æ¨™ç±¤ä¸ç´¯åŠ ï¼‰"

# æ–°å¢è¨˜éŒ„
interaction_tag = MemberInteractionTag(
    member_id=member_id,
    tag_name=tag_name,
    click_count=1  # å›ºå®šç‚º 1
)
```

### UNIQUE ç´¢å¼•çš„ä½œç”¨

```sql
-- é˜²æ­¢é‡è¤‡æ’å…¥ç›¸åŒçµ„åˆ
UNIQUE INDEX uq_member_tag_message (member_id, tag_name, message_id)
```

**æ•ˆæœ**:
- MySQL å±¤ç´šé˜²æ­¢ `(member_id, tag_name, message_id)` é‡è¤‡
- é…åˆ `ON DUPLICATE KEY UPDATE` å¯¦ç¾åŸå­æ€§ç´¯åŠ 
- ä¸éœ€è¦é¡å¤–çš„ SELECT æŸ¥è©¢æª¢æŸ¥

---

## å‰ç«¯æ•´åˆ

### TagInfo é¡å‹å®šç¾©

```typescript
interface TagInfo {
  id: number;
  name: string;
  type: 'member' | 'interaction';
  source?: 'auto' | 'manual';  // null for member tags
}
```

### æ¨™ç±¤é¡è‰²æ˜ å°„

```typescript
function getTagColor(tag: TagInfo): string {
  if (tag.type === 'member') {
    return 'green';  // æœƒå“¡æ¨™ç±¤
  }

  if (tag.type === 'interaction') {
    return tag.source === 'auto' ? 'yellow' : 'blue';
    // é»ƒè‰²: è‡ªå‹•ç”¢ç”Ÿ, è—è‰²: æ‰‹å‹•æ–°å¢
  }

  return 'gray';  // fallback
}
```

### React ç¯„ä¾‹

```tsx
import { Tag } from '@/components/ui/tag';

function MemberTags({ tags }: { tags: TagInfo[] }) {
  return (
    <div className="flex flex-wrap gap-2">
      {tags.map((tag) => (
        <Tag
          key={`${tag.type}-${tag.id}`}
          color={getTagColor(tag)}
        >
          {tag.name}
        </Tag>
      ))}
    </div>
  );
}
```

---

## æœ€ä½³å¯¦è¸

### 1. æ¨™ç±¤å‘½åè¦ç¯„

âœ… **æ¨è–¦åšæ³•**:
```
VIPæœƒå“¡, å¸¸å®¢, ä¼æ¥­å®¢æˆ¶
å·²é»æ“Šä¿ƒéŠ·é€£çµ, å·²å¡«å¯«å•å·
```

âŒ **é¿å…åšæ³•**:
```
VIPæœƒå“¡ğŸ˜€  (åŒ…å« Emoji)
æœƒå“¡@#$%  (åŒ…å«ç‰¹æ®Šå­—å…ƒ)
é€™æ˜¯ä¸€å€‹éå¸¸éå¸¸éå¸¸é•·çš„æ¨™ç±¤åç¨±è¶…é20å­—å…ƒ  (è¶…éé•·åº¦é™åˆ¶)
```

**è¦ç¯„**:
- âœ… åƒ…å…è¨±ä¸­æ–‡ã€è‹±æ–‡ã€æ•¸å­—ã€ç©ºæ ¼
- âœ… é•·åº¦ä¸è¶…é 20 å­—å…ƒ
- âŒ ç¦æ­¢ Emoji å’Œç‰¹æ®Šå­—å…ƒ
- æ­£å‰‡è¡¨é”å¼: `/^[\u4e00-\u9fa5a-zA-Z0-9\s]+$/`

### 2. æ¨™ç±¤ä¾†æºç®¡ç†

**æœƒå“¡æ¨™ç±¤ä¾†æº**:
- `CRM` - CRM å¾Œå°æ‰‹å‹•æ–°å¢
- `PMS` - PMS ç³»çµ±åŒ¯å…¥
- `å•åˆ¸` - å•å·ç³»çµ±è‡ªå‹•æ¨™è¨˜
- `å¾Œå°è‡ªè¨‚` - å…¶ä»–å¾Œå°ç³»çµ±

**äº’å‹•æ¨™ç±¤ä¾†æº**:
- `è¨Šæ¯æ¨¡æ¿` - è¨Šæ¯æŒ‰éˆ•é»æ“Šè§¸ç™¼
- `å•åˆ¸æ¨¡æ¿` - å•å·å¡«å¯«å®Œæˆè§¸ç™¼
- `CRM` - æ‰‹å‹•äº’å‹•æ¨™ç±¤å›ºå®šä¾†æº

### 3. æ•ˆèƒ½å„ªåŒ–å»ºè­°

**æŸ¥è©¢å„ªåŒ–**:
- âœ… ä½¿ç”¨ç´¢å¼•æ¬„ä½æŸ¥è©¢ï¼ˆmember_id, line_uidï¼‰
- âœ… åªé¸å–éœ€è¦çš„æ¬„ä½ï¼ˆ`SELECT id, tag_name` è€Œé `SELECT *`ï¼‰
- âœ… åœ¨è¨˜æ†¶é«”å…§é€²è¡Œå»é‡ï¼ˆPython setï¼‰ï¼Œè€Œéå¤šæ¬¡ SQL DISTINCT
- âœ… æª¢æŸ¥ line_uid å­˜åœ¨æ‰æŸ¥è©¢è‡ªå‹•äº’å‹•æ¨™ç±¤

**æœªä¾†å„ªåŒ–æ–¹å‘**:
- ä½¿ç”¨ `asyncio.gather()` å¹³è¡ŒåŸ·è¡Œä¸‰å€‹æ¨™ç±¤æŸ¥è©¢
- å¯¦ä½œæ¨™ç±¤å¿«å–æ©Ÿåˆ¶ï¼ˆRedisï¼‰
- å»ºç«‹ç‰©åŒ–è¦–åœ–ï¼ˆMaterialized Viewï¼‰

### 4. è³‡æ–™ä¸€è‡´æ€§

**ä½¿ç”¨äº¤æ˜“ï¼ˆTransactionï¼‰**:
```python
async with db.begin():
    # åˆªé™¤èˆŠæ¨™ç±¤
    await db.execute(delete(MemberTag).where(...))

    # æ–°å¢æ–°æ¨™ç±¤
    for tag_name in tag_names:
        db.add(MemberTag(...))

    await db.commit()
```

**é˜²æ­¢ç«¶çˆ­æ¢ä»¶**:
- ä½¿ç”¨ UNIQUE ç´¢å¼•é˜²æ­¢é‡è¤‡æ’å…¥
- ä½¿ç”¨ `ON DUPLICATE KEY UPDATE` ä¿è­‰åŸå­æ€§
- åœ¨æ‡‰ç”¨å±¤é¢ä¹Ÿé€²è¡Œæª¢æŸ¥ï¼ˆé›™é‡ä¿éšªï¼‰

---

## æ•…éšœæ’é™¤

### å•é¡Œ 1: æ¨™ç±¤é‡è¤‡é¡¯ç¤º

**ç—‡ç‹€**: åŒä¸€æ¨™ç±¤åç¨±åœ¨æœƒå“¡è©³æƒ…é å‡ºç¾å¤šæ¬¡

**åŸå› **: å»é‡é‚è¼¯å¤±æ•ˆæˆ–æŸ¥è©¢é‚è¼¯éŒ¯èª¤

**è§£æ±ºæ–¹æ¡ˆ**:
1. æª¢æŸ¥ `interaction_tag_names` set æ˜¯å¦æ­£ç¢ºæ›´æ–°
2. ç¢ºèªæŸ¥è©¢é †åºï¼šè‡ªå‹•æ¨™ç±¤ â†’ æ‰‹å‹•æ¨™ç±¤
3. é©—è­‰ DISTINCT é—œéµå­—æ˜¯å¦ç”Ÿæ•ˆ

### å•é¡Œ 2: click_count æœªç´¯åŠ 

**ç—‡ç‹€**: å¤šæ¬¡é»æ“Šæ¨™ç±¤ï¼Œclick_count ä»ç‚º 1

**åŸå› **:
- UNIQUE ç´¢å¼•æœªæ­£ç¢ºè¨­ç½®
- ä½¿ç”¨äº†éŒ¯èª¤çš„ API ç«¯é»ï¼ˆæ‰¹é‡æ›´æ–° vs. å–®å€‹æ–°å¢ï¼‰

**è§£æ±ºæ–¹æ¡ˆ**:
1. ç¢ºèªè³‡æ–™åº«å·²åŸ·è¡Œ migration: `39c1651f1c68_add_click_count_to_tags`
2. æª¢æŸ¥ UNIQUE ç´¢å¼•: `uq_member_tag_message`
3. ä½¿ç”¨æ­£ç¢ºç«¯é»: `POST /members/{id}/tags/add` è€Œé `PUT /members/{id}/tags`

### å•é¡Œ 3: è‡ªå‹•æ¨™ç±¤æœªé¡¯ç¤º

**ç—‡ç‹€**: æœƒå“¡å·²è§¸ç™¼äº’å‹•ï¼Œä½†æ¨™ç±¤æœªé¡¯ç¤º

**åŸå› **:
- `ComponentInteractionLog` æœªæ­£ç¢ºè¨˜éŒ„
- `line_uid` ä¸åŒ¹é…
- æŸ¥è©¢æ¢ä»¶éŒ¯èª¤

**è§£æ±ºæ–¹æ¡ˆ**:
1. æª¢æŸ¥ `component_interaction_logs` è¡¨æ˜¯å¦æœ‰è¨˜éŒ„
2. ç¢ºèª `line_id` æ¬„ä½èˆ‡æœƒå“¡çš„ `line_uid` ä¸€è‡´
3. é©—è­‰ JOIN æ¢ä»¶æ­£ç¢º

### å•é¡Œ 4: æ•ˆèƒ½å•é¡Œ

**ç—‡ç‹€**: æœƒå“¡è©³æƒ…é è¼‰å…¥ç·©æ…¢

**åŸå› **:
- ç¼ºå°‘ç´¢å¼•
- N+1 æŸ¥è©¢å•é¡Œ
- æœªå„ªåŒ– JOIN

**è§£æ±ºæ–¹æ¡ˆ**:
1. æª¢æŸ¥ç´¢å¼•æ˜¯å¦å­˜åœ¨: `SHOW INDEX FROM member_tags`
2. ä½¿ç”¨ EXPLAIN åˆ†ææŸ¥è©¢è¨ˆç•«
3. å•Ÿç”¨æŸ¥è©¢æ—¥èªŒåˆ†ææ…¢æŸ¥è©¢

---

## é™„éŒ„

### ç›¸é—œæ–‡ä»¶

- **è³‡æ–™åº«è¦æ ¼**: `/01/spec/erm.dbml` (v0.3.0)
- **å¯¦ä½œæ±ºç­–**: `/01/spec/implementation_decisions.md` (Decision 8)
- **Migration**: `/backend/migrations/versions/39c1651f1c68_add_click_count_to_tags.py`

### ç‰ˆæœ¬æ­·å²

- **v1.0** (2025-11-23): åˆå§‹ç‰ˆæœ¬
  - ä¸‰è¡¨æ¶æ§‹èªªæ˜
  - click_count æ©Ÿåˆ¶æ–‡æª”
  - API ç«¯é»å®Œæ•´èªªæ˜
  - æŸ¥è©¢é‚è¼¯èˆ‡æ•ˆèƒ½å„ªåŒ–

---

**ç¶­è­·è€…**: AI Team
**è¯çµ¡æ–¹å¼**: è«‹æäº¤ Issue è‡³å°ˆæ¡ˆ GitHub Repository
