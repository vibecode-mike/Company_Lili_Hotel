Feature: 會員標籤管理
  作為一位使用者
  當回覆會員訊息時，能即時查看會員喜好（標籤）並快速為會員新增或修改標籤
  以便即時更新會員資料來提升會員管理效率

  Rule: 會員標籤來源支援外部系統串接（CRM/PMS）

    Example: 外部系統串接的標籤來源為 CRM
      Given 會員「張三」從 CRM 系統獲得標籤「高消費客戶」
      When 使用者查看會員「張三」的標籤
      Then 系統顯示標籤「高消費客戶」，來源為「CRM」

    Example: 外部系統串接的標籤來源為 PMS
      Given 會員「李四」從 PMS 系統獲得標籤「商務房」
      When 使用者查看會員「李四」的標籤
      Then 系統顯示標籤「商務房」，來源為「PMS」

  Rule: 會員標籤來源支援問券蒐集模組

    Example: 問券蒐集的標籤來源
      Given 會員「王五」從問券系統獲得標籤「26-35 歲」
      When 使用者查看會員「王五」的標籤
      Then 系統顯示標籤「26-35 歲」，來源為「問券」

  Rule: 會員標籤來源支援後台自訂

    Example: 後台自訂的標籤來源
      Given 使用者為會員「趙六」手動新增標籤「VIP」
      When 使用者查看會員「趙六」的標籤
      Then 系統顯示標籤「VIP」，來源為「後台自訂」
  
  Rule: 錯誤處理：外部來源回傳無效標籤時跳過該筆資料

    @not-implemented
    Example: CRM 回傳未定義的標籤值
      Given CRM 系統應僅回傳前端設定檔內允許的標籤值
      And CRM 仍回傳會員「張三」的標籤「🔥VIP🔥」（不在允許清單內）
      When 系統處理 CRM 標籤資料
      Then 系統記錄錯誤「CRM 標籤值不在允許清單內」
      And 系統跳過該筆資料、不為會員「張三」新增此標籤
      And 其他有效標籤繼續匯入

  Rule: 滾動12個月的時間範圍計算採用從當前日期往前推算365天

    @not-implemented
    Example: 滾動12個月的計算基準日範例
      Given 今日為「2025/06/15」
      When 系統計算「過去 12 個月」的時間範圍
      Then 時間範圍為「2024/06/15 至 2025/06/15」
      And 計算公式為「current_date - 365 天至 current_date」
      And 系統每日自動更新標籤判定結果


  Rule: 問券蒐集標籤支援性別比對

    Example: 問券蒐集性別標籤
      Given 問券系統回傳會員「周八」的性別為「2」（女）
      When 系統處理問券資料
      Then 系統為會員「周八」新增標籤「女」
      And 會員「周八」的 gender 欄位更新為「2」

    Example: 性別值域說明
      Given 系統的性別值域定義為「0=不透漏 / 1=男 / 2=女」
      When 問券系統回傳會員「李九」的性別為「1」（男）
      Then 系統為會員「李九」新增標籤「男」
      And 會員「李九」的 gender 欄位更新為「1」

    Example: 預設值為不透漏
      Given 會員「王十」尚未填寫性別資料
      When 系統建立會員「王十」的資料
      Then 會員「王十」的 gender 欄位預設為「0」（不透漏）

  Rule: 問券蒐集標籤支援年齡區間比對

    Example: 年齡區間定義與比對邏輯
      Given 系統定義的年齡區間標籤為
        | 年齡區間 | 標籤名稱   |
        | < 18     | 18以下     |
        | 18-25    | 18-25      |
        | 26-35    | 26-35      |
        | 36-50    | 36-50      |
        | >= 51    | 51+        |
      When 問券系統回傳會員年齡
      Then 系統依據年齡區間為會員新增對應標籤

    Example: 問券蒐集年齡區間標籤 - 18-25 區間
      Given 問券系統回傳會員「吳九」的年齡為「22」
      When 系統處理問券資料
      Then 系統為會員「吳九」新增標籤「18-25」

    Example: 問券蒐集年齡區間標籤 - 18以下區間
      Given 問券系統回傳會員「小明」的年齡為「16」
      When 系統處理問券資料
      Then 系統為會員「小明」新增標籤「18以下」

    Example: 問券蒐集年齡區間標籤 - 36-50 區間
      Given 問券系統回傳會員「李華」的年齡為「42」
      When 系統處理問券資料
      Then 系統為會員「李華」新增標籤「36-50」

    Example: 問券蒐集年齡區間標籤 - 51+ 區間
      Given 問券系統回傳會員「王先生」的年齡為「58」
      When 系統處理問券資料
      Then 系統為會員「王先生」新增標籤「51+」

  Rule: 問券蒐集標籤支援地區比對（限制為台灣 22 縣市）

    Example: 問券蒐集地區標籤
      Given 問券系統回傳會員「鄭十」的居住地為「新北市」
      When 系統處理問券資料
      Then 系統為會員「鄭十」新增標籤「新北市」
      And 會員「鄭十」的 residence 欄位更新為「新北市」

    Example: 地區值域驗證
      Given 系統的地區值域限制為台灣 22 縣市標準名稱
      When 問券系統回傳會員「林十一」的居住地為「台北市」
      Then 系統驗證「台北市」在允許的值域範圍內
      And 系統為會員「林十一」新增標籤「台北市」

    Example: 地區值域完整列表
      Given 系統支援的地區值域包含
        | 直轄市 | 台北市、新北市、桃園市、台中市、台南市、高雄市 |
        | 市     | 基隆市、新竹市、嘉義市 |
        | 縣     | 新竹縣、苗栗縣、彰化縣、南投縣、雲林縣、嘉義縣、屏東縣、宜蘭縣、花蓮縣、台東縣、澎湖縣、金門縣、連江縣 |
      When 問券系統回傳會員的居住地
      Then 系統僅接受上述 22 個縣市名稱


  Rule: 問券蒐集標籤支援生日月份比對（從完整日期自動提取）

    Example: 問券蒐集生日月份標籤
      Given 問券系統回傳會員「王十一」的生日為「1995-09-15」
      When 系統處理問券資料
      Then 系統為會員「王十一」新增標籤「9月」
      And 會員「王十一」的 birthday 欄位更新為「1995-09-15」
      And 系統自動從完整日期提取月份「9」生成標籤

    Example: 生日月份標籤自動生成邏輯
      Given 會員「李十二」的生日為「1988-12-25」
      When 系統處理生日月份標籤
      Then 系統從 birthday 欄位提取月份「12」
      And 系統為會員「李十二」新增標籤「12月」

    Example: 未填寫生日則不產生月份標籤
      Given 會員「陳十三」未填寫生日資料（birthday 為 NULL）
      When 系統處理生日月份標籤
      Then 系統不為會員「陳十三」新增生日月份標籤

  Rule: 互動標籤來源支援會員互動模板（訊息圖文模板）

    @not-implemented
    Example: 訊息圖文模板的互動標籤
      Given 會員「李十三」點擊文字按鈕確認型模板
      When 系統處理互動事件
      Then 系統為會員「李十三」新增對應的互動標籤

  Rule: 互動標籤來源支援會員互動模板（問券模板）

    @not-implemented
    Example: 問券模板的互動標籤
      Given 會員「王十四」完成滿意度調查問券
      When 系統處理互動事件
      Then 系統為會員「王十四」新增互動標籤「滿意度調查」

  Rule: 查看會員詳細資料時，可新增後台自訂標籤

    Example: 新增後台自訂標籤
      Given 使用者正在查看會員「趙十五」的詳細資料
      When 使用者新增標籤「潛在客戶」
      Then 會員「趙十五」新增標籤「潛在客戶」

  Rule: 查看會員詳細資料時，可刪除後台自訂標籤

    Example: 刪除後台自訂標籤
      Given 會員「孫十六」擁有後台自訂標籤「測試標籤」
      And 使用者正在查看會員「孫十六」的詳細資料
      When 使用者刪除標籤「測試標籤」
      Then 會員「孫十六」的標籤「測試標籤」被刪除

  Rule: 聊天室頁面編輯會員標籤時，標籤變更須即時儲存至資料庫

    Example: 聊天室頁面批量更新會員標籤和互動標籤
      Given 使用者正在聊天室頁面查看會員「王小明」的資料
      And 會員「王小明」目前擁有會員標籤「VIP」和互動標籤「已點擊優惠」
      When 使用者開啟標籤編輯視窗
      And 使用者新增會員標籤「常客」並移除會員標籤「VIP」
      And 使用者新增互動標籤「參與活動」
      And 使用者點擊「確認」按鈕
      Then 系統調用後端 API「POST /api/v1/members/{member_id}/tags/batch-update」
      And 資料庫中會員「王小明」的會員標籤更新為「常客」
      And 資料庫中會員「王小明」的互動標籤更新為「已點擊優惠」和「參與活動」
      And 系統顯示「儲存成功」提示

    Example: 標籤儲存失敗時顯示錯誤訊息
      Given 使用者正在聊天室頁面編輯會員「李小華」的標籤
      When 使用者修改標籤並點擊「確認」按鈕
      And 後端 API 回傳錯誤
      Then 系統顯示「標籤更新失敗」錯誤訊息
      And 標籤編輯視窗保持開啟狀態
      And 會員「李小華」的原有標籤不變

    Example: 未登入時無法儲存標籤
      Given 使用者的登入 Token 已過期
      When 使用者嘗試儲存標籤變更
      Then 系統顯示「請先登入」錯誤訊息
      And 標籤變更不會被儲存

    Example: 標籤儲存為原子操作
      Given 使用者正在編輯會員「張三」的標籤
      And 使用者同時修改了會員標籤和互動標籤
      When 使用者點擊「確認」按鈕
      Then 系統在單一事務中同時更新會員標籤和互動標籤
      And 若任一標籤更新失敗，則所有變更回滾
