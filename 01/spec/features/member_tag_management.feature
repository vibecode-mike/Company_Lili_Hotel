Feature: 會員標籤管理
  作為一位使用者
  當回覆會員訊息時，能即時查看會員喜好（標籤）並快速為會員新增或修改標籤
  以便即時更新會員資料來提升會員管理效率

  Rule: 會員標籤來源支援外部系統串接（CRM/PMS）

    Example: 外部系統串接的標籤來源為 CRM
      Given 會員「張三」從 CRM 系統獲得標籤「高消費客戶」
      When 使用者查看會員「張三」的標籤
      Then 系統顯示標籤「高消費客戶」，來源為「CRM」

    Example: 外部系統串接的標籤來源為 PMS
      Given 會員「李四」從 PMS 系統獲得標籤「商務房」
      When 使用者查看會員「李四」的標籤
      Then 系統顯示標籤「商務房」，來源為「PMS」

  Rule: 會員標籤來源支援問券蒐集模組

    Example: 問券蒐集的標籤來源
      Given 會員「王五」從問券系統獲得標籤「26-35 歲」
      When 使用者查看會員「王五」的標籤
      Then 系統顯示標籤「26-35 歲」，來源為「問券」

  Rule: 會員標籤來源支援後台自訂

    Example: 後台自訂的標籤來源
      Given 使用者為會員「趙六」手動新增標籤「VIP」
      When 使用者查看會員「趙六」的標籤
      Then 系統顯示標籤「VIP」，來源為「後台自訂」

  Rule: 滾動12個月的時間範圍計算採用從當前日期往前推算365天

    Example: 滾動12個月的計算基準日範例
      Given 今日為「2025/06/15」
      When 系統計算「過去 12 個月」的時間範圍
      Then 時間範圍為「2024/06/15 至 2025/06/15」
      And 計算公式為「current_date - 365 天至 current_date」
      And 系統每日自動更新標籤判定結果

  Rule: 外部系統串接標籤支援今年消費金額達指定門檻條件

    Example: 消費金額達指定門檻的標籤（滾動 12 個月計算）
      Given 會員「陳一」在過去 12 個月內的消費總額為「50,000 元」
      And 系統設定「高消費客戶」標籤門檻為「30,000 元」
      And 時間範圍定義為「從當前日期（current_date）往前推算 365 天」
      When 系統處理 PMS/CRM 串接資料
      Then 系統為會員「陳一」新增標籤「高消費客戶」

    Example: 消費金額未達門檻
      Given 會員「林二」在過去 12 個月內的消費總額為「15,000 元」
      And 系統設定「高消費客戶」標籤門檻為「30,000 元」
      And 時間範圍定義為「從當前日期（current_date）往前推算 365 天」
      When 系統處理 PMS/CRM 串接資料
      Then 系統不為會員「林二」新增標籤「高消費客戶」

  Rule: 外部系統串接標籤支援消費房型分類條件

    Example: 消費房型分類標籤
      Given 會員「孫七」從 PMS 系統的消費紀錄顯示房型為「雙人房」
      When 系統處理 PMS 串接資料
      Then 系統為會員「孫七」新增標籤「雙人房」

  Rule: 外部系統串接標籤支援訪問頻率條件

    Example: 訪問頻率達標的標籤（滾動 12 個月計算）
      Given 會員「黃三」在過去 12 個月內住宿「5 次」
      And 系統設定「常客」標籤門檻為「3 次以上」
      And 計算週期定義為「從當前日期（current_date）往前推算 365 天的住宿次數」
      When 系統處理 PMS 串接資料
      Then 系統為會員「黃三」新增標籤「常客」

    Example: 訪問頻率未達標
      Given 會員「周四」在過去 12 個月內住宿「1 次」
      And 系統設定「常客」標籤門檻為「3 次以上」
      And 計算週期定義為「從當前日期（current_date）往前推算 365 天的住宿次數」
      When 系統處理 PMS 串接資料
      Then 系統不為會員「周四」新增標籤「常客」

  Rule: 外部系統串接標籤支援上次互動時間條件

    Example: 沉睡會員標籤（基於主動互動時間）
      Given 會員「吳五」最後一次主動發送訊息的時間為「90 天前」
      And 系統設定「沉睡會員」標籤門檻為「超過 60 天未主動互動」
      And 互動行為定義為「僅會員主動發送訊息，被動接收推播或點擊按鈕不計入」
      When 系統處理會員標籤更新
      Then 系統為會員「吳五」新增標籤「沉睡會員」

    Example: 活躍會員（有主動互動）
      Given 會員「鄭六」最後一次主動發送訊息的時間為「10 天前」
      And 系統設定「沉睡會員」標籤門檻為「超過 60 天未主動互動」
      And 互動行為定義為「僅會員主動發送訊息，被動接收推播或點擊按鈕不計入」
      When 系統處理會員標籤更新
      Then 系統不為會員「鄭六」新增標籤「沉睡會員」

  Rule: 問券蒐集標籤支援性別比對

    Example: 問券蒐集性別標籤
      Given 問券系統回傳會員「周八」的性別為「2」（女）
      When 系統處理問券資料
      Then 系統為會員「周八」新增標籤「女」
      And 會員「周八」的 gender 欄位更新為「2」

    Example: 性別值域說明
      Given 系統的性別值域定義為「0=不透漏 / 1=男 / 2=女」
      When 問券系統回傳會員「李九」的性別為「1」（男）
      Then 系統為會員「李九」新增標籤「男」
      And 會員「李九」的 gender 欄位更新為「1」

    Example: 預設值為不透漏
      Given 會員「王十」尚未填寫性別資料
      When 系統建立會員「王十」的資料
      Then 會員「王十」的 gender 欄位預設為「0」（不透漏）

  Rule: 問券蒐集標籤支援年齡區間比對

    Example: 問券蒐集年齡區間標籤
      Given 問券系統回傳會員「吳九」的年齡為「22」
      When 系統處理問券資料
      Then 系統為會員「吳九」新增標籤「18-25 歲」

  Rule: 問券蒐集標籤支援地區比對（限制為台灣 22 縣市）

    Example: 問券蒐集地區標籤
      Given 問券系統回傳會員「鄭十」的居住地為「新北市」
      When 系統處理問券資料
      Then 系統為會員「鄭十」新增標籤「新北市」
      And 會員「鄭十」的 residence 欄位更新為「新北市」

    Example: 地區值域驗證
      Given 系統的地區值域限制為台灣 22 縣市標準名稱
      When 問券系統回傳會員「林十一」的居住地為「台北市」
      Then 系統驗證「台北市」在允許的值域範圍內
      And 系統為會員「林十一」新增標籤「台北市」

    Example: 地區值域完整列表
      Given 系統支援的地區值域包含
        | 直轄市 | 台北市、新北市、桃園市、台中市、台南市、高雄市 |
        | 市     | 基隆市、新竹市、嘉義市 |
        | 縣     | 新竹縣、苗栗縣、彰化縣、南投縣、雲林縣、嘉義縣、屏東縣、宜蘭縣、花蓮縣、台東縣、澎湖縣、金門縣、連江縣 |
      When 問券系統回傳會員的居住地
      Then 系統僅接受上述 22 個縣市名稱

    Example: 非標準地區名稱處理
      Given 問券系統回傳會員「王十二」的居住地為「台北」（非標準名稱）
      When 系統處理問券資料
      Then 系統拒絕該資料並提示「請選擇有效的縣市名稱」

  Rule: 問券蒐集標籤支援生日月份比對（從完整日期自動提取）

    Example: 問券蒐集生日月份標籤
      Given 問券系統回傳會員「王十一」的生日為「1995-09-15」
      When 系統處理問券資料
      Then 系統為會員「王十一」新增標籤「9月」
      And 會員「王十一」的 birthday 欄位更新為「1995-09-15」
      And 系統自動從完整日期提取月份「9」生成標籤

    Example: 生日月份標籤自動生成邏輯
      Given 會員「李十二」的生日為「1988-12-25」
      When 系統處理生日月份標籤
      Then 系統從 birthday 欄位提取月份「12」
      And 系統為會員「李十二」新增標籤「12月」

    Example: 未填寫生日則不產生月份標籤
      Given 會員「陳十三」未填寫生日資料（birthday 為 NULL）
      When 系統處理生日月份標籤
      Then 系統不為會員「陳十三」新增生日月份標籤

  Rule: 互動標籤來源支援訊息模板設定

    Example: 訊息模板設定的互動標籤
      Given 會員「張十二」點擊訊息模板「早鳥優惠」
      When 系統處理互動事件
      Then 系統為會員「張十二」新增互動標籤「早鳥優惠」

  Rule: 互動標籤來源支援會員互動模板（訊息圖文模板）

    Example: 訊息圖文模板的互動標籤
      Given 會員「李十三」點擊文字按鈕確認型模板
      When 系統處理互動事件
      Then 系統為會員「李十三」新增對應的互動標籤

  Rule: 互動標籤來源支援會員互動模板（問券模板）

    Example: 問券模板的互動標籤
      Given 會員「王十四」完成滿意度調查問券
      When 系統處理互動事件
      Then 系統為會員「王十四」新增互動標籤「滿意度調查」

  Rule: 查看會員詳細資料時，可新增後台自訂標籤

    Example: 新增後台自訂標籤
      Given 使用者正在查看會員「趙十五」的詳細資料
      When 使用者新增標籤「潛在客戶」
      Then 會員「趙十五」新增標籤「潛在客戶」

  Rule: 查看會員詳細資料時，可刪除後台自訂標籤

    Example: 刪除後台自訂標籤
      Given 會員「孫十六」擁有後台自訂標籤「測試標籤」
      And 使用者正在查看會員「孫十六」的詳細資料
      When 使用者刪除標籤「測試標籤」
      Then 會員「孫十六」的標籤「測試標籤」被刪除
