Feature: 標籤規則管理
  作為一位飯店管理員
  我希望能夠透過後台管理介面設定 CRM/PMS 標籤的自動生成規則
  以便依據飯店經營策略調整會員分群標準


  Rule: 支援刪除標籤規則

    Example: 刪除不再使用的標籤規則
      Given 系統中存在標籤規則「測試標籤」
      When 管理員刪除該規則
      Then 系統刪除該標籤規則記錄
      And 不影響已經生成的會員標籤（MemberTag 表中的標籤保留）

    Example: 搜尋標籤名稱
      Given 系統中存在標籤規則「高消費客戶」、「常客」、「沉睡會員」
      When 管理員在搜尋框輸入「消費」
      Then 系統顯示包含「消費」的標籤規則「高消費客戶」
      And 不顯示「常客」與「沉睡會員」

  Rule: 標籤規則支援排序

    Example: 依建立時間排序
      Given 系統中存在以下標籤規則
        | 標籤名稱   | 建立時間        |
        | 高消費客戶 | 2025/01/10 10:00 |
        | 常客       | 2025/01/15 14:00 |
      When 管理員選擇「依建立時間排序（由新到舊）」
      Then 系統依序顯示
        | 標籤名稱 |
        | 常客     |
        | 高消費客戶 |

    Example: 依更新時間排序
      Given 系統中存在以下標籤規則
        | 標籤名稱   | 更新時間        |
        | 高消費客戶 | 2025/01/20 09:00 |
        | 常客       | 2025/01/18 11:00 |
      When 管理員選擇「依更新時間排序（由新到舊）」
      Then 系統依序顯示
        | 標籤名稱   |
        | 高消費客戶 |
        | 常客       |

  Rule: 標籤規則採用手動執行策略，不自動執行

    Example: 建立標籤規則後不自動執行
      Given 管理員建立標籤規則「累積消費 >= 50000 元」→「VIP 會員」
      When 規則建立完成
      Then 系統儲存標籤規則至 TagRule 表
      And 系統不自動對所有會員執行此規則
      And 規則狀態顯示為「已建立，尚未執行」

    Example: 管理員手動執行標籤規則
      Given 系統中存在標籤規則「累積消費 >= 50000 元」→「VIP 會員」
      And 會員 A 的累積消費為 52000 元（符合條件）
      And 會員 B 的累積消費為 30000 元（不符合條件）
      When 管理員點擊「執行規則」按鈕
      Then 系統檢查所有會員並執行規則
      And 系統為會員 A 新增「VIP 會員」標籤
      And 系統不為會員 B 新增標籤
      And 系統更新 TagRule.last_executed_at 為當前時間
      And 系統顯示執行結果「已為 1 位會員貼上標籤」

    Example: 會員資料異動不觸發規則執行
      Given 系統中存在標籤規則「累積消費 >= 50000 元」→「VIP 會員」
      And 會員 A 的累積消費原為 48000 元
      When 會員 A 新增一筆消費記錄 5000 元（累積變為 53000 元）
      Then 系統儲存消費記錄至 ConsumptionRecord 表
      And 系統不自動檢查並執行標籤規則
      And 會員 A 的標籤不自動更新（需管理員手動執行規則）

    Example: 手動執行規則可查看執行歷史
      Given 標籤規則「VIP 會員」曾於「2025/01/15 10:00」執行過一次
      When 管理員查看該規則的執行歷史
      Then 系統顯示執行記錄
        | 執行時間         | 執行結果        |
        | 2025/01/15 10:00 | 已為 5 位會員貼上標籤 |

    Example: 啟用規則不觸發自動執行
      Given 系統中存在已停用的標籤規則「VIP 會員」
      When 管理員啟用該規則（設定 is_enabled = true）
      Then 系統更新規則狀態為「已啟用」
      And 系統不自動執行該規則
      And 需管理員手動點擊「執行規則」按鈕才會執行
