Feature: 標籤規則管理
  作為一位飯店管理員
  我希望能夠透過後台管理介面設定 CRM/PMS 標籤的自動生成規則
  以便依據飯店經營策略調整會員分群標準

  Rule: 支援查看所有標籤規則列表

    Example: 查看標籤規則總覽
      Given 系統中存在以下標籤規則
        | 標籤名稱   | 規則類型 | 門檻值 | 單位  | 計算週期 | 狀態 |
        | 高消費客戶 | 消費金額 | 30000  | NTD   | 365天    | 啟用 |
        | 常客       | 訪問頻率 | 3      | times | 365天    | 啟用 |
        | 沉睡會員   | 互動時間 | 60     | days  | -        | 啟用 |
      When 管理員開啟「標籤規則管理」頁面
      Then 系統顯示所有標籤規則列表
      And 顯示每個規則的詳細參數與狀態

  Rule: 支援新增消費金額類型的標籤規則

    Example: 新增「高消費客戶」標籤規則
      Given 管理員正在新增標籤規則
      When 管理員設定以下參數
        | 欄位     | 值         |
        | 標籤名稱 | 高消費客戶 |
        | 標籤來源 | PMS        |
        | 規則類型 | 消費金額   |
        | 門檻值   | 30000      |
        | 單位     | NTD        |
        | 計算週期 | 365        |
        | 運算子   | >=         |
      And 管理員點擊「儲存」
      Then 系統建立新的標籤規則
      And 系統儲存 rule_type 為「consumption_amount」
      And 系統儲存 threshold_value 為「30000」
      And 系統儲存 threshold_unit 為「NTD」
      And 系統儲存 period_days 為「365」
      And 系統儲存 condition_operator 為「>=」
      And 系統儲存 is_enabled 為「true」
      And 系統顯示「規則建立成功」訊息

  Rule: 支援新增訪問頻率類型的標籤規則

    Example: 新增「常客」標籤規則
      Given 管理員正在新增標籤規則
      When 管理員設定以下參數
        | 欄位     | 值       |
        | 標籤名稱 | 常客     |
        | 標籤來源 | PMS      |
        | 規則類型 | 訪問頻率 |
        | 門檻值   | 3        |
        | 單位     | times    |
        | 計算週期 | 365      |
        | 運算子   | >=       |
      And 管理員點擊「儲存」
      Then 系統建立新的標籤規則
      And 系統儲存 rule_type 為「visit_frequency」
      And 系統儲存 threshold_value 為「3」

  Rule: 支援新增互動時間類型的標籤規則

    Example: 新增「沉睡會員」標籤規則
      Given 管理員正在新增標籤規則
      When 管理員設定以下參數
        | 欄位     | 值       |
        | 標籤名稱 | 沉睡會員 |
        | 標籤來源 | CRM      |
        | 規則類型 | 互動時間 |
        | 門檻值   | 60       |
        | 單位     | days     |
        | 運算子   | >        |
      And 管理員點擊「儲存」
      Then 系統建立新的標籤規則
      And 系統儲存 rule_type 為「interaction_time」
      And 系統儲存 period_days 為「NULL」（互動時間不需要計算週期）

  Rule: 支援新增房型分類類型的標籤規則

    Example: 新增「雙人房」標籤規則
      Given 管理員正在新增標籤規則
      When 管理員設定以下參數
        | 欄位     | 值       |
        | 標籤名稱 | 雙人房   |
        | 標籤來源 | PMS      |
        | 規則類型 | 房型分類 |
      And 管理員點擊「儲存」
      Then 系統建立新的標籤規則
      And 系統儲存 rule_type 為「room_type」
      And 系統儲存 threshold_value 為「NULL」（房型分類不需要門檻值）
      And 系統儲存 threshold_unit 為「NULL」
      And 系統儲存 period_days 為「NULL」

  Rule: 支援編輯既有標籤規則

    Example: 調整「高消費客戶」門檻值
      Given 系統中存在標籤規則「高消費客戶」，門檻值為「30000 元」
      When 管理員編輯該規則並將門檻值修改為「50000 元」
      And 管理員點擊「儲存」
      Then 系統更新標籤規則
      And 系統儲存 threshold_value 為「50000」
      And 系統更新 updated_at 為當前時間
      And 下次標籤計算時使用新門檻值「50000 元」

    Example: 調整「常客」訪問頻率門檻
      Given 系統中存在標籤規則「常客」，門檻值為「3 次」
      When 管理員編輯該規則並將門檻值修改為「5 次」
      And 管理員點擊「儲存」
      Then 系統更新標籤規則
      And 系統儲存 threshold_value 為「5」
      And 下次標籤計算時使用新門檻值「5 次」

  Rule: 支援啟用/停用標籤規則

    Example: 暫時停用「沉睡會員」標籤規則
      Given 系統中存在標籤規則「沉睡會員」，is_enabled 為「true」
      When 管理員將該規則設定為「停用」
      Then 系統更新 is_enabled 為「false」
      And 系統更新 updated_at 為當前時間
      And 系統停止為會員自動生成「沉睡會員」標籤

    Example: 重新啟用「沉睡會員」標籤規則
      Given 系統中存在標籤規則「沉睡會員」，is_enabled 為「false」
      When 管理員將該規則設定為「啟用」
      Then 系統更新 is_enabled 為「true」
      And 系統恢復為會員自動生成「沉睡會員」標籤

  Rule: 支援刪除標籤規則

    Example: 刪除不再使用的標籤規則
      Given 系統中存在標籤規則「測試標籤」
      When 管理員刪除該規則
      Then 系統刪除該標籤規則記錄
      And 不影響已經生成的會員標籤（MemberTag 表中的標籤保留）

  Rule: 規則修改時顯示影響範圍預覽

    Example: 預覽門檻值調整的影響
      Given 標籤規則「高消費客戶」當前門檻為「30000 元」
      And 系統計算目前符合該規則的會員數為「120 人」
      When 管理員將門檻值調整為「50000 元」
      Then 系統即時計算並顯示「預計符合會員數：85 人」
      And 系統顯示變化幅度「減少 35 人（-29%）」

    Example: 預覽計算週期調整的影響
      Given 標籤規則「常客」當前計算週期為「365 天」，符合會員數為「85 人」
      When 管理員將計算週期調整為「180 天」（半年）
      Then 系統即時計算並顯示「預計符合會員數：62 人」
      And 系統顯示變化幅度「減少 23 人（-27%）」

  Rule: 規則參數驗證 - 門檻值必須為正數

    Example: 門檻值為負數時阻擋儲存
      Given 管理員正在新增標籤規則
      When 管理員設定門檻值為「-1000」
      And 管理員點擊「儲存」
      Then 系統顯示錯誤訊息「門檻值必須為正數」
      And 系統阻擋儲存操作

    Example: 門檻值為零時阻擋儲存
      Given 管理員正在編輯標籤規則
      When 管理員設定門檻值為「0」
      And 管理員點擊「儲存」
      Then 系統顯示錯誤訊息「門檻值必須大於 0」
      And 系統阻擋儲存操作

  Rule: 規則參數驗證 - 計算週期合理範圍檢查

    Example: 計算週期過長時顯示警告
      Given 管理員正在編輯標籤規則
      When 管理員設定計算週期為「1000 天」
      And 管理員點擊「儲存」
      Then 系統顯示警告訊息「計算週期建議不超過 730 天（2 年），過長的週期可能影響標籤準確性」
      And 系統允許儲存但記錄警告

    Example: 計算週期在合理範圍內
      Given 管理員正在編輯標籤規則
      When 管理員設定計算週期為「365 天」
      And 管理員點擊「儲存」
      Then 系統成功儲存規則
      And 不顯示警告訊息

  Rule: 標籤規則自動執行邏輯

    Example: 排程任務讀取規則並為會員生成標籤
      Given 系統中存在以下啟用的標籤規則
        | 標籤名稱   | 規則類型 | 門檻值 | 單位 | 計算週期 |
        | 高消費客戶 | 消費金額 | 30000  | NTD  | 365天    |
      And 會員「張三」在過去 365 天內的消費總額為「50000 元」
      When 排程任務執行標籤計算
      Then 系統為會員「張三」新增標籤「高消費客戶」
      And 系統在 MemberTag 表建立記錄，tag_source 為「PMS」

    Example: 停用的規則不執行
      Given 系統中存在標籤規則「沉睡會員」，is_enabled 為「false」
      And 會員「李四」符合該規則條件
      When 排程任務執行標籤計算
      Then 系統不為會員「李四」新增標籤「沉睡會員」

  Rule: 支援篩選與搜尋標籤規則

    Example: 依規則類型篩選
      Given 系統中存在以下標籤規則
        | 標籤名稱   | 規則類型 |
        | 高消費客戶 | 消費金額 |
        | 常客       | 訪問頻率 |
        | 沉睡會員   | 互動時間 |
      When 管理員選擇篩選條件「規則類型：消費金額」
      Then 系統僅顯示「高消費客戶」規則

    Example: 依狀態篩選
      Given 系統中存在以下標籤規則
        | 標籤名稱   | 狀態 |
        | 高消費客戶 | 啟用 |
        | 測試標籤   | 停用 |
      When 管理員選擇篩選條件「狀態：啟用」
      Then 系統僅顯示「高消費客戶」規則

    Example: 搜尋標籤名稱
      Given 系統中存在標籤規則「高消費客戶」、「常客」、「沉睡會員」
      When 管理員在搜尋框輸入「消費」
      Then 系統顯示包含「消費」的標籤規則「高消費客戶」
      And 不顯示「常客」與「沉睡會員」

  Rule: 標籤規則支援排序

    Example: 依建立時間排序
      Given 系統中存在以下標籤規則
        | 標籤名稱   | 建立時間        |
        | 高消費客戶 | 2025/01/10 10:00 |
        | 常客       | 2025/01/15 14:00 |
      When 管理員選擇「依建立時間排序（由新到舊）」
      Then 系統依序顯示
        | 標籤名稱 |
        | 常客     |
        | 高消費客戶 |

    Example: 依更新時間排序
      Given 系統中存在以下標籤規則
        | 標籤名稱   | 更新時間        |
        | 高消費客戶 | 2025/01/20 09:00 |
        | 常客       | 2025/01/18 11:00 |
      When 管理員選擇「依更新時間排序（由新到舊）」
      Then 系統依序顯示
        | 標籤名稱   |
        | 高消費客戶 |
        | 常客       |
