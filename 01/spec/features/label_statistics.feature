Feature: 標籤使用統計
  作為一位品牌管理者
  我希望可以在後台查看全品牌於不同節點互動時所產生的標籤資料統計
  以便下一步規劃跨活動的整體行銷策略

  Rule: 系統須在標籤總覽頁顯示會員標籤與互動標籤的觸發次數、觸發會員數、並記錄最近觸發時間

    Example: 查看標籤總覽頁的標籤統計資料
      Given 系統中存在以下標籤資料
        | tag_name | tag_type | trigger_count | trigger_member_count | last_triggered_at |
        | VIP      | 會員標籤 | 150           | 50                   | 2025/01/15 14:30  |
        | 雙十優惠 | 互動標籤 | 300           | 120                  | 2025/01/20 10:15  |
      When 品牌管理者查看標籤總覽頁
      Then 系統顯示以下標籤統計資料
        | tag_name | tag_type | trigger_count | trigger_member_count | last_triggered_at |
        | VIP      | 會員標籤 | 150           | 50                   | 2025/01/15 14:30  |
        | 雙十優惠 | 互動標籤 | 300           | 120                  | 2025/01/20 10:15  |

  Rule: 觸發次數累計所有不重複的觸發記錄，觸發會員數為不重複會員總數

    Example: 同一會員點擊不同訊息累計觸發次數
      Given 互動標籤「雙十優惠」的初始統計為：觸發次數 0，觸發會員數 0
      And 會員「張三」點擊訊息1（標籤：雙十優惠）
      And 會員「張三」點擊訊息2（標籤：雙十優惠）
      When 品牌管理者查看標籤「雙十優惠」的統計
      Then 觸發次數為 2（會員張三的兩次點擊分別記錄）
      And 觸發會員數為 1（會員張三僅計算一次）

    Example: 同一會員重複點擊相同訊息不累計
      Given 互動標籤「早鳥優惠」的初始統計為：觸發次數 0，觸發會員數 0
      And 會員「李四」點擊訊息1（標籤：早鳥優惠）
      And 會員「李四」再次點擊訊息1（標籤：早鳥優惠）
      When 品牌管理者查看標籤「早鳥優惠」的統計
      Then 觸發次數為 1（重複點擊相同訊息不增加，因 unique 索引阻擋）
      And 觸發會員數為 1

    Example: 多個會員點擊同一訊息累計統計
      Given 互動標籤「新春優惠」的初始統計為：觸發次數 0，觸發會員數 0
      And 會員「張三」點擊訊息1（標籤：新春優惠）
      And 會員「李四」點擊訊息1（標籤：新春優惠）
      And 會員「王五」點擊訊息1（標籤：新春優惠）
      When 品牌管理者查看標籤「新春優惠」的統計
      Then 觸發次數為 3（三個會員分別點擊）
      And 觸發會員數為 3（三個不重複會員）

    Example: 綜合情境統計
      Given 互動標籤「VIP專屬」的初始統計為：觸發次數 0，觸發會員數 0
      And 會員「張三」點擊訊息1（標籤：VIP專屬）
      And 會員「張三」點擊訊息2（標籤：VIP專屬）
      And 會員「李四」點擊訊息1（標籤：VIP專屬）
      And 會員「李四」再次點擊訊息1（標籤：VIP專屬）
      When 品牌管理者查看標籤「VIP專屬」的統計
      Then 觸發次數為 3（張三訊息1 + 張三訊息2 + 李四訊息1，李四重複點擊不計）
      And 觸發會員數為 2（張三 + 李四）

  Rule: 可依「觸發次數最多」進行標籤排序查看

    Example: 依觸發次數最多排序標籤
      Given 系統中存在以下標籤資料
        | tag_name   | trigger_count |
        | VIP        | 150           |
        | 雙十優惠   | 300           |
        | 早鳥優惠   | 80            |
      When 品牌管理者選擇「依觸發次數最多」排序
      Then 系統顯示以下排序後的標籤
        | tag_name   | trigger_count |
        | 雙十優惠   | 300           |
        | VIP        | 150           |
        | 早鳥優惠   | 80            |

  Rule: 可依「最近觸發時間」進行標籤排序查看

    Example: 依最近觸發時間排序標籤
      Given 系統中存在以下標籤資料
        | tag_name   | last_triggered_at |
        | VIP        | 2025/01/15 14:30  |
        | 雙十優惠   | 2025/01/20 10:15  |
        | 早鳥優惠   | 2025/01/10 08:00  |
      When 品牌管理者選擇「依最近觸發時間」排序
      Then 系統顯示以下排序後的標籤
        | tag_name   | last_triggered_at |
        | 雙十優惠   | 2025/01/20 10:15  |
        | VIP        | 2025/01/15 14:30  |
        | 早鳥優惠   | 2025/01/10 08:00  |

  Rule: 提供標籤互動趨勢折線圖（近 7 天）

    Example: 查看近 7 天標籤互動趨勢折線圖
      Given 系統中存在標籤「雙十優惠」，近 7 天的互動資料如下
        | date       | trigger_count | trigger_member_count |
        | 2025/01/14 | 20            | 15                   |
        | 2025/01/15 | 35            | 28                   |
        | 2025/01/16 | 50            | 42                   |
        | 2025/01/17 | 45            | 38                   |
        | 2025/01/18 | 30            | 25                   |
        | 2025/01/19 | 25            | 20                   |
        | 2025/01/20 | 40            | 35                   |
      When 品牌管理者查看標籤「雙十優惠」的近 7 天趨勢圖
      Then 系統顯示雙軸折線圖，左 Y 軸為觸發次數，右 Y 軸為觸發會員數

  Rule: 提供標籤互動趨勢折線圖（近 30 天）

    Example: 查看近 30 天標籤互動趨勢折線圖
      Given 系統中存在標籤「VIP」，近 30 天有互動資料
      When 品牌管理者查看標籤「VIP」的近 30 天趨勢圖
      Then 系統顯示雙軸折線圖，左 Y 軸為觸發次數，右 Y 軸為觸發會員數

  Rule: 提供標籤互動趨勢折線圖（近 90 天）

    Example: 查看近 90 天標籤互動趨勢折線圖
      Given 系統中存在標籤「早鳥優惠」，近 90 天有互動資料
      When 品牌管理者查看標籤「早鳥優惠」的近 90 天趨勢圖
      Then 系統顯示雙軸折線圖，左 Y 軸為觸發次數，右 Y 軸為觸發會員數

  Rule: 可編輯既有的標籤

    Example: 編輯標籤名稱
      Given 系統中存在標籤「VIP」
      When 品牌管理者將標籤「VIP」編輯為「VIP會員」
      Then 標籤名稱更新為「VIP會員」

  Rule: 編輯標籤時，每筆標籤不得超過 20 個字

    Example: 編輯標籤名稱超過 20 個字時操作失敗
      Given 系統中存在標籤「VIP」
      When 品牌管理者將標籤「VIP」編輯為「超過二十個中文字元的標籤名稱測試超過二十個中文字元的標籤名稱測試」
      Then 操作失敗

  Rule: 編輯標籤時，系統自動排除重複標籤

    Example: 編輯標籤名稱為已存在的標籤時操作失敗
      Given 系統中存在以下標籤
        | tag_name |
        | VIP      |
        | 雙十優惠 |
      When 品牌管理者將標籤「VIP」編輯為「雙十優惠」
      Then 操作失敗

  Rule: 可刪除既有的標籤

    Example: 刪除標籤時彈窗確認
      Given 系統中存在標籤「VIP」
      When 品牌管理者刪除標籤「VIP」
      Then 系統彈窗確認是否刪除

  Rule: 刪除標籤不可復原

    Example: 確認刪除標籤後無法復原
      Given 系統中存在標籤「VIP」
      And 品牌管理者刪除標籤「VIP」
      When 品牌管理者在彈窗確認刪除
      Then 標籤「VIP」被刪除
      And 系統中不存在標籤「VIP」

  Rule: 系統須支援搜尋標籤

    Example: 搜尋標籤名稱
      Given 系統中存在以下標籤
        | tag_name   |
        | VIP        |
        | 雙十優惠   |
        | 早鳥優惠   |
      When 品牌管理者搜尋標籤「優惠」
      Then 系統顯示以下標籤
        | tag_name   |
        | 雙十優惠   |
        | 早鳥優惠   |

  Rule: 互動後可即時貼標

    Example: 會員點擊訊息按鈕後即時貼標（追蹤跳轉機制，全部觸發模式）
      Given 系統中存在訊息「雙十優惠」包含互動標籤「雙十,檔期優惠」
      And 標籤觸發模式為「全部觸發」
      And 訊息中的按鈕連結指向追蹤跳轉 URL「/__track?cid=123&uid=U001&tag=雙十,檔期優惠&mode=all&to=https://hotel.com」
      When 會員「張三」點擊該按鈕
      Then 系統立即記錄互動明細到資料庫，為會員「張三」新增標籤「雙十」和「檔期優惠」
      And 系統更新匯總表，兩個標籤的 trigger_count 分別累加
      And 系統將會員「張三」重定向到目標網址「https://hotel.com」
      And 後台管理員刷新頁面時可立即看到會員「張三」的互動標籤

    Example: 會員點擊訊息按鈕後即時貼標（追蹤跳轉機制，僅主標籤模式）
      Given 系統中存在訊息「新春優惠」包含互動標籤「新春,年度優惠」
      And 標籤觸發模式為「僅主標籤」
      And 訊息中的按鈕連結指向追蹤跳轉 URL「/__track?cid=456&uid=U002&tag=新春,年度優惠&mode=primary&to=https://hotel.com」
      When 會員「李四」點擊該按鈕
      Then 系統立即記錄互動明細到資料庫，僅為會員「李四」新增標籤「新春」
      And 系統不記錄標籤「年度優惠」
      And 系統將會員「李四」重定向到目標網址「https://hotel.com」
