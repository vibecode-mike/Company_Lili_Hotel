Feature: 會員管理
  作為一位行銷人員
  我希望系統能夠整合 LINE 官方帳號的會員，並抓取會員的基本資料、互動紀錄
  以便掌握會員資訊，能規劃不同推播訊息來提升會員的忠誠度

  Rule: LINE 會員頭像儲存機制：儲存 LINE CDN URL

    Example: 會員首次加入時取得並儲存頭像 URL
      Given 會員「張小明」透過 LINE 官方帳號加入
      And LINE API 回傳該會員的頭像 URL 為「https://profile.line-scdn.net/xxxxx」
      When 系統建立會員資料
      Then 系統儲存頭像 URL「https://profile.line-scdn.net/xxxxx」至 line_picture_url 欄位
      And 前端顯示時直接載入該 CDN URL

    Example: 會員已有頭像 URL 則不重複呼叫 LINE API
      Given 會員「張小明」的 line_picture_url 為「https://profile.line-scdn.net/xxxxx」
      When 系統檢查會員資料
      Then 系統不呼叫 LINE API
      And 直接使用資料庫中的頭像 URL

    Example: 會員頭像 URL 為空時補抓取
      Given 會員「張小明」的 line_picture_url 為空值
      When 系統檢查會員資料
      Then 系統呼叫 LINE Profile API 取得頭像 URL
      And 更新 line_picture_url 欄位

    Example: 前端顯示會員頭像時載入 LINE CDN URL
      Given 會員「張小明」的 line_picture_url 為「https://profile.line-scdn.net/xxxxx」
      When 前端顯示會員清單或會員詳細資料
      Then 前端使用 <img src="https://profile.line-scdn.net/xxxxx"> 載入頭像
      And 若 URL 失效則顯示預設頭像

  Rule: 以清單形式顯示會員清單，包含 LINE 會員頭像＋名稱

    Example: 查看會員清單顯示 LINE 會員頭像與名稱
      Given 系統中存在以下會員
        | member_id | line_avatar                              | line_name |
        | M001      | https://profile.line-scdn.net/xxxxx      | 張小明    |
        | M002      | https://profile.line-scdn.net/yyyyy      | 李小華    |
      When 行銷人員查看會員清單
      Then 系統顯示以下會員資料
        | member_id | line_avatar                              | line_name |
        | M001      | https://profile.line-scdn.net/xxxxx      | 張小明    |
        | M002      | https://profile.line-scdn.net/yyyyy      | 李小華    |

    Example: 會員清單顯示無頭像的會員
      Given 系統中存在會員「王小明」，line_picture_url 為空值
      When 行銷人員查看會員清單
      Then 系統顯示該會員使用預設頭像
      And 系統顯示會員 LINE 名稱「王小明」

    Example: 會員清單頭像 CDN 載入失敗顯示預設頭像
      Given 系統中存在會員「李四」，line_picture_url 為「https://profile.line-scdn.net/zzzzz」
      And LINE CDN 頭像 URL 已失效
      When 行銷人員查看會員清單
      Then 系統嘗試載入頭像失敗後顯示預設頭像
      And 系統顯示會員 LINE 名稱「李四」

  Rule: 以清單形式顯示會員清單，包含姓名

    Example: 查看會員清單顯示姓名
      Given 系統中存在會員「張小明」，姓名為「張三」
      When 行銷人員查看會員清單
      Then 系統顯示該會員姓名「張三」

    Example: 會員清單顯示多位會員姓名
      Given 系統中存在以下會員
        | member_id | line_name | name   |
        | M001      | 張小明    | 張三   |
        | M002      | 李小華    | 李四   |
        | M003      | 王大寶    | 王小明 |
      When 行銷人員查看會員清單
      Then 系統顯示所有會員姓名「張三」「李四」「王小明」

    Example: 會員清單顯示姓名為空的會員
      Given 系統中存在會員「趙小美」，姓名欄位為空值
      When 行銷人員查看會員清單
      Then 系統顯示該會員姓名欄位為空白
      And 僅顯示會員 LINE 名稱「趙小美」

  Rule: 以清單形式顯示會員清單，包含電子信箱

    Example: 查看會員清單顯示電子信箱
      Given 系統中存在會員「張三」，電子信箱為「zhang@example.com」
      When 行銷人員查看會員清單
      Then 系統顯示該會員電子信箱「zhang@example.com」

    Example: 會員清單顯示無電子信箱的會員
      Given 系統中存在會員「李四」，電子信箱為空值
      When 行銷人員查看會員清單
      Then 系統顯示該會員電子信箱欄位為空白

    Example: 會員清單顯示多種電子信箱格式
      Given 系統中存在以下會員
        | name   | email               |
        | 張三   | zhang@example.com   |
        | 李四   | li.si@company.co.tw |
        | 王小明 | wang123@gmail.com   |
      When 行銷人員查看會員清單
      Then 系統顯示所有會員電子信箱

  Rule: 以清單形式顯示會員清單，包含手機號碼

    Example: 查看會員清單顯示手機號碼
      Given 系統中存在會員「張三」，手機號碼為「0912345678」
      When 行銷人員查看會員清單
      Then 系統顯示該會員手機號碼「0912345678」

    Example: 會員清單顯示多種手機號碼格式
      Given 系統中存在以下會員
        | name   | phone      |
        | 張三   | 0912345678 |
        | 李四   | 0923456789 |
        | 王小明 | 0987654321 |
      When 行銷人員查看會員清單
      Then 系統顯示所有會員手機號碼

    Example: 會員清單顯示無手機號碼的會員
      Given 系統中存在會員「趙六」，手機號碼為空值
      When 行銷人員查看會員清單
      Then 系統顯示該會員手機號碼欄位為空白

  Rule: 以清單形式顯示會員清單，包含標籤（會員＋互動）

    Example: 查看會員清單顯示標籤
      Given 系統中存在會員「張三」，擁有以下標籤
        | tag_name | tag_type |
        | VIP      | 會員標籤 |
        | 雙十優惠 | 互動標籤 |
      When 行銷人員查看會員清單
      Then 系統顯示該會員標籤
        | tag_name | tag_type |
        | VIP      | 會員標籤 |
        | 雙十優惠 | 互動標籤 |

    Example: 會員清單顯示無標籤的會員
      Given 系統中存在會員「李四」，無任何標籤
      When 行銷人員查看會員清單
      Then 系統顯示該會員標籤欄位為空白

    Example: 會員清單顯示多個標籤的會員
      Given 系統中存在會員「王小明」，擁有以下標籤
        | tag_name   | tag_type |
        | VIP        | 會員標籤 |
        | 新客戶     | 會員標籤 |
        | 春節優惠   | 互動標籤 |
        | 生日禮     | 互動標籤 |
        | 問卷已填寫 | 互動標籤 |
      When 行銷人員查看會員清單
      Then 系統顯示該會員全部 5 個標籤

  Rule: 以清單形式顯示會員清單，包含建立時間

    Example: 查看會員清單顯示建立時間
      Given 系統中存在會員「張三」，建立時間為「2025/01/01 10:00」
      When 行銷人員查看會員清單
      Then 系統顯示該會員建立時間「2025/01/01 10:00」

    Example: 會員清單按建立時間排序
      Given 系統中存在以下會員
        | name   | created_at       |
        | 張三   | 2025/01/01 10:00 |
        | 李四   | 2025/01/05 14:30 |
        | 王小明 | 2025/01/03 09:15 |
      When 行銷人員查看會員清單並按建立時間降序排序
      Then 系統顯示會員順序為「李四」「王小明」「張三」

    Example: 會員清單顯示建立時間距今天數
      Given 系統中存在會員「張三」，建立時間為「2025/01/01 10:00」
      And 當前日期為「2025/01/25」
      When 行銷人員查看會員清單
      Then 系統顯示該會員建立時間「2025/01/01 10:00」
      And 系統顯示「加入已 24 天」

  Rule: 以清單形式顯示會員清單，包含最後回覆日期

    Example: 查看會員清單顯示最後回覆日期
      Given 系統中存在會員「張三」，最後回覆日期為「2025/01/20 15:30」
      When 行銷人員查看會員清單
      Then 系統顯示該會員最後回覆日期「2025/01/20 15:30」

    Example: 會員清單顯示從未回覆的會員
      Given 系統中存在會員「李四」，從未回覆訊息
      When 行銷人員查看會員清單
      Then 系統顯示該會員最後回覆日期為空白或「未回覆」

    Example: 會員清單按最後回覆日期排序
      Given 系統中存在以下會員
        | name   | last_reply_date  |
        | 張三   | 2025/01/20 15:30 |
        | 李四   | 2025/01/22 10:15 |
        | 王小明 | 2025/01/18 09:45 |
      When 行銷人員查看會員清單並按最後回覆日期降序排序
      Then 系統顯示會員順序為「李四」「張三」「王小明」

  Rule: 支援批次匯入會員資料（CSV 與 Excel 格式）

    Example: 下載批次匯入範本檔案
      Given 行銷人員需要批次匯入會員資料
      When 行銷人員點擊「下載匯入範本」
      Then 系統提供 CSV 與 Excel 兩種格式範本下載
      And 範本包含必填欄位說明（LINE UID、姓名、電子信箱、手機號碼等）

    Example: 上傳 CSV 格式批次匯入會員
      Given 行銷人員已準備好會員資料 CSV 檔案
      When 行銷人員上傳 CSV 檔案
      Then 系統驗證檔案格式與必填欄位
      And 系統批次建立會員資料
      And 系統顯示匯入結果「成功 50 筆 / 失敗 5 筆」

    Example: 上傳 Excel 格式批次匯入會員
      Given 行銷人員已準備好會員資料 Excel 檔案（.xlsx）
      When 行銷人員上傳 Excel 檔案
      Then 系統驗證檔案格式與必填欄位
      And 系統批次建立會員資料
      And 系統顯示匯入結果「成功 50 筆 / 失敗 5 筆」

    Example: 重複資料處理（依 LINE UID 判斷）
      Given 系統中已存在 LINE UID 為「U1234567890abcdef」的會員
      When 行銷人員上傳的批次匯入檔案中包含相同 LINE UID
      Then 系統跳過該筆重複資料
      And 系統在匯入報告中標註「重複跳過」

    Example: 批次匯入驗證錯誤處理
      Given 行銷人員上傳 CSV 檔案包含以下資料
        | line_uid         | name | email           | phone      |
        | U1234567890abcd  | 張三 | zhang@email.com | 0912345678 |
        | U9999999999aaaa  | 李四 | invalid-email   | 1234567890 |
        | U5555555555bbbb  | 王五 | wang@email.com  | 0923456789 |
      When 系統驗證批次匯入資料
      Then 系統拒絕第 2 筆資料（email 格式錯誤，phone 格式錯誤）
      And 系統成功匯入第 1 筆與第 3 筆
      And 系統顯示匯入結果「成功 2 筆 / 失敗 1 筆」
      And 系統提供錯誤明細「第 2 筆：email 格式錯誤、phone 格式錯誤」

    Example: 批次匯入空檔案處理
      Given 行銷人員上傳空白的 CSV 檔案（無資料列）
      When 系統驗證批次匯入檔案
      Then 系統顯示錯誤訊息「檔案無有效資料，請確認檔案內容」
      And 拒絕匯入

  Rule: 點擊「查看」動作，可查看會員詳細資料，包含 LINE 會員頭像＋名稱

    Example: 查看會員詳細資料顯示 LINE 頭像與名稱
      Given 系統中存在會員「張三」
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員「張三」的 LINE 會員頭像與名稱

    Example: 查看會員詳細資料顯示 LINE 頭像但無 LINE 名稱
      Given 系統中存在會員「李四」，LINE UID 為「U1234567890abcdef」
      And LINE 名稱為空值
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員 LINE 頭像
      And 系統顯示「未提供 LINE 名稱」

    Example: 查看會員詳細資料 LINE 頭像載入失敗
      Given 系統中存在會員「王小明」，line_picture_url 為「https://profile.line-scdn.net/invalid」
      And LINE CDN 頭像 URL 已失效
      When 行銷人員點擊「查看」動作
      Then 系統顯示預設頭像
      And 系統顯示會員 LINE 名稱「王小明」

  Rule: 點擊「查看」動作，可查看會員詳細資料，包含姓名

    Example: 查看會員詳細資料顯示姓名
      Given 系統中存在會員「張三」
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員姓名「張三」

    Example: 查看會員詳細資料姓名為空
      Given 系統中存在會員「趙六」，姓名欄位為空值
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員姓名欄位為空白或「未填寫」

    Example: 查看會員詳細資料顯示中英文姓名
      Given 系統中存在會員「John Smith」，姓名為「約翰·史密斯」
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員姓名「約翰·史密斯」

  Rule: 點擊「查看」動作，可查看會員詳細資料，包含性別

    Example: 查看會員詳細資料顯示性別
      Given 系統中存在會員「張三」，性別為「男」
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員性別「男」

    Example: 查看會員詳細資料顯示女性別
      Given 系統中存在會員「李小華」，性別為「女」
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員性別「女」

    Example: 查看會員詳細資料性別未填寫
      Given 系統中存在會員「王小明」，性別為空值
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員性別欄位為空白或「未填寫」

  Rule: 點擊「查看」動作，可查看會員詳細資料，包含生日

    Example: 查看會員詳細資料顯示生日
      Given 系統中存在會員「張三」，生日為「1990/08/15」
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員生日「1990/08/15」

    Example: 查看會員詳細資料顯示生日並計算年齡
      Given 系統中存在會員「李四」，生日為「1985/03/20」
      And 當前日期為「2025/01/25」
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員生日「1985/03/20」
      And 系統顯示會員年齡「39 歲」

    Example: 查看會員詳細資料生日為空
      Given 系統中存在會員「王五」，生日為空值
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員生日欄位為空白或「未填寫」

  Rule: 點擊「查看」動作，可查看會員詳細資料，包含電子信箱

    Example: 查看會員詳細資料顯示電子信箱
      Given 系統中存在會員「張三」，電子信箱為「zhang@example.com」
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員電子信箱「zhang@example.com」

    Example: 查看會員詳細資料電子信箱為空
      Given 系統中存在會員「李四」，電子信箱為空值
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員電子信箱欄位為空白或「未填寫」

    Example: 查看會員詳細資料顯示多種電子信箱格式
      Given 系統中存在會員「王小明」，電子信箱為「wang.xiao-ming_123@company.co.tw」
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員電子信箱「wang.xiao-ming_123@company.co.tw」

  Rule: 點擊「查看」動作，可查看會員詳細資料，包含手機號碼

    Example: 查看會員詳細資料顯示手機號碼
      Given 系統中存在會員「張三」，手機號碼為「0912345678」
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員手機號碼「0912345678」

    Example: 查看會員詳細資料手機號碼為空
      Given 系統中存在會員「李四」，手機號碼為空值
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員手機號碼欄位為空白或「未填寫」

    Example: 查看會員詳細資料顯示國際手機號碼格式
      Given 系統中存在會員「John Smith」，手機號碼為「+886-912-345-678」
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員手機號碼「+886-912-345-678」

  Rule: 點擊「查看」動作，可查看會員詳細資料，包含身分證/護照號碼（唯一值），前端預設顯示遮罩格式

    Example: 查看會員詳細資料預設顯示身分證號碼遮罩
      Given 系統中存在會員「張三」，身分證號碼為「A123456789」
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員身分證號碼「A12****789」

    Example: 查看會員詳細資料預設顯示護照號碼遮罩
      Given 系統中存在會員「李四」，護照號碼為「P123456789」
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員護照號碼「P12****789」

    Example: 查看會員詳細資料身分證號碼為空
      Given 系統中存在會員「王五」，身分證號碼為空值
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員身分證號碼欄位為空白或「未填寫」

  Rule: 身分證號碼遮罩可手動解除查看完整號碼

    Example: 手動解除遮罩顯示完整身分證號碼
      Given 系統中存在會員「張三」，身分證號碼為「A123456789」
      And 行銷人員點擊「查看」動作
      And 系統顯示會員身分證號碼「A12****789」
      When 行銷人員點擊「顯示完整號碼」按鈕
      Then 系統顯示會員身分證號碼「A123456789」

    Example: 再次點擊按鈕重新遮罩號碼
      Given 系統中存在會員「張三」，身分證號碼為「A123456789」
      And 行銷人員已解除遮罩，顯示完整號碼「A123456789」
      When 行銷人員點擊「隱藏號碼」按鈕
      Then 系統重新顯示會員身分證號碼「A12****789」

    Example: 解除護照號碼遮罩顯示完整號碼
      Given 系統中存在會員「李四」，護照號碼為「P123456789」
      And 行銷人員點擊「查看」動作
      And 系統顯示會員護照號碼「P12****789」
      When 行銷人員點擊「顯示完整號碼」按鈕
      Then 系統顯示會員護照號碼「P123456789」

  Rule: 點擊「查看」動作，可查看會員詳細資料，包含居住地

    Example: 查看會員詳細資料顯示居住地
      Given 系統中存在會員「張三」，居住地為「台北市」
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員居住地「台北市」

    Example: 查看會員詳細資料顯示完整居住地
      Given 系統中存在會員「李四」，居住地為「新北市板橋區文化路一段 188 號」
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員居住地「新北市板橋區文化路一段 188 號」

    Example: 查看會員詳細資料居住地為空
      Given 系統中存在會員「王五」，居住地為空值
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員居住地欄位為空白或「未填寫」

  Rule: 點擊「查看」動作，可查看會員詳細資料，包含加入來源

    Example: 查看會員詳細資料顯示加入來源
      Given 系統中存在會員「張三」，加入來源為「LINE」
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員加入來源「LINE」

    Example: 查看會員詳細資料顯示其他加入來源
      Given 系統中存在會員「李四」，加入來源為「官網註冊」
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員加入來源「官網註冊」

    Example: 查看會員詳細資料顯示批次匯入來源
      Given 系統中存在會員「王小明」，加入來源為「批次匯入」
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員加入來源「批次匯入」

  Rule: 點擊「查看」動作，可查看會員詳細資料，包含建立時間

    Example: 查看會員詳細資料顯示建立時間
      Given 系統中存在會員「張三」，建立時間為「2025-01-01 10:00」
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員建立時間「2025-01-01 10:00」

    Example: 查看會員詳細資料顯示建立時間並計算天數
      Given 系統中存在會員「李四」，建立時間為「2024-12-01 10:00」
      And 當前日期為「2025-01-25」
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員建立時間「2024-12-01 10:00」
      And 系統顯示「加入已 55 天」

    Example: 查看會員詳細資料顯示今日建立的會員
      Given 系統中存在會員「王小明」，建立時間為「2025-01-25 14:30」
      And 當前日期為「2025-01-25」
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員建立時間「2025-01-25 14:30」
      And 系統顯示「今日加入」

    Example: 查看會員詳細資料建立時間缺失時顯示預設文字
      Given 系統中存在會員「林小安」，建立時間為空值
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員建立時間「未知」

  Rule: 點擊「查看」動作，可查看會員詳細資料，包含最後回覆日期

    Example: 查看會員詳細資料顯示最後回覆日期
      Given 系統中存在會員「張三」，最後回覆日期為「2025-01-20 15:30」
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員最後回覆日期「2025-01-20 15:30」

    Example: 查看會員詳細資料顯示從未回覆的會員
      Given 系統中存在會員「李四」，從未回覆訊息
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員最後回覆日期「未知」

    Example: 查看會員詳細資料顯示最後回覆距今天數
      Given 系統中存在會員「王小明」，最後回覆日期為「2025-01-10 14:30」
      And 當前日期為「2025-01-25」
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員最後回覆日期「2025-01-10 14:30」
      And 系統顯示「15 天未回覆」

    Example: 查看會員詳細資料顯示其它欄位來源的最近互動時間
      Given 系統中存在會員「陳大海」，last_interaction_at 為「2025-02-01 09:00」
      And 該會員尚未有聊天訊息資料
      When 行銷人員點擊「查看」動作
      Then 系統仍顯示會員最後回覆日期「2025-02-01 09:00」

  Rule: 點擊「查看」動作，可查看會員詳細資料，包含 LINE UID

    Example: 查看會員詳細資料顯示 LINE UID
      Given 系統中存在會員「張三」，LINE UID 為「U1234567890abcdef」
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員 LINE UID「U1234567890abcdef」

    Example: 查看會員詳細資料顯示 LINE UID 完整格式
      Given 系統中存在會員「李四」，LINE UID 為「Uabcdef1234567890abcdef1234567890」
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員 LINE UID「Uabcdef1234567890abcdef1234567890」

    Example: 查看會員詳細資料 LINE UID 為空
      Given 系統中存在會員「王五」，LINE UID 為空值
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員 LINE UID 欄位為空白或「未綁定 LINE」

  Rule: 點擊「查看」動作，可查看會員詳細資料，包含標籤（會員＋互動）

    Example: 查看會員詳細資料顯示標籤
      Given 系統中存在會員「張三」，擁有以下標籤
        | tag_name | tag_type |
        | VIP      | 會員標籤 |
        | 雙十優惠 | 互動標籤 |
      When 行銷人員點擊「查看」動作
      Then 系統顯示該會員標籤
        | tag_name | tag_type |
        | VIP      | 會員標籤 |
        | 雙十優惠 | 互動標籤 |

    Example: 查看會員詳細資料顯示無標籤的會員
      Given 系統中存在會員「李四」，無任何標籤
      When 行銷人員點擊「查看」動作
      Then 系統顯示該會員標籤欄位為空白或「無標籤」

    Example: 查看會員詳細資料顯示多標籤分類
      Given 系統中存在會員「王小明」，擁有以下標籤
        | tag_name   | tag_type |
        | VIP        | 會員標籤 |
        | 新客戶     | 會員標籤 |
        | 春節優惠   | 互動標籤 |
        | 問卷已填寫 | 互動標籤 |
      When 行銷人員點擊「查看」動作
      Then 系統顯示該會員會員標籤「VIP」「新客戶」
      And 系統顯示該會員互動標籤「春節優惠」「問卷已填寫」

  Rule: 會員詳細資料需註記會員 ID 為唯一值

    Example: 查看會員詳細資料顯示唯一會員 ID
      Given 系統中存在會員「張三」，會員 ID 為「M001」
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員 ID「M001」

    Example: 會員 ID 唯一性驗證
      Given 系統中已存在會員 ID 為「M001」的會員
      When 系統嘗試建立另一個會員 ID 為「M001」的會員
      Then 系統拒絕建立並顯示錯誤訊息「會員 ID 已存在」

    Example: 查看會員詳細資料會員 ID 格式
      Given 系統中存在會員「李四」，會員 ID 為「M999999」
      When 行銷人員點擊「查看」動作
      Then 系統顯示會員 ID「M999999」

  Rule: 點擊「聊天」動作，可進入與該會員的一對一聊天訊息紀錄

    Example: 點擊聊天動作跳轉至聊天頁面
      Given 系統中存在會員「張三」，會員 ID 為「M001」
      When 行銷人員在會員清單中點擊會員「張三」的「聊天」按鈕
      Then 系統跳轉至該會員的一對一聊天訊息頁面
      And 當前頁面被取代為聊天訊息介面
      And 系統顯示與會員「張三」的所有歷史訊息紀錄

    Example: 點擊聊天動作顯示無訊息紀錄的會員
      Given 系統中存在會員「李四」，會員 ID 為「M002」
      And 該會員從未發送或接收過訊息
      When 行銷人員在會員清單中點擊會員「李四」的「聊天」按鈕
      Then 系統跳轉至該會員的一對一聊天訊息頁面
      And 系統顯示「尚無聊天紀錄」提示訊息
      And 提供可發送訊息的輸入框

    Example: 點擊聊天動作顯示最近 50 筆訊息
      Given 系統中存在會員「王小明」，會員 ID 為「M003」
      And 該會員有 150 筆歷史訊息紀錄
      When 行銷人員在會員清單中點擊會員「王小明」的「聊天」按鈕
      Then 系統跳轉至該會員的一對一聊天訊息頁面
      And 系統預設顯示最近 50 筆訊息
      And 提供向上滾動載入更多歷史訊息功能

  Rule: 若串接 CRM，可查看該會員消費紀錄（v0.2），包含消費時間

    Example: v0.1 所有管理員都可查看消費紀錄
      Given 系統版本為 v0.1
      And 系統已從 CRM 定期同步會員「張小明」的消費資料
      When 任何管理員點擊「串接 CRM」查看會員「張小明」的消費紀錄
      Then 系統允許查看
      And 系統顯示消費紀錄

    Example: 查看會員消費時間
      Given 系統已從 CRM 定期同步會員「張小明」的消費資料
      And 會員「張小明」有一筆消費時間為「2025/01/15 14:30」
      When 內部人員點擊「串接 CRM」查看會員「張小明」的消費紀錄
      Then 系統顯示該筆消費時間「2025/01/15 14:30」

    Example: 查看會員多筆消費時間
      Given 系統已從 CRM 定期同步會員「李四」的消費資料
      And 會員「李四」有以下消費紀錄
        | consumption_date | amount |
        | 2025/01/10       | 4500   |
        | 2025/01/15       | 8500   |
        | 2025/01/20       | 6000   |
      When 內部人員點擊「串接 CRM」查看會員「李四」的消費紀錄
      Then 系統顯示該會員全部消費時間並按時間降序排序

  Rule: 若串接 CRM，可查看該會員消費紀錄（v0.2），包含金額

    Example: 查看會員消費金額
      Given 系統已從 CRM 定期同步會員「張小明」的消費資料
      And 會員「張小明」有一筆消費金額為「8500」
      When 內部人員點擊「串接 CRM」查看會員「張小明」的消費紀錄
      Then 系統顯示該筆消費金額「NT$ 8,500」

    Example: 查看會員多筆消費金額
      Given 系統已從 CRM 定期同步會員「李四」的消費資料
      And 會員「李四」有以下消費紀錄
        | consumption_date | amount |
        | 2025/01/15       | 12000  |
        | 2025/01/18       | 8500   |
        | 2025/01/22       | 15000  |
      When 內部人員點擊「串接 CRM」查看會員「李四」的消費紀錄
      Then 系統顯示總消費金額「NT$ 35,500」
      And 系統顯示平均消費金額「NT$ 11,833」

  Rule: 若串接 CRM，可查看該會員消費紀錄（v0.2），包含房型或套餐

    Example: 查看會員房型套餐
      Given 系統已從 CRM 定期同步會員「張小明」的消費資料
      And 會員「張小明」有一筆房型為「豪華雙人房」
      When 內部人員點擊「串接 CRM」查看會員「張小明」的消費紀錄
      Then 系統顯示該筆房型「豪華雙人房」

    Example: 查看會員多筆房型套餐
      Given 系統已從 CRM 定期同步會員「王小明」的消費資料
      And 會員「王小明」有以下消費紀錄
        | consumption_date | room_type    | amount |
        | 2024/12/20       | 標準雙人房   | 3500   |
        | 2025/01/10       | 豪華雙人房   | 5500   |
        | 2025/01/20       | 總統套房     | 15000  |
      When 內部人員點擊「串接 CRM」查看會員「王小明」的消費紀錄
      Then 系統顯示全部 3 筆房型消費紀錄
      And 系統顯示會員偏好房型為「豪華雙人房」

    Example: 查看會員無房型套餐消費紀錄
      Given 系統已從 CRM 定期同步會員「趙六」的消費資料
      And 會員「趙六」無消費紀錄
      When 內部人員點擊「串接 CRM」查看會員「趙六」的消費紀錄
      Then 系統顯示「尚無消費紀錄」

  Rule: 若串接 CRM，可分析消費頻率

    Example: 分析會員消費頻率
      Given 系統已從 CRM 定期同步會員「張小明」的消費資料
      And 會員「張小明」在最近一年內有 5 筆消費紀錄
      When 內部人員查看會員「張小明」的消費分析
      Then 系統顯示該會員消費頻率「每 2.4 個月消費一次」

    Example: 分析高頻消費會員
      Given 系統已從 CRM 定期同步會員「李四」的消費資料
      And 會員「李四」在最近一年內有 12 筆消費紀錄
      When 內部人員查看會員「李四」的消費分析
      Then 系統顯示該會員消費頻率「每月消費一次」
      And 系統標註該會員為「高頻消費會員」

    Example: 分析無消費紀錄會員
      Given 系統已從 CRM 定期同步會員「王五」的消費資料
      And 會員「王五」在最近一年內無消費紀錄
      When 內部人員查看會員「王五」的消費分析
      Then 系統顯示該會員消費頻率「無消費紀錄」

  Rule: 消費紀錄資料透過定期同步機制從 CRM 系統批次匯入

    Example: 定期同步消費紀錄（每日凌晨 02:00 全量同步）
      Given CRM 系統中有會員的最新消費資料
      When 系統執行定期同步任務（每日凌晨 02:00）
      Then 系統批次匯入 CRM 消費資料至 ConsumptionRecord 資料表（全量覆蓋）
      And 系統記錄同步時間「2025/01/25 02:00」
      And 系統記錄同步筆數「1,250 筆」

    Example: 定期同步新增消費紀錄
      Given CRM 系統中有會員「張三」的新消費資料
        | consumption_date | amount | room_type  |
        | 2025/01/24       | 6500   | 商務單人房 |
      And 上次同步時間為「2025/01/24 02:00」
      When 系統執行定期同步任務（2025/01/25 02:00）
      Then 系統新增該筆消費紀錄至 ConsumptionRecord 資料表
      And 系統記錄同步時間「2025/01/25 02:00」

    Example: 定期同步更新消費紀錄
      Given CRM 系統中會員「李四」的消費金額從「5000」更新為「5500」
      And 上次同步時間為「2025/01/24 02:00」
      When 系統執行定期同步任務（2025/01/25 02:00）
      Then 系統更新該筆消費金額為「5500」
      And 系統記錄同步時間「2025/01/25 02:00」

  Rule: 消費紀錄查看權限控制（v0.2 功能）

    Example: v0.2 加入消費紀錄查看權限控制
      Given 系統版本為 v0.2
      And 系統已建立「consumption.view」權限
      And 管理員「admin001」擁有「consumption.view」權限
      And 管理員「admin002」不擁有「consumption.view」權限
      When 管理員「admin001」嘗試查看會員消費紀錄
      Then 系統允許查看
      When 管理員「admin002」嘗試查看會員消費紀錄
      Then 系統拒絕查看，顯示「您沒有查看消費紀錄的權限」

    Example: 同步失敗記錄日誌並次日重試
      Given CRM 系統連線失敗
      When 系統執行定期同步任務（2025/01/25 02:00）
      Then 同步失敗
      And 系統記錄失敗日誌「CRM 系統連線逾時」
      And 系統次日自動重試（2025/01/26 02:00）

    Example: 連續失敗超過 3 日系統告警
      Given 系統連續 3 日同步失敗
      When 系統執行第 4 次同步任務（2025/01/28 02:00）
      And 同步再次失敗
      Then 系統發送告警通知「CRM 同步連續失敗超過 3 日，請檢查系統狀態」

  Rule: 顯示會員的建立時間

    Example: 顯示會員建立時間
      Given 系統中存在會員「李四」，建立時間為「2025/01/05 12:00」
      When 行銷人員查看會員資料
      Then 系統顯示該會員建立時間「2025/01/05 12:00」

    Example: 顯示會員建立時間距今天數
      Given 系統中存在會員「張三」，建立時間為「2024/12/01 10:00」
      And 當前日期為「2025/01/25」
      When 行銷人員查看會員資料
      Then 系統顯示該會員建立時間「2024/12/01 10:00」
      And 系統顯示「加入已 55 天」

    Example: 顯示會員建立時間年份跨度
      Given 系統中存在會員「王小明」，建立時間為「2023/05/15 09:30」
      And 當前日期為「2025/01/25」
      When 行銷人員查看會員資料
      Then 系統顯示該會員建立時間「2023/05/15 09:30」
      And 系統顯示「加入已 1 年 8 個月」

  Rule: 顯示會員的最後回覆訊息日期

    Example: 顯示會員最後回覆訊息日期
      Given 系統中存在會員「李四」，最後回覆訊息日期為「2025/01/18 09:45」
      When 行銷人員查看會員資料
      Then 系統顯示該會員最後回覆訊息日期「2025/01/18 09:45」

    Example: 顯示會員最後回覆距今天數
      Given 系統中存在會員「王小明」，最後回覆訊息日期為「2025/01/10 14:30」
      And 當前日期為「2025/01/25」
      When 行銷人員查看會員資料
      Then 系統顯示該會員最後回覆訊息日期「2025/01/10 14:30」
      And 系統顯示「15 天未回覆」

    Example: 顯示從未回覆的會員
      Given 系統中存在會員「李五」，從未回覆訊息
      When 行銷人員查看會員資料
      Then 系統顯示該會員最後回覆訊息日期為空白
      And 系統顯示「從未回覆」

  Rule: 內部人員可新增備註，註記該會員的消費習慣與喜好

    Example: 新增會員備註
      Given 系統中存在會員「王五」
      When 內部人員為會員「王五」新增備註「偏好商務房型，常於週末入住」
      Then 系統記錄該會員備註「偏好商務房型，常於週末入住」

    Example: 編輯會員備註
      Given 系統中存在會員「張三」，備註為「偏好豪華房型」
      When 內部人員編輯備註為「偏好豪華房型，喜歡高樓層，對房間整潔度要求高」
      Then 系統更新該會員備註為「偏好豪華房型，喜歡高樓層，對房間整潔度要求高」

    Example: 查看會員備註歷史
      Given 系統中存在會員「李四」，備註曾被修改 3 次
      When 內部人員查看會員「李四」的備註歷史
      Then 系統顯示所有備註版本與修改時間
        | version | note_content                   | updated_at       | updated_by |
        | 1       | 首次入住，印象良好             | 2024/12/01 10:00 | admin001   |
        | 2       | 偏好商務房型                   | 2024/12/15 14:30 | admin002   |
        | 3       | 偏好商務房型，常於週末入住     | 2025/01/20 09:15 | admin001   |

    Example: 刪除會員備註
      Given 系統中存在會員「王小明」，備註為「測試備註」
      When 內部人員刪除該會員備註
      Then 系統清空該會員備註欄位
      And 系統保留備註刪除記錄於歷史中
