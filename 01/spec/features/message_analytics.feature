Feature: 訊息數據成效
  作為一位行銷數據人員
  我希望系統存取所有已發訊息的歷史成效數據
  以利分析用戶對內容與互動的偏好，來為下個季度做行銷的優化與調整

  Rule: 以清單形式顯示訊息發送清單

    Example: 訊息清單包含訊息標題
      Given 系統中存在訊息標題「雙人房優惠」
      When 行銷數據人員查看訊息發送清單
      Then 系統顯示訊息標題「雙人房優惠」

    Example: 訊息清單顯示多筆訊息
      Given 系統中存在以下訊息
        | message_name | send_status |
        | 春節優惠     | 已發送      |
        | 會員日活動   | 排程發送    |
        | 新品上市     | 草稿        |
      When 行銷數據人員查看訊息發送清單
      Then 系統顯示所有 3 筆訊息
      And 訊息依建立時間倒序排列

    Example: 空白清單顯示提示訊息
      Given 系統中沒有任何訊息
      When 行銷數據人員查看訊息發送清單
      Then 系統顯示「目前沒有任何訊息」
      And 系統提供「建立新訊息」按鈕


  Rule: 以清單形式顯示訊息發送清單，包含傳送時間

    Example: 訊息清單顯示傳送時間
      Given 系統中存在訊息「週末優惠」，傳送時間為「2025/01/20 10:00」
      When 行銷數據人員查看訊息發送清單
      Then 系統顯示訊息「週末優惠」的傳送時間「2025/01/20 10:00」

    Example: 排程訊息顯示預計發送時間
      Given 系統中存在訊息「母親節預告」，發送狀態為「排程發送」
      And 排程發送時間為「2025/05/10 09:00」
      When 行銷數據人員查看訊息發送清單
      Then 系統顯示訊息「母親節預告」的傳送時間「2025/05/10 09:00」
      And 時間標籤顯示「預計發送」

    Example: 草稿訊息不顯示傳送時間
      Given 系統中存在訊息「測試草稿」，發送狀態為「草稿」
      And 該訊息尚未設定排程時間
      When 行銷數據人員查看訊息發送清單
      Then 系統顯示訊息「測試草稿」的傳送時間為「--」
      And 提示「尚未設定發送時間」

  Rule: 以清單形式顯示訊息發送清單，包含傳送人數

    Example: 訊息清單顯示傳送人數
      Given 系統中存在訊息「新春活動」，傳送人數為 500 人
      When 行銷數據人員查看訊息發送清單
      Then 系統顯示訊息「新春活動」的傳送人數「500」

    Example: 傳送人數為 0 時顯示提示
      Given 系統中存在訊息「測試訊息」，傳送人數為 0 人
      When 行銷數據人員查看訊息發送清單
      Then 系統顯示訊息「測試訊息」的傳送人數「0」
      And 顯示提示「無符合條件的會員」

    Example: 草稿狀態訊息不顯示傳送人數
      Given 系統中存在訊息「未發送草稿」，發送狀態為「草稿」
      When 行銷數據人員查看訊息發送清單
      Then 系統顯示訊息「未發送草稿」的傳送人數為「--」
      And 提示「尚未發送」

  Rule: 以清單形式顯示訊息發送清單，包含部分訊息內容

    Example: 訊息清單顯示部分訊息內容
      Given 系統中存在訊息「春節優惠」，訊息內容為「春節期間住宿享 8 折優惠，名額有限...」
      When 行銷數據人員查看訊息發送清單
      Then 系統顯示訊息「春節優惠」的部分內容

    Example: 長文字內容自動截斷並顯示省略號
      Given 系統中存在訊息「詳細介紹」
      And 訊息內容超過 100 字元「本飯店位於市中心，擁有絕佳地理位置，鄰近捷運站、商圈及景點，提供豪華客房、健身房、游泳池、商務中心等多項設施，並有專業服務團隊為您服務，讓您享受賓至如歸的住宿體驗...」
      When 行銷數據人員查看訊息發送清單
      Then 系統顯示前 100 字元「本飯店位於市中心，擁有絕佳地理位置，鄰近捷運站、商圈及景點，提供豪華客房、健身房、游泳池、商務中心等多項設施，並有專業服務團隊為您服務，讓您享受賓至如歸的住宿...」
      And 結尾顯示省略號「...」

    Example: 圖片訊息顯示圖片類型標籤
      Given 系統中存在訊息「春季美景」，訊息類型為「圖片」
      And 訊息沒有文字內容
      When 行銷數據人員查看訊息發送清單
      Then 系統顯示「[圖片訊息]」標籤
      And 不顯示文字內容

  Rule: 以清單形式顯示訊息發送清單，包含開啟次數（會員已讀訊息的不重複人數）

    Example: 訊息清單顯示開啟次數
      Given 系統中存在訊息「VIP 專屬」，已傳送給 500 位會員
      And 其中 320 位不重複會員已讀該訊息
      When 行銷數據人員查看訊息發送清單
      Then 系統顯示訊息「VIP 專屬」的開啟次數「320」
      And 開啟次數計算邏輯為「COUNT(DISTINCT member_id WHERE 已讀)」

    Example: 同一會員多次開啟僅計算一次
      Given 系統中存在訊息「週末優惠」
      And 會員「張三」開啟該訊息 3 次
      And 會員「李四」開啟該訊息 1 次
      When 系統計算開啟次數
      Then 開啟次數為「2」（不重複會員數）

    Example: 沒有會員開啟時顯示 0
      Given 系統中存在訊息「測試訊息」，已傳送給 100 位會員
      And 沒有會員開啟該訊息
      When 行銷數據人員查看訊息發送清單
      Then 系統顯示訊息「測試訊息」的開啟次數「0」
      And 開啟率顯示「0%」

  Rule: 以清單形式顯示訊息發送清單，包含點擊次數（點擊單一按鈕的不重複人數）

    Note: 點擊次數統計來源
      點擊數據從 ComponentInteractionLog 表動態計算，不作為 messages 表欄位儲存
      統計來源：/__track 路由記錄的 component_interaction_logs 資料
      計算邏輯：COUNT(DISTINCT line_id WHERE message_id = ? AND interaction_type = 'button_url')
      支援多維度統計：可按 template_id、campaign_id、interaction_tag_id 等維度聚合

    Example: 訊息清單顯示點擊次數
      Given 系統中存在訊息「早鳥優惠」，已傳送給 500 位會員
      And 其中 150 位不重複會員點擊了單一按鈕
      And 點擊記錄已存入 ComponentInteractionLog 表
      When 行銷數據人員查看訊息發送清單
      Then 系統從 ComponentInteractionLog 動態計算點擊次數
      And 系統顯示訊息「早鳥優惠」的點擊次數「150」
      And 點擊次數計算邏輯為「COUNT(DISTINCT line_id WHERE message_id = ? AND interaction_type = 'button_url')」

    Example: 同一會員多次點擊單一按鈕僅計算一次
      Given 系統中存在訊息「限時促銷」
      And 會員「王五」點擊該訊息的按鈕一 5 次
      And 會員「趙六」點擊該訊息的按鈕一 2 次
      When 系統計算該訊息點擊次數
      Then 訊息點擊次數為「2」（不重複會員數）

    Example: 會員開啟但未點擊不計入點擊次數
      Given 系統中存在訊息「新品上市」
      And 會員「孫七」已讀該訊息但未點擊任何按鈕
      When 系統計算點擊次數
      Then 該會員不計入點擊次數

  Rule: 系統須識別訊息發送狀態：排程發送

    Example: 訊息狀態為排程發送
      Given 系統中存在訊息「週年慶」，發送狀態為「排程發送」
      When 行銷數據人員查看訊息發送清單
      Then 系統顯示訊息「週年慶」的狀態為「排程發送」

    Example: 排程訊息顯示倒數時間提示
      Given 系統中存在訊息「限時活動」，發送狀態為「排程發送」
      And 排程發送時間為「2025/02/15 10:00」
      And 當前時間為「2025/02/14 10:00」
      When 行銷數據人員查看訊息發送清單
      Then 系統顯示狀態為「排程發送」
      And 顯示倒數提示「距離發送還有 1 天」

    Example: 排程時間已過但尚未執行的訊息標示異常
      Given 系統中存在訊息「逾期排程」，發送狀態為「排程發送」
      And 排程發送時間為「2025/02/01 10:00」
      And 當前時間為「2025/02/02 10:00」
      And 訊息尚未實際發送
      When 行銷數據人員查看訊息發送清單
      Then 系統顯示狀態為「排程異常」
      And 顯示警告訊息「排程時間已過，但訊息尚未發送」

  Rule: 排程發送狀態的訊息可編輯

    Example: 編輯排程發送的訊息
      Given 系統中存在訊息「夏日優惠」，發送狀態為「排程發送」
      When 行銷數據人員編輯訊息「夏日優惠」
      Then 系統允許編輯訊息「夏日優惠」

    Example: 編輯排程訊息的內容和時間
      Given 系統中存在訊息「會員日」，發送狀態為「排程發送」
      And 排程發送時間為「2025/03/01 10:00」
      And 訊息內容為「會員日特惠」
      When 行銷數據人員修改訊息內容為「會員日超值優惠」
      And 修改排程時間為「2025/03/02 14:00」
      And 點擊「儲存」
      Then 系統成功儲存修改
      And 系統顯示「訊息已更新」
      And 排程時間更新為「2025/03/02 14:00」

    Example: 編輯排程訊息時顯示警告提示
      Given 系統中存在訊息「重要通知」，發送狀態為「排程發送」
      And 排程發送時間為「2025/02/20 09:00」
      When 行銷數據人員點擊編輯按鈕
      Then 系統顯示提示「此訊息已排程，編輯後將影響預定發送內容」
      And 提供「確認編輯」和「取消」選項

  Rule: 排程發送狀態的訊息可取消排程

    Example: 取消排程訊息
      Given 系統中存在訊息「春節促銷」，發送狀態為「排程發送」
      And 排程發送時間為「2025/02/01 10:00」（UTC: 2025-02-01T02:00:00Z）
      When 行銷人員點擊「取消排程」按鈕
      Then 系統將 send_status 更新為「草稿」
      And 系統保留所有訊息資料（內容、排程時間、篩選條件、訊息模板、互動標籤等）
      And 系統顯示訊息「已取消排程，訊息已改為草稿狀態」

    Example: 取消後資料完整保留
      Given 系統中存在排程訊息「VIP 專屬優惠」
        | 欄位                   | 值                       |
        | message_content        | VIP 會員專屬優惠         |
        | scheduled_datetime_utc | 2025-02-01T02:00:00Z     |
        | target_filter          | {"include": ["VIP"]}     |
        | template_id            | template_123             |
      When 行銷人員取消排程
      Then 系統將 send_status 更新為「草稿」
      And 所有訊息資料保持不變
        | 欄位                   | 值                       |
        | message_content        | VIP 會員專屬優惠         |
        | scheduled_datetime_utc | 2025-02-01T02:00:00Z     |
        | target_filter          | {"include": ["VIP"]}     |
        | template_id            | template_123             |

    Example: 取消後可重新編輯並再次排程
      Given 訊息「限時優惠」已取消排程，send_status 為「草稿」
      When 行銷人員重新編輯該訊息
      And 行銷人員修改排程時間為「2025/02/05 10:00」（UTC: 2025-02-05T02:00:00Z）
      And 行銷人員點擊「發送」並選擇「排程發送」
      Then 系統將 send_status 更新為「排程發送」
      And 系統更新 scheduled_datetime_utc 為「2025-02-05T02:00:00Z」

  Rule: 已發送或草稿狀態的訊息無取消排程操作

    Example: 已發送的訊息無法取消排程
      Given 訊息「春節促銷」send_status 為「已發送」
      When 行銷人員查看該訊息
      Then 系統不顯示「取消排程」按鈕

    Example: 草稿狀態的訊息無需取消操作
      Given 訊息「草稿訊息」send_status 為「草稿」
      When 行銷人員查看該訊息
      Then 系統不顯示「取消排程」按鈕
      And 原因：草稿本身就不在排程狀態

    Example: 發送中的訊息無法取消排程
      Given 訊息「即時優惠」send_status 為「發送中」
      And 訊息正在透過 LINE API 批次發送
      When 行銷人員查看該訊息
      Then 系統不顯示「取消排程」按鈕
      And 系統顯示提示「訊息正在發送中，無法取消」

  Rule: 系統須識別訊息發送狀態：已發送

    Example: 訊息狀態為已發送
      Given 系統中存在訊息「母親節特惠」，發送狀態為「已發送」
      When 行銷數據人員查看訊息發送清單
      Then 系統顯示訊息「母親節特惠」的狀態為「已發送」

    Example: 已發送訊息顯示實際發送時間
      Given 系統中存在訊息「週年慶」，發送狀態為「已發送」
      And 訊息於「2025/01/25 10:30」完成發送
      When 行銷數據人員查看訊息發送清單
      Then 系統顯示狀態為「已發送」
      And 顯示發送時間「2025/01/25 10:30」
      And 時間標籤顯示「已發送」

    Example: 已發送訊息顯示成效數據
      Given 系統中存在訊息「限時優惠」，發送狀態為「已發送」
      And 傳送人數為 1000 人
      And 開啟次數為 650 人
      And 點擊次數為 320 人
      When 行銷數據人員查看訊息發送清單
      Then 系統顯示完整成效數據
      And 開啟率顯示「65%」
      And 點擊率顯示「32%」

  Rule: 已發送狀態的訊息不可編輯

    Example: 無法編輯已發送的訊息
      Given 系統中存在訊息「端午促銷」，發送狀態為「已發送」
      When 行銷數據人員嘗試編輯訊息「端午促銷」
      Then 操作失敗

    Example: 已發送訊息不顯示編輯按鈕
      Given 系統中存在訊息「新年快樂」，發送狀態為「已發送」
      When 行銷數據人員查看該訊息詳情
      Then 系統不顯示「編輯」按鈕
      And 系統顯示提示「已發送的訊息無法編輯」

    Example: 點擊已發送訊息時顯示唯讀模式
      Given 系統中存在訊息「中秋特惠」，發送狀態為「已發送」
      When 行銷數據人員點擊該訊息
      Then 系統以唯讀模式顯示訊息內容
      And 所有欄位不可編輯
      And 僅顯示「關閉」和「複製為新訊息」按鈕

  Rule: 系統須識別訊息發送狀態：草稿

    Example: 訊息狀態為草稿
      Given 系統中存在訊息「中秋活動」，發送狀態為「草稿」
      When 行銷數據人員查看訊息發送清單
      Then 系統顯示訊息「中秋活動」的狀態為「草稿」

    Example: 新建訊息預設為草稿狀態
      Given 行銷數據人員建立新訊息「測試訊息」
      And 尚未點擊發送或排程
      When 行銷數據人員儲存訊息
      Then 系統將 send_status 設定為「草稿」
      And 訊息出現在草稿清單中

    Example: 草稿訊息不顯示成效數據
      Given 系統中存在訊息「未發送草稿」，發送狀態為「草稿」
      When 行銷數據人員查看訊息發送清單
      Then 系統不顯示開啟次數和點擊次數
      And 傳送人數顯示為「--」
      And 狀態顯示「草稿」

  Rule: 草稿狀態的訊息可編輯

    Example: 編輯草稿訊息
      Given 系統中存在訊息「雙十活動」，發送狀態為「草稿」
      When 行銷數據人員編輯訊息「雙十活動」
      Then 系統允許編輯訊息「雙十活動」

    Example: 草稿訊息可修改所有欄位
      Given 系統中存在訊息「促銷草稿」，發送狀態為「草稿」
      When 行銷數據人員點擊編輯
      Then 系統允許修改訊息標題
      And 允許修改訊息內容
      And 允許修改目標受眾篩選條件
      And 允許修改排程時間
      And 允許修改訊息模板

    Example: 草稿訊息編輯後仍保持草稿狀態
      Given 系統中存在訊息「測試草稿」，發送狀態為「草稿」
      When 行銷數據人員修改訊息內容
      And 點擊「儲存」
      Then 系統成功儲存修改
      And send_status 仍為「草稿」
      And 系統顯示「草稿已更新」

  Rule: 系統須識別訊息發送狀態：發送失敗

    Example: 訊息發送失敗後自動返回至草稿
      Given 系統中存在訊息「聖誕優惠」，發送狀態由發送中轉為「草稿」
      When 系統接收到 LINE API 返回錯誤（如 401 Unauthorized 或 403 Forbidden）
      Then 系統將訊息「聖誕優惠」的狀態更新為「發送失敗」
      And 系統自動將該訊息返回至草稿列表，並顯示失敗訊息「訊息發送失敗」
      And 行銷人員於「訊息發送清單」中可看到該訊息狀態為「草稿」並可重新編輯進行發送

    Example: 發送失敗顯示詳細錯誤訊息
      Given 系統中存在訊息「VIP 優惠」，正在發送
      When LINE API 返回錯誤「403 Forbidden: Invalid channel access token」
      Then 系統將 send_status 更新為「草稿」
      And 系統記錄錯誤訊息「LINE API 憑證無效」
      And 系統顯示通知「訊息發送失敗：LINE API 憑證無效，請檢查設定」
      And 行銷人員可查看詳細錯誤日誌

    Example: 部分發送失敗的處理
      Given 系統中存在訊息「會員通知」，目標受眾 1000 人
      When 已成功發送給 800 人
      And 剩餘 200 人因 LINE API 限流錯誤「429 Too Many Requests」失敗
      Then 系統將 send_status 標記為「部分成功」
      And 實際傳送人數記錄為「800」
      And 系統顯示警告「訊息部分發送失敗：800/1000 人成功接收」
      And 提供「重試失敗部分」選項

  Rule: 支援依據訊息的傳送時間進行篩選

    Example: 依傳送時間篩選訊息
      Given 系統中存在以下訊息
        | message_name | send_time        |
        | 元旦優惠     | 2025/01/01 10:00 |
        | 春節優惠     | 2025/02/10 09:00 |
        | 清明促銷     | 2025/04/04 14:00 |
      When 行銷數據人員篩選傳送時間介於「2025/01/01」到「2025/02/28」
      Then 系統顯示以下訊息
        | message_name | send_time        |
        | 元旦優惠     | 2025/01/01 10:00 |
        | 春節優惠     | 2025/02/10 09:00 |

    Example: 時間範圍邊界值包含在篩選結果中
      Given 系統中存在以下訊息
        | message_name | send_time        |
        | 訊息A        | 2025/01/01 00:00 |
        | 訊息B        | 2025/01/15 12:00 |
        | 訊息C        | 2025/01/31 23:59 |
        | 訊息D        | 2025/02/01 00:00 |
      When 行銷數據人員篩選傳送時間介於「2025/01/01」到「2025/01/31」
      Then 系統顯示以下訊息
        | message_name | send_time        |
        | 訊息A        | 2025/01/01 00:00 |
        | 訊息B        | 2025/01/15 12:00 |
        | 訊息C        | 2025/01/31 23:59 |
      And 不包含訊息D

    Example: 時間篩選無結果時顯示提示
      Given 系統中存在以下訊息，發送時間均在 2025/01/01 之前
      When 行銷數據人員篩選傳送時間介於「2025/02/01」到「2025/02/28」
      Then 系統顯示「此時間範圍內沒有訊息」
      And 提供「清除篩選條件」選項

  Rule: 允許帶入起始時間搜索歷史訊息

    Example: 輸入起始時間篩選訊息
      Given 系統中存在以下訊息
        | message_name | send_time        |
        | 訊息A        | 2025/01/10 10:00 |
        | 訊息B        | 2025/01/20 09:00 |
        | 訊息C        | 2025/01/30 14:00 |
      When 行銷數據人員輸入起始時間「2025/01/20」
      Then 系統顯示以下訊息
        | message_name | send_time        |
        | 訊息B        | 2025/01/20 09:00 |
        | 訊息C        | 2025/01/30 14:00 |

    Example: 僅輸入起始時間時包含所有未來訊息
      Given 系統中存在以下訊息
        | message_name | send_time        |
        | 過去訊息     | 2025/01/10 10:00 |
        | 目標訊息1    | 2025/01/20 09:00 |
        | 目標訊息2    | 2025/02/15 14:00 |
        | 未來訊息     | 2025/12/31 23:59 |
      When 行銷數據人員僅輸入起始時間「2025/01/20」
      And 未輸入結束時間
      Then 系統顯示從「2025/01/20」開始的所有訊息
      And 包含目標訊息1、目標訊息2、未來訊息
      And 不包含過去訊息

    Example: 起始時間為當前日期時顯示今日及之後訊息
      Given 當前日期為「2025/01/25」
      And 系統中存在以下訊息
        | message_name | send_time        |
        | 昨日訊息     | 2025/01/24 10:00 |
        | 今日訊息     | 2025/01/25 09:00 |
        | 明日訊息     | 2025/01/26 14:00 |
      When 行銷數據人員輸入起始時間「2025/01/25」
      Then 系統顯示以下訊息
        | message_name | send_time        |
        | 今日訊息     | 2025/01/25 09:00 |
        | 明日訊息     | 2025/01/26 14:00 |

  Rule: 允許帶入結束時間搜索歷史訊息

    Example: 輸入結束時間篩選訊息
      Given 系統中存在以下訊息
        | message_name | send_time        |
        | 訊息X        | 2025/01/10 10:00 |
        | 訊息Y        | 2025/01/20 09:00 |
        | 訊息Z        | 2025/01/30 14:00 |
      When 行銷數據人員輸入結束時間「2025/01/20」
      Then 系統顯示以下訊息
        | message_name | send_time        |
        | 訊息X        | 2025/01/10 10:00 |
        | 訊息Y        | 2025/01/20 09:00 |

    Example: 僅輸入結束時間時包含所有歷史訊息
      Given 系統中存在以下訊息
        | message_name | send_time        |
        | 最早訊息     | 2024/12/01 10:00 |
        | 目標訊息1    | 2025/01/10 09:00 |
        | 目標訊息2    | 2025/01/20 14:00 |
        | 未來訊息     | 2025/02/15 23:59 |
      When 行銷數據人員僅輸入結束時間「2025/01/20」
      And 未輸入起始時間
      Then 系統顯示截至「2025/01/20」的所有訊息
      And 包含最早訊息、目標訊息1、目標訊息2
      And 不包含未來訊息

    Example: 結束時間早於系統最早訊息時無結果
      Given 系統最早的訊息發送時間為「2025/01/15」
      When 行銷數據人員輸入結束時間「2025/01/10」
      Then 系統顯示「此時間範圍內沒有訊息」
      And 提示「請選擇 2025/01/15 之後的日期」


  Rule: 點擊任一訊息後，可進入詳細頁面查看完整訊息內容

    Example: 查看完整訊息內容
      Given 系統中已存在訊息，標題為「親子旅遊」
      And 訊息內容為群發訊息的模板
      And 該訊息包含發送時間、發送人數、平台、狀態、已讀次數與點擊次數等資訊
      When 行銷數據人員點擊訊息「親子旅遊」進入詳細頁面
      Then 詳細頁面顯示以下欄位：
        | 欄位名稱 | 說明 |
        | -------- | ---- |
        | 訊息標題 | 親子旅遊 |
        | 發送時間 | YYYY/MM/DD hh:mm |
        | 發送人數 | N 人 |
        | 平台 | LINE |
        | 狀態 | 已發送／排程發送／草稿 |
        | 已讀次數 | X 次 |
        | 點擊次數 | Y 次 |

    Example: 詳細頁面顯示完整訊息模板預覽
      Given 系統中存在訊息「VIP 優惠」
      And 訊息使用 Flex Message 輪播模板
      And 包含 3 張圖片卡片及行動按鈕
      When 行銷數據人員點擊該訊息進入詳細頁面
      Then 系統顯示完整的訊息模板預覽
      And 預覽呈現實際發送給會員的視覺效果
      And 顯示所有圖片、文字、按鈕配置
      And 預覽區域可滾動查看完整內容

    Example: 詳細頁面顯示目標受眾篩選條件
      Given 系統中存在訊息「高端客群專屬」
      And 目標受眾篩選條件為「VIP 會員」且「消費金額 > 10000」
      When 行銷數據人員點擊該訊息進入詳細頁面
      Then 系統顯示完整的篩選條件
        | 篩選條件     | 值           |
        | 會員標籤     | VIP 會員     |
        | 消費金額     | > 10000      |
        | 符合人數     | 250 人       |
      And 提供「查看符合條件的會員清單」連結