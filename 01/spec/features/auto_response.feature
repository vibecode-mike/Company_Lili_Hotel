Feature: 自動回應系統
  作為一位使用者
  我希望設定自動回應訊息，當特定條件觸發時自動發送
  以利在第一時間與用戶互動不疏漏，且可蒐集用戶資訊支持 CRM（會員資料整合）

  Background:
    說明:
      自動回應系統僅支援「被動觸發」模式，不支援主動推播。
      當會員發送訊息或執行特定動作時，系統依據設定的條件自動回應。

    各渠道支援的觸發類型:
      | 渠道     | 觸發類型                                           |
      | LINE     | 歡迎訊息、關鍵字回應、依日期或時間條件觸發的一律回應 |
      | Facebook | 關鍵字回應                                         |

    設計說明:
      - LINE 支援三種觸發類型，因 LINE Messaging API 提供完整的 webhook 事件
      - Facebook 僅支援關鍵字回應，因 Messenger Platform 對自動回應有較嚴格限制
      - 所有觸發類型皆為被動模式：會員發訊息 → 系統判斷條件 → 符合則回應

  # ============================================================================
  # 第一部分：回覆優先順序
  # ============================================================================

  Rule: 系統回覆優先順序（人工 > AI > 自動回應）

    Example: 回覆優先順序定義
      Given 系統收到使用者訊息
      Then 系統按以下優先順序決定回覆方式
        | 優先順序 | 回覆方式                        | 說明                                                |
        | 1        | 人工輸入框事件 (Human Override) | 人工進入聊天室輸入框開始輸入，該則訊息走人工發送     |
        | 2        | AI 回覆 (AI First)              | 呼叫 AI 回覆引擎 (LLM)                              |
        | 3        | 自動回應                        | 當 AI 用量耗盡，改用自動回應（歡迎訊息、關鍵字、一律回應） |

  Rule: 自動回應內部優先順序（關鍵字 > 一律回應 > 歡迎訊息）

    Example: 自動回應內部優先順序定義
      Given 系統進入自動回應流程
      Then 系統按以下順序判斷
        | 優先順序 | 觸發類型                     | 說明                                          |
        | 1        | 關鍵字觸發 (keyword_trigger) | 有命中關鍵字就回；同類型比較 updated_at（最新者勝出） |
        | 2        | 一律回應 (scheduled_trigger) | 關鍵字未命中時才檢查時間區間                   |
        | 3        | 歡迎訊息 (welcome_message)   | 新會員加入好友時觸發（獨立觸發，與上述不衝突）  |

  # ============================================================================
  # 第二部分：人工輸入框事件 (Human Override)
  # ============================================================================

  Rule: 人工進入輸入框後，系統停止 AI / 自動回應

    Example: 人工進入輸入框後，該則訊息強制走人工回覆
      Given 用戶剛傳送一則新訊息
      And 管理者尚未操作輸入框
      And ai_quota_status = AVAILABLE
      When 管理者點擊該會員的輸入框並開始輸入文字
      Then 系統應將 conversation_reply_mode 設定為 HUMAN
      And 當下這則訊息不得呼叫 AI
      And 系統不得觸發任何自動回應（歡迎訊息、關鍵字、一律回應）

  Rule: 人工離開輸入框（失焦）後，AI 恢復可用狀態

    Example: 人工離開輸入框後恢復正常回覆模式
      Given 管理者曾進入輸入框並輸入文字
      And 管理者未送出但已離開輸入框（blur）
      When 用戶傳送新的訊息
      Then 若 ai_quota_status = AVAILABLE，系統應呼叫 AI
      And conversation_reply_mode = AI

  Rule: 人工中斷輸入（超過 10 分鐘無操作）可視為失焦

    Example: 人工超過 10 分鐘無輸入，系統視為非人工狀態
      Given 管理者先前曾在輸入框輸入文字
      And 在接下來的 10 分鐘內沒有輸入或送出訊息
      When 用戶再傳送一則新訊息
      Then 系統應不再將回覆模式判定為 HUMAN
      And 若 ai_quota_status = AVAILABLE，AI 可被使用

  Rule: 多分頁開啟同一會員聊天視窗時，人工 override 必須同步

    Example: 多分頁同步人工輸入狀態
      Given 管理者在分頁 A 進入輸入框並開始輸入
      And 相同管理者在分頁 B 也開啟了同一位會員的聊天室
      When 用戶在此聊天室傳送新訊息
      Then 任一分頁的人工輸入行為皆應使 conversation_reply_mode = HUMAN
      And 不得呼叫 AI 或自動回應

  # ============================================================================
  # 第三部分：AI 回覆判斷規則
  # ============================================================================

  Rule: AI 額度足夠時，走 AI 回覆

    Example: AI 額度可用時呼叫 AI 引擎
      Given AI 用量狀態為 AVAILABLE
      And 客服人員沒有在該會員聊天室輸入訊息（is_agent_typing = false）
      When 會員傳送一則新訊息
      Then 系統應呼叫 AI 引擎產生回覆
      And 將本次使用的 tokens 累加至 used_tokens_today

  Rule: AI 額度用完時，改走關鍵字

    Example: AI 額度耗盡時改用關鍵字回覆
      Given AI 用量狀態為 EXHAUSTED
      And 會員訊息命中關鍵字規則
      And 客服人員沒有在該會員聊天室輸入訊息
      When 會員傳送一則新訊息
      Then 系統不呼叫 AI
      And 改由關鍵字規則回覆會員

  # ============================================================================
  # 第四部分：歡迎訊息
  # ============================================================================

  Rule: 支援事先設定訊息回應內容，觸發方式：歡迎訊息

    Example: 設定歡迎訊息
      Given 使用者正在建立自動回應
      When 使用者選擇觸發方式「歡迎訊息」
      Then 系統設定觸發類型為「歡迎訊息」

    Example: 歡迎訊息自動觸發
      Given 系統中存在自動回應「新會員歡迎」，觸發類型為「歡迎訊息」
      And 回應內容為「歡迎加入我們的飯店！」
      When 新會員「張小明」加入 LINE 官方帳號
      Then 系統自動發送訊息「歡迎加入我們的飯店！」給會員「張小明」

    Example: 歡迎訊息停用時不觸發
      Given 系統中存在自動回應「新會員歡迎」，觸發類型為「歡迎訊息」
      And 該自動回應狀態為「停用」
      When 新會員「李小華」加入 LINE 官方帳號
      Then 系統不發送歡迎訊息

  Rule: 單一渠道僅允許一組啟用中的歡迎訊息

    Example: 首次新增歡迎訊息
      Given 某一渠道目前沒有啟用中的歡迎訊息
      And 管理者建立一則類型為「歡迎訊息」的自動回應
      When 管理者點擊按鈕「儲存」
      Then 該歡迎訊息應儲存成功
      And 該歡迎訊息狀態為「啟用」

    Example: 新增第二組歡迎訊息時出現切換彈窗
      Given 某一渠道已有一組狀態為「啟用」的歡迎訊息
      And 管理者建立第二組類型為「歡迎訊息」的新訊息
      When 管理者點擊「儲存」
      Then 系統應顯示彈窗「系統目前已啟用中的歡迎訊息，是否切換至新的設定？」
      And 彈窗中應提供「確認切換」與「保存」兩個按鈕

    Example: 在彈窗選擇「確認切換」
      Given 某一渠道已有一組啟用中的歡迎訊息 A
      And 管理者建立新的歡迎訊息 B
      And 管理者在彈窗中點擊「確認切換」
      When 系統處理儲存與切換
      Then 歡迎訊息 A 的狀態應變更為「停用」
      And 歡迎訊息 B 的狀態應為「啟用」

    Example: 在彈窗選擇「保存」
      Given 某一渠道已有一組啟用中的歡迎訊息 A
      And 管理者建立新的歡迎訊息 B
      And 管理者在彈窗中點擊「保存」
      When 系統處理儲存
      Then 歡迎訊息 B 應儲存成功
      And 歡迎訊息 B 的狀態應為「停用」
      And 歡迎訊息 A 的狀態應維持「啟用」

  Rule: 編輯現有的歡迎訊息後，系統將視為新版本

    Example: 編輯現有啟用中的歡迎訊息
      Given 某渠道已存在一組啟用中的歡迎訊息 A
      And 歡迎訊息 A 的內容為「歡迎加入我們！」
      When 管理者對歡迎訊息 A 進行編輯並變更內容為「歡迎加入本官方帳號！」
      And 管理者點擊「儲存」
      Then 系統應顯示彈窗提示「系統目前已啟用中的歡迎訊息，是否切換至新的設定？」
      And 彈窗內應提供「確認切換」與「保存」兩個按鈕

    Example: 編輯現有「停用」的歡迎訊息不觸發切換
      Given 某渠道存在啟用中的歡迎訊息 A
      And 另有一組未啟用的歡迎訊息 B
      When 管理者編輯歡迎訊息 B 的內容並按下「儲存」
      Then 系統不應出現切換彈窗
      And 歡迎訊息 B 應成功儲存但保持「停用」狀態
      And 歡迎訊息 A 應維持「啟用」

  Rule: 歡迎訊息可設定觸發訊息內容

    Example: 設定歡迎訊息內容
      Given 使用者正在設定歡迎訊息
      When 使用者輸入訊息內容「歡迎加入我們的飯店，期待為您服務！」
      Then 系統記錄訊息內容「歡迎加入我們的飯店，期待為您服務！」

    Example: 設定歡迎訊息多筆內容
      Given 使用者正在設定歡迎訊息
      When 使用者輸入第 1 筆訊息「歡迎加入我們的飯店！」
      And 使用者輸入第 2 筆訊息「很高興認識您～」
      And 使用者輸入第 3 筆訊息「有任何問題隨時詢問」
      Then 系統記錄 3 筆訊息內容
      And 系統將依序發送這 3 筆訊息

    Example: 歡迎訊息內容超過長度限制
      Given 使用者正在設定歡迎訊息
      When 使用者輸入超過 5000 字的訊息內容
      Then 系統顯示錯誤訊息「訊息內容不可超過 5000 字」
      And 拒絕儲存該訊息

  # ============================================================================
  # 第五部分：關鍵字觸發
  # ============================================================================

  Rule: 支援事先設定訊息回應內容，觸發方式：輸入關鍵字觸發

    Example: 設定關鍵字觸發訊息
      Given 使用者正在建立自動回應
      When 使用者選擇觸發方式「關鍵字觸發」
      Then 系統設定觸發類型為「關鍵字觸發」

    Example: 關鍵字觸發訊息自動回應
      Given 系統中存在關鍵字觸發訊息，關鍵字為「訂房」
      And 回應內容為「請撥打訂房專線 02-12345678」
      When 會員發送訊息「訂房」
      Then 系統自動回覆「請撥打訂房專線 02-12345678」

    Example: 關鍵字觸發訊息停用時不回應
      Given 系統中存在關鍵字觸發訊息，關鍵字為「價格」
      And 該自動回應狀態為「停用」
      When 會員發送訊息「價格」
      Then 系統不自動回覆

  Rule: 關鍵字觸發訊息可輸入多組關鍵字（最多 20 組）

    Example: 輸入多組關鍵字
      Given 使用者正在設定關鍵字觸發訊息
      When 使用者輸入關鍵字「訂房」「預約」「價格」
      Then 系統記錄關鍵字「訂房」「預約」「價格」

    Example: 輸入 20 組關鍵字達上限
      Given 使用者正在設定關鍵字觸發訊息
      When 使用者輸入 20 組關鍵字
      Then 系統記錄全部 20 組關鍵字
      And 系統顯示「已達關鍵字上限 20 組」

    Example: 超過 20 組關鍵字拒絕新增
      Given 使用者已輸入 20 組關鍵字
      When 使用者嘗試輸入第 21 組關鍵字「住宿」
      Then 系統顯示錯誤訊息「關鍵字數量已達上限 20 組」
      And 拒絕新增第 21 組關鍵字

    Example: 同則訊息設定重複的關鍵字標籤時禁止新增
      Given 同則訊息內已存在相同的關鍵字「訂房」
      When 當使用者在後台系統輸入「訂房」
      Then 系統顯示提示文字「不可重複關鍵字」
      And 阻擋儲存

  Rule: 關鍵字比對邏輯：後台完全匹配，前台包含匹配，不區分大小寫

    Example: 拒絕純空白關鍵字
      Given 使用者正在設定關鍵字觸發訊息
      When 使用者僅輸入空白字元（例如「   」）
      Then 系統顯示錯誤訊息「關鍵字不可為空白」
      And 拒絕儲存該關鍵字

    Example: 用戶輸入「包含」後台任一完整關鍵字則命中
      Given 系統已存在關鍵字設定「訂房, 訂」訊息 A
      When 當使用者在前台輸入「請問如何訂房？」時
      Then 觸發系統「訂房」訊息 A 作為關鍵字回覆

    Example: 不區分大小寫
      Given 系統中存在關鍵字觸發訊息，關鍵字為「Price」
      When 會員發送訊息「price」
      Then 系統自動回覆價格相關訊息

    Example: 特殊字元需完全匹配
      Given 系統中存在關鍵字觸發訊息，關鍵字為「訂房@vip」
      When 會員發送訊息「訂房@vip」
      Then 系統自動回覆該關鍵字對應的訊息
      But 當會員發送訊息「訂房」時
      Then 系統不觸發自動回應（因未完整包含 @vip）

  Rule: 多組關鍵字為 OR 邏輯，任一匹配即觸發

    Example: 多組關鍵字任一匹配觸發
      Given 系統中存在關鍵字觸發訊息，關鍵字為「訂房」「預約」「價格」
      And 回應內容為「請撥打訂房專線 02-12345678」
      When 會員發送訊息「價格」
      Then 系統自動回覆「請撥打訂房專線 02-12345678」

    Example: 多組關鍵字不同關鍵字都能觸發
      Given 系統中存在關鍵字觸發訊息，關鍵字為「訂房」「預約」「booking」
      And 回應內容為「請撥打訂房專線 02-12345678」
      When 會員發送訊息「booking」
      Then 系統自動回覆「請撥打訂房專線 02-12345678」

    Example: 多組關鍵字皆未匹配則不觸發
      Given 系統中存在關鍵字觸發訊息，關鍵字為「訂房」「預約」「價格」
      When 會員發送訊息「你好」
      Then 系統不自動回覆該訊息

  Rule: 關鍵字衝突時僅有一個版本可生效

    Example: 存在多組同一關鍵字設定時僅一組生效
      Given 資料庫中已有一則觸發關鍵字「飯店」的設定 A，狀態為「生效」
      And 管理者新增另一則同樣關鍵字「飯店」的設定 B
      When 管理者點擊「儲存」
      Then 設定 B 應儲存成功
      And 設定 B 應標記為「最新版本並生效」
      And 設定 A 應標記為「不生效」
      And 在介面上設定 A 的關鍵字標籤應以紅色顯示

  Rule: 關鍵字彼此包含時的觸發優先順序

    Example: 完全符合優先於部分符合
      Given 已存在關鍵字設定 A，關鍵字為「飯店」
      And 已存在關鍵字設定 B，關鍵字為「飯店位置」
      And A 與 B 皆為「生效」狀態
      When 用戶傳送訊息「請問飯店位置怎麼走？」
      Then 系統應優先判定完全符合的關鍵字「飯店位置」
      And 觸發設定 B 所對應的回覆內容

    Example: 同時命中多組完全匹配的關鍵字時優先觸發最新版本回覆
      Given 系統已存在關鍵字「訂房, 訂」訊息 A
      And 訊息 A 的建立時間為 t1
      And 系統已存在關鍵字「時間, 營業時間」訊息 B
      And 訊息 B 的建立時間為 t2
      And t2 > t1（B為最新版本）
      When 當使用者在前台輸入「訂房時間」
      Then 觸發系統最新版本的訊息 B 作為回覆

  Rule: 重複關鍵字的紅色標籤 Tooltip 提示

    Example: 滑鼠移到紅色關鍵字標籤顯示提示
      Given 某一觸發關鍵字設定已被標記為「重複（不生效）」
      And 該設定的關鍵字標籤在介面上以紅色顯示
      When 使用者將滑鼠移到該紅色關鍵字標籤上
      Then 系統應顯示 Tooltip 提示文字「重複的關鍵字，以最新版本觸發」

  Rule: 觸發的關鍵字會記錄於後台

    Example: 記錄觸發的關鍵字
      Given 系統中存在關鍵字觸發訊息，關鍵字為「優惠」
      When 會員發送訊息「優惠」
      Then 系統記錄觸發關鍵字「優惠」

    Example: 記錄觸發關鍵字時包含觸發時間
      Given 系統中存在關鍵字觸發訊息，關鍵字為「訂房」
      When 會員於「2025-11-19 14:30」發送訊息「訂房」
      Then 系統記錄觸發關鍵字「訂房」
      And 系統記錄觸發時間為「2025-11-19 14:30」

    Example: 記錄觸發關鍵字時包含會員資訊
      Given 系統中存在關鍵字觸發訊息，關鍵字為「價格」
      When 會員「張小明」發送訊息「價格」
      Then 系統記錄觸發關鍵字「價格」
      And 系統記錄觸發會員為「張小明」

  Rule: 關鍵字觸發時更新統計資訊

    Example: 關鍵字觸發時累加觸發次數
      Given 自動回應「訂房諮詢」的關鍵字「訂房」目前觸發次數為 5 次
      When 會員發送訊息「訂房」觸發關鍵字「訂房」
      Then 系統將關鍵字「訂房」的 trigger_count 更新為 6
      And 更新 last_triggered_at 為當前時間

    Example: 僅更新實際觸發的關鍵字統計
      Given 自動回應「訂房諮詢」存在關鍵字「訂房」「預約」「價格」
      When 會員發送訊息「價格」觸發關鍵字「價格」
      Then 系統僅更新關鍵字「價格」的 trigger_count 與 last_triggered_at
      And 關鍵字「訂房」「預約」的統計資訊不變

    Example: 查看關鍵字觸發統計
      Given 自動回應「訂房諮詢」存在以下關鍵字
        | keyword_text | trigger_count | last_triggered_at |
        | 訂房         | 15            | 2025/01/20 14:30  |
        | 預約         | 8             | 2025/01/19 10:15  |
        | 價格         | 23            | 2025/01/20 16:45  |
      When 使用者查看自動回應「訂房諮詢」的關鍵字統計
      Then 系統顯示各關鍵字的觸發次數與最近觸發時間
      And 可依觸發次數排序，分析哪些關鍵字最常被使用

  Rule: 關鍵字透過關聯表管理（AutoResponseKeyword）

    Example: 新增關鍵字建立關聯記錄
      Given 使用者正在建立自動回應「訂房諮詢」
      When 使用者輸入關鍵字「訂房」「預約」「價格」
      Then 系統為自動回應「訂房諮詢」建立 3 筆關鍵字關聯記錄
        | keyword_text | match_type | is_enabled |
        | 訂房         | 完全匹配   | true       |
        | 預約         | 完全匹配   | true       |
        | 價格         | 完全匹配   | true       |

    Example: 刪除關鍵字移除關聯記錄
      Given 自動回應「訂房諮詢」存在關鍵字「訂房」「預約」「價格」
      When 使用者刪除關鍵字「價格」
      Then 系統刪除關鍵字「價格」的關聯記錄
      And 自動回應「訂房諮詢」剩餘關鍵字「訂房」「預約」

    Example: 關鍵字數量上限驗證（最多 20 組）
      Given 自動回應「訂房諮詢」已有 20 組關鍵字
      When 使用者嘗試新增第 21 組關鍵字「住宿」
      Then 系統拒絕新增，顯示錯誤訊息「關鍵字數量已達上限 20 組」

    Example: 同一自動回應不可有重複關鍵字
      Given 自動回應「訂房諮詢」已存在關鍵字「訂房」
      When 使用者嘗試新增關鍵字「訂房」
      Then 系統拒絕新增，顯示錯誤訊息「關鍵字已存在」

    Example: 停用自動回應的訊息，則關鍵字不刪除記錄
      Given 自動回應的訊息「訂房諮詢」存在關鍵字「訂房」
      And 關鍵字「訂房」的 trigger_count 為 15 次
      When 使用者停用自動回應的該則訊息「訂房諮詢」
      Then 關鍵字「訂房」的關聯記錄仍保留在資料庫
      And 觸發統計資訊（trigger_count = 15）不變

  # ============================================================================
  # 第六部分：重複關鍵字標籤點擊切換生效版本
  # ============================================================================

  Rule: 點擊紅色標籤需先彈窗確認，避免誤觸切換

    Example: 點擊紅色關鍵字標籤後出現確認彈窗
      Given 存在關鍵字設定 A，關鍵字為「訂房」，狀態為「生效」
      And 存在關鍵字設定 B，關鍵字同樣為「訂房」，狀態為「重複（不生效）」
      And 設定 B 的關鍵字標籤在介面上顯示為紅色
      When 管理者點擊設定 B 的紅色關鍵字標籤
      Then 系統應顯示彈窗提示「確認更新標籤？」
      And 彈窗內應提供「確認更新」與「取消」兩個按鈕
      And 彈窗外背景應為不可操作狀態（避免誤點其他操作）

    Example: 點擊取消時，不應有任何狀態變更
      Given 確認彈窗已顯示
      When 管理者點擊「取消」
      Then 彈窗應關閉
      And 設定 A 應維持為「生效」
      And 設定 B 應維持為「重複（不生效）」
      And UI 不得更新任何標籤顏色與狀態

  Rule: 確認更新後，切換為主要生效版本且互斥更新

    Example: 點擊確認更新後，切換生效版本並更新 UI 標籤顏色
      Given 存在關鍵字設定 A，關鍵字為「訂房」，狀態為「生效」
      And 存在關鍵字設定 B，關鍵字同樣為「訂房」，狀態為「重複（不生效）」
      And 管理者已點擊 B 的紅色標籤並開啟確認彈窗
      When 管理者點擊「確認更新」
      Then 系統應將設定 B 標記為「生效」
      And 系統應將設定 A 標記為「不生效」
      And UI 上設定 A 的關鍵字標籤應更新為紅色
      And UI 上設定 B 的關鍵字標籤應更新為正常顯示
      And 系統應顯示 Toast「標籤已更新」

  Rule: 送出切換請求時需防連點與避免重複提交

    Example: 防止重複提交
      Given 確認彈窗已顯示
      When 管理者點擊「確認更新」
      Then 「確認更新」按鈕應進入 loading 狀態
      And 「確認更新」與「取消」按鈕應暫時不可點擊
      And 系統不得重複送出第二次切換請求

  Rule: 切換失敗的錯誤處理

    Example: 切換請求失敗時顯示錯誤提示
      Given 管理者已在確認彈窗點擊「確認更新」
      When 系統切換請求回傳失敗（例如 500 或網路中斷）
      Then 系統應顯示錯誤 Toast「操作失敗，請稍後再試」
      And 系統不得變更設定 A / B 的狀態
      And UI 標籤顏色不得更新
      And 彈窗應維持開啟並恢復按鈕可點擊

  # ============================================================================
  # 第七部分：一律回應（指定時間觸發）
  # ============================================================================

  Rule: 支援事先設定訊息回應內容，觸發方式：選擇指定時間觸發

    Example: 設定指定時間觸發訊息
      Given 使用者正在建立自動回應
      When 使用者選擇觸發方式「指定時間觸發」
      Then 系統設定觸發類型為「指定時間觸發」

    Example: 指定時間觸發訊息自動回應
      Given 系統中存在指定時間觸發訊息，時間區間為「18:00」到「09:00」
      And 回應內容為「目前為非營業時間，請於 09:00 後來電」
      When 會員於「20:30」發送訊息「還有房間嗎？」
      Then 系統自動回覆「目前為非營業時間，請於 09:00 後來電」

    Example: 指定時間觸發訊息停用時不回應
      Given 系統中存在指定時間觸發訊息，時間區間為「18:00」到「09:00」
      And 該自動回應狀態為「停用」
      When 會員於「20:30」發送訊息「還有房間嗎？」
      Then 系統不自動回覆

  Rule: 單一渠道在同一日期或同一時間區間內僅允許一組「一律回應」啟用

    Example: 首次新增一律回應
      Given 某一渠道目前沒有啟用中的一律回應訊息
      And 管理者建立一則類型為「一律回應」的訊息
      And 管理者設定日期區間或時間區間
      When 管理者點擊「儲存」
      Then 該訊息應儲存成功
      And 該訊息狀態為「啟用」

    Example: 同一日期區間內新增第二組一律回應出現切換彈窗
      Given 某一渠道已有一組「一律回應」訊息 A，日期/時間區間為 X
      And 訊息 A 狀態為「啟用」
      And 管理者建立新的「一律回應」訊息 B，日期/時間區間與 X 完全相同或重疊
      When 管理者點擊「儲存」
      Then 系統應顯示彈窗「系統目前已啟用中的一律回應，是否切換至新的設定？」
      And 彈窗中應提供「確認切換」與「保存」兩個按鈕

    Example: 一律回應選擇「確認切換」
      Given 渠道已有啟用中的一律回應訊息 A
      And 管理者建立新的訊息 B，其日期/時間區間與 A 重疊
      And 管理者在彈窗中點擊「確認切換」
      When 系統處理儲存
      Then 訊息 A 的狀態應變更為「停用」
      And 訊息 B 的狀態應為「啟用中」

    Example: 一律回應選擇「保存」
      Given 渠道已有啟用中的一律回應訊息 A
      And 管理者建立新的訊息 B，其日期/時間區間與 A 重疊
      And 管理者在彈窗中點擊「保存」
      When 系統處理儲存
      Then 訊息 B 應儲存成功且狀態為「未啟用」
      And 訊息 A 應維持為「啟用中」

  Rule: 系統無「一律回應」設定則不回覆

    Example: 無一律回應設定時不回覆
      Given 系統中不存在任何啟用中的一律回應
      And 系統中也未設定任何一律回應訊息
      And 用戶傳送訊息「你好」
      When 系統檢查可用的自動回應規則
      Then 系統不應觸發任何自動回應
      And 系統不回覆任何訊息

  Rule: 指定時間觸發可選擇指定日期區間

    Example: 設定指定日期區間
      Given 使用者正在設定指定時間觸發訊息
      When 使用者設定日期區間「2025/02/01」到「2025/02/28」
      Then 系統記錄日期區間「2025/02/01」到「2025/02/28」

    Example: 設定指定日期區間（活動期間）
      Given 使用者正在設定指定時間觸發訊息
      When 使用者設定日期區間「2025/01/25」到「2025/01/31」
      And 使用者設定回應內容「春節特價活動進行中！」
      Then 系統記錄日期區間「2025/01/25」到「2025/01/31」
      And 會員在此期間發送訊息時觸發自動回應

    Example: 日期區間外不觸發
      Given 系統中存在指定時間觸發訊息，日期區間為「2025/02/01」到「2025/02/28」
      When 會員於「2025/03/01」發送訊息
      Then 系統不觸發該指定時間自動回應

  Rule: 指定時間觸發可選擇指定時間區間

    Example: 設定指定時間區間（非營業時間段）
      Given 使用者正在設定指定時間觸發訊息
      When 使用者設定時間區間「18:00」到「09:00」
      Then 系統記錄 time_range_start 為「18:00」
      And 系統記錄 time_range_end 為「09:00」

    Example: 設定指定時間區間（營業時間段）
      Given 使用者正在設定指定時間觸發訊息
      When 使用者設定時間區間「09:00」到「18:00」
      Then 系統記錄 time_range_start 為「09:00」
      And 系統記錄 time_range_end 為「18:00」
      And 系統判斷為非跨日時間區間

    Example: 設定指定時間區間（午休時段）
      Given 使用者正在設定指定時間觸發訊息
      When 使用者設定時間區間「12:00」到「13:30」
      And 使用者設定回應內容「目前為午休時間，13:30 後恢復服務」
      Then 系統記錄 time_range_start 為「12:00」
      And 系統記錄 time_range_end 為「13:30」

  Rule: 時間區間採用兩欄位設計（time_range_start, time_range_end）

    Example: 時間區間格式為 HH:mm（24小時制）
      Given 使用者正在設定指定時間觸發訊息
      When 使用者設定時間區間「18:00」到「09:00」
      Then 系統儲存 time_range_start 為「18:00」（格式：HH:mm）
      And 系統儲存 time_range_end 為「09:00」（格式：HH:mm）

    Example: 時間格式驗證（正確格式）
      Given 使用者正在設定指定時間觸發訊息
      When 使用者輸入時間區間起始「18:00」
      Then 系統驗證格式正確（符合 ^([01]\d|2[0-3]):[0-5]\d$ 規則）
      And 系統接受輸入

    Example: 時間格式驗證（錯誤格式 - 超出範圍）
      Given 使用者正在設定指定時間觸發訊息
      When 使用者輸入時間區間起始「25:00」
      Then 系統驗證格式錯誤
      And 系統拒絕輸入，顯示錯誤訊息「時間格式錯誤，請輸入 HH:mm 格式（00:00-23:59）」

    Example: 時間格式驗證（錯誤格式 - 缺少冒號）
      Given 使用者正在設定指定時間觸發訊息
      When 使用者輸入時間區間起始「1800」
      Then 系統驗證格式錯誤
      And 系統拒絕輸入，顯示錯誤訊息「時間格式錯誤，請輸入 HH:mm 格式（00:00-23:59）」

  Rule: 支援跨日時間區間（time_range_end < time_range_start 表示跨日）

    Example: 跨日時間區間判斷（18:00-09:00）
      Given 使用者設定 time_range_start 為「18:00」
      And 使用者設定 time_range_end 為「09:00」
      When 系統比對 time_range_end < time_range_start
      Then 系統判斷為跨日時間區間
      And 系統記錄此為跨日情境（晚上 18:00 到隔天早上 09:00）

    Example: 非跨日時間區間判斷（09:00-18:00）
      Given 使用者設定 time_range_start 為「09:00」
      And 使用者設定 time_range_end 為「18:00」
      When 系統比對 time_range_end >= time_range_start
      Then 系統判斷為非跨日時間區間
      And 系統記錄此為同日時間區間（當日 09:00 到 18:00）

    Example: 跨日時間區間觸發判斷（會員在區間內）
      Given 自動回應設定 time_range_start 為「18:00」
      And time_range_end 為「09:00」（跨日）
      When 會員於「20:00」發送訊息
      Then 系統判斷當前時間「20:00」>= time_range_start「18:00」
      And 系統觸發自動回應

    Example: 跨日時間區間觸發判斷（會員在隔日區間內）
      Given 自動回應設定 time_range_start 為「18:00」
      And time_range_end 為「09:00」（跨日）
      When 會員於隔日「08:00」發送訊息
      Then 系統判斷當前時間「08:00」<= time_range_end「09:00」
      And 系統觸發自動回應

    Example: 跨日時間區間觸發判斷（會員在區間外）
      Given 自動回應設定 time_range_start 為「18:00」
      And time_range_end 為「09:00」（跨日）
      When 會員於「10:00」發送訊息
      Then 系統判斷當前時間「10:00」不在區間內
      And 系統不觸發自動回應

    Example: 非跨日時間區間觸發判斷（會員在區間內）
      Given 自動回應設定 time_range_start 為「09:00」
      And time_range_end 為「18:00」（非跨日）
      When 會員於「14:00」發送訊息
      Then 系統判斷當前時間「14:00」>= time_range_start「09:00」且 <=time_range_end「18:00」
      And 系統觸發自動回應

    Example: 非跨日時間區間觸發判斷（會員在區間外）
      Given 自動回應設定 time_range_start 為「09:00」
      And time_range_end 為「18:00」（非跨日）
      When 會員於「19:00」發送訊息
      Then 系統判斷當前時間「19:00」> time_range_end「18:00」
      And 系統不觸發自動回應

  # ============================================================================
  # 第八部分：被動回應模式
  # ============================================================================

  Rule: 被動回應模式（scheduled_mode = 'passive'）會員發訊息時判斷時間範圍

    Example: 非營業時間自動回覆
      Given 系統中存在自動回應，觸發類型為「指定時間觸發」
      And 時間區間為「18:00」到「09:00」
      And 回應內容為「目前為非營業時間，請於 09:00 後來電，謝謝！」
      When 會員於「20:00」發送訊息「還有房間嗎？」
      Then 系統自動回覆「目前為非營業時間，請於 09:00 後來電，謝謝！」

    Example: 時間範圍外不回應
      Given 系統中存在自動回應，觸發類型為「指定時間觸發」
      And 時間區間為「18:00」到「09:00」
      When 會員於「10:00」發送訊息「還有房間嗎？」
      Then 系統不自動回覆該訊息

    Example: 多個會員在時間範圍內發訊息都回應
      Given 系統中存在自動回應，觸發類型為「指定時間觸發」
      And 時間區間為「18:00」到「09:00」
      And 回應內容為「目前為非營業時間，請於 09:00 後來電」
      When 會員「張小明」於「20:00」發送訊息「你好」
      And 會員「李小華」於「21:00」發送訊息「請問」
      Then 系統分別回覆兩位會員「目前為非營業時間，請於 09:00 後來電」

    Example: 跨日時間區間的邊界測試
      Given 自動回應設定如下
        | trigger_type      | scheduled_mode | time_range_start | time_range_end | response_content | is_enabled |
        | scheduled_trigger | passive        | 18:00            | 09:00          | 目前為非營業時間 | true       |
      When 會員於「18:00」整點發送訊息「你好」
      Then 系統檢查當前時間「18:00」恰好等於 time_range_start
      And 系統觸發自動回應（包含邊界）
      When 會員於「09:00」整點發送訊息「早安」
      Then 系統檢查當前時間「09:00」恰好等於 time_range_end
      And 系統觸發自動回應（包含邊界）

  # ============================================================================
  # 第九部分：觸發衝突優先順序
  # ============================================================================

  Rule: 觸發衝突優先順序（單一事件僅回覆一條規則）

    Example: 關鍵字優先於指定時間
      Given 系統中存在關鍵字觸發訊息「訂房」，回應內容為「請撥打 02-12345678」
      And 系統中存在指定時間觸發訊息（18:00-09:00），回應內容為「目前為非營業時間」
      When 會員於「20:00」發送訊息「訂房」
      Then 系統僅回覆關鍵字訊息「請撥打 02-12345678」
      And 指定時間觸發記錄為「已忽略（同事件已有高優先回應）」

    Example: 關鍵字未命中但時間觸發滿足 - 執行時間觸發
      Given 系統中存在以下自動回應
        | trigger_type      | trigger_condition | response_content               |
        | scheduled_trigger | 18:00-09:00       | 目前為非營業時間，請稍後再聯繫 |
        | keyword_trigger   | 訂房              | 請撥打訂房專線 02-12345678     |
      When 會員於「20:00」發送訊息「還有房間嗎」
      Then 系統檢查關鍵字觸發，未命中任何關鍵字
      And 系統檢查時間觸發，當前時間「20:00」在區間「18:00-09:00」內
      And 系統執行「指定時間觸發」自動回應
      And 系統回覆「目前為非營業時間，請稍後再聯繫」

    Example: 新好友加入並發送關鍵字 - 歡迎訊息與關鍵字都執行（不衝突）
      Given 系統中存在以下自動回應
        | trigger_type    | trigger_condition | response_content           |
        | welcome_message | -                 | 歡迎加入飯店！             |
        | keyword_trigger | 你好              | 您好，有什麼可以幫您的嗎？ |
      When 新會員加入好友時
      Then 系統立即觸發「歡迎訊息」自動回應
      When 新會員發送訊息「你好」
      Then 系統檢查關鍵字觸發，命中關鍵字「你好」
      And 系統執行「關鍵字觸發」自動回應
      And 歡迎訊息與關鍵字回應皆會發送（不衝突）

    Example: 同類型多個關鍵字觸發 - 執行最後更新的
      Given 系統中存在以下自動回應
        | trigger_type    | trigger_condition | response_content   | created_at       | updated_at       | is_enabled |
        | keyword_trigger | 訂房              | 回應 A：訂房資訊 A | 2025/01/01 10:00 | 2025/01/02 09:00 | true       |
        | keyword_trigger | 訂房              | 回應 B：訂房資訊 B | 2025/01/01 11:00 | 2025/01/02 14:00 | true       |
        | keyword_trigger | 訂房              | 回應 C：訂房資訊 C | 2025/01/01 12:00 | 2025/01/02 12:00 | true       |
      When 會員發送訊息「訂房」
      Then 系統觸發 3 個關鍵字自動回應
      And 系統按 updated_at DESC 排序：回應 B（最新）> 回應 C > 回應 A
      And 系統僅執行「回應 B：訂房資訊 B」（最新更新）
      And 系統不執行其他關鍵字回應

    Example: 所有自動回應皆停用 - 不執行任何回應
      Given 系統中存在以下自動回應
        | trigger_type    | trigger_condition | response_content | is_enabled |
        | welcome_message | -                 | 歡迎訊息         | false      |
        | keyword_trigger | 你好              | 關鍵字回應       | false      |
      When 新會員加入好友並發送訊息「你好」
      Then 系統檢查所有自動回應的 is_enabled 狀態
      And 系統不執行任何自動回應（所有回應皆已停用）

  # ============================================================================
  # 第十部分：會員 GPT 自動回應開關
  # ============================================================================

  Rule: 會員 GPT 自動回應開關（Member.gpt_enabled）

    Example: 關閉後不觸發 GPT，自動回應 (keyword/welcome/time) 照常
      Given 會員「王小明」的 gpt_enabled = false
      And 會員發送訊息「訂房」
      And 系統中存在 GPT 自動回應流程與關鍵字自動回應規則
      When 系統處理訊息
      Then 系統跳過 GPT 自動回應（不呼叫 GPT 模型）
      And 系統仍可觸發關鍵字/歡迎/指定時間等其他自動回應
      And 聊天室訊息來源標註正常（若有觸發其他自動回應）

  # ============================================================================
  # 第十一部分：自動回應訊息管理
  # ============================================================================

  Rule: 訊息回應格式以純文字為主

    Example: 設定純文字回應內容
      Given 使用者正在設定自動回應訊息
      When 使用者輸入純文字「感謝您的詢問，我們將盡快回覆」
      Then 系統記錄回應內容「感謝您的詢問，我們將盡快回覆」

    Example: 設定包含換行的純文字回應
      Given 使用者正在設定自動回應訊息
      When 使用者輸入純文字回應內容
        """
        感謝您的詢問！

        營業時間：09:00-18:00
        訂房專線：02-12345678
        """
      Then 系統記錄包含換行格式的回應內容

    Example: 設定純文字回應長度限制
      Given 使用者正在設定自動回應訊息
      When 使用者輸入超過 5000 字的純文字
      Then 系統顯示錯誤訊息「訊息內容不可超過 5000 字」
      And 拒絕儲存

  Rule: 自動回應訊息透過關聯表管理（AutoResponseMessage）

    Example: 新增第一筆訊息
      Given 使用者正在建立自動回應
      When 使用者新增第一筆訊息「歡迎加入我們的飯店！」
      Then 系統建立 AutoResponseMessage 記錄
      And 系統記錄 message_content 為「歡迎加入我們的飯店！」
      And 系統記錄 sequence_order 為 1
      And 系統更新 AutoResponse.response_count 為 1

    Example: 新增多筆訊息
      Given 使用者已新增第一筆訊息「歡迎加入！」
      When 使用者新增第二筆訊息「很高興認識您～」
      Then 系統建立第二筆 AutoResponseMessage 記錄
      And 系統記錄 sequence_order 為 2
      And 系統更新 AutoResponse.response_count 為 2

    Example: 刪除訊息後 response_count 更新
      Given 使用者已新增 3 筆訊息
      And AutoResponse.response_count 為 3
      When 使用者刪除第 2 筆訊息
      Then 系統刪除對應的 AutoResponseMessage 記錄
      And 系統更新 AutoResponse.response_count 為 2

  Rule: 自動回應訊息數量限制（至少 1 筆，最多 5 筆）

    Example: UI 互動方式為逐筆新增
      Given 使用者正在建立自動回應
      When 使用者查看訊息設定區
      Then 系統顯示「+ 新增訊息」按鈕
      And 每筆訊息可獨立編輯、刪除
      And 訊息數量顯示為「已新增 X / 最多 5 筆」

    Example: 訊息數量至少 1 筆
      Given 使用者正在建立自動回應
      When 使用者嘗試儲存但未新增任何訊息
      Then 系統顯示驗證錯誤「至少需要新增 1 筆訊息」
      And 拒絕儲存

    Example: 訊息數量最多 5 筆
      Given 使用者已新增 5 筆自動回應訊息
      When 使用者嘗試新增第 6 筆訊息
      Then 系統顯示提示「已達訊息數量上限（最多 5 筆）」
      And 拒絕新增
      And 「+ 新增訊息」按鈕變為不可點擊狀態

    Example: 使用「+ 新增訊息」按鈕新增訊息
      Given 使用者已新增 2 筆訊息
      When 使用者點擊「+ 新增訊息」按鈕
      Then 系統新增一個空白訊息欄位
      And sequence_order 自動設定為 3
      And 訊息數量更新為「已新增 3 / 最多 5 筆」

  Rule: 支援個別訊息的新增、編輯、刪除操作

    Example: 編輯特定訊息內容
      Given 使用者已新增訊息「歡迎加入！」（sequence_order = 1）
      When 使用者編輯該訊息內容為「熱烈歡迎加入我們的飯店！」
      Then 系統更新對應 AutoResponseMessage 記錄的 message_content
      And sequence_order 保持不變

    Example: 刪除特定訊息
      Given 使用者已新增 3 筆訊息（sequence_order: 1, 2, 3）
      When 使用者刪除第 2 筆訊息
      Then 系統刪除對應的 AutoResponseMessage 記錄
      And 系統更新剩餘訊息的 sequence_order（原第 3 筆變為第 2 筆）
      And 系統更新 AutoResponse.response_count 為 2

    Example: 編輯第三筆訊息內容不影響順序
      Given 使用者已新增 3 筆訊息
      When 使用者編輯第 3 筆訊息內容為「期待為您服務！」
      Then 系統更新該訊息的 message_content
      And sequence_order 保持為 3
      And 其他訊息順序不變

  Rule: 支援訊息順序調整（拖曳排序）

    Example: 調整訊息順序
      Given 使用者已新增 3 筆訊息
        | sequence_order | message_content |
        | 1              | 訊息 A          |
        | 2              | 訊息 B          |
        | 3              | 訊息 C          |
      When 使用者將「訊息 C」拖曳至第 1 位
      Then 系統更新所有訊息的 sequence_order
        | message_content | new_sequence_order |
        | 訊息 C          | 1                  |
        | 訊息 A          | 2                  |
        | 訊息 B          | 3                  |

    Example: 拖曳第一筆訊息至最後
      Given 使用者已新增 4 筆訊息（順序: A, B, C, D）
      When 使用者將「訊息 A」拖曳至第 4 位
      Then 系統更新 sequence_order 為（順序: B, C, D, A）
      And 新順序為 1=B, 2=C, 3=D, 4=A

    Example: 拖曳中間訊息至中間位置
      Given 使用者已新增 5 筆訊息（順序: A, B, C, D, E）
      When 使用者將「訊息 C」拖曳至第 2 位
      Then 系統更新 sequence_order 為（順序: A, C, B, D, E）
      And 新順序為 1=A, 2=C, 3=B, 4=D, 5=E

  Rule: 觸發時依序發送所有訊息

    Example: 依序發送多筆訊息
      Given 自動回應設定包含 3 筆訊息
        | sequence_order | message_content |
        | 1              | 歡迎加入！      |
        | 2              | 很高興認識您～  |
        | 3              | 有問題隨時詢問  |
      When 觸發條件滿足（如新好友加入）
      Then 系統依序發送第 1 筆訊息「歡迎加入！」
      And 延遲 1-2 秒後發送第 2 筆訊息「很高興認識您～」
      And 延遲 1-2 秒後發送第 3 筆訊息「有問題隨時詢問」

    Example: 僅一筆訊息時立即發送
      Given 自動回應設定包含 1 筆訊息「感謝您的詢問」
      When 觸發條件滿足
      Then 系統立即發送訊息「感謝您的詢問」
      And 不延遲

    Example: 發送過程中若某筆失敗則記錄錯誤
      Given 自動回應設定包含 3 筆訊息
      When 觸發條件滿足並開始依序發送
      And 第 2 筆訊息發送失敗（LINE API 錯誤）
      Then 系統記錄第 2 筆訊息發送失敗
      And 系統繼續嘗試發送第 3 筆訊息

  # ============================================================================
  # 第十二部分：自動回應訊息的啟用/停用
  # ============================================================================

  Rule: 支援自動回應訊息的啟用/停用

    Example: 停用自動回應訊息的關鍵字不參與比對
      Given 自動回應「訂房諮詢」存在關鍵字「訂房」（is_enabled = true）
      When 使用者停用自動回應訊息的關鍵字「訂房」
      Then 系統將關鍵字「訂房」的 is_enabled 更新為 false
      When 會員發送訊息「訂房」
      Then 系統不觸發自動回應「訂房諮詢」

    Example: 重新啟用關鍵字恢復比對
      Given 自動回應「訂房諮詢」存在關鍵字「訂房」（is_enabled = false）
      When 使用者重新啟用關鍵字「訂房」
      Then 系統將關鍵字「訂房」的 is_enabled 更新為 true
      When 會員發送訊息「訂房」
      Then 系統觸發自動回應「訂房諮詢」

  Rule: 停用則不啟動觸發

    Example: 停用的訊息不觸發
      Given 系統中存在關鍵字觸發訊息「訂房回覆」，關鍵字為「訂房」，狀態為「停用」
      When 會員發送訊息「我想訂房」
      Then 系統不觸發自動回應

    Example: 停用歡迎訊息不觸發
      Given 系統中存在歡迎訊息「新會員歡迎」，狀態為「停用」
      When 新會員加入 LINE 官方帳號
      Then 系統不觸發歡迎訊息

  Rule: 設定完成後，可選擇停用該訊息

    Example: 停用自動回應訊息
      Given 系統中存在自動回應訊息「歡迎訊息」，狀態為「啟用」
      When 使用者停用訊息「歡迎訊息」
      Then 系統設定訊息「歡迎訊息」狀態為「停用」

    Example: 批次停用多筆自動回應訊息
      Given 系統中存在以下自動回應訊息
        | message_name | is_enabled |
        | 歡迎訊息     | true       |
        | 訂房諮詢     | true       |
        | 營業時間     | true       |
      When 使用者選擇「歡迎訊息」「訂房諮詢」並批次停用
      Then 系統將這 2 筆訊息狀態設定為「停用」
      And 「營業時間」訊息狀態保持「啟用」

    Example: 快速切換訊息狀態
      Given 系統中存在自動回應訊息「訂房諮詢」，狀態為「啟用」
      When 使用者在清單中點擊狀態切換按鈕
      Then 系統將訊息狀態切換為「停用」
      And 清單即時更新顯示「停用」狀態

  # ============================================================================
  # 第十三部分：自動回應訊息的刪除
  # ============================================================================

  Rule: 支援刪除自動回應訊息

    Example: 刪除自動回應訊息
      Given 系統中存在自動回應訊息「測試訊息」
      When 使用者刪除自動回應訊息「測試訊息」
      Then 系統移除自動回應訊息「測試訊息」

    Example: 刪除自動回應訊息同時刪除關聯資料
      Given 系統中存在自動回應訊息「訂房諮詢」
      And 該訊息有 3 筆關鍵字關聯記錄
      And 該訊息有 2 筆訊息內容記錄
      When 使用者刪除自動回應訊息「訂房諮詢」
      Then 系統同時刪除該訊息的所有關鍵字關聯記錄
      And 系統同時刪除該訊息的所有訊息內容記錄

    Example: 刪除自動回應訊息前確認
      Given 系統中存在自動回應訊息「歡迎訊息」
      When 使用者點擊刪除按鈕
      Then 系統顯示確認對話框「確定要刪除此自動回應訊息嗎？刪除後無法復原」
      When 使用者確認刪除
      Then 系統移除該自動回應訊息

  Rule: 刪除則無法復原需重新設定

    Example: 刪除後無法復原
      Given 系統中存在自動回應訊息「過期優惠」
      When 使用者刪除訊息「過期優惠」
      Then 系統中不存在訊息「過期優惠」

    Example: 誤刪後需重新建立
      Given 使用者誤刪自動回應訊息「重要通知」
      When 使用者嘗試復原該訊息
      Then 系統無法復原已刪除訊息
      And 使用者需重新建立相同內容的自動回應

    Example: 刪除前系統顯示警告訊息
      Given 系統中存在自動回應訊息「春節活動」
      When 使用者點擊刪除按鈕
      Then 系統顯示警告訊息「確定要刪除此自動回應訊息嗎？刪除後無法復原」
      And 提供「取消」與「確定刪除」選項

  # ============================================================================
  # 第十四部分：編輯自動回應訊息
  # ============================================================================

  Rule: 設定完成後，可編輯該訊息內容

    Example: 編輯自動回應訊息內容
      Given 系統中存在自動回應訊息「營業時間回覆」，內容為「營業時間：09:00-18:00」
      When 使用者編輯訊息內容為「營業時間：10:00-20:00」
      Then 系統更新訊息內容為「營業時間：10:00-20:00」

    Example: 編輯自動回應訊息關鍵字
      Given 系統中存在關鍵字觸發訊息「訂房諮詢」，關鍵字為「訂房」「預約」
      When 使用者編輯關鍵字，新增「booking」
      Then 系統將關鍵字更新為「訂房」「預約」「booking」

    Example: 編輯自動回應訊息時間區間
      Given 系統中存在指定時間觸發訊息，時間區間為「18:00-09:00」
      When 使用者編輯時間區間為「20:00-08:00」
      Then 系統更新時間區間為「20:00-08:00」

  Rule: 用戶下次觸發時啟用更新後的內容

    Example: 觸發時使用更新後的內容
      Given 系統中存在關鍵字觸發訊息，關鍵字為「營業時間」
      And 訊息內容已更新為「營業時間：10:00-20:00」
      When 會員發送訊息「請問營業時間」
      Then 系統回覆「營業時間：10:00-20:00」

    Example: 編輯後立即生效
      Given 系統中存在關鍵字觸發訊息，回應內容為「舊內容」
      When 使用者編輯回應內容為「新內容」
      And 使用者儲存變更
      And 會員立即發送觸發關鍵字
      Then 系統回覆「新內容」（非「舊內容」）

    Example: 編輯未儲存時使用原內容
      Given 系統中存在關鍵字觸發訊息，回應內容為「原始內容」
      When 使用者開始編輯回應內容為「修改內容」
      And 使用者未儲存變更
      And 會員發送觸發關鍵字
      Then 系統回覆「原始內容」（編輯未生效）

  # ============================================================================
  # 第十五部分：訊息清單外部顯示
  # ============================================================================

  Rule: 於訊息外部可查看訊息的停用/啟用狀態

    Example: 查看訊息啟用狀態
      Given 系統中存在自動回應訊息「歡迎訊息」，狀態為「啟用」
      When 使用者查看自動回應訊息清單
      Then 系統顯示訊息「歡迎訊息」的狀態為「啟用」

    Example: 查看訊息清單顯示混合狀態
      Given 系統中存在以下自動回應訊息
        | message_name     | is_enabled |
        | 歡迎訊息         | true       |
        | 訂房諮詢         | false      |
        | 非營業時間回覆   | true       |
        | 春節優惠         | false      |
      When 使用者查看自動回應訊息清單
      Then 系統顯示「歡迎訊息」狀態為「啟用」
      And 系統顯示「訂房諮詢」狀態為「停用」
      And 系統顯示「非營業時間回覆」狀態為「啟用」
      And 系統顯示「春節優惠」狀態為「停用」

  Rule: 於訊息外部可查看回應類型：歡迎訊息

    Example: 查看回應類型為歡迎訊息
      Given 系統中存在自動回應訊息「新會員歡迎」，回應類型為「歡迎訊息」
      When 使用者查看自動回應訊息清單
      Then 系統顯示訊息「新會員歡迎」的回應類型為「歡迎訊息」

    Example: 查看回應類型顯示圖示
      Given 系統中存在自動回應訊息「新會員歡迎」，回應類型為「歡迎訊息」
      When 使用者查看自動回應訊息清單
      Then 系統顯示該訊息的回應類型圖示「歡迎訊息」
      And 圖示顏色為藍色，區別其他類型

  Rule: 於訊息外部可查看回應類型：關鍵字

    Example: 查看回應類型為關鍵字
      Given 系統中存在自動回應訊息「訂房諮詢」，回應類型為「關鍵字」
      When 使用者查看自動回應訊息清單
      Then 系統顯示訊息「訂房諮詢」的回應類型為「關鍵字」

    Example: 查看關鍵字類型顯示關鍵字數量
      Given 系統中存在自動回應訊息「訂房諮詢」，回應類型為「關鍵字」
      And 該訊息有 5 組關鍵字
      When 使用者查看自動回應訊息清單
      Then 系統顯示該訊息的回應類型為「關鍵字 (5)」

    Example: 查看關鍵字類型顯示前三個關鍵字預覽
      Given 系統中存在自動回應訊息「訂房諮詢」，回應類型為「關鍵字」
      And 該訊息關鍵字為「訂房」「預約」「booking」「價格」「房型」
      When 使用者查看自動回應訊息清單
      Then 系統顯示關鍵字預覽「訂房, 預約, booking...」
      And 顯示總數「(5)」

  Rule: 於訊息外部可查看回應類型：指定時間

    Example: 查看回應類型為指定時間
      Given 系統中存在自動回應訊息「非營業時間回覆」，回應類型為「指定時間」
      When 使用者查看自動回應訊息清單
      Then 系統顯示訊息「非營業時間回覆」的回應類型為「指定時間」

    Example: 查看指定時間類型顯示時間區間
      Given 系統中存在自動回應訊息「非營業時間回覆」，回應類型為「指定時間」
      And 時間區間為「18:00-09:00」
      When 使用者查看自動回應訊息清單
      Then 系統顯示該訊息的回應類型為「指定時間 (18:00-09:00)」

    Example: 查看指定時間類型顯示日期區間
      Given 系統中存在自動回應訊息「春節活動」，回應類型為「指定時間」
      And 日期區間為「2025-02-01 至 2025-02-28」
      When 使用者查看自動回應訊息清單
      Then 系統顯示該訊息的回應類型為「指定時間」
      And 顯示日期區間「2025-02-01 至 2025-02-28」

  # ============================================================================
  # 第十六部分：即時預覽
  # ============================================================================

  Rule: 支援發送前的效果即時預覽

    Example: 前端模擬即時預覽自動回應訊息
      Given 使用者正在建立自動回應訊息
      When 使用者輸入訊息文字「歡迎加入，{好友的顯示名稱}！」
      Then 系統使用 LINE Simulator 在網頁上即時渲染預覽
      And 預覽區顯示訊息內容，變數標籤以特殊格式突出顯示

    Example: 即時預覽多筆訊息
      Given 使用者正在建立自動回應訊息
      And 使用者已新增 3 筆訊息
      When 使用者點擊「預覽」按鈕
      Then 系統依序顯示 3 筆訊息的預覽效果
      And 模擬訊息發送的時間間隔（1-2 秒）

    Example: 即時預覽顯示實際效果
      Given 使用者正在建立自動回應訊息
      When 使用者輸入訊息「感謝您的詢問！\n\n營業時間：09:00-18:00」
      Then 系統預覽區顯示包含換行的訊息效果
      And 預覽樣式與 LINE 實際顯示一致

  # ============================================================================
  # 第十七部分：觸發類型擴充
  # ============================================================================

  Rule: 觸發類型支援動態擴充（可透過設定檔管理）

    Example: 初始觸發類型清單
      Given 系統初始化時載入觸發類型設定
      When 管理員查看可用的觸發類型選項
      Then 系統顯示以下初始觸發類型
        | trigger_code      | trigger_name | description                    | is_enabled | priority |
        | welcome_message   | 歡迎訊息     | 會員加入好友時自動觸發歡迎訊息 | true       | 1        |
        | keyword_trigger   | 關鍵字觸發   | 會員訊息包含關鍵字時自動回應   | true       | 2        |
        | scheduled_trigger | 指定時間觸發 | 特定時間或日期區間內觸發訊息   | true       | 3        |

    Example: 新增自定義觸發類型
      Given 系統管理員需要新增「會員生日觸發」類型
      When 管理員在設定檔中新增觸發類型
        | trigger_code     | trigger_name | description                  |
        | birthday_trigger | 會員生日觸發 | 會員生日當天自動發送祝福訊息 |
      And 系統重新載入設定
      Then 使用者可選擇「會員生日觸發」作為觸發方式

    Example: 停用特定觸發類型
      Given 系統中存在「指定時間觸發」類型
      When 管理員在設定檔中將該觸發類型標記為停用
      And 系統重新載入設定
      Then 使用者無法選擇「指定時間觸發」作為觸發方式
      And 已存在的「指定時間觸發」訊息仍可正常運作

    Example: 查看所有觸發類型配置
      Given 系統載入觸發類型設定檔
      When 管理員查看觸發類型配置
      Then 系統顯示所有觸發類型的詳細資訊
        | trigger_code      | trigger_name | is_enabled | priority |
        | welcome_message   | 歡迎訊息     | true       | 1        |
        | keyword_trigger   | 關鍵字觸發   | true       | 2        |
        | scheduled_trigger | 指定時間觸發 | true       | 3        |

  # ============================================================================
  # 第十八部分：新增自動回應訊息
  # ============================================================================

  Rule: 支援新增自動回應訊息

    Example: 新增自動回應訊息
      Given 使用者已設定 2 筆自動回應訊息
      When 使用者新增第 3 筆自動回應訊息「價格查詢請訪問官網」
      Then 系統新增自動回應訊息「價格查詢請訪問官網」

    Example: 新增自動回應訊息包含關鍵字
      Given 使用者正在建立新的自動回應訊息
      When 使用者選擇觸發方式「關鍵字觸發」
      And 使用者輸入關鍵字「優惠」「折扣」
      And 使用者輸入回應內容「目前春節優惠 8 折！」
      Then 系統新增自動回應訊息「春節優惠」
      And 系統建立 2 筆關鍵字關聯記錄

    Example: 新增自動回應訊息包含時間區間
      Given 使用者正在建立新的自動回應訊息
      When 使用者選擇觸發方式「指定時間觸發」
      And 使用者設定時間區間「18:00-09:00」
      And 使用者輸入回應內容「目前為非營業時間」
      Then 系統新增自動回應訊息「非營業時間回覆」
      And 系統記錄時間區間設定
