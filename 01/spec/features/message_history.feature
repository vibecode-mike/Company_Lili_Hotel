Feature: 訊息紀錄
  作為一位使用者
  我希望看到會員最新的互動紀錄，並即時確認是否已回覆、確保會員的問題有解決
  藉此蒐集更多用戶的洞察來提升會員經營

  Rule: 顯示一對一聊天記錄，包含 LINE 會員頭像＋名稱

    Example: 查看一對一聊天記錄顯示 LINE 頭像與名稱
      Given 會員「張三」與系統有聊天記錄
      When 使用者查看與會員「張三」的聊天記錄
      Then 系統顯示會員「張三」的 LINE 頭像與名稱

  Rule: 完整記錄會員與內部人員的所有聊天內容

    Example: 完整記錄聊天內容
      Given 會員「李四」發送訊息「請問有雙人房嗎?」
      And 內部人員回覆「有的，請問您想預訂哪一天?」
      When 使用者查看聊天記錄
      Then 系統顯示以下訊息
        | sender   | content                     |
        | 會員李四 | 請問有雙人房嗎?             |
        | 內部人員 | 有的，請問您想預訂哪一天?   |

  Rule: 訊息即時更新

    Example: 會員發送訊息後即時顯示於聊天介面
      Given 內部人員正在與會員「張三」聊天
      And 系統透過 WebSocket 建立即時連線
      When 會員「張三」透過 LINE 發送訊息「請問有空房嗎?」
      Then 聊天介面在 100 毫秒內即時顯示新訊息「請問有空房嗎?」

    Example: 內部人員發送訊息後即時確認送達
      Given 內部人員正在與會員「李四」聊天
      And 系統透過 WebSocket 建立即時連線
      When 內部人員發送訊息「有的，請問您想預訂哪一天?」
      Then 系統透過 WebSocket 確認訊息已發送至 LINE 伺服器
      And 聊天介面即時顯示訊息狀態「已送達」

  Rule: WebSocket 連線中斷時顯示提示，不自動重連，由使用者手動刷新頁面

    Example: WebSocket 連線中斷時顯示提示訊息
      Given 內部人員正在與會員「張三」聊天
      And 系統透過 WebSocket 建立即時連線
      When WebSocket 連線因網路問題中斷
      Then 系統偵測到連線中斷
      And 聊天介面顯示提示訊息「連線已中斷，請刷新頁面以恢復即時連線」
      And 系統不自動嘗試重新連線

    Example: 使用者手動刷新頁面後重新建立連線
      Given 聊天介面顯示「連線已中斷，請刷新頁面以恢復即時連線」
      When 使用者手動刷新頁面（F5 或重新載入）
      Then 系統重新建立 WebSocket 連線
      And 聊天介面載入最新的訊息紀錄
      And 提示訊息消失，恢復正常使用

  Rule: 紀錄對話開啟日期，格式為 YYYY/MM/DD（week）

    Example: 記錄對話開啟日期
      Given 會員「王五」於「2025/01/20（Mon）」開始對話
      When 使用者查看聊天記錄
      Then 系統顯示對話開啟日期「2025/01/20（Mon）」

  Rule: 訊息傳送時間顯示為 12 小時制

    Example: 訊息傳送時間為 12 小時制
      Given 會員「趙六」於「14:30」發送訊息
      When 使用者查看聊天記錄
      Then 系統顯示訊息傳送時間「02:30」

  Rule: 訊息傳送時間分為上午時段（06:00-11:59）

    Example: 訊息傳送時間顯示上午（早晨）
      Given 會員「孫七」於「06:00」發送訊息
      When 使用者查看聊天記錄
      Then 系統顯示訊息時段「上午 06:00」

    Example: 訊息傳送時間顯示上午（接近中午）
      Given 會員「孫七」於「11:59」發送訊息
      When 使用者查看聊天記錄
      Then 系統顯示訊息時段「上午 11:59」

  Rule: 訊息傳送時間分為中午時段（12:00-13:59）

    Example: 訊息傳送時間顯示中午（午餐開始）
      Given 會員「周八」於「12:00」發送訊息
      When 使用者查看聊天記錄
      Then 系統顯示訊息時段「中午 12:00」

    Example: 訊息傳送時間顯示中午（午餐時段）
      Given 會員「周八」於「12:30」發送訊息
      When 使用者查看聊天記錄
      Then 系統顯示訊息時段「中午 12:30」

    Example: 訊息傳送時間顯示中午（午餐結束前）
      Given 會員「周八」於「13:59」發送訊息
      When 使用者查看聊天記錄
      Then 系統顯示訊息時段「中午 01:59」

  Rule: 訊息傳送時間分為下午時段（14:00-17:59）

    Example: 訊息傳送時間顯示下午（午休後）
      Given 會員「吳九」於「14:00」發送訊息
      When 使用者查看聊天記錄
      Then 系統顯示訊息時段「下午 02:00」

    Example: 訊息傳送時間顯示下午（下班前）
      Given 會員「吳九」於「17:59」發送訊息
      When 使用者查看聊天記錄
      Then 系統顯示訊息時段「下午 05:59」

  Rule: 訊息傳送時間分為晚上時段（18:00-23:59）

    Example: 訊息傳送時間顯示晚上（晚餐時段）
      Given 會員「鄭十」於「18:00」發送訊息
      When 使用者查看聊天記錄
      Then 系統顯示訊息時段「晚上 06:00」

    Example: 訊息傳送時間顯示晚上（就寢前）
      Given 會員「鄭十」於「23:59」發送訊息
      When 使用者查看聊天記錄
      Then 系統顯示訊息時段「晚上 11:59」

  Rule: 訊息傳送時間分為凌晨時段（00:00-05:59）

    Example: 訊息傳送時間顯示凌晨（午夜）
      Given 會員「王十一」於「00:00」發送訊息
      When 使用者查看聊天記錄
      Then 系統顯示訊息時段「凌晨 12:00」

    Example: 訊息傳送時間顯示凌晨（深夜）
      Given 會員「王十一」於「02:00」發送訊息
      When 使用者查看聊天記錄
      Then 系統顯示訊息時段「凌晨 02:00」

    Example: 訊息傳送時間顯示凌晨（清晨）
      Given 會員「王十一」於「05:59」發送訊息
      When 使用者查看聊天記錄
      Then 系統顯示訊息時段「凌晨 05:59」

  Rule: 訊息狀態標記僅顯示「已讀」

    Example: 訊息狀態顯示已讀
      Given 會員「張十二」發送訊息「您好」
      And 內部人員已讀此訊息
      When 使用者查看聊天記錄
      Then 系統顯示該訊息狀態為「已讀」

  Rule: 未讀狀態不標記

    Example: 未讀訊息不顯示狀態標記
      Given 會員「李十三」發送訊息「請問價格?」
      And 內部人員尚未讀取此訊息
      When 使用者查看聊天記錄
      Then 系統不顯示該訊息的狀態標記

  Rule: 支援發送訊息類型：純文字

    Example: 發送純文字訊息
      Given 使用者正在與會員「王十四」聊天
      When 使用者發送純文字訊息「感謝您的詢問」
      Then 會員「王十四」收到純文字訊息「感謝您的詢問」

  Rule: 支援發送訊息類型：上傳圖片

    Example: 發送圖片訊息
      Given 使用者正在與會員「趙十五」聊天
      When 使用者上傳圖片「room_photo.jpg」
      Then 會員「趙十五」收到圖片訊息「room_photo.jpg」

  Rule: 支援發送訊息類型：引用配置區設定完成的訊息模板

    Example: 發送配置區建立的訊息模板
      Given 使用者正在與會員「孫十六」聊天
      And 該模板先前已在配置區完成設定並保存
      When 使用者引用訊息模板「雙人房優惠」
      Then 會員「孫十六」收到訊息模板「雙人房優惠」，預覽區內容與 LINE 顯示一致

  Rule: 可排程指定日期與時間人工發送

    Example: 排程發送訊息
      Given 使用者正在與會員「周十七」聊天
      When 使用者排程於「2025/01/25 10:00」發送訊息「特價通知」
      Then 系統於「2025/01/25 10:00」發送訊息「特價通知」給會員「周十七」

  Rule: 訊息來源識別標註「人工回覆（顯示帳號名稱）」

    Example: 訊息來源顯示人工回覆
      Given 內部人員「客服小王」回覆會員「吳十八」
      When 使用者查看聊天記錄
      Then 系統顯示訊息來源「人工回覆（客服小王）」

  Rule: 訊息來源識別標註「訊息推播」

    Example: 訊息來源顯示訊息推播
      Given 系統透過群發功能發送訊息給會員「鄭十九」
      When 使用者查看聊天記錄
      Then 系統顯示訊息來源「訊息推播」

  Rule: 訊息來源識別標註「自動回應」

    Example: 訊息來源顯示自動回應
      Given 會員「王二十」觸發關鍵字自動回應
      When 使用者查看聊天記錄
      Then 系統顯示訊息來源「自動回應」

  Rule: 聊天頁面可部分檢視會員基本資訊

    Example: 聊天頁面顯示會員基本資訊
      Given 使用者正在與會員「張二一」聊天
      When 使用者查看會員基本資訊
      Then 系統顯示會員「張二一」的姓名、性別、生日、聯絡方式

  Rule: 聊天頁面可編輯備註

    Example: 聊天頁面編輯會員備註
      Given 使用者正在與會員「李二二」聊天
      When 使用者編輯備註「偏好週末入住」
      Then 系統記錄會員「李二二」的備註「偏好週末入住」

  Rule: 聊天頁面可檢視會員所有標籤（會員標籤＋互動標籤）

    Example: 聊天頁面顯示會員所有標籤
      Given 會員「王二三」擁有以下標籤
        | tag_name | tag_type |
        | VIP      | 會員標籤 |
        | 雙十優惠 | 互動標籤 |
      And 使用者正在與會員「王二三」聊天
      When 使用者查看會員標籤
      Then 系統顯示以下標籤
        | tag_name | tag_type |
        | VIP      | 會員標籤 |
        | 雙十優惠 | 互動標籤 |

  Rule: 聊天頁面可新增標籤

    Example: 聊天頁面新增會員標籤
      Given 使用者正在與會員「趙二四」聊天
      When 使用者新增標籤「高價值客戶」
      Then 會員「趙二四」新增標籤「高價值客戶」

  Rule: 聊天頁面可刪除標籤

    Example: 聊天頁面刪除會員標籤
      Given 會員「孫二五」擁有標籤「測試」
      And 使用者正在與會員「孫二五」聊天
      When 使用者刪除標籤「測試」
      Then 會員「孫二五」的標籤「測試」被刪除
