Feature: 訊息紀錄
  作為一位使用者
  我希望看到會員最新的互動紀錄，並即時確認是否已回覆、確保會員的問題有解決
  藉此蒐集更多用戶的洞察來提升會員經營

  Rule: 顯示一對一聊天記錄，包含 LINE 會員頭像＋名稱

    Example: 查看一對一聊天記錄顯示 LINE 頭像與名稱
      Given 會員「張三」與系統有聊天記錄
      When 使用者查看與會員「張三」的聊天記錄
      Then 系統顯示會員「張三」的 LINE 頭像與名稱

    Example: 會員未設定 LINE 頭像時顯示預設頭像
      Given 會員「李小明」未設定 LINE 頭像
      And 會員「李小明」與系統有聊天記錄
      When 使用者查看與會員「李小明」的聊天記錄
      Then 系統顯示會員「李小明」的預設頭像與名稱

    Example: 會員更改 LINE 名稱後顯示最新名稱
      Given 會員「王美麗」原本名稱為「小王」
      And 會員「王美麗」已將 LINE 名稱更改為「王美麗」
      When 使用者查看聊天記錄
      Then 系統顯示最新的會員名稱「王美麗」與對應頭像

  Rule: 完整記錄會員與內部人員的所有聊天內容

    Example: 完整記錄聊天內容
      Given 會員「李四」發送訊息「請問有雙人房嗎?」
      And 內部人員回覆「有的，請問您想預訂哪一天?」
      When 使用者查看聊天記錄
      Then 系統顯示以下訊息
        | sender   | content                     |
        | 會員李四 | 請問有雙人房嗎?             |
        | 內部人員 | 有的，請問您想預訂哪一天?   |

    Example: 記錄包含圖片與貼圖的聊天內容
      Given 會員「陳大華」發送貼圖「熊大比讚」
      And 內部人員回覆圖片「房間照片.jpg」
      And 會員「陳大華」回覆文字「看起來不錯」
      When 使用者查看聊天記錄
      Then 系統完整顯示以下訊息
        | sender     | content_type | content      |
        | 會員陳大華 | 貼圖         | 熊大比讚     |
        | 內部人員   | 圖片         | 房間照片.jpg |
        | 會員陳大華 | 文字         | 看起來不錯   |

    Example: 長時間對話完整保存所有歷史記錄
      Given 會員「林志明」在過去 6 個月內發送了 500 筆訊息
      And 內部人員在此期間回覆了 480 筆訊息
      When 使用者查看與會員「林志明」的聊天記錄
      Then 系統保存並可查詢所有 980 筆歷史訊息
      And 訊息依時間順序完整顯示

  Rule: 訊息即時更新

    Example: 會員發送訊息後即時顯示於聊天介面
      Given 內部人員正在與會員「張三」聊天
      And 系統透過 WebSocket 建立即時連線
      When 會員「張三」透過 LINE 發送訊息「請問有空房嗎?」
      Then 聊天介面在 100 毫秒內即時顯示新訊息「請問有空房嗎?」

    Example: 內部人員發送訊息後即時確認送達
      Given 內部人員正在與會員「李四」聊天
      And 系統透過 WebSocket 建立即時連線
      When 內部人員發送訊息「有的，請問您想預訂哪一天?」
      Then 系統透過 WebSocket 確認訊息已發送至 LINE 伺服器
      And 聊天介面即時顯示訊息狀態「已送達」

    Example: 多位內部人員同時與不同會員聊天時訊息即時更新
      Given 客服人員「小王」正在與會員「張三」聊天
      And 客服人員「小李」正在與會員「李四」聊天
      And 兩個聊天介面皆透過 WebSocket 建立即時連線
      When 會員「張三」發送訊息「謝謝」
      And 會員「李四」發送訊息「好的」
      Then 客服人員「小王」的聊天介面即時顯示會員「張三」的訊息「謝謝」
      And 客服人員「小李」的聊天介面即時顯示會員「李四」的訊息「好的」
      And 兩個聊天介面的訊息互不干擾

  Rule: WebSocket 斷線自動重連（固定間隔 5 秒，最多 5 次），失敗後提示手動重試

    Example: 斷線後自動重連最多 5 次
      Given 內部人員正在與會員「張三」聊天
      And 系統透過 WebSocket 建立即時連線
      When WebSocket 連線因網路問題中斷
      Then 系統在 5 秒後發起第 1 次重連
      And 若仍失敗則每隔 5 秒重連，最多重連 5 次
      And 重連成功後自動恢復即時訊息流與送達狀態

    Example: 重連超過 5 次失敗後提示手動重試
      Given 系統已嘗試 5 次重連皆失敗
      When 重連次數達上限
      Then 聊天介面顯示提示訊息「連線已中斷，已重試 5 次未恢復，請檢查網路或手動重試」
      And 系統停止自動重連
      And 提供「重新連線」按鈕讓使用者手動觸發

    Example: 連線中斷期間發送訊息的處理
      Given 內部人員正在與會員「王五」聊天
      And WebSocket 連線已中斷且正在自動重連中
      When 內部人員嘗試發送訊息「請稍候」
      Then 系統暫停送出並顯示提示「連線恢復後自動送出」
      And 若最終重連失敗（達 5 次），顯示錯誤「連線已中斷，訊息未送出，請手動重試」

  Rule: 歷史訊息採用無限滾動載入策略（向上滾動時自動載入更早訊息）

    Example: 初次開啟聊天介面載入最新訊息
      Given 內部人員開啟與會員「張三」的聊天介面
      When 聊天介面初次載入
      Then 系統自動載入最新 50 筆訊息
      And 聊天視窗捲動至最底部（顯示最新訊息）

    Example: 向上滾動時自動載入更早的歷史訊息
      Given 內部人員正在查看與會員「李四」的聊天記錄
      And 當前已載入最新 50 筆訊息
      When 內部人員向上滾動至聊天介面頂部
      Then 系統自動載入更早的 50 筆訊息
      And 保持當前閱讀位置不變（不跳回頂部）

    Example: 已載入所有歷史訊息時顯示提示
      Given 內部人員正在查看與會員「王五」的聊天記錄
      And 已載入該會員的所有歷史訊息
      When 內部人員向上滾動至聊天介面頂部
      Then 系統顯示提示「已載入所有歷史訊息」
      And 不再觸發額外的載入請求

  Rule: 紀錄對話開啟日期，格式為 YYYY/MM/DD（week）

    Example: 記錄對話開啟日期
      Given 會員「王五」於「2025/01/20（Mon）」開始對話
      When 使用者查看聊天記錄
      Then 系統顯示對話開啟日期「2025/01/20（Mon）」

    Example: 週末開始對話顯示正確的星期格式
      Given 會員「劉大明」於「2025/02/15（Sat）」開始對話
      When 使用者查看聊天記錄
      Then 系統顯示對話開啟日期「2025/02/15（Sat）」

    Example: 跨年度對話顯示正確日期格式
      Given 會員「陳小華」於「2024/12/31（Tue）」開始對話
      And 對話持續至「2025/01/02（Thu）」
      When 使用者查看聊天記錄
      Then 系統顯示對話開啟日期「2024/12/31（Tue）」

  Rule: 訊息傳送時間顯示為 12 小時制

    Example: 訊息傳送時間為 12 小時制
      Given 會員「趙六」於「14:30」發送訊息
      When 使用者查看聊天記錄
      Then 系統顯示訊息傳送時間「02:30」

    Example: 午夜時間顯示為 12 小時制
      Given 會員「黃小芳」於「00:15」發送訊息
      When 使用者查看聊天記錄
      Then 系統顯示訊息傳送時間「12:15」

    Example: 中午 12 點顯示為 12 小時制
      Given 會員「林志豪」於「12:45」發送訊息
      When 使用者查看聊天記錄
      Then 系統顯示訊息傳送時間「12:45」

  Rule: 訊息傳送時間分為上午時段（06:00-11:59）

    Example: 訊息傳送時間顯示上午（早晨）
      Given 會員「孫七」於「06:00」發送訊息
      When 使用者查看聊天記錄
      Then 系統顯示訊息時段「上午 06:00」

    Example: 訊息傳送時間顯示上午（接近中午）
      Given 會員「孫七」於「11:59」發送訊息
      When 使用者查看聊天記錄
      Then 系統顯示訊息時段「上午 11:59」

    Example: 訊息傳送時間顯示上午（上班時段）
      Given 會員「周美玲」於「09:30」發送訊息
      When 使用者查看聊天記錄
      Then 系統顯示訊息時段「上午 09:30」

  Rule: 訊息傳送時間分為中午時段（12:00-13:59）

    Example: 訊息傳送時間顯示中午（午餐開始）
      Given 會員「周八」於「12:00」發送訊息
      When 使用者查看聊天記錄
      Then 系統顯示訊息時段「中午 12:00」

    Example: 訊息傳送時間顯示中午（午餐時段）
      Given 會員「周八」於「12:30」發送訊息
      When 使用者查看聊天記錄
      Then 系統顯示訊息時段「中午 12:30」

    Example: 訊息傳送時間顯示中午（午餐結束前）
      Given 會員「周八」於「13:59」發送訊息
      When 使用者查看聊天記錄
      Then 系統顯示訊息時段「中午 01:59」

  Rule: 訊息傳送時間分為下午時段（14:00-17:59）

    Example: 訊息傳送時間顯示下午（午休後）
      Given 會員「吳九」於「14:00」發送訊息
      When 使用者查看聊天記錄
      Then 系統顯示訊息時段「下午 02:00」

    Example: 訊息傳送時間顯示下午（下班前）
      Given 會員「吳九」於「17:59」發送訊息
      When 使用者查看聊天記錄
      Then 系統顯示訊息時段「下午 05:59」

    Example: 訊息傳送時間顯示下午（下午茶時段）
      Given 會員「許文華」於「15:30」發送訊息
      When 使用者查看聊天記錄
      Then 系統顯示訊息時段「下午 03:30」

  Rule: 訊息傳送時間分為晚上時段（18:00-23:59）

    Example: 訊息傳送時間顯示晚上（晚餐時段）
      Given 會員「鄭十」於「18:00」發送訊息
      When 使用者查看聊天記錄
      Then 系統顯示訊息時段「晚上 06:00」

    Example: 訊息傳送時間顯示晚上（就寢前）
      Given 會員「鄭十」於「23:59」發送訊息
      When 使用者查看聊天記錄
      Then 系統顯示訊息時段「晚上 11:59」

    Example: 訊息傳送時間顯示晚上（黃金時段）
      Given 會員「蔡雅婷」於「20:30」發送訊息
      When 使用者查看聊天記錄
      Then 系統顯示訊息時段「晚上 08:30」

  Rule: 訊息傳送時間分為凌晨時段（00:00-05:59）

    Example: 訊息傳送時間顯示凌晨（午夜）
      Given 會員「王十一」於「00:00」發送訊息
      When 使用者查看聊天記錄
      Then 系統顯示訊息時段「凌晨 12:00」

    Example: 訊息傳送時間顯示凌晨（深夜）
      Given 會員「王十一」於「02:00」發送訊息
      When 使用者查看聊天記錄
      Then 系統顯示訊息時段「凌晨 02:00」

    Example: 訊息傳送時間顯示凌晨（清晨）
      Given 會員「王十一」於「05:59」發送訊息
      When 使用者查看聊天記錄
      Then 系統顯示訊息時段「凌晨 05:59」

  Rule: 訊息狀態標記僅顯示「已讀」

    Example: 訊息狀態顯示已讀
      Given 會員「張十二」發送訊息「您好」
      And 內部人員已讀此訊息
      When 使用者查看聊天記錄
      Then 系統顯示該訊息狀態為「已讀」

    Example: 多筆訊息部分已讀時僅標記已讀訊息
      Given 會員「楊建國」發送以下訊息
        | message        | is_read |
        | 請問有房間嗎？ | true    |
        | 雙人房多少錢？ | true    |
        | 可以延遲退房嗎 | false   |
      When 使用者查看聊天記錄
      Then 系統顯示前兩筆訊息狀態為「已讀」
      And 第三筆訊息不顯示任何狀態標記

    Example: 內部人員發送的訊息不顯示已讀狀態
      Given 內部人員發送訊息「有的，請問您想預訂哪一天？」給會員「吳佩珊」
      And 會員「吳佩珊」已讀取此訊息
      When 使用者查看聊天記錄
      Then 內部人員發送的訊息不顯示「已讀」狀態標記

  Rule: 未讀狀態不標記

    Example: 未讀訊息不顯示狀態標記
      Given 會員「李十三」發送訊息「請問價格?」
      And 內部人員尚未讀取此訊息
      When 使用者查看聊天記錄
      Then 系統不顯示該訊息的狀態標記

    Example: 會員連續發送多筆未讀訊息均不顯示狀態
      Given 會員「張文傑」發送以下訊息
        | message          |
        | 你好             |
        | 請問有空房嗎？   |
        | 我想預訂雙人房   |
      And 內部人員尚未讀取這些訊息
      When 使用者查看聊天記錄
      Then 所有訊息均不顯示狀態標記

    Example: 未讀訊息後來被讀取後狀態更新
      Given 會員「林佳慧」發送訊息「請問價格多少？」
      And 內部人員尚未讀取此訊息
      And 使用者查看聊天記錄時不顯示狀態標記
      When 內部人員讀取該訊息
      And 使用者再次查看聊天記錄
      Then 系統顯示該訊息狀態為「已讀」

  Rule: 支援發送訊息類型：純文字

    Example: 發送純文字訊息
      Given 使用者正在與會員「王十四」聊天
      When 使用者發送純文字訊息「感謝您的詢問」
      Then 會員「王十四」收到純文字訊息「感謝您的詢問」

    Example: 發送包含特殊字元的純文字訊息
      Given 使用者正在與會員「陳志強」聊天
      When 使用者發送純文字訊息「房價：NT$2,500/晚（含早餐）」
      Then 會員「陳志強」收到純文字訊息「房價：NT$2,500/晚（含早餐）」
      And 特殊字元正確顯示

    Example: 發送長篇純文字訊息
      Given 使用者正在與會員「黃麗華」聊天
      When 使用者發送包含 500 字的純文字訊息說明房型詳情
      Then 會員「黃麗華」完整收到 500 字的純文字訊息
      And 訊息內容無截斷或遺失


  Rule: 支援發送訊息類型：引用配置區設定完成的訊息草稿

    Example: 發送配置區建立的訊息草稿
      Given 使用者正在與會員「孫十六」聊天
      And 該草稿先前已在配置區完成設定並保存
      When 使用者引用訊息草稿「雙人房優惠」
      Then 會員「孫十六」收到訊息模板「雙人房優惠」，預覽區內容與 LINE 顯示一致

    Example: 引用不存在的訊息草稿時顯示錯誤
      Given 使用者正在與會員「劉子揚」聊天
      When 使用者嘗試引用不存在的訊息草稿「豪華套房優惠」
      Then 系統顯示錯誤提示「找不到指定的訊息草稿」
      And 訊息未發送

    Example: 發送包含圖文的訊息草稿
      Given 使用者正在與會員「許雅文」聊天
      And 訊息草稿「週末特惠」包含圖片與文字說明
      When 使用者引用訊息草稿「週末特惠」
      Then 會員「許雅文」收到包含圖片與文字的完整訊息
      And 圖片與文字排版與草稿預覽一致

  Rule: 可排程指定日期與時間人工發送

    Example: 排程發送訊息
      Given 使用者正在與會員「周十七」聊天
      When 使用者排程於「2025/01/25 10:00」發送訊息「特價通知」
      Then 系統於「2025/01/25 10:00」發送訊息「特價通知」給會員「周十七」

    Example: 排程過去時間時顯示錯誤
      Given 使用者正在與會員「鄭明輝」聊天
      And 當前時間為「2025/01/25 15:00」
      When 使用者嘗試排程於「2025/01/25 14:00」發送訊息
      Then 系統顯示錯誤提示「排程時間不能為過去時間」
      And 訊息未被排程

    Example: 取消已排程的訊息
      Given 使用者已排程於「2025/01/26 09:00」發送訊息給會員「吳淑芬」
      And 當前時間為「2025/01/25 18:00」
      When 使用者取消該排程訊息
      Then 系統取消排程
      And 訊息於「2025/01/26 09:00」不會發送

  Rule: 訊息來源識別標註「人工回覆（顯示帳號名稱）」

    Example: 訊息來源顯示人工回覆
      Given 內部人員「客服小王」回覆會員「吳十八」
      When 使用者查看聊天記錄
      Then 系統顯示訊息來源「人工回覆（客服小王）」

    Example: 不同內部人員回覆時顯示各自帳號名稱
      Given 內部人員「客服小李」回覆會員「張秀英」訊息「您好」
      And 內部人員「經理王大明」回覆會員「張秀英」訊息「我們會為您特別安排」
      When 使用者查看聊天記錄
      Then 第一筆訊息顯示來源「人工回覆（客服小李）」
      And 第二筆訊息顯示來源「人工回覆（經理王大明）」

    Example: 排程發送的人工訊息顯示原排程人員名稱
      Given 內部人員「客服小陳」排程於「2025/01/27 10:00」發送訊息給會員「林雅萍」
      When 系統於「2025/01/27 10:00」發送該訊息
      And 使用者查看聊天記錄
      Then 系統顯示訊息來源「人工回覆（客服小陳）」

  Rule: 訊息來源識別標註「訊息推播」

    Example: 訊息來源顯示訊息推播
      Given 系統透過群發功能發送訊息給會員「鄭十九」
      When 使用者查看聊天記錄
      Then 系統顯示訊息來源「訊息推播」

    Example: 排程群發訊息標註為訊息推播
      Given 系統已排程於「2025/01/28 09:00」群發優惠訊息給所有 VIP 會員
      And 會員「趙國強」是 VIP 會員
      When 系統於「2025/01/28 09:00」發送訊息
      And 使用者查看會員「趙國強」的聊天記錄
      Then 系統顯示該訊息來源「訊息推播」

    Example: 針對特定標籤會員群發的訊息標註為訊息推播
      Given 系統透過群發功能發送「週年慶活動」訊息給標籤「高價值客戶」的所有會員
      And 會員「蔡麗娟」擁有「高價值客戶」標籤
      When 使用者查看會員「蔡麗娟」的聊天記錄
      Then 系統顯示該訊息來源「訊息推播」

  Rule: 訊息來源識別標註「自動回應」

    Example: 訊息來源顯示自動回應
      Given 會員「王二十」觸發關鍵字自動回應
      When 使用者查看聊天記錄
      Then 系統顯示訊息來源「自動回應」

    Example: 關鍵字觸發的自動回應標註來源
      Given 系統設定關鍵字「價格」觸發自動回應「房價資訊請參考...」
      And 會員「黃志明」發送訊息「請問價格多少？」
      When 系統自動回覆「房價資訊請參考...」
      And 使用者查看聊天記錄
      Then 系統顯示該回覆訊息來源「自動回應」

    Example: 歡迎訊息自動回應標註來源
      Given 系統設定新會員加入好友時自動發送歡迎訊息
      And 會員「林雅婷」剛加入好友
      When 系統自動發送歡迎訊息「感謝您加入我們！」
      And 使用者查看聊天記錄
      Then 系統顯示該訊息來源「自動回應」

  Rule: 聊天頁面可部分檢視會員基本資訊

    Example: 聊天頁面顯示會員基本資訊
      Given 使用者正在與會員「張二一」聊天
      When 使用者查看會員基本資訊
      Then 系統顯示會員「張二一」的姓名、性別、生日、聯絡方式

    Example: 會員資訊不完整時顯示已填寫欄位
      Given 會員「陳建華」僅填寫姓名與性別
      And 未填寫生日與聯絡方式
      When 使用者查看會員「陳建華」的基本資訊
      Then 系統顯示已填寫的姓名與性別
      And 未填寫的欄位顯示「未提供」

    Example: 會員基本資訊即時更新顯示
      Given 使用者正在與會員「王淑芬」聊天
      And 會員「王淑芬」的生日資訊為「未提供」
      When 會員「王淑芬」透過 PMS 系統更新生日為「1985/06/15」
      And 系統同步會員資訊
      Then 聊天頁面即時顯示更新後的生日「1985/06/15」

  Rule: 聊天頁面可編輯備註

    Example: 聊天頁面編輯會員備註
      Given 使用者正在與會員「李二二」聊天
      When 使用者編輯備註「偏好週末入住」
      Then 系統記錄會員「李二二」的備註「偏好週末入住」

    Example: 更新已存在的會員備註
      Given 會員「劉建明」已有備註「需要無障礙房間」
      And 使用者正在與會員「劉建明」聊天
      When 使用者修改備註為「需要無障礙房間，偏好一樓」
      Then 系統更新會員「劉建明」的備註為「需要無障礙房間，偏好一樓」
      And 舊備註被覆蓋

    Example: 清空會員備註
      Given 會員「黃美玲」已有備註「對海鮮過敏」
      And 使用者正在與會員「黃美玲」聊天
      When 使用者清空備註內容
      Then 系統移除會員「黃美玲」的備註
      And 備註欄位顯示為空

  Rule: 聊天頁面可檢視會員所有標籤（會員標籤＋互動標籤）

    Example: 聊天頁面顯示會員所有標籤
      Given 會員「王二三」擁有以下標籤
        | tag_name | tag_type |
        | VIP      | 會員標籤 |
        | 雙十優惠 | 互動標籤 |
      And 使用者正在與會員「王二三」聊天
      When 使用者查看會員標籤
      Then 系統顯示以下標籤
        | tag_name | tag_type |
        | VIP      | 會員標籤 |
        | 雙十優惠 | 互動標籤 |

    Example: 會員無任何標籤時顯示空白
      Given 會員「李建宏」沒有任何標籤
      And 使用者正在與會員「李建宏」聊天
      When 使用者查看會員標籤
      Then 系統顯示「此會員尚無標籤」

    Example: 標籤區分顯示會員標籤與互動標籤
      Given 會員「張雅琪」擁有以下標籤
        | tag_name   | tag_type |
        | 黃金會員   | 會員標籤 |
        | 常客       | 會員標籤 |
        | 春節活動   | 互動標籤 |
        | 已點擊連結 | 互動標籤 |
      And 使用者正在與會員「張雅琪」聊天
      When 使用者查看會員標籤
      Then 系統分別顯示會員標籤「黃金會員」、「常客」
      And 系統分別顯示互動標籤「春節活動」、「已點擊連結」

  Rule: 聊天頁面可新增標籤

    Example: 聊天頁面新增會員標籤
      Given 使用者正在與會員「趙二四」聊天
      When 使用者新增標籤「高價值客戶」
      Then 會員「趙二四」新增標籤「高價值客戶」

    Example: 新增已存在的系統標籤
      Given 系統已有預設標籤「VIP」
      And 會員「周志豪」尚未擁有「VIP」標籤
      And 使用者正在與會員「周志豪」聊天
      When 使用者從標籤列表選擇「VIP」標籤
      Then 會員「周志豪」新增標籤「VIP」

    Example: 新增自訂標籤並立即顯示
      Given 使用者正在與會員「林淑華」聊天
      When 使用者新增自訂標籤「需要停車位」
      Then 系統建立新標籤「需要停車位」
      And 會員「林淑華」新增標籤「需要停車位」
      And 標籤列表即時顯示該標籤

  Rule: 聊天頁面可刪除標籤

    Example: 聊天頁面刪除會員標籤
      Given 會員「孫二五」擁有標籤「測試」
      And 使用者正在與會員「孫二五」聊天
      When 使用者刪除標籤「測試」
      Then 會員「孫二五」的標籤「測試」被刪除

    Example: 刪除多個標籤中的一個
      Given 會員「蔡志偉」擁有以下標籤
        | tag_name   |
        | VIP        |
        | 常客       |
        | 春節活動   |
      And 使用者正在與會員「蔡志偉」聊天
      When 使用者刪除標籤「春節活動」
      Then 會員「蔡志偉」的標籤「春節活動」被刪除
      And 會員「蔡志偉」仍保有標籤「VIP」、「常客」

    Example: 刪除會員標籤不影響其他會員
      Given 會員「吳佳玲」擁有標籤「測試標籤」
      And 會員「鄭明華」也擁有標籤「測試標籤」
      And 使用者正在與會員「吳佳玲」聊天
      When 使用者刪除會員「吳佳玲」的標籤「測試標籤」
      Then 會員「吳佳玲」的標籤「測試標籤」被刪除
      And 會員「鄭明華」仍保有標籤「測試標籤」
