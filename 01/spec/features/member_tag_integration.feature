Feature: 會員標籤串接
  作為一位行銷人員
  我希望在整合其他平台資料時，可看到該會員的消費習慣，自動整合貼標
  以便後續規劃的廣告活動能鎖定更精準的受眾

  Rule: 會員標籤來源支援外部系統平台（CRM/PMS）串接

    Example: 外部系統串接後呈現命中的會員標籤
      Given 外部系統 PMS 回傳會員「張三」的消費紀錄
        | name | id_number | consumption_amount | room_type |
        | 張三 | A123456789 | 50000             | 商務房    |
      When 系統比對會員姓名「張三」和身分證「A123456789」
      Then 系統為會員「張三」新增以下標籤
        | tag_name | tag_source |
        | 商務房   | PMS        |

  Rule: 會員標籤來源支援問券蒐集會員資料的模組

    Example: 問券蒐集後呈現命中的特徵標籤
      Given 問券系統回傳會員「李四」的資料
        | name | gender | age | region  | birthday_month |
        | 李四 | 男     | 28  | 台北市  | 8              |
      When 系統處理問券資料
      Then 系統為會員「李四」新增以下標籤
        | tag_name    | tag_source |
        | 男          | 問券       |
        | 26-35 歲    | 問券       |
        | 台北市      | 問券       |
        | 8月         | 問券       |

  Rule: 當外部平台回傳會員消費紀錄或屬性資料時，系統自動比對會員姓名、身分證（唯一值）並命中標籤

    Example: 系統自動比對會員並命中標籤
      Given 系統中存在會員「王五」，身分證「B987654321」
      And 外部系統 CRM 回傳消費紀錄
        | name | id_number  | consumption_amount |
        | 王五 | B987654321 | 80000              |
      When 系統比對會員資料
      Then 系統為會員「王五」新增標籤「高消費客戶」

  Rule: 支援外部串接的標籤，命中可以是複數多個

    Example: 外部串接命中多個標籤
      Given 外部系統 PMS 回傳會員「趙六」的消費紀錄
        | name | id_number  | consumption_amount | room_type | visit_count |
        | 趙六 | C111222333 | 100000             | 雙人房    | 5           |
      When 系統比對會員資料並套用標籤規則
      Then 系統為會員「趙六」新增以下標籤
        | tag_name       | tag_source |
        | 雙人房         | PMS        |
        | 高消費客戶     | PMS        |
        | 常客           | PMS        |

  Rule: 支援外部串接的標籤自動產生邏輯須支援自訂條件，如今年消費金額達指定門檻

    Example: 管理員設定消費金額門檻後自動貼標
      Given 管理員設定標籤規則「高消費客戶」，觸發條件為「累積消費 >= 50000 元」
      And 外部系統 PMS 回傳會員「張三」的消費紀錄，累積消費「80000 元」
      When 系統套用標籤規則
      Then 系統為會員「張三」新增標籤「高消費客戶」

  Rule: 支援外部串接的標籤自動產生邏輯須支援自訂條件，如消費依房型分類

    Example: 管理員設定房型分類條件後自動貼標
      Given 管理員設定標籤規則「豪華套房愛好者」，觸發條件為「房型 = 豪華套房」
      And 外部系統 PMS 回傳會員「李四」的消費紀錄，房型「豪華套房」
      When 系統套用標籤規則
      Then 系統為會員「李四」新增標籤「豪華套房愛好者」

  Rule: 支援外部串接的標籤自動產生邏輯須支援自訂條件，如訪問頻率

    Example: 管理員設定訪問頻率條件後自動貼標
      Given 管理員設定標籤規則「常客」，觸發條件為「一年內住宿次數 >= 5 次」
      And 外部系統 PMS 回傳會員「王五」的消費紀錄，一年內住宿次數「7 次」
      When 系統套用標籤規則
      Then 系統為會員「王五」新增標籤「常客」

  Rule: 支援外部串接的標籤自動產生邏輯須支援自訂條件，如上次互動時間

    Example: 管理員設定上次互動時間條件後自動貼標
      Given 管理員設定標籤規則「沉睡會員」，觸發條件為「最後互動距今 > 90 天」
      And 外部系統 CRM 回傳會員「趙六」的資料，最後互動日期「2024/08/01」，今日「2024/12/15」
      When 系統套用標籤規則
      Then 系統為會員「趙六」新增標籤「沉睡會員」

  Rule: 支援問券蒐集會員資料的模組，命中可以是複數多個

    Example: 問券蒐集命中多個標籤
      Given 問券系統回傳會員「錢七」的資料
        | name | gender | age | region  | birthday_month |
        | 錢七 | 女     | 32  | 新北市  | 10             |
      When 系統處理問券資料
      Then 系統為會員「錢七」新增以下標籤
        | tag_name    | tag_source |
        | 女          | 問券       |
        | 26-35 歲    | 問券       |
        | 新北市      | 問券       |
        | 10月        | 問券       |

  Rule: 支援問券蒐集標籤自動產生性別比對

    Example: 問券蒐集自動產生性別標籤
      Given 問券系統回傳會員性別「男」
      When 系統處理問券資料
      Then 系統為該會員新增標籤「男」

  Rule: 支援問券蒐集標籤自動產生年齡區間比對

    Example: 問券蒐集自動產生年齡區間標籤
      Given 問券系統回傳會員年齡「28」
      When 系統處理問券資料
      Then 系統為該會員新增標籤「26-35 歲」

  Rule: 支援問券蒐集標籤自動產生地區比對

    Example: 問券蒐集自動產生地區標籤
      Given 問券系統回傳會員居住地「台北市」
      When 系統處理問券資料
      Then 系統為該會員新增標籤「台北市」

  Rule: 支援問券蒐集標籤自動產生生日月份比對

    Example: 問券蒐集自動產生生日月份標籤
      Given 問券系統回傳會員生日月份「8」
      When 系統處理問券資料
      Then 系統為該會員新增標籤「8月」

  Rule: 串接後會員資料中，顯示各來源標籤

    Example: 會員資料顯示標籤來源
      Given 會員「孫八」擁有以下標籤
        | tag_name   | tag_source |
        | VIP        | CRM        |
        | 商務房     | PMS        |
        | 雙十優惠   | LINE OA    |
      When 行銷人員查看會員「孫八」的資料
      Then 系統顯示以下標籤及來源
        | tag_name   | tag_source |
        | VIP        | CRM        |
        | 商務房     | PMS        |
        | 雙十優惠   | LINE OA    |

  Rule: 可編輯既有的會員標籤

    Example: 編輯會員標籤
      Given 會員「周九」擁有標籤「VIP」
      When 行銷人員將標籤「VIP」編輯為「VVIP」
      Then 會員「周九」的標籤更新為「VVIP」

  Rule: 刪除會員標籤時二次確認彈窗

    Example: 刪除會員標籤時彈窗確認
      Given 會員「吳十」擁有標籤「黑名單」
      When 行銷人員刪除標籤「黑名單」
      Then 系統彈窗確認是否刪除

  Rule: 於會員管理設定頁可手動輸入新標籤

    Example: 手動新增會員標籤
      Given 會員「鄭十一」不擁有任何標籤
      When 行銷人員為會員「鄭十一」手動新增標籤「潛在客戶」
      Then 會員「鄭十一」新增標籤「潛在客戶」

  Rule: 手動新增標籤時自動排除重複標籤

    Example: 手動新增重複標籤時操作失敗
      Given 會員「王十二」擁有標籤「VIP」
      When 行銷人員為會員「王十二」手動新增標籤「VIP」
      Then 操作失敗

  Rule: 新增標籤後即時反映於標籤管理頁

    Example: 新增會員標籤後標籤管理頁立即更新
      Given 行銷人員在會員管理設定頁為會員「鄭十一」手動新增標籤「潛在客戶」
      When 標籤新增成功
      Then 標籤管理頁立即顯示新標籤「潛在客戶」，無需手動刷新頁面

  Rule: 單筆會員標籤不得超過 20 個字

    Example: 新增標籤名稱超過 20 個字時操作失敗
      Given 會員「張十三」不擁有任何標籤
      When 行銷人員為會員「張十三」新增標籤「超過二十個中文字元的標籤名稱測試超過二十個中文字元的標籤名稱測試」
      Then 操作失敗

  Rule: 若同一會員重複串接的相同消費紀錄，系統僅記錄一次貼標

    Example: 重複串接相同消費紀錄僅記錄一次
      Given 會員「李十四」已從 PMS 系統獲得標籤「商務房」
      And 外部系統 PMS 再次回傳相同的消費紀錄
        | name   | id_number  | room_type |
        | 李十四 | D444555666 | 商務房    |
      When 系統處理串接資料
      Then 會員「李十四」的標籤「商務房」觸發次數不增加
