Feature: 建立訊息推播
  作為一位行銷人員
  我希望建立訊息並支援排程推播，同時能夠精準鎖定目標受眾並提前預估發送配額
  以便高效部署和管理我的品牌行銷活動

  Rule: 支援兩種模板來源：從模板庫選擇或建立新模板

    Example: 選擇模板來源選項
      Given 行銷人員正在建立群發訊息
      When 行銷人員查看模板來源選項
      Then 系統顯示兩個選項
        | 選項         | 描述                   |
        | 從模板庫選擇 | 選擇既有模板快速起步   |
        | 建立新模板   | 從空白開始設計全新模板 |

  Rule: 從模板庫選擇既有模板（複製機制）

    Example: 從模板庫選擇模板
      Given 行銷人員選擇「從模板庫選擇」
      And 模板庫中存在模板「春節促銷」（is_in_library = true）
      When 行銷人員選擇模板「春節促銷」
      Then 系統複製模板「春節促銷」建立新 MessageTemplate 記錄
      And 系統記錄 source_template_id 為原始模板ID
      And 系統將原始模板的 usage_count 累加 1
      And 新模板 is_in_library 預設為 false（僅限該群發使用）

    Example: 複製後可獨立編輯
      Given 行銷人員從模板庫選擇模板「春節促銷」並複製
      When 行銷人員編輯新模板的標題為「端午特惠」
      Then 系統更新新模板的標題為「端午特惠」
      And 原始模板「春節促銷」保持不變
      And 其他使用原始模板的群發不受影響

  Rule: 建立新模板（從空白開始）

    Example: 從空白建立新模板
      Given 行銷人員選擇「建立新模板」
      When 行銷人員在配置區填寫欄位
      Then 系統建立新 MessageTemplate 記錄
      And source_template_id 為 NULL（從空白建立）
      And is_in_library 預設為 false

  Rule: 建立群發時可選擇是否將模板加入模板庫

    Example: 將新建模板加入模板庫
      Given 行銷人員完成群發訊息設定
      And 該模板為新建或從模板庫複製而來
      When 行銷人員勾選「將此模板加入模板庫」
      And 輸入模板名稱「端午特惠」
      Then 系統設定 is_in_library = true
      And 系統設定 template_name = 「端午特惠」
      And 該模板會顯示在模板庫供未來選擇

    Example: 不加入模板庫
      Given 行銷人員完成群發訊息設定
      When 行銷人員未勾選「將此模板加入模板庫」
      Then 系統設定 is_in_library = false
      And 該模板僅限該群發使用，不會顯示在模板庫

  Rule: 模板庫顯示與篩選

    Example: 模板庫只顯示已加入的模板
      Given 系統中存在以下模板
        | template_name | is_in_library |
        | 春節促銷      | true          |
        | 端午特惠      | true          |
        | 臨時活動      | false         |
      When 行銷人員開啟模板庫
      Then 系統顯示以下模板
        | template_name |
        | 春節促銷      |
        | 端午特惠      |
      And 不顯示「臨時活動」（is_in_library = false）

    Example: 模板庫按使用次數排序（熱門優先）
      Given 模板庫中存在以下模板
        | template_name | usage_count |
        | 春節促銷      | 15          |
        | 新會員歡迎    | 8           |
        | VIP專屬       | 23          |
      When 行銷人員開啟模板庫並選擇「熱門優先」排序
      Then 系統依序顯示
        | 排序 | template_name | usage_count |
        | 1    | VIP專屬       | 23          |
        | 2    | 春節促銷      | 15          |
        | 3    | 新會員歡迎    | 8           |

    Example: 模板庫按建立時間排序（最新優先）
      Given 模板庫中存在以下模板
        | template_name | created_at      |
        | 春節促銷      | 2025/01/15 10:00|
        | 端午特惠      | 2025/05/20 14:30|
        | 雙十活動      | 2025/10/05 09:15|
      When 行銷人員開啟模板庫並選擇「最新優先」排序
      Then 系統依序顯示
        | 排序 | template_name | created_at      |
        | 1    | 雙十活動      | 2025/10/05 09:15|
        | 2    | 端午特惠      | 2025/05/20 14:30|
        | 3    | 春節促銷      | 2025/01/15 10:00|

    Example: 模板庫搜尋功能
      Given 模板庫中存在模板「春節促銷」、「春節限定」、「端午特惠」
      When 行銷人員在搜尋框輸入「春節」
      Then 系統顯示包含「春節」的模板
        | template_name |
        | 春節促銷      |
        | 春節限定      |
      And 不顯示「端午特惠」

  Rule: 訊息發送之前，支援訊息效果的即時模擬與預覽功能

    Example: 前端模擬即時預覽訊息內容
      Given 行銷人員正在建立群發訊息
      And 該模板於配置區設定為圖卡按鈕型，預覽區即時顯示對應視覺效果
      When 行銷人員輸入標題「春節優惠」、內文「限時特惠中」、金額「3999」
      Then 系統使用 LINE Simulator 在網頁上即時渲染預覽
      And 預覽區顯示標題「春節優惠」、內文「限時特惠中」、金額「NT$ 3,999」

    Example: 前端模擬預覽輪播圖卡切換效果
      Given 行銷人員正在建立群發訊息
      And 已新增 3 張輪播圖卡
      When 行銷人員切換至第 2 張圖卡
      Then 系統使用 LINE Simulator 即時渲染第 2 張圖卡的內容
      And 預覽區可手動滾動查看所有圖卡

  Rule: 必須能夠選擇傳送對象：所有好友

    Example: 選擇傳送對象為所有好友
      Given 行銷人員正在建立群發訊息
      When 行銷人員選擇傳送對象「所有好友」
      Then 系統設定傳送對象為「所有好友」

  Rule: 必須能夠選擇傳送對象：篩選目標對象

    Example: 選擇傳送對象為篩選目標對象
      Given 行銷人員正在建立群發訊息
      When 行銷人員選擇傳送對象「篩選目標對象」
      Then 系統設定傳送對象為「篩選目標對象」

  Rule: 篩選目標對象依據會員標籤進行篩選

    Example: 依會員標籤篩選目標對象
      Given 行銷人員正在建立群發訊息
      And 系統中存在會員標籤「VIP」
      When 行銷人員篩選會員標籤「VIP」
      Then 系統篩選擁有標籤「VIP」的會員作為目標對象

  Rule: 篩選條件組合邏輯：包含條件（AND）+ 排除條件（AND NOT）

    Example: 包含多個標籤的 AND 邏輯
      Given 行銷人員正在建立群發訊息
      When 行銷人員設定篩選條件「包含標籤：VIP, 台北市」
      Then 系統篩選同時擁有標籤「VIP」和「台北市」的會員（AND 邏輯）

    Example: 包含條件 + 排除條件的組合
      Given 行銷人員正在建立群發訊息
      When 行銷人員設定篩選條件「包含標籤：VIP, 台北市」「排除標籤：黑名單, 已發送」
      Then 系統篩選同時擁有「VIP」和「台北市」但不擁有「黑名單」和「已發送」的會員

    Example: 僅排除條件
      Given 行銷人員正在建立群發訊息
      When 行銷人員設定篩選條件「排除標籤：黑名單」
      Then 系統篩選不擁有標籤「黑名單」的所有會員

    Example: 多個包含條件的 AND 邏輯
      Given 行銷人員正在建立群發訊息
      When 行銷人員設定篩選條件「包含標籤：26-35歲, 女性, 台北市」
      Then 系統篩選同時擁有標籤「26-35歲」、「女性」、「台北市」的會員（三個條件全部 AND）

  Rule: 會員標籤資料來源為問卷系統，包含生日月份

    Example: 依生日月份篩選會員
      Given 行銷人員正在建立群發訊息
      When 行銷人員篩選生日月份「8月」
      Then 系統篩選生日月份為「8月」的會員

  Rule: 會員標籤資料來源為問卷系統，包含年齡區間

    Example: 依年齡區間篩選會員
      Given 行銷人員正在建立群發訊息
      When 行銷人員篩選年齡區間「26-35 歲」
      Then 系統篩選年齡區間為「26-35 歲」的會員

  Rule: 會員標籤資料來源為問卷系統，包含居住地區（限制為台灣 22 縣市）

    Example: 依居住地區篩選會員
      Given 行銷人員正在建立群發訊息
      When 行銷人員篩選居住地區「台北市」
      Then 系統篩選居住地區為「台北市」的會員
      And 地區選項限制為台灣 22 縣市標準名稱

    Example: 地區篩選值域限制
      Given 行銷人員正在選擇居住地區篩選條件
      When 行銷人員查看可用的地區選項
      Then 系統顯示 22 個台灣縣市選項
      And 選項包含：台北市、新北市、桃園市、台中市、台南市、高雄市、基隆市、新竹市、嘉義市、新竹縣、苗栗縣、彰化縣、南投縣、雲林縣、嘉義縣、屏東縣、宜蘭縣、花蓮縣、台東縣、澎湖縣、金門縣、連江縣

  Rule: 會員標籤資料來源為問卷系統，包含性別

    Example: 依性別篩選會員
      Given 行銷人員正在建立群發訊息
      When 行銷人員篩選性別「女」
      Then 系統篩選性別為「女」的會員

  Rule: 會員標籤資料來源為後台建立自訂標籤

    Example: 依後台自訂標籤篩選會員
      Given 行銷人員正在建立群發訊息
      And 系統中存在後台自訂標籤「潛在客戶」
      When 行銷人員篩選標籤「潛在客戶」
      Then 系統篩選擁有標籤「潛在客戶」的會員

  Rule: 使用者能夠選擇立即傳送

    Example: 選擇立即傳送訊息
      Given 行銷人員已完成群發訊息設定
      When 行銷人員選擇「立即傳送」
      Then 系統立即發送訊息

  Rule: 使用者能夠選擇於指定日期與時間進行排程傳送（以台灣時間顯示，UTC 儲存）

    Example: 選擇台灣時間排程，系統轉換為 UTC 儲存
      Given 行銷人員已完成群發訊息設定
      When 行銷人員選擇排程於台灣時間「2025/02/01 10:00」傳送
      Then 前端計算 UTC 時間為「2025-02-01T02:00:00Z」（台灣時間 -8 小時）
      And 系統儲存 scheduled_datetime_utc 為「2025-02-01T02:00:00Z」
      And 前端顯示給使用者的排程時間為「2025/02/01 10:00」（台灣時間）

    Example: 顯示既有排程時轉換回台灣時間
      Given 系統儲存的排程時間為「2025-02-01T02:00:00Z」（UTC）
      When 行銷人員查看該排程訊息
      Then 前端從 UTC 轉換為台灣時間（+8 小時）
      And 前端顯示排程時間為「2025/02/01 10:00」（台灣時間）

  Rule: 後端排程任務以 UTC 時間為基準觸發發送

    Example: 排程時間已到，觸發發送
      Given 系統儲存的排程時間為「2025-02-01T02:00:00Z」（UTC）
      And 當前 UTC 時間為「2025-02-01T02:00:00Z」
      When 排程任務檢查待發送訊息
      Then 系統觸發該訊息發送
      And 更新 send_status 為「已發送」

    Example: 排程時間未到，不觸發發送
      Given 系統儲存的排程時間為「2025-02-01T02:00:00Z」（UTC）
      And 當前 UTC 時間為「2025-02-01T01:59:59Z」
      When 排程任務檢查待發送訊息
      Then 系統不觸發該訊息發送
      And send_status 保持為「排程發送」

    Example: 排程時間已過，立即觸發
      Given 系統儲存的排程時間為「2025-02-01T02:00:00Z」（UTC）
      And 當前 UTC 時間為「2025-02-01T02:05:00Z」（已過排程時間 5 分鐘）
      When 排程任務檢查待發送訊息
      Then 系統立即觸發該訊息發送
      And 更新 send_status 為「已發送」

  Rule: 使用者可選擇訊息特定的觸發條件，如加入好友期間的 7～29天

    Example: 設定加入好友期間觸發條件
      Given 行銷人員正在建立群發訊息
      When 行銷人員設定觸發條件「加入好友 7～29 天」
      Then 系統篩選加入好友 7～29 天的會員作為目標對象
      And 計算邏輯為「加入天數 >= 7 且 <= 29」（含頭尾）

    Example: 加入好友期間計算邏輯（含頭尾）
      Given 今日為「2025/11/12」
      And 系統中存在以下會員及其加入日期
        | member_name | join_date  | 加入天數 |
        | 會員A       | 2025/11/05 | 7天      |
        | 會員B       | 2025/11/04 | 8天      |
        | 會員C       | 2025/10/14 | 29天     |
        | 會員D       | 2025/10/13 | 30天     |
        | 會員E       | 2025/11/06 | 6天      |
      When 行銷人員設定篩選條件「加入好友 7～29 天」
      Then 系統篩選出以下會員
        | member_name | join_date  | 加入天數 |
        | 會員A       | 2025/11/05 | 7天      |
        | 會員B       | 2025/11/04 | 8天      |
        | 會員C       | 2025/10/14 | 29天     |
      And 會員D 不符合條件（30天，超出範圍）
      And 會員E 不符合條件（6天，未達最小天數）

    Example: 邊界值測試：第 7 天和第 29 天都包含
      Given 今日為「2025/11/12」
      And 會員「張三」於「2025/11/05」加入（恰好 7 天）
      And 會員「李四」於「2025/10/14」加入（恰好 29 天）
      When 行銷人員設定篩選條件「加入好友 7～29 天」
      Then 會員「張三」符合條件（>= 7 天）
      And 會員「李四」符合條件（<= 29 天）

  Rule: 在確認發送前，系統必須顯示此次訊息的預計發送好友人數

    Example: 顯示預計發送好友人數
      Given 行銷人員已完成群發訊息設定
      And 符合篩選條件的會員共 500 人
      When 行銷人員準備確認發送
      Then 系統顯示預計發送好友人數「500」

  Rule: 在確認發送前，系統必須顯示當前可用訊息的配額用量

    Example: 顯示可用訊息配額用量
      Given 行銷人員已完成群發訊息設定
      And 當前可用訊息配額為 1000 則
      When 行銷人員準備確認發送
      Then 系統顯示可用訊息配額「1000」

  Rule: 若可用訊息的配額用量小於預計發送的好友人數，系統須阻擋發送行為

    Example: 配額不足時阻擋發送
      Given 行銷人員已完成群發訊息設定
      And 預計發送好友人數為 1500 人
      And 可用訊息配額為 1000 則
      When 行銷人員確認發送
      Then 操作失敗

  Rule: 若可用訊息的配額用量小於預計發送的好友人數，系統須向使用者顯示明確的提示

    Example: 配額不足時顯示提示
      Given 行銷人員已完成群發訊息設定
      And 預計發送好友人數為 1500 人
      And 可用訊息配額為 1000 則
      When 行銷人員確認發送
      Then 系統顯示提示「訊息配額不足，無法發送」

  Rule: 當編輯到一半，離開視窗則彈窗提示

    Example: 任何欄位變更後離開視窗觸發提示
      Given 行銷人員正在建立群發訊息
      And 行銷人員已修改任一欄位（如訊息模板、傳送對象、排程時間等）
      And 變更尚未儲存為草稿或發送
      When 行銷人員嘗試離開視窗（關閉分頁或跳轉至其他頁面）
      Then 系統顯示彈窗提示「您有未儲存的變更，確定要離開嗎？」
      And 使用者可選擇「留在此頁」或「離開」

    Example: 未修改任何欄位時離開視窗不觸發提示
      Given 行銷人員開啟建立群發訊息頁面
      And 尚未修改任何欄位
      When 行銷人員嘗試離開視窗
      Then 系統不顯示彈窗提示
      And 直接離開頁面

  Rule: 可以將未完成設定的群發訊息儲存為草稿（必須已選擇模板）

    Example: 儲存群發訊息為草稿（已選擇模板但內容未填）
      Given 行銷人員選擇「建立新模板」
      And MessageTemplate 記錄已建立（template_id 存在）
      But 尚未填寫任何內容欄位（text_content, image_url, title 等皆為空）
      When 行銷人員選擇「儲存為草稿」
      Then 系統將訊息儲存為草稿（send_status = 草稿）
      And 系統保留 Message 與 MessageTemplate 的 1:1 關聯
      And 草稿清單顯示「空白模板」

    Example: 儲存群發訊息為草稿（從模板庫選擇但未完成設定）
      Given 行銷人員從模板庫選擇模板「春節促銷」並複製
      And 已修改部分內容（如標題改為「端午優惠」）
      But 尚未設定發送對象與排程時間
      When 行銷人員選擇「儲存為草稿」
      Then 系統將訊息儲存為草稿
      And 已填寫的內容（標題、圖片等）保留在 MessageTemplate
      And 未填寫的欄位保持空值

    Example: 未選擇模板無法儲存草稿
      Given 行銷人員進入群發訊息建立頁面
      But 尚未選擇「從模板庫選擇」或「建立新模板」
      When 行銷人員選擇「儲存為草稿」
      Then 系統顯示錯誤訊息「請先選擇模板來源」
      And 不允許儲存草稿

  Rule: 儲存的草稿支援隨時可開啟編輯

    Example: 開啟草稿編輯
      Given 系統中存在訊息草稿「春節優惠」
      And 該草稿關聯的 MessageTemplate 包含部分內容
      When 行銷人員開啟草稿「春節優惠」進行編輯
      Then 系統載入草稿「春節優惠」的所有設定內容
      And 系統載入 MessageTemplate 的所有欄位（包含已填與空白欄位）
      And 行銷人員可繼續編輯並再次儲存

    Example: 開啟空白草稿編輯
      Given 系統中存在草稿，關聯的 MessageTemplate 內容完全空白
      When 行銷人員開啟該草稿進行編輯
      Then 系統載入空白模板
      And 行銷人員可從頭開始填寫內容

  Rule: 圖片上傳後由後端自動裁切為正方形（1:1 比例）

    Example: 上傳橫向圖片（16:9）自動裁切
      Given 行銷人員正在建立訊息模板
      When 行銷人員上傳橫向圖片「banner.jpg」（尺寸：1600x900）
      Then 前端顯示 CSS 模擬預覽（300x300 正方形，取中心區域）
      And 前端上傳圖片到後端
      And 後端計算裁切區域：取中心 900x900 正方形
      And 後端裁切圖片並儲存
      And 後端返回裁切後圖片 URL
      And 前端更新 image_url 為裁切後圖片 URL
      And 前端重新載入裁切後圖片顯示在預覽區

    Example: 上傳直向圖片（9:16）自動裁切
      Given 行銷人員正在建立訊息模板
      When 行銷人員上傳直向圖片「portrait.jpg」（尺寸：900x1600）
      Then 後端計算裁切區域：取中心 900x900 正方形
      And 後端裁切圖片並儲存
      And 前端顯示裁切後圖片（正方形）

    Example: 上傳已是正方形圖片（1:1）
      Given 行銷人員正在建立訊息模板
      When 行銷人員上傳正方形圖片「square.jpg」（尺寸：800x800）
      Then 後端不需裁切（已是正方形）
      And 後端直接儲存原圖
      And 前端顯示原圖

  Rule: 圖片檔案大小限制為 1 MB

    Example: 上傳檔案大小超過 1 MB
      Given 行銷人員正在上傳圖片
      When 行銷人員選擇檔案大小為「1.5 MB」的圖片
      Then 前端顯示錯誤訊息「圖片檔案大小不可超過 1 MB」
      And 前端阻擋上傳操作

    Example: 上傳檔案大小符合限制
      Given 行銷人員正在上傳圖片
      When 行銷人員選擇檔案大小為「800 KB」的圖片
      Then 前端允許上傳
      And 後端接收並處理圖片

  Rule: 前端使用 CSS 模擬裁切預覽

    Example: 上傳前預覽模擬裁切效果
      Given 行銷人員選擇了橫向圖片「banner.jpg」
      When 前端顯示預覽
      Then 前端使用 CSS object-fit: cover 顯示圖片
      And 前端設定 object-position: center 取中心區域
      And 預覽區顯示正方形圖片（模擬裁切效果）
      And 預覽區顯示提示文字「預覽（實際發送時將裁切為正方形）」

  Rule: 前端上傳完成後重新載入實際裁切後圖片

    Example: 上傳完成後更新預覽為實際裁切圖
      Given 行銷人員已上傳圖片「banner.jpg」
      And 後端已完成裁切並返回 URL「https://cdn.com/cropped_banner.jpg」
      When 前端接收到後端返回的 URL
      Then 前端更新 image_url 為「https://cdn.com/cropped_banner.jpg」
      And 前端重新載入該 URL 的圖片顯示在預覽區
      And 預覽區顯示實際裁切後的圖片（100%準確）
