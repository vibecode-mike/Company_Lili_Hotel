# TDD ç¶ ç‡ˆéšæ®µï¼šè®“æ¸¬è©¦é€šé

## ç›®æ¨™

åœ¨ TDD ç´…ç‡ˆéšæ®µå·²ç¶“å¯«å¥½æ¸¬è©¦ä¸¦ç¢ºèªå¤±æ•—ï¼ˆç´…ç‡ˆ ğŸ”´ï¼‰ã€‚ç¾åœ¨é€²å…¥ç¶ ç‡ˆéšæ®µï¼š

**å¯«æœ€å°‘çš„ç¨‹å¼ç¢¼è®“æ¸¬è©¦é€šéï¼Œä¸æ–· trial-and-error ç›´åˆ°æ‰€æœ‰æ¸¬è©¦è®Šç¶ ã€‚**

---

## æ ¸å¿ƒåŸå‰‡

### 1. æœ€å°å¢é‡é–‹ç™¼åŸå‰‡

åªå¯«è®“æ¸¬è©¦é€šéæ‰€éœ€çš„æœ€å°‘ç¨‹å¼ç¢¼ï¼Œä¸è¦å¤šåšã€‚

**ç¯„ä¾‹ (Python)**ï¼š
```python
# âŒ åšå¤ªå¤šäº†ï¼ˆæ¸¬è©¦æ²’è¦æ±‚ï¼‰
def add_item(product_id, quantity):
    validate_product_exists(product_id)  # æ²’æ¸¬è©¦
    log_operation(product_id)            # æ²’æ¸¬è©¦
    send_notification()                  # æ²’æ¸¬è©¦
    self.items.append(...)

# âœ… å‰›å¥½å¤ ï¼ˆåªå¯¦ä½œæ¸¬è©¦è¦æ±‚çš„ï¼‰
def add_item(product_id, quantity):
    self.items.append({"product_id": product_id, "quantity": quantity})
```

### 2. Trial-and-Error æµç¨‹

```
1. åŸ·è¡Œæ¸¬è©¦ â†’ çœ‹å“ªå€‹å¤±æ•—
2. å¯«æœ€å°‘çš„ç¨‹å¼ç¢¼ä¿®æ­£
3. åŸ·è¡Œæ¸¬è©¦ â†’ é‚„æœ‰å¤±æ•—ï¼Ÿ
4. é‡è¤‡ 2-3ï¼Œç›´åˆ°å…¨éƒ¨é€šé
```

**ä¸è¦ä¸€æ¬¡å¯«å®Œ**ï¼Œè®“æ¸¬è©¦é©…å‹•ä½ ä¸€æ­¥æ­¥å®Œæˆã€‚

---

## Service / Repository è·è²¬åˆ†é…

### Repository è·è²¬ï¼šè³‡æ–™å­˜å–

- è² è²¬å„²å­˜ã€æŸ¥è©¢ã€åˆªé™¤è³‡æ–™
- åªç®¡è³‡æ–™çš„ CRUDï¼Œä¸ç®¡æ¥­å‹™é‚è¼¯

**å¯¦ä½œç­–ç•¥ï¼ˆæ ¹æ“šå°ˆæ¡ˆæƒ…æ³ï¼‰ï¼š**

#### æƒ…æ³ 1ï¼šå°ˆæ¡ˆä½¿ç”¨ ORM

Repository ä½œç‚º **Adapter**ï¼Œå°è£ ORMï¼ˆAdapteeï¼‰çš„ä½¿ç”¨é‚è¼¯ã€‚

**ç¯„ä¾‹ (Python with SQLAlchemy)**ï¼š
```python
# Repository æ˜¯ Adapterï¼Œå°è£ ORM
class OrderRepository:
    def __init__(self, session):
        self.session = session  # ORM session (Adaptee)
    
    def save(self, order):
        """å°è£ ORM çš„å„²å­˜é‚è¼¯"""
        self.session.add(order)
        self.session.commit()
    
    def find_by_id(self, order_id):
        """å°è£ ORM çš„æŸ¥è©¢é‚è¼¯"""
        return self.session.query(Order).filter_by(id=order_id).first()
```

#### æƒ…æ³ 2ï¼šå°ˆæ¡ˆæ²’æœ‰ ORM

ç›´æ¥å¯¦ä½œ **Fake Repository**ï¼Œç”¨è¨˜æ†¶é«”å…§çš„è³‡æ–™çµæ§‹ï¼ˆå¦‚ dictã€mapã€hashmapï¼‰æ¨¡æ“¬ DB æ“ä½œã€‚

**ç¯„ä¾‹ (Python)**ï¼š
```python
# Fake Repositoryï¼Œæ¨¡æ“¬ DB æ“ä½œ
class OrderRepository:
    def __init__(self):
        self.orders = {}  # ç”¨ dict æ¨¡æ“¬è³‡æ–™åº«
    
    def save(self, order):
        """æ¨¡æ“¬å„²å­˜åˆ°è³‡æ–™åº«"""
        self.orders[order.id] = order
    
    def find_by_id(self, order_id):
        """æ¨¡æ“¬å¾è³‡æ–™åº«æŸ¥è©¢"""
        return self.orders.get(order_id)
    
    def find_by_customer(self, customer_id):
        """æ¨¡æ“¬è¤‡é›œæŸ¥è©¢"""
        return [o for o in self.orders.values() if o.customer_id == customer_id]
```

**é—œéµåŸå‰‡**ï¼šç„¡è«–ä½¿ç”¨å“ªç¨®æ–¹å¼ï¼ŒRepository çš„ä»‹é¢ï¼ˆå¦‚ saveã€find ç­‰æ–¹æ³•ï¼‰ä¿æŒä¸€è‡´ï¼ŒService ä¸éœ€è¦çŸ¥é“åº•å±¤å¯¦ä½œç´°ç¯€ã€‚

### Service è·è²¬ï¼šæ¥­å‹™é‚è¼¯

- è² è²¬å¯¦ä½œæ¥­å‹™è¦å‰‡å’Œæµç¨‹
- é€é repository è®€å–å’Œå„²å­˜è³‡æ–™
- **å¿…é ˆæ”¯æ´ä¾è³´æ³¨å…¥**ï¼ˆæ¸¬è©¦æ‰èƒ½æ³¨å…¥ repositoryï¼‰

**ç¯„ä¾‹ (Python)**ï¼š
```python
class OrderService:
    def __init__(self, order_repository=None):
        # æ”¯æ´ä¾è³´æ³¨å…¥
        self.order_repository = order_repository or OrderRepository()
    
    def create_order(self, customer_id, amount):
        # æ¥­å‹™è¦å‰‡æª¢æŸ¥
        if amount <= 0:
            raise InvalidArgumentError("é‡‘é¡å¿…é ˆå¤§æ–¼ 0")
        
        # æ¥­å‹™é‚è¼¯ï¼šå‰µå»ºè¨‚å–®
        order_id = generate_order_id()
        order = Order(order_id, customer_id, amount, status="å¾…ä»˜æ¬¾")
        
        # é€é repository å„²å­˜
        self.order_repository.save(order)
        
        return order_id
    
    def cancel_order(self, order_id):
        # é€é repository è®€å–
        order = self.order_repository.find_by_id(order_id)
        if not order:
            raise OrderNotFoundError("è¨‚å–®ä¸å­˜åœ¨")
        
        # æ¥­å‹™è¦å‰‡æª¢æŸ¥
        if order.status == "å·²å®Œæˆ":
            raise InvalidStateError("å·²å®Œæˆè¨‚å–®ç„¡æ³•å–æ¶ˆ")
        
        # æ¥­å‹™é‚è¼¯ï¼šä¿®æ”¹ç‹€æ…‹
        order.status = "å·²å–æ¶ˆ"
        
        # é€é repository å„²å­˜
        self.order_repository.save(order)
```

### ç‚ºä»€éº¼éœ€è¦ä¾è³´æ³¨å…¥ï¼Ÿ

**è®“æ¸¬è©¦å’Œ Service ä½¿ç”¨åŒä¸€å€‹ repository å¯¦ä¾‹ã€‚**

**ç¯„ä¾‹ (Python)**ï¼š
```python
# æ¸¬è©¦æª”æ¡ˆ
def test_å‰µå»ºè¨‚å–®():
    # 1. å‰µå»º repository
    repository = OrderRepository()
    
    # 2. æ³¨å…¥åˆ° service
    service = OrderService(order_repository=repository)
    
    # 3. åŸ·è¡Œæ“ä½œ
    order_id = service.create_order("C001", 1000)
    
    # 4. é€éåŒä¸€å€‹ repository é©—è­‰ï¼ˆé—œéµï¼ï¼‰
    order = repository.find_by_id(order_id)
    assert order.status == "å¾…ä»˜æ¬¾"
```

å¦‚æœä¸æ”¯æ´ä¾è³´æ³¨å…¥ï¼Œæ¸¬è©¦å’Œ Service æœƒä½¿ç”¨ä¸åŒçš„ repositoryï¼Œæ¸¬è©¦å°±ç„¡æ³•é©—è­‰ç‹€æ…‹è®ŠåŒ–ã€‚

---

## å®Œæˆæ¢ä»¶

ç¶ ç‡ˆéšæ®µå®Œæˆçš„æ¨™æº–ï¼š

- âœ… åŸ·è¡Œæ¸¬è©¦æ¡†æ¶ï¼Œå…¨éƒ¨æ¸¬è©¦é€šéï¼ˆç¶ ç‡ˆ ğŸŸ¢ï¼‰
- âœ… æ²’æœ‰ç·¨è­¯/åŸ·è¡ŒéŒ¯èª¤
- âœ… ç¨‹å¼ç¢¼ç°¡å–®ç›´æ¥

**ä¸éœ€è¦**ï¼š
- âŒ ç¨‹å¼ç¢¼å„ªé›…ï¼ˆç•™çµ¦é‡æ§‹éšæ®µï¼‰
- âŒ æ•ˆèƒ½å„ªåŒ–ï¼ˆç•™çµ¦é‡æ§‹éšæ®µï¼‰
- âŒ å®Œæ•´éŒ¯èª¤è™•ç†ï¼ˆæ¸¬è©¦æ²’è¦æ±‚å°±ä¸åšï¼‰

---

## è¨˜ä½

1. **æ¸¬è©¦é©…å‹•ä½ ** - ä¸è¦çŒœæ¸¬éœ€è¦ä»€éº¼ï¼Œè®“å¤±æ•—çš„æ¸¬è©¦å‘Šè¨´ä½ 
2. **æœ€å°å¯¦ä½œ** - åªå¯«é€šéæ¸¬è©¦éœ€è¦çš„ç¨‹å¼ç¢¼
3. **ä¾è³´æ³¨å…¥** - Service å¿…é ˆæ”¯æ´æ³¨å…¥ repository
4. **Trial-and-Error** - åŸ·è¡Œæ¸¬è©¦ â†’ ä¿®æ­£ â†’ å†åŸ·è¡Œï¼Œä¸æ–·å¾ªç’°

å®Œæˆç¶ ç‡ˆå¾Œï¼Œé€²å…¥é‡æ§‹éšæ®µ â™»ï¸
