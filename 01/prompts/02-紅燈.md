# Test Implementation - ç´…ç‡ˆç”Ÿæˆå™¨

## Role
å°‡æ¸¬è©¦æ¨£æ¿ï¼ˆç´”è¨»è§£ï¼‰è½‰æ›ç‚ºå¯åŸ·è¡Œçš„æ¸¬è©¦ç¨‹å¼ç¢¼ï¼Œä¾ç…§è¨»è§£ä¸­çš„ Handler Prompt æŒ‡å¼•ç”Ÿæˆå°æ‡‰çš„ç¨‹å¼ç¢¼ï¼Œç”Ÿæˆç´…ç‡ˆæ¸¬è©¦ã€‚

## Core Task
æ¸¬è©¦æ¨£æ¿ï¼ˆè¨»è§£ï¼‰â†’ å¯åŸ·è¡Œæ¸¬è©¦ç¨‹å¼ç¢¼ï¼ˆç´…ç‡ˆï¼‰

## Input
1. æ¸¬è©¦æ–¹æ³•ï¼ˆåŒ…å«è¨»è§£æ¨£æ¿ï¼Œä¾†è‡ª 01-Feature-to-æ¸¬è©¦æ¨£æ¿.mdï¼‰
2. DBMLï¼ˆAggregate å®šç¾©ï¼‰
3. Tech Stackï¼ˆé è¨­ Python + pytestï¼‰
4. Handler Promptsï¼ˆhandlers/ è³‡æ–™å¤¾ä¸­çš„æ‰€æœ‰ Handlerï¼‰

## Output

### 1. æ¸¬è©¦ç¨‹å¼ç¢¼
å®Œæ•´çš„æ¸¬è©¦ç¨‹å¼ç¢¼ï¼ŒåŒ…å«ï¼š
- å¿…è¦çš„ import
- repository å’Œ service åˆå§‹åŒ–
- å®Œæ•´çš„æ¸¬è©¦æ–¹æ³•å¯¦ä½œ
- æ‰€æœ‰æ¸¬è©¦é‚è¼¯å®Œæ•´å¯¦ä½œ

### 2. ä»‹é¢å®šç¾©
**å¦‚æœæ¸¬è©¦ä¸­éœ€è¦ç”¨åˆ°çš„é¡åˆ¥æˆ–ä»‹é¢å°šä¸å­˜åœ¨**ï¼Œå‰‡åœ¨ src/ ä¸­å®šç¾©ï¼š
- Entity é¡åˆ¥ï¼ˆå¦‚ `LessonProgress`ï¼‰
- Repository é¡åˆ¥ï¼ˆå¦‚ `LessonProgressRepository`ï¼‰
- Service é¡åˆ¥ï¼ˆå¦‚ `LessonService`ï¼‰

**âš ï¸ é—œéµåŸå‰‡ï¼šåƒ…å®šç¾©ä»‹é¢ï¼Œä¸å¯¦ä½œå…§éƒ¨é‚è¼¯**
- é¡åˆ¥å’Œæ–¹æ³•å®šç¾©å®Œæ•´ï¼ˆåŒ…å«åƒæ•¸ï¼‰
- æ–¹æ³•å…§éƒ¨ä¸å¯¦ä½œï¼Œæˆ–æ‹‹å‡º `NotImplementedError`
- æˆ–è¿”å› `None` / ç©ºå€¼

---

## ğŸ”´ ç´…ç‡ˆéšæ®µçš„æ ¸å¿ƒåŸå‰‡

### âœ… è¦åšçš„äº‹
1. **å®Œæ•´å¯¦ä½œæ¸¬è©¦ç¨‹å¼ç¢¼**ï¼šæ¸¬è©¦é‚è¼¯å¿…é ˆå®Œæ•´ä¸”æ­£ç¢º
2. **å®šç¾©æ‰€éœ€ä»‹é¢**ï¼šåœ¨å°ˆæ¡ˆä¸­çš„å¯¦éš›ç¨‹å¼çš„ source root (e.g., src/) ä¸­å‰µå»ºæ¸¬è©¦éœ€è¦å®šç¾©çš„é¡åˆ¥å’Œæ–¹æ³•ç°½å
3. **ä¿æŒä»‹é¢ç‚ºç©ºå¯¦ä½œ**ï¼šé¡åˆ¥æ–¹æ³•å…§éƒ¨ã€Œä¸ã€å¯¦ä½œæ¥­å‹™é‚è¼¯

### âŒ ä¸è¦åšçš„äº‹
1. **ä¸è¦å¯¦ä½œæ¥­å‹™é‚è¼¯**ï¼šservice å’Œ repository çš„æ–¹æ³•å…§éƒ¨ä¿æŒç©ºç™½
2. **ä¸è¦è®“æ¸¬è©¦é€šé**ï¼šæ¸¬è©¦æ‡‰è©²å› ç‚ºå¯¦ä½œç©ºç™½è€Œå¤±æ•—ï¼ˆç´…ç‡ˆï¼‰
3. **ä¸è¦è·³éä»‹é¢å®šç¾©**ï¼šæ¸¬è©¦éœ€è¦çš„ä»‹é¢å¿…é ˆå®šç¾©ï¼Œå¦å‰‡æ¸¬è©¦ç„¡æ³•åŸ·è¡Œ

### ç‚ºä»€éº¼è¦é€™æ¨£ï¼Ÿ
é€™æ˜¯ TDD çš„æ ¸å¿ƒæµç¨‹ï¼š
1. **ç´…ç‡ˆ**ï¼šå¯«æ¸¬è©¦ + å®šç¾©ä»‹é¢ï¼ˆæ¸¬è©¦å¤±æ•—ï¼‰â† æˆ‘å€‘ç¾åœ¨åœ¨é€™
2. **ç¶ ç‡ˆ**ï¼šå¯¦ä½œæœ€å°å¯è¡Œé‚è¼¯ï¼ˆæ¸¬è©¦é€šéï¼‰
3. **é‡æ§‹**ï¼šå„ªåŒ–ç¨‹å¼ç¢¼å“è³ªï¼ˆæ¸¬è©¦æŒçºŒé€šéï¼‰

---

## Execution Steps

### Step 1: è®€å–æ¸¬è©¦æ¨£æ¿
è­˜åˆ¥æ¸¬è©¦æ–¹æ³•ä¸­çš„æ¯å€‹è¨»è§£å€å¡ŠåŠå…¶å°æ‡‰çš„ Handler Prompt

```python
def test_æˆåŠŸå¢åŠ å½±ç‰‡é€²åº¦():
    # Given ç”¨æˆ¶ "Alice" åœ¨èª²ç¨‹ 1 çš„é€²åº¦ç‚º 70%ï¼Œç‹€æ…‹ç‚º "é€²è¡Œä¸­"
    # [äº‹ä»¶é¢¨æš´éƒ¨ä½: Aggregate - LessonProgress]
    # [ç”Ÿæˆåƒè€ƒ Prompt: Aggregate-Given-Handler.md]
    
    # When ç”¨æˆ¶ "Alice" æ›´æ–°èª²ç¨‹ 1 çš„å½±ç‰‡é€²åº¦ç‚º 80%
    # [äº‹ä»¶é¢¨æš´éƒ¨ä½: Command - update_video_progress]
    # [ç”Ÿæˆåƒè€ƒ Prompt: Command-Handler.md]
    
    # Then æ“ä½œæˆåŠŸ
    # [ç”Ÿæˆåƒè€ƒ Prompt: Success-Failure-Handler.md]
    
    # And ç”¨æˆ¶ "Alice" åœ¨èª²ç¨‹ 1 çš„é€²åº¦æ‡‰ç‚º 80%
    # [äº‹ä»¶é¢¨æš´éƒ¨ä½: Aggregate - LessonProgress]
    # [ç”Ÿæˆåƒè€ƒ Prompt: Aggregate-Then-Handler.md]
```

### Step 2: é€æ­¥ç”Ÿæˆç¨‹å¼ç¢¼
æ ¹æ“šæ¯å€‹è¨»è§£å€å¡Šçš„ Handler Prompt ç”Ÿæˆå°æ‡‰çš„ç¨‹å¼ç¢¼

#### ç¯„ä¾‹æµç¨‹

**Given å€å¡Š**ï¼š
- Handler: Aggregate-Given-Handler.md
- ç”Ÿæˆ: å‰µå»º entity â†’ repository.save()

**When å€å¡Š**ï¼š
- Handler: Command-Handler.md
- ç”Ÿæˆ: service.method()

**Then å€å¡Š**ï¼š
- Handler: Success-Failure-Handler.md
- ç”Ÿæˆ: ï¼ˆä¸éœ€è¦é¡å¤–ç¨‹å¼ç¢¼ï¼Œå› ç‚ºæ˜¯ã€Œæ“ä½œæˆåŠŸã€ï¼‰

**And å€å¡Š**ï¼š
- Handler: Aggregate-Then-Handler.md
- ç”Ÿæˆ: repository.find() â†’ assert entity.field

### Step 3: ç”Ÿæˆæ¸¬è©¦æ¡†æ¶
åŒ…å« repositoryã€service åˆå§‹åŒ–ç­‰å¿…è¦ç¨‹å¼ç¢¼

---

## Complete Example

### Inputï¼ˆæ¸¬è©¦æ¨£æ¿ï¼‰

```python
def test_æˆåŠŸå¢åŠ å½±ç‰‡é€²åº¦():
    # Given ç”¨æˆ¶ "Alice" åœ¨èª²ç¨‹ 1 çš„é€²åº¦ç‚º 70%ï¼Œç‹€æ…‹ç‚º "é€²è¡Œä¸­"
    # [äº‹ä»¶é¢¨æš´éƒ¨ä½: Aggregate - LessonProgress]
    # [ç”Ÿæˆåƒè€ƒ Prompt: Aggregate-Given-Handler.md]
    
    # When ç”¨æˆ¶ "Alice" æ›´æ–°èª²ç¨‹ 1 çš„å½±ç‰‡é€²åº¦ç‚º 80%
    # [äº‹ä»¶é¢¨æš´éƒ¨ä½: Command - update_video_progress]
    # [ç”Ÿæˆåƒè€ƒ Prompt: Command-Handler.md]
    
    # Then æ“ä½œæˆåŠŸ
    # [ç”Ÿæˆåƒè€ƒ Prompt: Success-Failure-Handler.md]
    
    # And ç”¨æˆ¶ "Alice" åœ¨èª²ç¨‹ 1 çš„é€²åº¦æ‡‰ç‚º 80%
    # [äº‹ä»¶é¢¨æš´éƒ¨ä½: Aggregate - LessonProgress]
    # [ç”Ÿæˆåƒè€ƒ Prompt: Aggregate-Then-Handler.md]
```

### Output 1ï¼ˆæ¸¬è©¦ç¨‹å¼ç¢¼ - tests/test_01_å¢åŠ å½±ç‰‡é€²åº¦.pyï¼‰

```python
import pytest
from src.lesson_service import LessonService
from src.lesson_progress_repository import LessonProgressRepository
from src.lesson_progress import LessonProgress

def test_æˆåŠŸå¢åŠ å½±ç‰‡é€²åº¦():
    # Arrange: åˆå§‹åŒ– repository å’Œ service
    repository = LessonProgressRepository()
    service = LessonService(lesson_progress_repository=repository)
    
    # Given ç”¨æˆ¶ "Alice" åœ¨èª²ç¨‹ 1 çš„é€²åº¦ç‚º 70%ï¼Œç‹€æ…‹ç‚º "é€²è¡Œä¸­"
    # [ä½¿ç”¨ Aggregate-Given-Handler.md]
    progress = LessonProgress(
        user_id="Alice",
        lesson_id=1,
        progress=70,
        status="IN_PROGRESS"
    )
    repository.save(progress)
    
    # When ç”¨æˆ¶ "Alice" æ›´æ–°èª²ç¨‹ 1 çš„å½±ç‰‡é€²åº¦ç‚º 80%
    # [ä½¿ç”¨ Command-Handler.md]
    service.update_video_progress(user_id="Alice", lesson_id=1, progress=80)
    
    # Then æ“ä½œæˆåŠŸ
    # [ä½¿ç”¨ Success-Failure-Handler.md]
    # ï¼ˆä¸éœ€è¦é¡å¤–ç¨‹å¼ç¢¼ï¼‰
    
    # And ç”¨æˆ¶ "Alice" åœ¨èª²ç¨‹ 1 çš„é€²åº¦æ‡‰ç‚º 80%
    # [ä½¿ç”¨ Aggregate-Then-Handler.md]
    updated_progress = repository.find(user_id="Alice", lesson_id=1)
    assert updated_progress.progress == 80
```

### Output 2ï¼ˆä»‹é¢å®šç¾© - src/lesson_progress.pyï¼‰

```python
class LessonProgress:
    """èª²ç¨‹é€²åº¦ Entity"""
    
    def __init__(self, user_id: str, lesson_id: int, progress: int, status: str):
        self.user_id = user_id
        self.lesson_id = lesson_id
        self.progress = progress
        self.status = status
```

### Output 3ï¼ˆä»‹é¢å®šç¾© - src/lesson_progress_repository.pyï¼‰

```python
from typing import Optional
from src.lesson_progress import LessonProgress

class LessonProgressRepository:
    """èª²ç¨‹é€²åº¦ Repository - åƒ…å®šç¾©ä»‹é¢ï¼Œä¸å¯¦ä½œ"""
    
    def save(self, progress: LessonProgress) -> None:
        """ä¿å­˜èª²ç¨‹é€²åº¦ - ç´…ç‡ˆéšæ®µï¼šç©ºå¯¦ä½œ"""
        raise NotImplementedError("ç´…ç‡ˆéšæ®µï¼šå°šæœªå¯¦ä½œ")
    
    def find(self, user_id: str, lesson_id: int) -> Optional[LessonProgress]:
        """æŸ¥è©¢èª²ç¨‹é€²åº¦ - ç´…ç‡ˆéšæ®µï¼šç©ºå¯¦ä½œ"""
        raise NotImplementedError("ç´…ç‡ˆéšæ®µï¼šå°šæœªå¯¦ä½œ")
```

### Output 4ï¼ˆä»‹é¢å®šç¾© - src/lesson_service.pyï¼‰

```python
from src.lesson_progress_repository import LessonProgressRepository

class LessonService:
    """èª²ç¨‹æœå‹™ - åƒ…å®šç¾©ä»‹é¢ï¼Œä¸å¯¦ä½œ"""
    
    def __init__(self, lesson_progress_repository: LessonProgressRepository):
        self.lesson_progress_repository = lesson_progress_repository
    
    def update_video_progress(self, user_id: str, lesson_id: int, progress: int) -> None:
        """æ›´æ–°å½±ç‰‡é€²åº¦ - ç´…ç‡ˆéšæ®µï¼šç©ºå¯¦ä½œ"""
        raise NotImplementedError("ç´…ç‡ˆéšæ®µï¼šå°šæœªå¯¦ä½œ")
```

### é æœŸçµæœï¼šæ¸¬è©¦åŸ·è¡Œæœƒå¤±æ•—ï¼ˆç´…ç‡ˆï¼‰ğŸ”´

```bash
$ pytest tests/test_01_å¢åŠ å½±ç‰‡é€²åº¦.py::test_æˆåŠŸå¢åŠ å½±ç‰‡é€²åº¦ -v

FAILED tests/test_01_å¢åŠ å½±ç‰‡é€²åº¦.py::test_æˆåŠŸå¢åŠ å½±ç‰‡é€²åº¦
NotImplementedError: ç´…ç‡ˆéšæ®µï¼šå°šæœªå¯¦ä½œ
```

**é€™å°±æ˜¯ç´…ç‡ˆ**ï¼š
- âœ… æ¸¬è©¦ç¨‹å¼ç¢¼å®Œæ•´ä¸”æ­£ç¢º
- âœ… ä»‹é¢å®šç¾©å®Œæ•´ï¼ˆé¡åˆ¥ã€æ–¹æ³•ã€åƒæ•¸ï¼‰
- âœ… æ¥­å‹™é‚è¼¯æœªå¯¦ä½œï¼ˆæ‹‹å‡º NotImplementedErrorï¼‰
- âœ… æ¸¬è©¦åŸ·è¡Œæœƒå¤±æ•—

---

## Critical Rules

### R1: æ¸¬è©¦ç¨‹å¼ç¢¼å¿…é ˆå®Œæ•´
æ¸¬è©¦é‚è¼¯å¿…é ˆå®Œæ•´å¯¦ä½œï¼Œä¸èƒ½æœ‰ `pass` æˆ–ç©ºç™½ã€‚

```python
# âœ… æ­£ç¢ºï¼šå®Œæ•´çš„æ¸¬è©¦é‚è¼¯
def test_example():
    repository = ExampleRepository()
    service = ExampleService(repository)
    entity = Example(id=1, name="test")
    repository.save(entity)
    service.do_something(id=1)
    result = repository.find(id=1)
    assert result.name == "expected"

# âŒ éŒ¯èª¤ï¼šæ¸¬è©¦é‚è¼¯ä¸å®Œæ•´
def test_example():
    pass
```

### R2: ä»‹é¢å®šç¾©å¿…é ˆå®Œæ•´ï¼Œä½†ä¸å¯¦ä½œ
é¡åˆ¥å’Œæ–¹æ³•ç°½åå®Œæ•´ï¼Œä½†å…§éƒ¨ä¸å¯¦ä½œæ¥­å‹™é‚è¼¯ã€‚

```python
# âœ… æ­£ç¢ºï¼šå®šç¾©å®Œæ•´ï¼Œä¸å¯¦ä½œ
class ExampleService:
    def do_something(self, id: int) -> None:
        raise NotImplementedError("ç´…ç‡ˆéšæ®µï¼šå°šæœªå¯¦ä½œ")

# âŒ éŒ¯èª¤ï¼šå¯¦ä½œäº†æ¥­å‹™é‚è¼¯
class ExampleService:
    def do_something(self, id: int) -> None:
        entity = self.repository.find(id)
        entity.process()
        self.repository.save(entity)
```

### R3: ä»‹é¢å¿…é ˆæ”¾åœ¨ src/ ç›®éŒ„
æ‰€æœ‰æ¥­å‹™é‚è¼¯ç›¸é—œçš„é¡åˆ¥éƒ½æ”¾åœ¨ src/ ç›®éŒ„ä¸­ã€‚

```
âœ… æ­£ç¢ºçµæ§‹ï¼š
src/
  - lesson_progress.py           # Entity
  - lesson_progress_repository.py  # Repository
  - lesson_service.py            # Service
tests/
  - test_01_å¢åŠ å½±ç‰‡é€²åº¦.py      # æ¸¬è©¦

âŒ éŒ¯èª¤ï¼šåœ¨ tests/ ä¸­å®šç¾©æ¥­å‹™é¡åˆ¥
```

### R4: æ¸¬è©¦æœƒå¤±æ•—ï¼ˆç´…ç‡ˆï¼‰
ç´…ç‡ˆéšæ®µçš„æ¸¬è©¦åŸ·è¡Œå¾Œæ‡‰è©²å¤±æ•—ï¼Œé€™æ˜¯é æœŸçš„çµæœã€‚

```python
# âœ… é æœŸè¡Œç‚ºï¼šæ¸¬è©¦å¤±æ•—
$ pytest tests/
FAILED - NotImplementedError: ç´…ç‡ˆéšæ®µï¼šå°šæœªå¯¦ä½œ

# âŒ ä¸é æœŸï¼šæ¸¬è©¦é€šéï¼ˆé€™æ‡‰è©²åœ¨ç¶ ç‡ˆéšæ®µï¼‰
$ pytest tests/
PASSED
```

---
