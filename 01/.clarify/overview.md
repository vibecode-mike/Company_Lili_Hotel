# 釐清項目總覽

## 釐清項目統計

- **資料模型相關**：0 項
- **功能模型相關**：17 項
- **總計**：6 項

## 優先級分佈

### High（高優先級）：0 項
（已完成所有 High 優先級項目）

### Medium（中優先級）：0 項
（已完成所有 Medium 優先級項目）

### Low（低優先級）：6 項
優化細節、非關鍵路徑、或可延後處理的決策點。

**資料模型 Low（1 項）**：
1. 標籤統計_趨勢圖資料保留期限

**功能模型 Low（5 項）**：
1. 會員管理_消費紀錄顯示權限控制
2. 訊息模板_輪播圖卡刪除後的序號調整
6. 登入系統_會話零時登出的時區基準
7. 登入系統_授權到期檢查與展延流程
8. 設定_Login_API_憑證格式驗證規則

---

## 建議釐清順序

### 核心原則
- **由核心至延伸**：優先處理影響資料建模與核心功能的項目
- **平衡資料與功能**：交錯處理資料模型與功能模型，避免單一類別連續過多
- **依賴關係優先**：先釐清被依賴的項目，再處理依賴它們的項目

---

### 第一階段：核心資料模型（建議 9 項，High 優先級）

**目標**：確立核心實體與屬性定義，為所有功能奠定資料基礎

5. **MemberTag_觸發次數計算邏輯**
   - 理由：影響標籤統計準確性、去重邏輯、行為分析
   - 依賴：無
   - 後續影響：標籤統計、趨勢分析、會員行為洞察

6. **LoginConfig_與LoginSession關係釐清**
   - 理由：影響 LINE Login 整合、會員資料蒐集、管理員會話管理
   - 依賴：無
   - 後續影響：登入系統、會員資料整合

7. **Campaign_status狀態轉換規則**
   - 理由：影響群發訊息編輯權限、排程任務、失敗重試
   - 依賴：無
   - 後續影響：訊息推播、排程管理、錯誤處理

8. **MessageTemplate_flex_message_json結構驗證**
   - 理由：影響訊息模板儲存、LINE API 呼叫成功率、系統穩定性
   - 依賴：無
   - 後續影響：訊息模板建立、群發訊息、預覽功能

9. **ConsumptionRecord_同步機制詳細設計**
   - 理由：影響 PMS 整合架構、資料一致性、同步任務設計
   - 依賴：Member_id_number唯一性（第3項）
   - 後續影響：消費紀錄查詢、標籤自動生成、會員分析

---

### 第二階段：核心功能規則（建議 10 項，High 優先級）

**目標**：確保主要業務流程規則清晰，支援核心交互功能開發

10. **自動回應_關鍵字比對邏輯**
    - 理由：影響自動回應觸發準確性、會員體驗、觸發統計
    - 依賴：無
    - 關聯功能：自動回應設定、關鍵字管理

11. **自動回應_指定時間觸發的實際執行時機**
    - 理由：影響自動回應觸發邏輯、排程任務、訊息配額消耗
    - 依賴：無
    - 關聯功能：自動回應設定、排程系統

12. **群發訊息_篩選條件組合邏輯**
    - 理由：影響篩選功能設計、查詢效能、使用者體驗
    - 依賴：無
    - 關聯功能：群發訊息建立、會員篩選

13. **會員搜尋_需回覆會員的24小時計算基準**
    - 理由：影響需回覆判定準確性、客服時效監控
    - 依賴：Member_last_interaction_at更新條件（第4項）
    - 關聯功能：會員搜尋、客服管理

14. **會員標籤_滾動12個月的計算基準日**
    - 理由：影響標籤判定邏輯、標籤更新時機、測試設計
    - 依賴：無
    - 關聯功能：會員標籤管理、標籤自動生成

15. **訊息紀錄_WebSocket即時連線斷線重連機制**
    - 理由：影響即時訊息可靠性、使用者體驗、系統穩定性
    - 依賴：無
    - 關聯功能：一對一聊天、訊息即時更新

17. **訊息數據_開啟次數與點擊次數的定義**
    - 理由：影響數據追蹤實作、成效分析準確性、LINE API 整合
    - 依賴：無
    - 關聯功能：訊息數據成效、廣告成效分析

19. **訊息數據_發送失敗的重試機制**
    - 理由：影響訊息發送可靠性、錯誤處理、系統穩定性
    - 依賴：Campaign_status狀態轉換（第7項）
    - 關聯功能：群發訊息、排程發送、錯誤通知

---

### 第三階段：系統基礎與認證（建議 5 項，High 優先級）

**目標**：確立系統認證與卡控機制，確保系統安全與存取控制

18. **卡控流程_LINE_OA設定檢查邏輯**
    - 理由：影響功能模組存取控制、使用者導航體驗
    - 依賴：LoginConfig關係釐清（第6項）
    - 關聯功能：功能模組卡控、導航流程

19. **登入系統_24小時自動登入的實作機制**
    - 理由：影響前後端架構、安全性、跨域請求處理
    - 依賴：無
    - 關聯功能：管理員登入、會話管理

20. **重新設定_LINE_OA_資料清除範圍**
    - 理由：影響資料保留策略、重新設定流程、資料遺失風險
    - 依賴：無
    - 關聯功能：LINE OA 設定、資料管理

21. **群發訊息_加入好友期間計算邏輯**
    - 理由：影響篩選準確性、邊界條件測試
    - 依賴：無
    - 關聯功能：群發訊息篩選、會員篩選

---

### 第四階段：邊界條件與擴充性（建議 16 項，Medium 優先級）

**目標**：完善邊界情況處理、提升使用者體驗、確保系統擴充性

#### 資料模型 Medium（8 項）

23. **Member_gender欄位值域定義**
24. **Member_birthday資料型別與格式**
25. **Member_region地區值域標準化**
26. **Member_join_source值域定義**
27. **Admin_角色權限系統設計**
28. **AutoResponse_trigger_type值域與擴充性**
29. **AutoResponse_關鍵字儲存結構**
30. **AutoResponse_time_range時間區間表示法**

#### 功能模型 Medium（7 項）

31. **自動回應_訊息數量1-5筆的UI互動**
34. **群發訊息_模板選擇來源與範圍**
35. **群發訊息_排程發送時區與夏令時處理**
36. **會員標籤_CRM_PMS標籤規則的管理介面**
37. **訊息紀錄_排程發送的取消機制**
38. **訊息模板_圖片裁切邏輯與預覽**
39. **訊息模板_動作按鈕互動類型的必填邏輯**
40. **登入系統_密碼複雜度要求**

---

### 第五階段：細節與優化（建議 10 項，Medium + Low 優先級）

**目標**：完善系統細節、提升產品完成度

#### Medium（5 項）

38. **登入系統_密碼複雜度要求**
39. **設定_Messaging_API_webhook驗證方式**
42. **登出系統_清除會話的完整性**
43. **會員搜尋_模糊搜尋與精確搜尋**
44. **會員管理_頭像圖片儲存與更新機制**

#### Low（9 項）

43. **Message_template_type值域定義**
44. **PMS_Integration_API規格與資料格式**
45. **群發訊息_草稿儲存完整性**
46. **互動標籤_標籤名稱格式與特殊字元限制**
47. **標籤統計_趨勢圖資料保留期限**

---

## 釐清策略說明

### 平衡原則
- 每階段交錯處理資料模型與功能模型，避免連續處理同類問題
- 第一、二階段專注 High 優先級，確保核心功能可開始開發
- 第三階段補齊剩餘 High 項目，確保無阻礙項目
- 第四、五階段處理 Medium 與 Low，逐步完善系統

### 依賴關係標註
- **第 9 項依賴第 3 項**：ConsumptionRecord 同步需先確認 id_number 唯一性
- **第 14 項依賴第 5 項**：互動標籤觸發需先確認 MemberTag 計算邏輯
- **第 15 項依賴第 4 與 5 項**：標籤統計需先確認觸發次數與互動邏輯
- **第 16 項依賴第 4 項**：需回覆會員判定需先確認 last_interaction_at 定義
- **第 19 項依賴第 7 項**：發送失敗重試需先確認狀態轉換規則
- **第 20 項依賴第 6 項**：卡控邏輯需先確認 LoginConfig 關係

### 組合釐清建議
以下項目可一併處理，提升釐清效率：

- **會員基本資料組合**（第 1-4 項）：LINE UID、email/phone、id_number、last_interaction_at
- **標籤系統組合**（第 5、13-15 項）：觸發次數、多標籤邏輯、統計去重
- **認證系統組合**（第 6、20-21 項）：LoginConfig 關係、卡控邏輯、自動登入
- **訊息系統組合**（第 7-8、18-19 項）：Campaign 狀態、模板驗證、數據定義、失敗重試

### 漸進式釐清策略
1. **第一週（第 1-9 項）**：核心資料模型，確保資料庫 schema 可定案
2. **第二週（第 10-17 項）**：核心功能規則，確保主要業務流程可開發
3. **第三週（第 18-22 項）**：系統基礎與認證，確保無阻礙項目
4. **第四週（第 23-37 項）**：邊界條件與擴充性，提升系統穩健性
5. **第五週（第 38-47 項）**：細節與優化，完善產品完成度

---

## 覆蓋度摘要

### A. 領域與資料模型檢查（spec/erm.dbml）

| 檢查項 | 狀態 | 釐清項目數 | 說明 |
|--------|------|------------|------|
| A1. 實體完整性 | **Clear** | 0 | 所有核心業務概念已建模 |
| A2. 屬性定義 | **Partial** | 10 | 已建立 19 個資料模型釐清項目，涵蓋主要屬性定義 |
| A3. 屬性值邊界條件 | **Partial** | 6 | 涵蓋格式、長度、值域等邊界定義 |
| A4. 跨屬性不變條件 | **Clear** | 0 | 現有規格中未發現明顯的跨屬性約束 |
| A5. 關係與唯一性 | **Partial** | 3 | 涵蓋唯一性約束、關聯關係釐清 |
| A6. 生命週期與狀態 | **Partial** | 2 | 涵蓋 Campaign 狀態轉換、會話管理 |

### B. 功能模型檢查（spec/features/*.feature）

| 檢查項 | 狀態 | 釐清項目數 | 說明 |
|--------|------|------------|------|
| B1. 功能識別 | **Clear** | 0 | 所有主要功能已識別為獨立 feature |
| B2. 規則完整性 | **Clear** | 0 | 規則已充分原子化，前後置條件完整 |
| B3. 例子覆蓋度 | **Partial** | 0 | 大部分規則有 Example，少數標記 #TODO（已在釐清項目中處理） |
| B4. 邊界條件覆蓋 | **Partial** | 20 | 已建立 36 個功能模型釐清項目，涵蓋主要邊界情況 |
| B5. 錯誤與異常處理 | **Partial** | 8 | 涵蓋失敗處理、重試機制、錯誤提示 |

### C. 術語與一致性檢查

| 檢查項 | 狀態 | 釐清項目數 | 說明 |
|--------|------|------------|------|
| C1. 詞彙表 | **Clear** | 0 | 核心術語（會員、標籤、訊息、模板等）命名一致 |
| C2. 術語衝突 | **Clear** | 0 | 未發現明顯的術語衝突或同義詞混用 |

### D. 其他品質檢查

| 檢查項 | 狀態 | 釐清項目數 | 說明 |
|--------|------|------------|------|
| D1. 待決事項 | **Partial** | 8 | 已針對所有 #TODO 標記建立釐清項目 |
| D2. 模糊描述 | **Clear** | 0 | 規格描述相對具體，量化形容詞使用適當 |

---

## 總結

本次 Discovery 掃描識別出 **37 個待釐清項目**（資料模型 6 項、功能模型 31 項），覆蓋資料建模、核心功能規則、邊界條件處理、系統基礎設施等關鍵決策點。已解決 2 項。

### 關鍵發現
1. **資料模型基礎穩固**：核心實體與關係已定義，主要需釐清屬性細節與約束規則
2. **功能規則完整**：主要業務流程規則清晰，需釐清邊界條件與執行細節
3. **#TODO 項目集中**：系統基礎功能（登入、登出、卡控）的實作細節需補充
4. **高優先級項目明確**：10 個 High 項目為開發起步的關鍵阻礙，需優先釐清

### 建議執行步驟
1. **第一週**：執行第一階段釐清（第 1-9 項），確保資料庫 schema 定案
2. **第二週**：執行第二階段釐清（第 10-17 項），確保核心功能可開始開發
3. **第三週**：執行第三階段釐清（第 18-22 項），補齊剩餘 High 優先級項目
4. **後續**：依需求逐步釐清 Medium 與 Low 項目，持續完善規格

### 已解決項目
1. **互動標籤_同一訊息多個標籤的觸發邏輯** - 已釐清為「由訊息模板設定決定」，新增 tag_trigger_mode 欄位
2. **標籤統計_觸發次數與觸發會員數的去重邏輯** - 已釐清為「觸發次數累計所有觸發，觸發會員數去重」

### 下一步行動
執行 `formulation.md` prompt，依照本 overview 建議的釐清順序，逐項與 Stakeholder 互動釐清，並更新規格檔案。
