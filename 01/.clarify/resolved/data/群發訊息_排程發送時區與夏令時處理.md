# 釐清項目：群發訊息_排程發送時區與夏令時處理

## 基本資訊
- **優先級**：Medium
- **類別**：功能模型
- **相關檔案**：
  - `spec/features/create_broadcast.feature` (Rule: 使用者能夠選擇於指定發送日期進行排程傳送)
  - `spec/erm.dbml` (Message.scheduled_date, Message.scheduled_time)

## 問題描述

現有規格定義了排程發送的日期與時間欄位：
- `Message.scheduled_date` - 格式：yyyy/mm/dd
- `Message.scheduled_time` - 格式：hh:mm

但未明確定義以下關鍵問題：

1. **時區基準**：scheduled_time 應以何種時區為基準？
2. **夏令時處理**：若系統未來擴展至有夏令時的地區，如何確保排程準確觸發？
3. **跨時區支援**：若飯店集團有海外據點，如何處理不同時區的排程需求？
4. **系統時間變更**：若伺服器時區設定變更，既有排程是否受影響？

## 影響範圍

- **功能影響**：排程發送觸發邏輯、使用者介面顯示時間
- **資料模型影響**：Message.scheduled_date, scheduled_time 的儲存格式與語義
- **使用者體驗**：行銷人員設定排程時的時區認知、觸發時間準確性
- **系統擴充性**：未來支援跨時區、跨國經營的能力

## 選項分析

### 選項 A：固定台灣時區（UTC+8）+ 不支援夏令時

**儲存格式**：
- `scheduled_date`: yyyy/mm/dd（台灣時間）
- `scheduled_time`: hh:mm（台灣時間，UTC+8）
- 不新增時區欄位

**觸發邏輯**：
- 後端排程任務固定以台灣時間（UTC+8）為基準
- 比對當前系統時間（轉換為 UTC+8）與 scheduled_date + scheduled_time
- 當系統時間 >= 排程時間時觸發發送

**優點**：
- ✅ 實作最簡單，無需時區轉換邏輯
- ✅ 符合台灣飯店業現況（無夏令時）
- ✅ 使用者體驗直覺（顯示即儲存，所見即所得）

**缺點**：
- ❌ 無法支援跨時區擴展
- ❌ 伺服器時區變更會導致排程錯亂
- ❌ 若系統未來國際化需重構

**適用情境**：
- 系統僅服務台灣市場
- 短期內無跨國擴展計畫
- 伺服器時區設定穩定不變

---

### 選項 B：儲存 UTC 時間 + 顯示台灣時區（推薦）

**儲存格式**：
- `scheduled_datetime_utc`: ISO 8601 格式（yyyy-MM-ddTHH:mm:ssZ，UTC 時間）
- 移除 `scheduled_date` 和 `scheduled_time` 欄位

**觸發邏輯**：
- 後端排程任務以 UTC 時間為基準
- 直接比對當前 UTC 時間與 scheduled_datetime_utc
- 當 UTC 時間 >= scheduled_datetime_utc 時觸發發送

**前端顯示邏輯**：
- 前端固定顯示為台灣時間（UTC+8）
- 使用者選擇「2025/02/01 10:00」時，前端轉換為 UTC 儲存（2025-02-01T02:00:00Z）
- 顯示時從 UTC 轉換回台灣時間

**優點**：
- ✅ 標準化儲存格式（UTC），符合國際最佳實踐
- ✅ 支援未來跨時區擴展（只需調整前端顯示時區）
- ✅ 伺服器時區變更不影響排程準確性
- ✅ 避免夏令時問題（UTC 無夏令時）

**缺點**：
- ❌ 需要前後端時區轉換邏輯
- ❌ 資料庫直接查詢時不直觀（顯示 UTC 時間）
- ❌ 實作複雜度中等

**適用情境**：
- 系統有跨時區擴展可能性
- 追求標準化與國際化架構
- 可接受適度的實作複雜度

---

### 選項 C：儲存本地時間 + 時區欄位

**儲存格式**：
- `scheduled_date`: yyyy/mm/dd
- `scheduled_time`: hh:mm
- `timezone`: 時區識別碼（如：Asia/Taipei, America/New_York）

**觸發邏輯**：
- 後端排程任務根據 timezone 欄位轉換為 UTC 時間
- 轉換公式：scheduled_datetime_local + timezone → UTC
- 比對 UTC 時間觸發發送

**前端顯示邏輯**：
- 前端允許使用者選擇時區（預設為 Asia/Taipei）
- 顯示時間即為儲存時間（無需轉換）

**優點**：
- ✅ 資料庫查詢直觀（顯示本地時間）
- ✅ 支援跨時區擴展（每筆排程可指定時區）
- ✅ 靈活性最高（支援跨國飯店集團）

**缺點**：
- ❌ 實作複雜度最高（需維護時區資料庫）
- ❌ 需處理夏令時轉換（時區資料庫必須更新）
- ❌ 觸發邏輯較複雜（每次都需時區轉換）
- ❌ 對於單一時區場景過度設計

**適用情境**：
- 系統已確定需支援跨時區經營
- 飯店集團有海外據點
- 可接受高實作複雜度換取高靈活性

---

### 選項 D：混合方案（儲存雙時間戳）

**儲存格式**：
- `scheduled_datetime_local`: yyyy/mm/dd hh:mm（台灣時間，供顯示）
- `scheduled_datetime_utc`: ISO 8601 UTC（供觸發邏輯）

**觸發邏輯**：
- 後端排程任務以 `scheduled_datetime_utc` 為準
- 確保觸發時間準確性

**前端顯示邏輯**：
- 前端直接顯示 `scheduled_datetime_local`（無需轉換）
- 使用者修改時同步更新兩個欄位

**優點**：
- ✅ 兼顧查詢直觀性與觸發準確性
- ✅ 支援未來擴展（保留 UTC 基準）
- ✅ 前端顯示效能最佳（無需轉換）

**缺點**：
- ❌ 資料冗餘（儲存兩份時間）
- ❌ 需維護雙欄位一致性（可能不同步）
- ❌ 增加資料模型複雜度

**適用情境**：
- 追求查詢效能與顯示直觀性
- 願意犧牲儲存空間換取簡化邏輯
- 資料一致性可透過應用層控制

---

## 推薦方案

**推薦選項 B：儲存 UTC 時間 + 顯示台灣時區**

**推薦理由**：

1. **最佳實踐對齊**：UTC 儲存是國際標準，符合 ISO 8601 規範
2. **擴展性考量**：若未來支援跨時區無需重構資料模型
3. **避免夏令時陷阱**：UTC 無夏令時，避免每年兩次的時間跳變問題
4. **實作成熟度**：主流框架（Django, Rails, .NET）都內建 UTC 支援
5. **平衡複雜度**：適度的實作複雜度換取長期穩定性

**次要推薦選項 A**（若確定系統不跨國）：
- 若系統確定僅服務台灣市場且短期無擴展計畫
- 可採用選項 A 簡化實作
- 但需在技術文件明確記錄此限制

---

## 設計細節（基於推薦選項 B）

### 資料模型變更

**erm.dbml - Message 表欄位調整**：

```dbml
Table Message {
  message_id string [pk]
  # ... 其他欄位 ...

  # 移除舊欄位
  # scheduled_date string [note: '排程發送日期，格式：yyyy/mm/dd']
  # scheduled_time string [note: '排程發送時間，格式：hh:mm']

  # 新增 UTC 時間欄位
  scheduled_datetime_utc string [note: '排程發送時間（UTC），格式：ISO 8601 (yyyy-MM-ddTHH:mm:ssZ)。範例：2025-02-01T02:00:00Z 表示台灣時間 2025/02/01 10:00。前端顯示時轉換為台灣時區（UTC+8）']

  # ... 其他欄位 ...
}
```

### 功能規則調整

**create_broadcast.feature 新增規則**：

```gherkin
Rule: 排程時間以 UTC 格式儲存，前端顯示為台灣時間（UTC+8）

  Example: 使用者設定台灣時間排程，系統轉換為 UTC 儲存
    Given 行銷人員正在建立群發訊息
    When 行銷人員設定排程時間「2025/02/01 10:00」（台灣時間）
    Then 前端計算 UTC 時間為「2025-02-01T02:00:00Z」
    And 系統儲存 scheduled_datetime_utc 為「2025-02-01T02:00:00Z」

  Example: 顯示排程時間時轉換回台灣時間
    Given 系統儲存的排程時間為「2025-02-01T02:00:00Z」（UTC）
    When 行銷人員查看該排程訊息
    Then 前端顯示排程時間為「2025/02/01 10:00」（台灣時間）

Rule: 後端排程任務以 UTC 時間為基準觸發發送

  Example: 排程任務準確觸發
    Given 系統儲存的排程時間為「2025-02-01T02:00:00Z」（UTC）
    And 當前 UTC 時間為「2025-02-01T02:00:00Z」
    When 排程任務檢查待發送訊息
    Then 系統觸發該訊息發送
    And 更新 send_status 為「已發送」

  Example: 排程時間未到不觸發
    Given 系統儲存的排程時間為「2025-02-01T02:00:00Z」（UTC）
    And 當前 UTC 時間為「2025-02-01T01:59:59Z」
    When 排程任務檢查待發送訊息
    Then 系統不觸發該訊息發送
    And send_status 保持為「排程發送」
```

---

## 後續影響

### 需同步更新的規格檔案
1. **spec/erm.dbml**：Message 表欄位調整
2. **spec/features/create_broadcast.feature**：新增時區處理規則

### 需考慮的技術實作
1. **前端時區轉換**：使用 `date-fns-tz` 或 `moment-timezone` 函式庫
2. **後端時區處理**：確保所有 datetime 操作使用 UTC
3. **排程任務**：使用 UTC 時間比對，避免本地時間陷阱
4. **測試案例**：涵蓋時區轉換邊界值（如：跨日、跨年）

### 相關釐清項目
- **登入系統_會話零時登出的時區基準**（Low 優先級）- 可能採用相同時區策略

---

## 決策記錄
- **決策日期**：2025-11-13
- **決策者**：Stakeholder
- **選擇方案**：選項 B - 儲存 UTC 時間 + 顯示台灣時區
- **決策理由**：
  1. 符合國際標準（ISO 8601）與最佳實踐
  2. 避免夏令時問題（UTC 無夏令時變換）
  3. 支援未來跨時區擴展，無需重構資料模型
  4. 實作複雜度適中，主流框架內建良好支援
  5. 保證排程觸發邏輯的準確性與穩定性

## 已完成的規格更新

### 1. 資料模型更新（spec/erm.dbml）

**Message 表欄位調整**：
- ❌ 移除：`scheduled_date` (yyyy/mm/dd)
- ❌ 移除：`scheduled_time` (hh:mm)
- ✅ 新增：`scheduled_datetime_utc` (ISO 8601 格式，如：2025-02-01T02:00:00Z)

**欄位說明**：
```
scheduled_datetime_utc string [note: '排程發送時間（UTC），格式：ISO 8601 (yyyy-MM-ddTHH:mm:ssZ)。
範例：2025-02-01T02:00:00Z 表示台灣時間 2025/02/01 10:00。
前端顯示時轉換為台灣時區（UTC+8）。若為立即發送則此欄位為 NULL']
```

### 2. 功能規則更新（spec/features/create_broadcast.feature）

**新增 2 個 Rule，共 5 個 Example**：

**Rule 1: 使用者能夠選擇於指定日期與時間進行排程傳送（以台灣時間顯示，UTC 儲存）**
- Example 1: 選擇台灣時間排程，系統轉換為 UTC 儲存
- Example 2: 顯示既有排程時轉換回台灣時間

**Rule 2: 後端排程任務以 UTC 時間為基準觸發發送**
- Example 1: 排程時間已到，觸發發送
- Example 2: 排程時間未到，不觸發發送
- Example 3: 排程時間已過，立即觸發

### 3. 技術實作建議

**前端實作**：
- 使用 `date-fns-tz` 或 `Intl.DateTimeFormat` 處理時區轉換
- 使用者輸入台灣時間 → 轉換為 UTC 儲存
- 顯示時從 UTC 轉換回台灣時間（UTC+8）

**後端實作**：
- 所有 datetime 操作使用 UTC
- 排程任務使用 UTC 時間比對：`current_utc >= scheduled_datetime_utc`
- 避免使用本地時間，防止時區陷阱

**測試案例**：
- 時區轉換邊界值測試（跨日、跨年）
- 排程觸發準確性測試
- 顯示轉換正確性測試
