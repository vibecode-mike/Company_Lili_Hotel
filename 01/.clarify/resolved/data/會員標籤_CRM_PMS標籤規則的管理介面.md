# 釐清項目：會員標籤_CRM_PMS標籤規則的管理介面

## 基本資訊
- **優先級**：Medium
- **類別**：功能模型
- **相關檔案**：
  - `spec/features/member_tag_management.feature` (外部系統串接標籤規則)
  - `spec/erm.dbml` (MemberTag.tag_source)
  - `spec/requirement_LabelSetting.md`

## 問題描述

現有規格定義了多種 CRM/PMS 標籤自動生成規則：

1. **消費金額門檻**：「高消費客戶」標籤門檻為「30,000 元」
2. **訪問頻率門檻**：「常客」標籤門檻為「3 次以上」
3. **互動時間門檻**：「沉睡會員」標籤門檻為「超過 60 天未主動互動」
4. **房型分類**：「雙人房」、「商務房」、「親子房」等

但規格中未明確定義：

1. **規則管理方式**：這些門檻值（30,000 元、3 次、60 天）是寫死在程式碼中，還是可動態配置？
2. **管理介面需求**：是否需要提供管理介面讓飯店管理員自行設定這些規則？
3. **規則儲存位置**：應該儲存在資料庫、設定檔，還是程式碼常數？
4. **規則覆蓋範圍**：每家飯店可以有不同規則，還是全系統統一規則？

## 影響範圍

- **功能影響**：標籤自動生成邏輯、會員篩選精準度、行銷活動效果
- **資料模型影響**：可能需要新增 TagRule 資料表
- **使用者體驗**：飯店管理員是否能自訂規則以符合不同經營策略
- **系統擴充性**：未來新增規則類型的難易度

## 選項分析

### 選項 A：寫死在程式碼中（固定規則）

**實作方式**：
- 門檻值定義為程式碼常數（如 `HIGH_VALUE_CUSTOMER_THRESHOLD = 30000`）
- 規則邏輯寫在業務邏輯層，不可動態修改
- 需要調整規則時必須修改程式碼並重新部署

**範例**：
```python
# 寫死在程式碼中
HIGH_VALUE_CUSTOMER_THRESHOLD = 30000  # 高消費客戶門檻
FREQUENT_VISITOR_THRESHOLD = 3  # 常客門檻
INACTIVE_MEMBER_DAYS = 60  # 沉睡會員天數
```

**優點**：
- ✅ 實作最簡單，無需額外資料表或介面
- ✅ 效能最佳（無需查詢資料庫）
- ✅ 規則一致性高（所有飯店統一標準）

**缺點**：
- ❌ 無彈性，無法因應不同飯店的經營策略
- ❌ 調整規則需要重新部署系統
- ❌ 無法快速測試不同門檻值的效果

**適用情境**：
- 系統僅服務單一飯店
- 飯店集團希望統一標籤標準
- 規則變動頻率極低

---

### 選項 B：設定檔配置（半動態管理）

**實作方式**：
- 門檻值儲存於設定檔（如 `config.yaml` 或 `.env`）
- 支援每家飯店有獨立設定檔
- 修改設定檔後需重啟服務生效

**範例設定檔**（config.yaml）：
```yaml
tag_rules:
  high_value_customer:
    threshold_amount: 30000
    period_days: 365
  frequent_visitor:
    threshold_count: 3
    period_days: 365
  inactive_member:
    threshold_days: 60
  room_types:
    - 雙人房
    - 商務房
    - 親子房
```

**優點**：
- ✅ 實作複雜度適中
- ✅ 支援不同飯店有不同規則（多設定檔）
- ✅ 修改規則無需改程式碼

**缺點**：
- ❌ 需重啟服務才能生效
- ❌ 缺乏管理介面，需直接編輯設定檔（技術門檻）
- ❌ 設定錯誤可能導致系統異常

**適用情境**：
- 規則變動頻率低（每季或每年調整）
- 技術團隊可直接編輯設定檔
- 飯店集團有多個據點，需個別規則

---

### 選項 C：資料庫儲存 + 後台管理介面（全動態管理，推薦）

**實作方式**：
- 新增 `TagRule` 資料表儲存規則定義
- 提供後台管理介面供飯店管理員設定規則
- 規則修改立即生效，無需重啟服務

**資料模型新增**（TagRule 表）：
```dbml
Table TagRule {
  rule_id string [pk]
  tag_name string [note: '標籤名稱（如：高消費客戶）']
  tag_source string [note: '標籤來源：CRM / PMS']
  rule_type string [note: '規則類型：消費金額 / 訪問頻率 / 互動時間 / 房型分類']
  threshold_value float [note: '門檻值（如：30000 元、3 次）']
  threshold_unit string [note: '單位：元 / 次 / 天']
  period_days int [note: '計算週期（天數），如 365 表示滾動 12 個月']
  is_enabled bool [note: '是否啟用']
  created_at string
  updated_at string
}
```

**管理介面功能**：
1. **規則列表頁**：顯示所有 CRM/PMS 標籤規則
2. **新增規則**：建立新的標籤規則
3. **編輯規則**：修改門檻值、計算週期等參數
4. **啟用/停用規則**：暫時停用某些規則
5. **刪除規則**：移除不再使用的規則
6. **預覽影響**：顯示該規則目前符合的會員數量

**範例規則設定**：
| 標籤名稱 | 規則類型 | 門檻值 | 單位 | 計算週期 | 狀態 |
|---------|---------|-------|-----|---------|-----|
| 高消費客戶 | 消費金額 | 30000 | 元 | 365天 | 啟用 |
| 常客 | 訪問頻率 | 3 | 次 | 365天 | 啟用 |
| 沉睡會員 | 互動時間 | 60 | 天 | - | 啟用 |
| 雙人房 | 房型分類 | - | - | - | 啟用 |

**優點**：
- ✅ 最高彈性，飯店可即時調整規則
- ✅ 無需技術團隊介入，管理員自行操作
- ✅ 支援 A/B 測試（調整門檻值比較效果）
- ✅ 規則修改立即生效，無需重啟
- ✅ 可記錄規則變更歷史

**缺點**：
- ❌ 實作複雜度最高（需設計資料表 + 管理介面）
- ❌ 需考慮規則驗證（防止設定不合理的值）
- ❌ 查詢效能略低於寫死常數（可透過快取優化）

**適用情境**：
- 飯店集團有多個據點，各有不同經營策略
- 希望靈活調整規則以因應市場變化
- 行銷團隊需要測試不同門檻值的效果

---

### 選項 D：混合方案（預設規則 + 可覆寫）

**實作方式**：
- 程式碼中定義預設規則（保底機制）
- 資料庫儲存自訂規則（優先使用）
- 簡化管理介面（只管理常用規則）

**規則優先順序**：
1. 資料庫中的自訂規則（最高優先）
2. 設定檔中的飯店規則
3. 程式碼中的預設規則（保底）

**優點**：
- ✅ 兼顧彈性與穩定性
- ✅ 系統初始化時有預設規則可用
- ✅ 允許部分飯店使用預設，部分飯店自訂

**缺點**：
- ❌ 規則來源複雜，增加維護難度
- ❌ 規則優先順序可能造成混淆

**適用情境**：
- 大部分飯店使用預設規則
- 少數飯店需要特殊規則

---

## 推薦方案

**推薦選項 C：資料庫儲存 + 後台管理介面**

**推薦理由**：

1. **業務靈活性**：飯店集團各據點可依據自身定位設定不同門檻（如：精品飯店 vs 商務飯店）
2. **行銷敏捷性**：可快速調整規則因應促銷活動或市場變化
3. **自主管理**：飯店管理員無需技術團隊協助即可調整規則
4. **數據驗證**：可即時查看規則調整對會員數量的影響
5. **系統擴展**：未來新增規則類型無需修改程式碼

**次要推薦選項 B**（若預算有限或初期 MVP）：
- 可先採用設定檔方式快速上線
- 後續再升級為選項 C 的管理介面

---

## 設計細節（基於推薦選項 C）

### 資料模型新增

**erm.dbml 新增 TagRule 表**：

```dbml
Table TagRule {
  rule_id string [pk, note: '規則唯一識別碼']
  tag_name string [note: '標籤名稱（如：高消費客戶、常客）']
  tag_source string [note: '標籤來源：CRM / PMS。必填欄位']
  rule_type string [note: '規則類型：consumption_amount（消費金額）/ visit_frequency（訪問頻率）/ interaction_time（互動時間）/ room_type（房型分類）。必填欄位']
  threshold_value float [note: '門檻值（如：30000 元、3 次）。允許 NULL（房型分類不需要門檻值）']
  threshold_unit string [note: '單位：NTD（新台幣）/ times（次）/ days（天）。允許 NULL（房型分類不需要單位）']
  period_days int [note: '計算週期（天數），如 365 表示滾動 12 個月。允許 NULL（互動時間規則不需要週期）']
  condition_operator string [note: '比較運算子：>= / > / <= / < / =。預設值：>=']
  is_enabled bool [note: '是否啟用。預設值：true']
  created_at string [note: '建立時間，格式：yyyy/mm/dd hh:mm']
  updated_at string [note: '更新時間，格式：yyyy/mm/dd hh:mm']

  Note: '''
  標籤規則實體，用於定義 CRM/PMS 標籤的自動生成規則
  規則類型說明：
    - consumption_amount：消費金額達門檻（如：過去 12 個月消費 >= 30000 元）
    - visit_frequency：訪問頻率達門檻（如：過去 12 個月住宿 >= 3 次）
    - interaction_time：互動時間超過門檻（如：超過 60 天未主動互動）
    - room_type：房型分類（如：雙人房、商務房）
  計算週期：採用滾動時間窗口（從當前日期往前推算 period_days 天）
  規則優先順序：資料庫規則 > 程式碼預設規則
  '''
}
```

### 功能規則新增

**新增 feature 檔案：tag_rule_management.feature**

```gherkin
Feature: 標籤規則管理
  作為一位飯店管理員
  我希望能夠設定 CRM/PMS 標籤的自動生成規則
  以便依據飯店經營策略調整會員分群標準

  Rule: 支援查看所有標籤規則列表

    Example: 查看標籤規則總覽
      Given 系統中存在以下標籤規則
        | 標籤名稱   | 規則類型 | 門檻值 | 單位 | 計算週期 | 狀態 |
        | 高消費客戶 | 消費金額 | 30000  | NTD  | 365天    | 啟用 |
        | 常客       | 訪問頻率 | 3      | times| 365天    | 啟用 |
        | 沉睡會員   | 互動時間 | 60     | days | -        | 啟用 |
      When 管理員開啟「標籤規則管理」頁面
      Then 系統顯示所有標籤規則列表
      And 顯示每個規則的詳細參數與狀態

  Rule: 支援新增消費金額類型的標籤規則

    Example: 新增「高消費客戶」標籤規則
      Given 管理員正在新增標籤規則
      When 管理員設定以下參數
        | 欄位     | 值       |
        | 標籤名稱 | 高消費客戶 |
        | 規則類型 | 消費金額 |
        | 門檻值   | 30000    |
        | 單位     | NTD      |
        | 計算週期 | 365      |
        | 運算子   | >=       |
      And 管理員點擊「儲存」
      Then 系統建立新的標籤規則
      And 系統顯示「規則建立成功」訊息

  Rule: 支援編輯既有標籤規則

    Example: 調整「高消費客戶」門檻值
      Given 系統中存在標籤規則「高消費客戶」，門檻值為「30000 元」
      When 管理員編輯該規則並將門檻值修改為「50000 元」
      And 管理員點擊「儲存」
      Then 系統更新標籤規則
      And 下次標籤計算時使用新門檻值「50000 元」

  Rule: 支援啟用/停用標籤規則

    Example: 暫時停用「沉睡會員」標籤規則
      Given 系統中存在標籤規則「沉睡會員」，狀態為「啟用」
      When 管理員將該規則設定為「停用」
      Then 系統更新規則狀態為「停用」
      And 系統停止為會員自動生成「沉睡會員」標籤

  Rule: 支援刪除標籤規則

    Example: 刪除不再使用的標籤規則
      Given 系統中存在標籤規則「測試標籤」
      When 管理員刪除該規則
      Then 系統刪除該標籤規則
      And 不影響已經生成的會員標籤

  Rule: 規則修改時顯示影響範圍預覽

    Example: 預覽門檻值調整的影響
      Given 標籤規則「高消費客戶」當前門檻為「30000 元」，符合會員數為「120 人」
      When 管理員將門檻值調整為「50000 元」
      Then 系統即時計算並顯示「預計符合會員數：85 人」
      And 系統顯示變化幅度「減少 35 人（-29%）」

  Rule: 規則參數驗證

    Example: 門檻值必須為正數
      Given 管理員正在新增標籤規則
      When 管理員設定門檻值為「-1000」
      And 管理員點擊「儲存」
      Then 系統顯示錯誤訊息「門檻值必須為正數」
      And 系統阻擋儲存操作

    Example: 計算週期必須在合理範圍內
      Given 管理員正在編輯標籤規則
      When 管理員設定計算週期為「10000 天」
      And 管理員點擊「儲存」
      Then 系統顯示警告訊息「計算週期建議不超過 730 天（2 年）」
      And 系統允許儲存但記錄警告
```

### 管理介面設計

**頁面結構**：

1. **標籤規則列表頁**
   - 顯示所有規則的卡片或表格
   - 支援篩選（規則類型、狀態）
   - 支援搜尋（標籤名稱）
   - 操作按鈕：新增、編輯、刪除、啟用/停用

2. **新增/編輯規則對話框**
   - 標籤名稱（文字輸入）
   - 規則類型（下拉選單：消費金額 / 訪問頻率 / 互動時間 / 房型分類）
   - 門檻值（數字輸入）
   - 單位（自動根據規則類型帶入）
   - 計算週期（數字輸入，單位：天）
   - 運算子（下拉選單：>= / > / <= / < / =）
   - 預覽影響（即時顯示符合會員數）

3. **規則詳情頁**
   - 顯示規則完整參數
   - 顯示規則生效時間軸
   - 顯示符合該規則的會員列表

---

## 後續影響

### 需同步更新的規格檔案
1. **spec/erm.dbml**：新增 TagRule 表
2. **spec/features/tag_rule_management.feature**：新增標籤規則管理功能規格（新檔案）
3. **spec/features/member_tag_management.feature**：更新標籤自動生成邏輯，改為讀取 TagRule 表

### 需考慮的技術實作
1. **後端 API**：TagRule CRUD 端點
2. **排程任務**：定期執行標籤計算（讀取 TagRule 表動態執行規則）
3. **快取機制**：TagRule 變更時清除快取
4. **資料遷移**：將現有寫死的規則轉為 TagRule 資料

### 相關釐清項目
- **會員標籤_滾動12個月的計算基準日**（已完成）- 規則計算的時間基準

---

## 決策記錄
- **決策日期**：2025-11-13
- **決策者**：Stakeholder
- **選擇方案**：選項 C - 資料庫儲存 + 後台管理介面
- **決策理由**：
  1. 符合 SAAS 服務定位，提供客戶自助操作能力
  2. 飯店集團多據點可依據各自定位設定不同門檻
  3. 行銷團隊可快速調整規則因應市場變化，無需技術團隊介入
  4. 支援 A/B 測試不同門檻值的效果
  5. 系統已有管理介面基礎，延續現有架構

## 已完成的規格更新

### 1. 資料模型更新（spec/erm.dbml）

**新增 TagRule 表**：

```dbml
Table TagRule {
  rule_id string [pk]
  tag_name string [note: '標籤名稱（如：高消費客戶、常客）']
  tag_source string [note: '標籤來源：CRM / PMS']
  rule_type string [note: '規則類型：consumption_amount / visit_frequency / interaction_time / room_type']
  threshold_value float [note: '門檻值（如：30000 元、3 次）']
  threshold_unit string [note: '單位：NTD / times / days']
  period_days int [note: '計算週期（天數），如 365 表示滾動 12 個月']
  condition_operator string [note: '比較運算子：>= / > / <= / < / =']
  is_enabled bool [note: '是否啟用']
  created_at string
  updated_at string
}
```

**欄位說明**：
- **rule_type**：支援 4 種規則類型（消費金額、訪問頻率、互動時間、房型分類）
- **threshold_value**：門檻值（房型分類允許 NULL）
- **period_days**：計算週期（互動時間規則允許 NULL）
- **is_enabled**：支援啟用/停用功能

### 2. 功能規則更新（spec/features/tag_rule_management.feature）

**新增完整的標籤規則管理功能規格（新檔案）**，包含：

**Rule 1-4: 新增四種類型的標籤規則**
- 消費金額類型（如：高消費客戶 >= 30000 元）
- 訪問頻率類型（如：常客 >= 3 次）
- 互動時間類型（如：沉睡會員 > 60 天）
- 房型分類類型（如：雙人房）

**Rule 5-7: 規則管理功能**
- 編輯既有規則（調整門檻值、計算週期）
- 啟用/停用規則
- 刪除規則

**Rule 8: 影響範圍預覽**
- 即時計算門檻值調整後的符合會員數
- 顯示變化幅度（增減人數與百分比）

**Rule 9-10: 規則參數驗證**
- 門檻值必須為正數
- 計算週期建議不超過 730 天（顯示警告）

**Rule 11: 自動執行邏輯**
- 排程任務讀取 TagRule 表並執行規則
- 停用的規則不執行

**Rule 12-13: 篩選、搜尋與排序**
- 依規則類型、狀態篩選
- 搜尋標籤名稱
- 依建立時間或更新時間排序

### 3. 管理介面設計

**標籤規則列表頁**：
- 顯示所有規則的卡片或表格
- 支援篩選（規則類型、狀態）
- 支援搜尋（標籤名稱）
- 操作按鈕：新增、編輯、刪除、啟用/停用

**新增/編輯規則對話框**：
- 標籤名稱、規則類型、門檻值、單位、計算週期、運算子
- 即時預覽影響（符合會員數）

**規則詳情頁**：
- 顯示規則完整參數
- 顯示符合該規則的會員列表

### 4. 技術實作建議

**後端 API**：
- `GET /api/v1/tag-rules` - 查詢規則列表
- `POST /api/v1/tag-rules` - 新增規則
- `PUT /api/v1/tag-rules/{rule_id}` - 更新規則
- `DELETE /api/v1/tag-rules/{rule_id}` - 刪除規則
- `GET /api/v1/tag-rules/{rule_id}/preview` - 預覽影響範圍

**排程任務**：
- 定期執行標籤計算（每日凌晨執行）
- 讀取所有啟用的 TagRule
- 動態執行規則邏輯
- 為符合條件的會員建立 MemberTag 記錄

**快取機制**：
- TagRule 變更時清除快取
- 使用快取提升查詢效能
