# 釐清項目：登入系統_密碼複雜度要求

## 基本資訊
- **優先級**：Medium
- **類別**：功能模型
- **相關檔案**：
  - `spec/erm.dbml` (Admin.password_hash)
  - `spec/features/登入系統.feature` (Rule: 帳號與密碼支援英文、數字、特殊符號)

## 問題描述

現有規格定義了：
- `Admin.password_hash`：**密碼雜湊值，支援英文、數字、特殊符號**
- 登入系統 Rule：**帳號與密碼支援英文、數字、特殊符號**（#TODO）
- 範例密碼：`Pass123!`（顯示於登入系統.feature:31）

但規格中未明確定義：

1. **最小長度**：密碼至少需要幾個字元？（常見：8-16字元）
2. **最大長度**：密碼最多允許幾個字元？（避免 DOS 攻擊，常見：64-128字元）
3. **必需字元類型**：是否必須包含以下類型？
   - 英文大寫字母（A-Z）
   - 英文小寫字母（a-z）
   - 數字（0-9）
   - 特殊符號（如：!@#$%^&*）
4. **允許的特殊符號清單**：哪些特殊符號允許使用？
5. **禁止的密碼模式**：
   - 連續字元（如：123456、abcdef）
   - 重複字元（如：aaaaaa、111111）
   - 常見弱密碼（如：password、123456、qwerty）
   - 與使用者信箱相同或包含信箱
6. **密碼修改時的規則**：新密碼與舊密碼是否需要不同？
7. **錯誤提示**：密碼不符合要求時，如何提示使用者？

## 影響範圍

- **系統安全性**：密碼複雜度直接影響系統帳號安全
- **使用者體驗**：過於嚴格的規則可能影響使用便利性
- **前端驗證**：需實作即時密碼強度檢查與錯誤提示
- **後端驗證**：需實作伺服器端密碼規則驗證
- **註冊/修改密碼流程**：影響管理員註冊、重設密碼、修改密碼功能

## 選項分析

### 選項 A：基本密碼要求 - 8字元 + 2種類型（簡單）

**密碼規則**：
- **長度**：8-64 字元
- **必需類型**：至少包含以下 2 種類型：
  - 英文大寫字母（A-Z）
  - 英文小寫字母（a-z）
  - 數字（0-9）
  - 特殊符號
- **允許的特殊符號**：`!@#$%^&*()-_=+[]{}|;:,.<>?/~`
- **禁止規則**：無額外限制

**驗證時機**：
- 註冊時驗證
- 修改密碼時驗證

**錯誤提示範例**：
- 「密碼長度須為 8-64 字元」
- 「密碼須包含至少 2 種類型：大寫字母、小寫字母、數字、特殊符號」

**優點**：
- ✅ 簡單易懂（使用者容易記憶）
- ✅ 驗證邏輯簡單（前後端實作容易）
- ✅ 足夠的基本安全性

**缺點**：
- ❌ 安全性較低（允許較弱的密碼如 `abcd1234`）
- ❌ 無法防止常見弱密碼

**適用情境**：
- 內部管理系統（使用者為可信任的內部員工）
- 追求使用便利性

---

### 選項 B：中等密碼要求 - 8字元 + 3種類型 + 弱密碼檢查（推薦）

**密碼規則**：
- **長度**：8-64 字元
- **必需類型**：至少包含以下 3 種類型：
  - 英文大寫字母（A-Z）
  - 英文小寫字母（a-z）
  - 數字（0-9）
  - 特殊符號
- **允許的特殊符號**：`!@#$%^&*()-_=+[]{}|;:,.<>?/~`
- **禁止規則**：
  - 不允許純數字連續（如：123456、654321）
  - 不允許純字母連續（如：abcdef、fedcba）
  - 不允許重複字元超過 3 次（如：aaaa、1111）
  - 不允許常見弱密碼（預定義清單：password, 123456, qwerty, admin, 等）
  - 不允許與信箱相同或包含信箱帳號部分

**驗證時機**：
- 註冊時驗證
- 修改密碼時驗證
- 前端即時檢查（密碼強度指示器）

**錯誤提示範例**：
- 「密碼長度須為 8-64 字元」
- 「密碼須包含至少 3 種類型：大寫字母、小寫字母、數字、特殊符號」
- 「密碼不可包含連續字元（如 123456、abcdef）」
- 「密碼不可包含超過 3 次重複字元」
- 「密碼強度過弱，請使用更複雜的密碼」
- 「密碼不可與信箱相同」

**前端密碼強度指示器**：
- **弱**（紅色）：不符合最小要求
- **中**（橙色）：符合最小要求但未達推薦強度
- **強**（綠色）：符合推薦強度（12字元以上 + 4種類型）

**優點**：
- ✅ 平衡安全性與使用便利性
- ✅ 防止大部分常見弱密碼
- ✅ 前端即時回饋（使用者體驗佳）
- ✅ 符合業界標準（OWASP 建議）

**缺點**：
- ❌ 驗證邏輯稍複雜（需實作弱密碼清單檢查）
- ❌ 可能需要預定義弱密碼清單

**適用情境**：
- **一般管理系統**（推薦）
- 追求安全性與使用便利性的平衡

---

### 選項 C：嚴格密碼要求 - 12字元 + 4種類型 + 定期修改

**密碼規則**：
- **長度**：12-128 字元
- **必需類型**：必須包含所有 4 種類型：
  - 英文大寫字母（A-Z）
  - 英文小寫字母（a-z）
  - 數字（0-9）
  - 特殊符號
- **允許的特殊符號**：`!@#$%^&*()-_=+[]{}|;:,.<>?/~`
- **禁止規則**：
  - 所有選項 B 的禁止規則
  - 不允許與最近 3 次使用過的密碼相同
  - 密碼需每 90 天定期修改
  - 首次登入需強制修改密碼
- **密碼歷史記錄**：系統記錄最近 3 次密碼雜湊值，防止重複使用

**驗證時機**：
- 註冊時驗證
- 修改密碼時驗證
- 定期檢查密碼到期（每次登入時）
- 前端即時檢查（密碼強度指示器）

**錯誤提示範例**：
- 「密碼長度須為 12-128 字元」
- 「密碼必須包含大寫字母、小寫字母、數字、特殊符號」
- 「新密碼不可與最近 3 次使用過的密碼相同」
- 「密碼已過期，請修改密碼」

**優點**：
- ✅ 最高安全性（符合金融級安全標準）
- ✅ 防止密碼重複使用
- ✅ 定期修改降低密碼洩漏風險

**缺點**：
- ❌ 使用便利性差（使用者容易忘記密碼）
- ❌ 實作複雜度高（需密碼歷史記錄、到期檢查）
- ❌ 可能導致使用者使用密碼管理器或寫下密碼

**適用情境**：
- 金融系統、高度敏感資料系統
- 符合特定合規要求（如 PCI DSS、HIPAA）

---

### 選項 D：最小要求 - 6字元 + 1種類型（不推薦）

**密碼規則**：
- **長度**：6-64 字元
- **必需類型**：至少包含以下 1 種類型：
  - 英文字母（a-z, A-Z）
  - 數字（0-9）
  - 特殊符號
- **禁止規則**：無

**驗證時機**：
- 註冊時驗證
- 修改密碼時驗證

**錯誤提示範例**：
- 「密碼長度須為 6-64 字元」

**優點**：
- ✅ 最簡單（使用者容易記憶）
- ✅ 驗證邏輯最簡單

**缺點**：
- ❌ **安全性極低**（允許極弱密碼如 `123456`）
- ❌ 容易被暴力破解
- ❌ 不符合業界安全標準

**適用情境**：
- **不推薦使用**（安全性過低）

---

## 推薦方案

**推薦選項 B：中等密碼要求 - 8字元 + 3種類型 + 弱密碼檢查**

**推薦理由**：

1. **平衡安全性與使用便利性**：8 字元長度足夠安全且使用者容易記憶
2. **符合業界標準**：OWASP 建議至少 8 字元 + 多種字元類型
3. **防止常見弱密碼**：透過弱密碼清單檢查，有效防止大部分弱密碼
4. **前端即時回饋**：密碼強度指示器提升使用者體驗
5. **實作難度適中**：前後端驗證邏輯不會過於複雜
6. **適合一般管理系統**：內部管理系統無需過於嚴格的規則（如定期修改密碼）

**次要推薦選項 A**（若追求極簡）：
- 適合內部可信任環境
- 實作最簡單

**不推薦選項 C**（除非有特殊合規要求）：
- 對於一般飯店管理系統過於嚴格
- 定期修改密碼可能降低使用便利性

---

## 設計細節（基於推薦選項 B）

### 密碼驗證規則實作

**前端驗證（JavaScript/TypeScript）**：

```typescript
interface PasswordValidation {
  isValid: boolean;
  errors: string[];
  strength: 'weak' | 'medium' | 'strong';
}

function validatePassword(password: string, email: string): PasswordValidation {
  const errors: string[] = [];
  let strength: 'weak' | 'medium' | 'strong' = 'weak';

  // 長度檢查
  if (password.length < 8 || password.length > 64) {
    errors.push('密碼長度須為 8-64 字元');
  }

  // 字元類型檢查
  const hasUpperCase = /[A-Z]/.test(password);
  const hasLowerCase = /[a-z]/.test(password);
  const hasNumber = /[0-9]/.test(password);
  const hasSpecialChar = /[!@#$%^&*()\-_=+\[\]{}|;:,.<>?/~]/.test(password);

  const typeCount = [hasUpperCase, hasLowerCase, hasNumber, hasSpecialChar].filter(Boolean).length;

  if (typeCount < 3) {
    errors.push('密碼須包含至少 3 種類型：大寫字母、小寫字母、數字、特殊符號');
  }

  // 連續字元檢查
  if (/(?:012|123|234|345|456|567|678|789|abc|bcd|cde|def|efg|fgh|ghi|hij|ijk|jkl|klm|lmn|mno|nop|opq|pqr|qrs|rst|stu|tuv|uvw|vwx|wxy|xyz)/i.test(password)) {
    errors.push('密碼不可包含連續字元（如 123456、abcdef）');
  }

  // 重複字元檢查
  if (/(.)\1{3,}/.test(password)) {
    errors.push('密碼不可包含超過 3 次重複字元');
  }

  // 弱密碼清單檢查
  const weakPasswords = ['password', '123456', '12345678', 'qwerty', 'abc123', 'admin', 'letmein', 'welcome', '111111', '123123'];
  if (weakPasswords.some(weak => password.toLowerCase().includes(weak))) {
    errors.push('密碼強度過弱，請使用更複雜的密碼');
  }

  // 信箱檢查
  const emailUsername = email.split('@')[0];
  if (password.toLowerCase().includes(emailUsername.toLowerCase())) {
    errors.push('密碼不可與信箱相同');
  }

  // 密碼強度評估
  if (errors.length === 0) {
    if (password.length >= 12 && typeCount === 4) {
      strength = 'strong';
    } else {
      strength = 'medium';
    }
  }

  return {
    isValid: errors.length === 0,
    errors,
    strength
  };
}
```

**前端密碼強度指示器（React 範例）**：

```tsx
function PasswordStrengthIndicator({ strength }: { strength: 'weak' | 'medium' | 'strong' }) {
  const colors = {
    weak: 'bg-red-500',
    medium: 'bg-orange-500',
    strong: 'bg-green-500'
  };

  const labels = {
    weak: '弱',
    medium: '中',
    strong: '強'
  };

  return (
    <div className="flex items-center gap-2">
      <div className="flex gap-1">
        <div className={`h-2 w-8 rounded ${strength === 'weak' || strength === 'medium' || strength === 'strong' ? colors[strength] : 'bg-gray-300'}`}></div>
        <div className={`h-2 w-8 rounded ${strength === 'medium' || strength === 'strong' ? colors[strength] : 'bg-gray-300'}`}></div>
        <div className={`h-2 w-8 rounded ${strength === 'strong' ? colors[strength] : 'bg-gray-300'}`}></div>
      </div>
      <span className="text-sm">{labels[strength]}</span>
    </div>
  );
}
```

**後端驗證（Python FastAPI 範例）**：

```python
import re
from typing import List

WEAK_PASSWORDS = [
    'password', '123456', '12345678', 'qwerty', 'abc123',
    'admin', 'letmein', 'welcome', '111111', '123123'
]

def validate_password(password: str, email: str) -> tuple[bool, List[str]]:
    """驗證密碼是否符合複雜度要求"""
    errors = []

    # 長度檢查
    if len(password) < 8 or len(password) > 64:
        errors.append('密碼長度須為 8-64 字元')

    # 字元類型檢查
    has_upper = bool(re.search(r'[A-Z]', password))
    has_lower = bool(re.search(r'[a-z]', password))
    has_number = bool(re.search(r'[0-9]', password))
    has_special = bool(re.search(r'[!@#$%^&*()\-_=+\[\]{}|;:,.<>?/~]', password))

    type_count = sum([has_upper, has_lower, has_number, has_special])

    if type_count < 3:
        errors.append('密碼須包含至少 3 種類型：大寫字母、小寫字母、數字、特殊符號')

    # 連續字元檢查
    consecutive_pattern = r'(?:012|123|234|345|456|567|678|789|abc|bcd|cde|def|efg|fgh|ghi|hij|ijk|jkl|klm|lmn|mno|nop|opq|pqr|qrs|rst|stu|tuv|uvw|vwx|wxy|xyz)'
    if re.search(consecutive_pattern, password.lower()):
        errors.append('密碼不可包含連續字元（如 123456、abcdef）')

    # 重複字元檢查
    if re.search(r'(.)\1{3,}', password):
        errors.append('密碼不可包含超過 3 次重複字元')

    # 弱密碼檢查
    for weak in WEAK_PASSWORDS:
        if weak in password.lower():
            errors.append('密碼強度過弱，請使用更複雜的密碼')
            break

    # 信箱檢查
    email_username = email.split('@')[0]
    if email_username.lower() in password.lower():
        errors.append('密碼不可與信箱相同')

    return len(errors) == 0, errors
```

### 功能規則新增

**登入系統.feature 更新 Rule: 帳號與密碼支援英文、數字、特殊符號**：

```gherkin
Rule: 密碼須符合複雜度要求（8-64字元 + 至少3種類型）

  Example: 密碼長度不足 8 字元
    Given 管理員正在註冊或修改密碼
    When 管理員輸入密碼「Pass12!」（7字元）
    Then 系統顯示錯誤訊息「密碼長度須為 8-64 字元」
    And 系統阻擋註冊或修改操作

  Example: 密碼長度超過 64 字元
    Given 管理員正在註冊或修改密碼
    When 管理員輸入密碼長度為 65 字元
    Then 系統顯示錯誤訊息「密碼長度須為 8-64 字元」
    And 系統阻擋註冊或修改操作

  Example: 密碼僅包含 2 種類型（不符合要求）
    Given 管理員正在註冊或修改密碼
    When 管理員輸入密碼「abcd1234」（僅小寫字母 + 數字）
    Then 系統顯示錯誤訊息「密碼須包含至少 3 種類型：大寫字母、小寫字母、數字、特殊符號」
    And 系統阻擋註冊或修改操作

  Example: 密碼包含 3 種類型（符合要求）
    Given 管理員正在註冊或修改密碼
    When 管理員輸入密碼「Pass1234」（大寫字母 + 小寫字母 + 數字）
    Then 系統驗證密碼符合複雜度要求
    And 系統允許註冊或修改操作

  Example: 密碼包含 4 種類型（強密碼）
    Given 管理員正在註冊或修改密碼
    When 管理員輸入密碼「Pass123!」（大寫字母 + 小寫字母 + 數字 + 特殊符號）
    Then 系統驗證密碼符合複雜度要求
    And 系統顯示密碼強度為「強」
    And 系統允許註冊或修改操作

Rule: 密碼不可包含連續字元或過多重複字元

  Example: 密碼包含連續數字
    Given 管理員正在註冊或修改密碼
    When 管理員輸入密碼「Pass123456」（包含連續數字 123456）
    Then 系統顯示錯誤訊息「密碼不可包含連續字元（如 123456、abcdef）」
    And 系統阻擋註冊或修改操作

  Example: 密碼包含連續字母
    Given 管理員正在註冊或修改密碼
    When 管理員輸入密碼「Passabcdef1」（包含連續字母 abcdef）
    Then 系統顯示錯誤訊息「密碼不可包含連續字元（如 123456、abcdef）」
    And 系統阻擋註冊或修改操作

  Example: 密碼包含超過 3 次重複字元
    Given 管理員正在註冊或修改密碼
    When 管理員輸入密碼「Passaaaa1」（包含 4 個連續 a）
    Then 系統顯示錯誤訊息「密碼不可包含超過 3 次重複字元」
    And 系統阻擋註冊或修改操作

Rule: 密碼不可為常見弱密碼或與信箱相同

  Example: 密碼為常見弱密碼
    Given 管理員正在註冊或修改密碼
    When 管理員輸入密碼「password」（常見弱密碼）
    Then 系統顯示錯誤訊息「密碼強度過弱，請使用更複雜的密碼」
    And 系統阻擋註冊或修改操作

  Example: 密碼與信箱相同
    Given 管理員正在註冊，信箱為「admin@example.com」
    When 管理員輸入密碼「admin123」（包含信箱帳號 admin）
    Then 系統顯示錯誤訊息「密碼不可與信箱相同」
    And 系統阻擋註冊或修改操作

  Example: 密碼符合所有要求
    Given 管理員正在註冊，信箱為「admin@example.com」
    When 管理員輸入密碼「Pass123!」
    Then 系統驗證密碼符合所有複雜度要求
    And 系統允許註冊操作

Rule: 前端即時顯示密碼強度指示器

  Example: 輸入密碼時即時顯示強度
    Given 管理員正在註冊或修改密碼頁面
    When 管理員輸入密碼「Pass1234」（8字元 + 3種類型）
    Then 前端即時顯示密碼強度為「中」（橙色）
    And 前端顯示強度指示條（2/3 填滿）

  Example: 強密碼顯示綠色指示器
    Given 管理員正在註冊或修改密碼頁面
    When 管理員輸入密碼「StrongPass123!」（12字元以上 + 4種類型）
    Then 前端即時顯示密碼強度為「強」（綠色）
    And 前端顯示強度指示條（3/3 填滿）
```

---

## 後續影響

### 需同步更新的規格檔案
1. **spec/erm.dbml**：Admin.password_hash 欄位說明更新（明確密碼複雜度要求）
2. **spec/features/登入系統.feature**：更新 #TODO 規則，新增密碼複雜度驗證範例

### 需考慮的技術實作
1. **前端密碼驗證函數**：即時驗證密碼複雜度、顯示錯誤訊息
2. **前端密碼強度指示器**：視覺化顯示密碼強度（弱/中/強）
3. **後端密碼驗證**：伺服器端最終驗證（防止前端繞過）
4. **弱密碼清單維護**：定期更新常見弱密碼清單
5. **密碼雜湊**：使用 bcrypt/scrypt/Argon2 等安全雜湊演算法

### 相關釐清項目
- **登入系統_24小時自動登入的實作機制**（已釐清）- JWT Token 實作方式
- **登入系統_授權到期檢查與展延流程**（Low 優先級）- 授權到期處理流程

---

## 決策記錄
- **決策日期**：2025-01-13
- **決策者**：專案團隊
- **選擇方案**：選項 B - 中等密碼要求（8字元 + 3種類型 + 弱密碼檢查）
- **決策理由**：
  1. 平衡安全性與使用便利性：8 字元長度足夠安全且使用者容易記憶
  2. 符合業界標準：OWASP 建議至少 8 字元 + 多種字元類型
  3. 防止常見弱密碼：透過弱密碼清單檢查，有效防止大部分弱密碼
  4. 前端即時回饋：密碼強度指示器提升使用者體驗
  5. 適合一般管理系統：內部管理系統無需過於嚴格的規則（如定期修改密碼）

## 實作內容
- **已更新 spec/erm.dbml**：Admin.password_hash 欄位說明更新，明確密碼複雜度要求（8-64字元、至少3種類型、禁止連續字元、禁止重複字元、禁止弱密碼、禁止與信箱相同）
- **已更新 spec/features/登入系統.feature**：替換 #TODO，新增 4 個 Rule with 13 個 Examples 涵蓋密碼複雜度驗證、連續字元檢查、弱密碼檢查、密碼強度指示器
