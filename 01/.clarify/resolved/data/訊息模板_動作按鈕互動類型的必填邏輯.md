# 釐清項目：訊息模板_動作按鈕互動類型的必填邏輯

## 基本資訊
- **優先級**：Medium
- **類別**：功能模型
- **相關檔案**：
  - `spec/erm.dbml` (MessageTemplate.action_type, action_url, action_text, action_image)
  - `spec/features/message_template.feature` (按鈕互動類型設定)

## 問題描述

現有規格定義了動作按鈕的互動類型與對應欄位：
- `action_type`：開啟網址 / 觸發文字 / 觸發圖片
- `action_url`：**當 action_type = 開啟網址時必填**
- `action_text`：**當 action_type = 觸發文字時必填**
- `action_image`：**當 action_type = 觸發圖片時必填**

但規格中未明確定義：

1. **action_type 本身是否必填**：按鈕可以不設定互動類型嗎？若可以，按鈕點擊時會發生什麼？
2. **前端驗證時機**：何時進行必填驗證？即時驗證、儲存時、還是發送前？
3. **錯誤提示**：若未填寫必填欄位，系統如何提示使用者？
4. **變更互動類型時的處理**：若使用者從「開啟網址」改為「觸發文字」，舊的 action_url 值應該保留、清空、還是不管？
5. **儲存草稿的容錯**：草稿狀態是否允許 action_type 已設定但對應欄位未填？
6. **發送前的最終驗證**：發送群發訊息前，系統如何確保所有必填欄位已填寫？

## 影響範圍

- **使用者體驗**：驗證時機影響操作流暢度、錯誤提示清晰度
- **資料完整性**：儲存邏輯影響資料庫儲存的資料是否完整
- **系統穩定性**：發送前驗證確保不會發送不完整的訊息到 LINE API
- **前端開發複雜度**：驗證邏輯需明確定義，避免前後端不一致

## 選項分析

### 選項 A：嚴格驗證 - action_type 必填 + 即時驗證

**驗證規則**：
- **action_type 必填**：必須選擇一種互動類型（開啟網址 / 觸發文字 / 觸發圖片）
- **對應欄位必填**：選擇互動類型後，對應欄位立即變為必填
- **即時驗證**：使用者選擇互動類型後，即時檢查對應欄位是否已填寫
- **阻擋儲存**：若必填欄位未填，無法儲存草稿或發送

**驗證時機**：
1. **選擇互動類型時**：立即顯示必填欄位標記（紅色星號）
2. **切換互動類型時**：檢查新的必填欄位是否已填，若未填則即時提示
3. **儲存草稿時**：檢查所有必填欄位，若未填則阻擋儲存並顯示錯誤訊息
4. **發送訊息時**：最終驗證，確保所有必填欄位已填寫

**切換互動類型的處理**：
- 保留舊值（不清空），但不驗證舊值
- 例如：從「開啟網址」切換到「觸發文字」，action_url 保留但不驗證，action_text 變為必填

**錯誤提示**：
- **即時提示**：選擇互動類型後，若對應欄位為空，欄位旁顯示「此欄位為必填」
- **儲存時提示**：若有未填欄位，顯示彈窗「請填寫所有必填欄位：[欄位名稱列表]」
- **發送前提示**：最終驗證失敗時，顯示「訊息設定不完整，無法發送」

**優點**：
- ✅ 確保資料完整性（無法儲存不完整的資料）
- ✅ 使用者體驗良好（即時知道哪些欄位需要填寫）
- ✅ 系統穩定性高（不會發送不完整的訊息）

**缺點**：
- ❌ 嚴格限制（不允許儲存未完成的草稿）
- ❌ 前端驗證邏輯複雜（需實作即時驗證）

**適用情境**：
- 追求資料完整性
- 使用者操作流程清晰（不需要多次中斷儲存）

---

### 選項 B：寬鬆驗證 - 草稿容錯 + 發送前嚴格驗證（推薦）

**驗證規則**：
- **action_type 選填**：按鈕可以不設定互動類型（允許儲存草稿時未完成）
- **草稿容錯**：儲存草稿時，允許 action_type 已設定但對應欄位未填
- **發送前嚴格驗證**：發送訊息前，必須完成所有必填欄位驗證

**驗證時機**：
1. **選擇互動類型時**：顯示必填欄位標記（紅色星號），但不阻擋操作
2. **儲存草稿時**：不驗證必填欄位（允許儲存未完成的設定）
3. **發送訊息時**：嚴格驗證，若必填欄位未填，阻擋發送並顯示錯誤訊息

**切換互動類型的處理**：
- 保留舊值（不清空），使用者可手動清空或覆蓋
- 例如：從「開啟網址」切換到「觸發文字」，action_url 保留，action_text 顯示為必填

**錯誤提示**：
- **即時提示**：選擇互動類型後，顯示必填標記（星號），但不顯示錯誤訊息
- **發送前提示**：若有未填必填欄位，顯示彈窗「訊息設定不完整，無法發送：
  - action_type 為「開啟網址」但 action_url 未填寫
  - action_type 為「觸發文字」但 action_text 未填寫
  - ...」

**優點**：
- ✅ 使用者體驗佳（允許儲存未完成的草稿，中途離開不會遺失）
- ✅ 前端驗證邏輯簡單（只在發送前驗證）
- ✅ 草稿容錯性高（不強制立即完成設定）
- ✅ 發送前嚴格把關（確保不會發送不完整的訊息）

**缺點**：
- ❌ 草稿可能儲存不完整資料（但不影響發送）
- ❌ 使用者可能忘記填寫必填欄位（需在發送時提醒）

**適用情境**：
- **草稿工作流程**（使用者可能中途離開，稍後繼續編輯）
- 追求使用者體驗（不強制立即完成所有設定）

---

### 選項 C：按鈕互動類型選填 + 無互動按鈕支援

**驗證規則**：
- **action_type 選填**：按鈕可以不設定互動類型（純展示按鈕）
- **無互動按鈕行為**：若 action_type 為 NULL 或未設定，按鈕點擊後無反應（僅展示）
- **有互動類型時**：對應欄位變為必填，發送前驗證

**驗證時機**：
1. **選擇互動類型時**：顯示必填標記
2. **發送訊息時**：檢查有設定 action_type 的按鈕，驗證對應欄位

**切換互動類型的處理**：
- 允許清空 action_type（設為 NULL），此時所有 action_* 欄位不驗證
- 允許保留舊值（不清空）

**錯誤提示**：
- **發送前提示**：若有設定 action_type 但對應欄位未填，阻擋發送並提示

**優點**：
- ✅ 支援純展示按鈕（無互動功能）
- ✅ 靈活性高（按鈕可以有或沒有互動）

**缺點**：
- ❌ 使用者可能誤以為按鈕有功能（實際上點擊無反應）
- ❌ LINE API 可能不支援無互動按鈕（需確認 LINE Flex Message 規範）

**適用情境**：
- 需要支援純展示按鈕
- LINE API 支援無互動按鈕

---

### 選項 D：後端統一驗證 + 前端提示

**驗證規則**：
- **前端僅提示**：顯示必填標記，但不阻擋操作
- **後端統一驗證**：儲存草稿和發送訊息時，後端驗證必填欄位
- **後端返回錯誤**：若驗證失敗，後端返回錯誤訊息，前端顯示

**驗證時機**：
1. **前端**：即時顯示必填標記（星號），不驗證
2. **後端儲存草稿**：允許儲存未完成的設定（不驗證）
3. **後端發送訊息**：嚴格驗證，若失敗返回錯誤

**切換互動類型的處理**：
- 前端不處理（由使用者手動管理舊值）
- 後端驗證時檢查對應欄位

**錯誤提示**：
- **前端提示**：必填標記（星號）
- **後端錯誤**：返回錯誤訊息，前端解析並顯示

**優點**：
- ✅ 前端邏輯簡單（不需實作複雜驗證）
- ✅ 後端統一把關（確保資料完整性）

**缺點**：
- ❌ 使用者體驗稍差（需等待後端返回錯誤）
- ❌ 後端驗證邏輯複雜（需處理多種錯誤情境）

**適用情境**：
- 前端技術能力有限
- 追求後端統一驗證

---

## 推薦方案

**推薦選項 B：寬鬆驗證 - 草稿容錯 + 發送前嚴格驗證**

**推薦理由**：

1. **使用者體驗最佳**：允許儲存未完成的草稿，使用者可中途離開並稍後繼續編輯
2. **前端邏輯簡單**：只在發送前進行驗證，減少前端複雜度
3. **草稿容錯性高**：不強制立即完成所有設定，使用者可逐步完善訊息內容
4. **發送前嚴格把關**：確保不會發送不完整的訊息到 LINE API，保障系統穩定性
5. **符合草稿工作流程**：大多數內容管理系統都採用這種策略

**次要推薦選項 A**（若特別重視資料完整性）：
- 嚴格驗證可確保資料庫中的資料始終完整
- 適合不需要草稿工作流程的情境

---

## 設計細節（基於推薦選項 B）

### 前端實作

**必填標記顯示**：

```tsx
// 當 action_type 選擇後，對應欄位顯示必填標記
<Select value={actionType} onChange={handleActionTypeChange}>
  <option value="">請選擇互動類型</option>
  <option value="開啟網址">開啟網址</option>
  <option value="觸發文字">觸發文字</option>
  <option value="觸發圖片">觸發圖片</option>
</Select>

{actionType === '開啟網址' && (
  <div>
    <label>
      URL 網址 <span className="required">*</span>
    </label>
    <input
      type="url"
      value={actionUrl}
      onChange={(e) => setActionUrl(e.target.value)}
      placeholder="https://example.com"
    />
  </div>
)}

{actionType === '觸發文字' && (
  <div>
    <label>
      觸發文字 <span className="required">*</span>
    </label>
    <input
      type="text"
      value={actionText}
      onChange={(e) => setActionText(e.target.value)}
      placeholder="輸入觸發的訊息文字"
    />
  </div>
)}

{actionType === '觸發圖片' && (
  <div>
    <label>
      觸發圖片 <span className="required">*</span>
    </label>
    <input
      type="file"
      accept="image/*"
      onChange={handleImageUpload}
    />
  </div>
)}
```

**發送前驗證**：

```tsx
function validateBeforeSend(template: MessageTemplate): string[] {
  const errors: string[] = [];

  // 檢查 action_type 與對應欄位
  if (template.action_type === '開啟網址' && !template.action_url) {
    errors.push('互動類型為「開啟網址」但 URL 網址未填寫');
  }

  if (template.action_type === '觸發文字' && !template.action_text) {
    errors.push('互動類型為「觸發文字」但觸發文字未填寫');
  }

  if (template.action_type === '觸發圖片' && !template.action_image) {
    errors.push('互動類型為「觸發圖片」但觸發圖片未上傳');
  }

  return errors;
}

function handleSend() {
  const errors = validateBeforeSend(messageTemplate);

  if (errors.length > 0) {
    // 顯示錯誤彈窗
    showErrorDialog({
      title: '訊息設定不完整',
      message: '無法發送訊息，請完成以下設定：\n' + errors.join('\n')
    });
    return;
  }

  // 發送訊息
  sendMessage(messageTemplate);
}
```

### 功能規則新增

**message_template.feature 新增驗證規則**：

```gherkin
Rule: 儲存草稿時允許 action_type 已設定但對應欄位未填（草稿容錯）

  Example: 儲存草稿時 action_type 為「開啟網址」但 action_url 未填
    Given 內容管理者已設定按鈕互動類型為「開啟網址」
    And 尚未輸入 URL 網址
    When 內容管理者點擊「儲存為草稿」
    Then 系統允許儲存草稿
    And 系統記錄 action_type 為「開啟網址」
    And 系統記錄 action_url 為 NULL

  Example: 儲存草稿時 action_type 為「觸發文字」但 action_text 未填
    Given 內容管理者已設定按鈕互動類型為「觸發文字」
    And 尚未輸入觸發文字
    When 內容管理者點擊「儲存為草稿」
    Then 系統允許儲存草稿
    And 系統記錄 action_type 為「觸發文字」
    And 系統記錄 action_text 為 NULL

Rule: 發送訊息前嚴格驗證 action_type 與對應欄位

  Example: 發送訊息時 action_type 為「開啟網址」但 action_url 未填
    Given 內容管理者已設定按鈕互動類型為「開啟網址」
    And action_url 為 NULL
    When 內容管理者點擊「發送訊息」
    Then 系統阻擋發送
    And 系統顯示錯誤訊息「互動類型為「開啟網址」但 URL 網址未填寫」

  Example: 發送訊息時 action_type 為「觸發文字」但 action_text 未填
    Given 內容管理者已設定按鈕互動類型為「觸發文字」
    And action_text 為 NULL
    When 內容管理者點擊「發送訊息」
    Then 系統阻擋發送
    And 系統顯示錯誤訊息「互動類型為「觸發文字」但觸發文字未填寫」

  Example: 發送訊息時 action_type 為「觸發圖片」但 action_image 未上傳
    Given 內容管理者已設定按鈕互動類型為「觸發圖片」
    And action_image 為 NULL
    When 內容管理者點擊「發送訊息」
    Then 系統阻擋發送
    And 系統顯示錯誤訊息「互動類型為「觸發圖片」但觸發圖片未上傳」

  Example: 發送訊息時所有必填欄位已填寫
    Given 內容管理者已設定按鈕互動類型為「開啟網址」
    And action_url 已填寫為「https://example.com/book」
    When 內容管理者點擊「發送訊息」
    Then 系統允許發送訊息

Rule: 切換互動類型時保留舊值（不清空）

  Example: 從「開啟網址」切換到「觸發文字」保留 action_url
    Given 內容管理者已設定 action_type 為「開啟網址」
    And action_url 為「https://example.com/book」
    When 內容管理者切換 action_type 為「觸發文字」
    Then 系統保留 action_url 為「https://example.com/book」
    And 系統顯示 action_text 為必填欄位（紅色星號）

  Example: 從「觸發文字」切換到「開啟網址」保留 action_text
    Given 內容管理者已設定 action_type 為「觸發文字」
    And action_text 為「我要預訂房間」
    When 內容管理者切換 action_type 為「開啟網址」
    Then 系統保留 action_text 為「我要預訂房間」
    And 系統顯示 action_url 為必填欄位（紅色星號）

Rule: action_type 本身為選填（允許按鈕不設定互動類型）

  Example: 儲存草稿時 action_type 未設定
    Given 內容管理者已新增按鈕「立即預訂」
    And 尚未選擇互動類型
    When 內容管理者點擊「儲存為草稿」
    Then 系統允許儲存草稿
    And 系統記錄 action_type 為 NULL

  Example: 發送訊息時 action_type 未設定（警告但不阻擋）
    Given 內容管理者已新增按鈕「立即預訂」
    And action_type 為 NULL
    When 內容管理者點擊「發送訊息」
    Then 系統顯示警告訊息「按鈕「立即預訂」未設定互動類型，點擊後將無反應」
    And 系統允許發送訊息（由使用者決定是否繼續）
```

---

## 後續影響

### 需同步更新的規格檔案
1. **spec/erm.dbml**：MessageTemplate 欄位說明更新（明確 action_type 為選填，對應欄位在發送前驗證）
2. **spec/features/message_template.feature**：新增驗證規則與錯誤處理範例

### 需考慮的技術實作
1. **前端驗證邏輯**：發送前驗證函數、錯誤訊息彈窗
2. **草稿儲存邏輯**：允許儲存未完成的設定（不驗證必填欄位）
3. **錯誤提示 UI**：錯誤彈窗、必填標記（紅色星號）
4. **切換互動類型的 UX**：保留舊值、顯示新的必填欄位

### 相關釐清項目
- **訊息模板_圖片裁切邏輯與預覽**（已釐清）- action_image 欄位的圖片處理策略

---

## 決策記錄
- **決策日期**：2025-01-13
- **決策者**：專案團隊
- **選擇方案**：選項 B - 寬鬆驗證（草稿容錯 + 發送前嚴格驗證）
- **決策理由**：
  1. 使用者體驗最佳：允許儲存未完成的草稿，使用者可中途離開並稍後繼續編輯
  2. 前端邏輯簡單：只在發送前進行驗證，減少前端複雜度
  3. 草稿容錯性高：不強制立即完成所有設定，使用者可逐步完善訊息內容
  4. 發送前嚴格把關：確保不會發送不完整的訊息到 LINE API，保障系統穩定性
  5. 符合草稿工作流程：大多數內容管理系統都採用這種策略

## 實作內容
- **已更新 spec/erm.dbml**：MessageTemplate.action_type, action_url, action_text, action_image 欄位說明更新，明確草稿容錯與發送前驗證邏輯、切換互動類型時保留舊值
- **已更新 spec/features/message_template.feature**：新增 4 個 Rule with 10 個 Examples 涵蓋草稿容錯、發送前驗證、切換類型處理、action_type 選填邏輯
