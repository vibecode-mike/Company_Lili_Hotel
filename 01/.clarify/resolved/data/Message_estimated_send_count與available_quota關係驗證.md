# 釐清問題

Message 表的 estimated_send_count 與 available_quota 之間有不變條件「available_quota < estimated_send_count 時須阻擋發送」，但未明確定義驗證時機與錯誤處理策略

# 定位

ERM: Message 表 Note 說明
「不變條件：若 available_quota < estimated_send_count，系統須阻擋發送行為」

# 多選題

| 選項 | 描述 |
|--------|-------------|
| A | 排程發送前驗證配額，不足時自動取消排程並通知管理員 |
| B | 排程發送前驗證配額，不足時暫停發送並等待下次排程時重試 |
| C | 發送按鈕點擊時即時驗證配額，不足時顯示錯誤訊息並阻擋排程 |
| D | 每小時自動檢查所有已排程訊息的配額狀態，不足時發送警告通知 |
| Short | 提供其他簡短答案(<=5 字) |

# 影響範圍

影響範圍：
1. 群發訊息建立與排程 API 需實作配額驗證邏輯
2. 排程任務執行前需再次驗證配額（防止配額變動）
3. 前端 UI 需顯示配額不足的錯誤提示
4. 管理員通知機制設計

# 優先級

High

理由：
- 業務影響：配額不足會導致發送失敗，影響行銷活動
- 使用者體驗：需提前告知配額狀態避免排程後失敗
- 成本控制：避免超額使用 LINE API 產生額外費用

---

# 解決記錄

- **回答**：選擇 C。使用者按下送出或排程時即時檢查 available_quota 與 estimated_send_count；不足時直接返回錯誤並阻擋排程，不做自動重試。
- **更新的規格檔**：`spec/erm.dbml`
- **變更內容**：
  1. 在 Message Note 中新增「配額檢查」段落，說明即時驗證時機與流程。
  2. 明確指出排程執行前不再自動重試，需人工補足額度或調整鎖定對象後重新送出。
- **業務影響**：
  - 管理員能在操作當下立即得知配額不足，避免排程後才發現失敗。
  - 系統不負責排程期間的自動等待與重試，節省資源並要求使用者主動處理配額。
