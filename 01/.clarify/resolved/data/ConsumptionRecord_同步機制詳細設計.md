# 釐清問題

ConsumptionRecord 透過「定期同步機制」從 CRM/PMS 匯入，同步頻率、衝突處理、失敗重試機制為何？

# 定位

ERM：spec/erm.dbml ConsumptionRecord 表格（約第105-114行）
Feature：spec/features/member_management.feature Rule 關於定期同步（約第212-218行）

# 多選題

| 選項 | 描述 |
|--------|-------------|
| A | 每日凌晨 02:00 全量同步，以 CRM 資料為準覆蓋本地 |
| B | 每日凌晨增量同步，僅同步新增或更新的紀錄（需 timestamp 比對） |
| C | 每 4 小時同步一次，支援手動觸發，記錄同步日誌 |
| D | 使用 CDC（Change Data Capture）即時同步，延遲 <5 分鐘 |
| Short | 其他機制（<=5字）|

# 影響範圍

影響系統架構設計、資料一致性保證、同步任務排程、錯誤監控與告警，以及 PMS 整合介面設計。

# 優先級

High

---
# 解決記錄

- **回答**：A - 每日凌晨 02:00 全量同步，以 CRM 資料為準覆蓋本地
- **更新的規格檔**：spec/erm.dbml、spec/features/member_management.feature
- **變更內容**：
  1. 更新 ConsumptionRecord 表格 Note，詳細說明同步機制
  2. 更新 member_management.feature，新增 3 個 Example：
     - 定期同步消費紀錄（每日凌晨 02:00 全量同步）
     - 同步失敗記錄日誌並次日重試
     - 連續失敗超過 3 日系統告警
- **同步機制設計**：
  - **同步頻率**：每日凌晨 02:00 執行（飯店業務低峰期）
  - **同步模式**：全量同步（CRM 資料為準，覆蓋本地資料）
  - **衝突處理**：以 CRM 系統資料為唯一來源，不處理衝突
  - **失敗重試**：記錄失敗日誌，次日自動重試；連續失敗超過 3 日則系統告警
  - **同步記錄**：記錄同步時間、同步筆數、失敗原因供人工檢查
- **設計理由**：
  - **需求特性**：消費紀錄用於分析消費頻率，不需要實時性
  - **資料量**：飯店消費紀錄相對不大，全量同步成本低
  - **實作成本**：全量同步最簡單，無需複雜的增量比對邏輯
  - **容錯性**：失敗後次日自動重試，記錄日誌供人工檢查
