# 釐清問題

多渠道會員合併（依 email 匹配）應在什麼時機觸發？

# 定位

- ERM：Member 表 - email 欄位（unique 約束）
- Feature：聊天室多渠道 - Rule: 當不同渠道的 email 相同時，系統應合併為同一 member_id

# 多選題

| 選項 | 描述 |
|--------|-------------|
| A | 即時合併：OAuth 登入取得 email 時立即檢查並合併 |
| B | 批次合併：每日排程批次掃描重複 email 並合併 |
| C | 人工觸發：客服在會員詳情頁面手動觸發合併 |
| D | 混合模式：OAuth 登入時即時合併 + 每日批次補漏 |
| Short | 提供其他簡短答案（<=5 字）|

# 影響範圍

- OAuth 登入流程複雜度
- 會員資料一致性
- 客服聊天室即時性
- 系統效能（即時 vs 批次）

# 優先級

Medium - 影響多渠道整合的即時性和資料一致性

---

# 解決記錄

**解決日期**: 2025-12-11
**初始選擇**: A - 即時合併：OAuth 登入取得 email 時立即檢查並合併
**修訂選擇**: D - 混合策略（因 OAuth 不一定取得 email）

**修訂原因**:
- OAuth 不一定取得 email：LINE/Facebook 用戶可能拒絕授權 email scope
- 需要備援機制：無 email 時仍需有合併邏輯

**最終決策 - 混合策略**:
合併優先順序：
1. email 相同 → 合併為同一 member_id
2. 同渠道 UID 已存在 → 使用既有 member_id（同一用戶重複登入）
3. 以上都不符合 → 建立新 member_id

延遲合併：若 OAuth 未取得 email，日後用戶填入 email 時再觸發合併

**補充規格（用戶確認）**:
- 合併策略：新資料優先覆蓋非空欄位，空白不覆蓋舊資料
- 標籤合併：去重合併集合

**規格更新位置**:
- ERM: WebchatFriend Note 區段更新「跨渠道會員合併觸發時機」規則 (line 301-308)
- Feature: 聊天室多渠道.feature 更新「多渠道會員合併」Rule 描述，新增 5 個 Example (line 177-223)
