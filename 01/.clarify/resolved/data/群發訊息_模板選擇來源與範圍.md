# 釐清問題

建立群發訊息時，模板選擇的來源與範圍為何？只能從模板庫選擇？還是可以臨時建立新模板？選擇後的關聯方式是引用還是複製？

# 定位

ERM：spec/erm.dbml Message 表格 template_id 欄位（約第95行）
Feature：spec/features/create_broadcast.feature Rule「使用者可以從已建立的訊息圖文模板中選擇並建立群發訊息」（約第6-11行）

# 背景資訊

**目前定義**：
- Message.template_id 關聯到 MessageTemplate（FK）
- create_broadcast.feature 說明「從已建立的訊息圖文模板中選擇」
- Message 與 MessageTemplate 是 1:1 關係

**問題核心**：
1. 模板來源：只能從「模板庫」選擇既有模板？還是可以「臨時建立新模板」？
2. 選擇範圍：所有模板都可選？還是有篩選條件（如：按標籤、類別、時間篩選）？
3. 關聯方式：選擇既有模板後是「引用」（共用template_id）還是「複製」（建立新template記錄）？
4. 編輯權限：選擇既有模板後，可以編輯內容嗎？如果可以，修改會影響原模板嗎？

# 多選題

| 選項 | 描述 |
|--------|-------------|
| A | 只能從模板庫選擇既有模板，引用（共用 template_id），不可編輯 |
| B | 只能從模板庫選擇既有模板，複製（建立新 template），可編輯副本 |
| C | 可選擇既有模板或建立新模板，引用既有模板，新建模板獨立 |
| D | 可選擇既有模板或建立新模板，複製既有模板，所有模板獨立可編輯 |
| Short | 其他設計（<=5字）|

# 影響範圍

影響群發訊息建立流程、模板管理策略、資料一致性、模板複用效果、UI 互動設計。

# 優先級

Medium

---
# 解決記錄

- **回答**：D - 可選擇既有模板或建立新模板，複製既有模板，所有模板獨立可編輯
- **更新的規格檔**：spec/erm.dbml, spec/features/create_broadcast.feature
- **變更內容**：
  - erm.dbml - MessageTemplate 表格：
    - 新增 template_name 欄位（模板名稱，用於模板庫顯示）
    - 新增 is_in_library 欄位（bool，是否加入模板庫，預設 false）
    - 新增 source_template_id 欄位（複製來源模板ID，允許 NULL）
    - 新增 usage_count 欄位（使用次數統計，用於熱門排序）
    - 新增 created_at 欄位（建立時間）
    - 新增 updated_at 欄位（更新時間）
    - 更新 Note：說明模板來源（從模板庫選擇或從空白建立）、複製機制、獨立編輯、加入模板庫、使用統計
  - create_broadcast.feature：
    - Rule 1: 支援兩種模板來源（從模板庫選擇或建立新模板）
    - Rule 2: 從模板庫選擇既有模板（複製機制、複製後可獨立編輯）
    - Rule 3: 建立新模板（從空白開始）
    - Rule 4: 建立群發時可選擇是否將模板加入模板庫（將新建模板加入模板庫、不加入模板庫）
    - Rule 5: 模板庫顯示與篩選（只顯示 is_in_library = true 的模板、按使用次數排序、按建立時間排序、搜尋功能）
- **設計理念**：
  - 模板來源多元化：支援從模板庫選擇或從空白建立，滿足不同使用場景
  - 複製機制保護原模板：從模板庫選擇時複製建立新記錄，保護原模板不被修改
  - 獨立編輯不影響其他群發：每個 Message 有專屬 MessageTemplate（1:1 關係），編輯不影響其他群發或原始模板
  - 模板庫作為快速起點：提供常用模板供選擇，提升效率並維持品牌一致性
  - 模板庫動態擴充：建立群發時可選擇將模板加入模板庫，豐富範本選擇
  - 使用統計與排序：記錄 usage_count 用於熱門排序，幫助使用者找到最受歡迎的模板
  - 追蹤來源：source_template_id 記錄複製來源，方便分析哪些模板最常被重用
- **UI/UX 流程**：
  1. 選擇模板來源（從模板庫選擇 / 建立新模板）
  2. 如選擇「從模板庫選擇」：
     - 顯示模板庫（is_in_library = true 的模板）
     - 支援搜尋、排序（熱門優先/最新優先）
     - 選擇模板後系統複製建立新記錄
     - 可編輯新模板內容
  3. 如選擇「建立新模板」：
     - 在配置區從空白開始填寫欄位
     - 系統建立新 MessageTemplate 記錄
  4. 完成群發設定後：
     - 可勾選「將此模板加入模板庫」
     - 如勾選則輸入模板名稱，設定 is_in_library = true
- **技術實作細節**：
  - 複製模板時更新原始模板的 usage_count +1
  - 新模板預設 is_in_library = false（僅限該群發使用）
  - 模板庫查詢條件：WHERE is_in_library = true
  - 排序選項：ORDER BY usage_count DESC（熱門）或 ORDER BY created_at DESC（最新）
  - 搜尋功能：WHERE template_name LIKE '%關鍵字%'
