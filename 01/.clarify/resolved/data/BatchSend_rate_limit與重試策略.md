# 釐清問題

`/api/line/send-batch-message` 目前僅逐筆呼叫 `send_line_message`，未定義節流或重試策略。LINE Messaging API 有每分鐘/每秒的速率限制，也可能回傳 429 或暫時性 5xx。需確認系統應如何控制吞吐與自動重試，避免打爆 LINE API 或造成大批訊息失敗。

# 定位

`spec/api_line_message_interface.md` → Batch send 節點說明僅示意迴圈呼叫；未記錄吞吐規則或 LINE API 429 處理方式。

# 多選題

| 選項 | 描述 |
| --- | --- |
| A | 單節點限速 5 req/s（300 req/min），超過部分排隊，遇到 429 時等待 2 秒重試（最多 2 次） |
| B | 單節點限速 15 req/s（900 req/min），符合 LINE 官方 1,000 req/min 預設限制並保留緩衝；429/5xx 採 3 次指數回退重試 |
| C | 單節點限速 50 req/s，透過多節點水平擴展應付高頻需求 |
| D | 不做節流，完全交由 LINE 限制，失敗再人工重發 |
| Short | 其他 |

# 影響範圍

1. Batch API 伺服器需具備共用節流器或佇列控制吞吐。
2. 需定義可重試的錯誤類型（429、5xx、網路錯誤等）與回退策略。
3. API 規格需告知客戶端 `line_uids` 上限及預期延遲，以便 UX 顯示。
4. 日誌要記錄每個 UID 的嘗試次數、最終錯誤供排查。

# 優先級

High：若無節流，容易觸發 LINE API 429，造成整批失敗；亦缺少重試邏輯，導致暫時性錯誤需人工重推。

---

# 解決記錄

- **回答**：選擇 B。每個 `line_app` 節點採令牌桶限速 15 req/s（900 req/min），預留 10% 緩衝低於 LINE 官方 1,000 req/min 限制。遇到 429、5xx 或網路連線錯誤時，對單一 UID 最多重試 3 次，延遲分別為 1 秒、2 秒、4 秒；若仍失敗則記錄錯誤並回報。
- **更新的規格檔**：`spec/api_line_message_interface.md`
- **變更內容**：
  1. 新增「批量發送節流與重試策略」章節，說明 15 req/s 限速、500 UID 上限、重試條件與回退時間。
  2. 要求 Batch API 回傳 `attempts`、`last_status_code`、`last_error` 以利除錯。
- **業務影響**：
  - 防止因瞬間高峰觸碰 LINE API 限制導致整批退件。
  - 暫時性錯誤自動重試，降低人工介入。
  - 透過結果欄位可觀察被重試的對象及最終狀態，便於客服通知。
