# 釐清項目：訊息紀錄_排程發送的取消機制

## 基本資訊
- **優先級**：Medium
- **類別**：功能模型
- **相關檔案**：
  - `spec/erm.dbml` (Message.send_status 狀態轉換)
  - `spec/features/message_analytics.feature` (排程發送狀態的訊息可編輯)
  - `spec/features/create_broadcast.feature`

## 問題描述

現有規格定義了排程發送的狀態轉換規則：
- **草稿 ⇄ 排程發送**：雙向轉換（允許取消排程）
- **排程發送 → 已發送**：成功發送後進入終止狀態
- **發送失敗 → 草稿**：允許修正問題後重新排程

規格明確提到「允許取消排程」，但未詳細說明：

1. **取消操作方式**：取消排程是改回「草稿」狀態，還是直接刪除訊息記錄？
2. **資料保留策略**：取消後排程時間、訊息內容、篩選條件等資料是否保留？
3. **時間限制**：是否有取消的時間窗口限制？（例如：發送前 1 小時內不能取消）
4. **權限控制**：是否需要特定權限才能取消排程？或者建立者才能取消？
5. **記錄與通知**：取消操作是否需要記錄？是否需要通知相關人員？

## 影響範圍

- **功能影響**：排程管理流程、訊息狀態控制、使用者操作體驗
- **資料模型影響**：可能需要新增取消相關欄位（取消時間、取消原因、取消人員）
- **使用者體驗**：行銷人員調整排程策略的靈活性
- **系統穩定性**：避免發送前臨時取消導致的問題

## 選項分析

### 選項 A：取消排程改回草稿（保留資料）

**操作方式**：
- 行銷人員點擊「取消排程」按鈕
- 系統將 send_status 從「排程發送」改為「草稿」
- 保留所有訊息資料（內容、排程時間、篩選條件等）

**資料保留**：
- ✅ 保留 message_content
- ✅ 保留 scheduled_datetime_utc
- ✅ 保留 target_filter
- ✅ 保留 template_id

**時間限制**：無限制（任何時候都可取消）

**後續操作**：
- 行銷人員可重新編輯訊息
- 可重新設定排程時間
- 可重新發送（立即或排程）

**優點**：
- ✅ 操作最簡單，符合直覺
- ✅ 資料不遺失，可重新利用
- ✅ 符合現有「草稿 ⇄ 排程發送」的雙向設計
- ✅ 無需額外資料表或欄位

**缺點**：
- ❌ 無法區分「從未排程的草稿」與「取消排程的草稿」
- ❌ 無法追蹤取消操作記錄
- ❌ 發送前極短時間內取消可能來不及阻止發送

**適用情境**：
- 行銷人員常需調整排程策略
- 取消後通常會重新編輯並再次排程
- 不需要嚴格的取消記錄追蹤

---

### 選項 B：取消排程改回草稿 + 記錄取消資訊（推薦）

**操作方式**：
- 行銷人員點擊「取消排程」按鈕
- 系統將 send_status 從「排程發送」改為「草稿」
- 記錄取消相關資訊（取消時間、取消人員、取消原因）

**資料模型新增**（Message 表欄位）：
```dbml
cancelled_at string [note: '取消排程時間（若曾取消），格式：yyyy/mm/dd hh:mm']
cancelled_by string [note: '取消排程的管理員ID（若曾取消）']
cancel_reason string [note: '取消原因（選填），如：活動延期、策略調整']
```

**時間限制**：
- 建議：發送前至少 30 分鐘才能取消
- 若距離發送時間 < 30 分鐘，顯示警告但仍允許取消

**權限控制**：
- 建立者可取消
- 管理員權限可取消他人建立的排程

**記錄與通知**：
- 記錄取消時間、人員、原因
- 可選：通知團隊成員（Email 或系統通知）

**優點**：
- ✅ 保留資料可重新利用
- ✅ 可追蹤取消操作記錄（審計需求）
- ✅ 提供時間窗口保護，避免臨時取消
- ✅ 支援團隊協作（可查看誰取消了排程）

**缺點**：
- ❌ 需要新增額外欄位
- ❌ 實作複雜度略高

**適用情境**：
- 需要追蹤取消操作記錄
- 團隊協作場景（多人管理排程）
- 重視審計與合規性

---

### 選項 C：取消排程直接刪除訊息

**操作方式**：
- 行銷人員點擊「取消排程」按鈕
- 系統顯示確認對話框：「確定要刪除此排程訊息？此操作無法復原」
- 確認後刪除 Message 記錄

**資料保留**：完全刪除（無法復原）

**時間限制**：
- 建議：發送前至少 1 小時才能刪除
- 若距離發送時間 < 1 小時，阻擋刪除操作

**優點**：
- ✅ 清理不需要的排程，減少資料雜訊
- ✅ 明確區分「取消」與「保留草稿」的意圖

**缺點**：
- ❌ 資料無法復原，誤操作風險高
- ❌ 無法重新利用訊息內容
- ❌ 不符合「草稿 ⇄ 排程發送」的雙向設計

**適用情境**：
- 取消的排程通常不會再使用
- 重視資料庫清潔度

---

### 選項 D：取消排程新增「已取消」狀態

**操作方式**：
- 行銷人員點擊「取消排程」按鈕
- 系統將 send_status 從「排程發送」改為「已取消」
- 保留所有訊息資料

**狀態轉換規則**：
- 排程發送 → 已取消（取消操作）
- 已取消 → 草稿（重新啟用）
- 已取消 → 刪除（永久移除）

**資料保留**：保留所有資料

**時間限制**：發送前 30 分鐘內不能取消

**優點**：
- ✅ 明確區分「草稿」、「排程發送」、「已取消」三種狀態
- ✅ 可查詢所有取消的排程（統計分析）
- ✅ 資料可復原（重新啟用）

**缺點**：
- ❌ 新增狀態增加複雜度
- ❌ 需要調整現有狀態轉換邏輯
- ❌ 「已取消」訊息可能累積過多

**適用情境**：
- 需要統計取消排程的頻率與原因
- 重視資料分析與審計

---

## 推薦方案

**推薦選項 B：取消排程改回草稿 + 記錄取消資訊**

**推薦理由**：

1. **符合現有設計**：遵循「草稿 ⇄ 排程發送」的雙向轉換規則
2. **資料可重用**：取消後可重新編輯並再次排程，提升效率
3. **審計需求**：記錄取消操作滿足合規與團隊協作需求
4. **時間保護**：30 分鐘窗口避免臨時取消導致問題
5. **實作適中**：僅需新增 3 個欄位，無需調整狀態機

**次要推薦選項 A**（若不需要取消記錄追蹤）：
- 最簡單的實作方式
- 適合小團隊或單人管理場景

---

## 設計細節（基於推薦選項 B）

### 資料模型變更

**erm.dbml - Message 表新增欄位**：

```dbml
Table Message {
  message_id string [pk]
  # ... 其他欄位 ...

  send_status string [note: '發送狀態：草稿 / 排程發送 / 已發送 / 發送失敗']
  scheduled_datetime_utc string [note: '排程發送時間（UTC）']

  # 新增取消相關欄位
  cancelled_at string [note: '取消排程時間（若曾取消），格式：yyyy/mm/dd hh:mm。允許 NULL（從未取消過）']
  cancelled_by string [note: '取消排程的管理員ID（若曾取消）。允許 NULL']
  cancel_reason string [note: '取消原因（選填），如：活動延期、策略調整、內容需修正。允許 NULL']

  # ... 其他欄位 ...

  Note: '''
  狀態轉換規則：
    - 草稿 ⇄ 排程發送：雙向轉換（允許取消排程，取消後回到草稿狀態）
    - 取消排程邏輯：將 send_status 從「排程發送」改為「草稿」，並記錄 cancelled_at、cancelled_by、cancel_reason
    - 時間限制：建議距離發送時間至少 30 分鐘才能取消，若 < 30 分鐘顯示警告但仍允許
  '''
}
```

### 功能規則新增

**create_broadcast.feature 或 message_analytics.feature 新增規則**：

```gherkin
Rule: 排程發送狀態的訊息可取消排程

  Example: 取消排程訊息（距離發送時間 > 30 分鐘）
    Given 系統中存在排程訊息「春節促銷」，send_status 為「排程發送」
    And 排程發送時間為「2025/02/01 10:00」（UTC: 2025-02-01T02:00:00Z）
    And 當前時間為「2025/01/31 08:00」（距離發送時間 26 小時）
    When 行銷人員點擊「取消排程」按鈕
    Then 系統將 send_status 更新為「草稿」
    And 系統記錄 cancelled_at 為當前時間「2025/01/31 08:00」
    And 系統記錄 cancelled_by 為當前管理員ID
    And 系統顯示訊息「已取消排程，訊息已改為草稿狀態」

  Example: 取消排程訊息（距離發送時間 < 30 分鐘，顯示警告）
    Given 系統中存在排程訊息「限時優惠」，send_status 為「排程發送」
    And 排程發送時間為「2025/02/01 10:00」（UTC: 2025-02-01T02:00:00Z）
    And 當前時間為「2025/02/01 09:45」（距離發送時間 15 分鐘）
    When 行銷人員點擊「取消排程」按鈕
    Then 系統顯示警告訊息「距離發送時間不足 30 分鐘，取消排程可能來不及阻止發送，確定要取消嗎？」
    And 系統提供「確定取消」與「返回」兩個選項

  Example: 確認取消臨時排程
    Given 系統顯示警告訊息「距離發送時間不足 30 分鐘...」
    When 行銷人員點擊「確定取消」
    Then 系統將 send_status 更新為「草稿」
    And 系統記錄 cancelled_at、cancelled_by
    And 系統顯示訊息「已取消排程，請注意發送任務可能已在執行中」

  Example: 取消排程時填寫取消原因
    Given 系統中存在排程訊息「春節促銷」，send_status 為「排程發送」
    When 行銷人員點擊「取消排程」按鈕
    Then 系統顯示「取消原因」輸入框（選填）
    When 行銷人員輸入「活動延期至下週」
    And 行銷人員點擊「確定」
    Then 系統將 send_status 更新為「草稿」
    And 系統記錄 cancel_reason 為「活動延期至下週」

Rule: 取消排程後的訊息保留所有資料

  Example: 取消後資料完整保留
    Given 系統中存在排程訊息「VIP專屬」
      | 欄位                | 值                          |
      | message_content     | VIP 會員專屬優惠            |
      | scheduled_datetime_utc | 2025-02-01T02:00:00Z     |
      | target_filter       | {"include": ["VIP"]}        |
      | template_id         | template_123                |
    When 行銷人員取消排程
    Then 系統將 send_status 更新為「草稿」
    And 所有訊息資料保持不變
      | 欄位                | 值                          |
      | message_content     | VIP 會員專屬優惠            |
      | scheduled_datetime_utc | 2025-02-01T02:00:00Z     |
      | target_filter       | {"include": ["VIP"]}        |
      | template_id         | template_123                |

  Example: 取消後可重新編輯並再次排程
    Given 訊息「春節促銷」已取消排程，send_status 為「草稿」
    When 行銷人員重新編輯該訊息
    And 行銷人員修改排程時間為「2025/02/05 10:00」
    And 行銷人員點擊「發送」並選擇「排程發送」
    Then 系統將 send_status 更新為「排程發送」
    And 系統更新 scheduled_datetime_utc 為新的時間

Rule: 權限控制 - 建立者或管理員可取消排程

  Example: 建立者取消自己建立的排程
    Given 行銷人員「張三」建立了排程訊息「春節促銷」
    And 訊息 send_status 為「排程發送」
    When 行銷人員「張三」點擊「取消排程」
    Then 系統允許取消操作
    And 系統記錄 cancelled_by 為「張三」的管理員ID

  Example: 管理員取消他人建立的排程
    Given 行銷人員「李四」建立了排程訊息「限時優惠」
    And 訊息 send_status 為「排程發送」
    And 管理員「王五」擁有管理員權限
    When 管理員「王五」點擊「取消排程」
    Then 系統允許取消操作
    And 系統記錄 cancelled_by 為「王五」的管理員ID

  Example: 一般人員無法取消他人建立的排程
    Given 行銷人員「張三」建立了排程訊息「春節促銷」
    And 訊息 send_status 為「排程發送」
    And 行銷人員「李四」無管理員權限
    When 行銷人員「李四」嘗試取消「張三」建立的排程
    Then 系統顯示錯誤訊息「您沒有權限取消此排程」
    And 系統阻擋取消操作

Rule: 已發送或發送失敗的訊息無法取消排程

  Example: 已發送的訊息無法取消
    Given 訊息「春節促銷」send_status 為「已發送」
    When 行銷人員嘗試取消排程
    Then 系統不顯示「取消排程」按鈕
    Or 系統顯示訊息「已發送的訊息無法取消」

  Example: 草稿狀態的訊息無需取消操作
    Given 訊息「草稿訊息」send_status 為「草稿」
    Then 系統不顯示「取消排程」按鈕（草稿本身就不在排程狀態）
```

---

## 後續影響

### 需同步更新的規格檔案
1. **spec/erm.dbml**：Message 表新增 cancelled_at, cancelled_by, cancel_reason 欄位
2. **spec/features/create_broadcast.feature** 或 **message_analytics.feature**：新增取消排程相關規則

### 需考慮的技術實作
1. **前端介面**：「取消排程」按鈕、取消原因輸入框、時間警告對話框
2. **後端 API**：`PUT /api/v1/messages/{message_id}/cancel-schedule` 端點
3. **權限檢查**：驗證操作者是建立者或管理員
4. **時間檢查**：計算距離發送時間，顯示適當警告
5. **排程任務**：確保取消後的訊息不會被發送

### 相關釐清項目
- **訊息數據_發送失敗的重試機制**（已完成）- 失敗後改回草稿的邏輯
- **Campaign_status狀態轉換規則**（已完成）- 狀態機設計參考

---

## 決策記錄
- **決策日期**：2025-11-13
- **決策者**：Stakeholder
- **選擇方案**：選項 A - 取消排程改回草稿（保留資料）
- **決策理由**：
  1. 操作最簡單，符合使用者直覺
  2. 資料不遺失，可重新利用（取消後可再次編輯並排程）
  3. 符合現有「草稿 ⇄ 排程發送」的雙向設計
  4. 無需額外資料表或欄位，開發成本最低
  5. 適合小團隊或單人管理場景

## 已完成的規格更新

### 1. 資料模型更新（spec/erm.dbml）

**Message 表 Note 更新**：

新增取消排程邏輯說明：
```
取消排程邏輯：
  - 操作方式：將 send_status 從「排程發送」改為「草稿」
  - 資料保留：保留所有訊息資料（message_content, scheduled_datetime_utc, target_filter, template_id 等）
  - 時間限制：無時間限制，任何時候都可取消
  - 後續操作：取消後可重新編輯訊息內容、調整排程時間並再次發送
```

**無需新增欄位**（選項 A 不需要記錄取消資訊）

### 2. 功能規則更新（spec/features/message_analytics.feature）

**新增 2 個 Rule，共 5 個 Example**：

**Rule 1: 排程發送狀態的訊息可取消排程**
- Example 1: 取消排程訊息（將 send_status 改為草稿）
- Example 2: 取消後資料完整保留（message_content, scheduled_datetime_utc, target_filter, template_id 都保留）
- Example 3: 取消後可重新編輯並再次排程

**Rule 2: 已發送或草稿狀態的訊息無取消排程操作**
- Example 1: 已發送的訊息無法取消排程（不顯示按鈕）
- Example 2: 草稿狀態的訊息無需取消操作（草稿本身就不在排程狀態）

### 3. 取消排程流程

**操作流程**：
1. 行銷人員在訊息列表或訊息詳情頁看到「排程發送」狀態的訊息
2. 點擊「取消排程」按鈕
3. 系統將 send_status 從「排程發送」改為「草稿」
4. 系統保留所有訊息資料
5. 系統顯示「已取消排程，訊息已改為草稿狀態」

**後續操作**：
- 行銷人員可重新編輯訊息內容
- 可調整排程時間
- 可重新發送（立即或排程）

### 4. 前端介面設計

**訊息列表頁**：
- 「排程發送」狀態的訊息顯示「取消排程」按鈕
- 「已發送」、「草稿」、「發送失敗」狀態不顯示「取消排程」按鈕

**訊息詳情頁**：
- 「排程發送」狀態時，操作按鈕區顯示「取消排程」
- 點擊後將狀態改為「草稿」，頁面自動刷新或顯示成功訊息

### 5. 技術實作建議

**後端 API**：
- `PUT /api/v1/messages/{message_id}/cancel-schedule`
- 驗證 send_status 必須為「排程發送」
- 將 send_status 更新為「草稿」
- 返回成功訊息

**前端實作**：
- 根據 send_status 決定是否顯示「取消排程」按鈕
- 點擊後呼叫 API
- 更新本地狀態並顯示成功訊息

**排程任務**：
- 排程任務只處理 send_status = 「排程發送」的訊息
- 若訊息已改為「草稿」，排程任務自動跳過
