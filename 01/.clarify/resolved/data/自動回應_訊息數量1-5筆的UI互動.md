# 釐清問題

自動回應設定「1-5 筆訊息」時，資料儲存結構與 UI 互動方式為何？response_content 如何儲存多筆訊息？

# 定位

ERM：spec/erm.dbml AutoResponse 表格 response_content 與 response_count 欄位（約第179、186行）
Feature：spec/features/auto_response.feature 訊息數量規則（約第299-311行）

# 背景資訊

**目前定義**：
- AutoResponse.response_content 為 string 欄位（純文字）
- AutoResponse.response_count 記錄訊息數量（1-5 筆）
- auto_response.feature 規定：至少 1 筆，最多 5 筆

**問題核心**：
1. response_content 是單一欄位，如何儲存多筆訊息？
2. 多筆訊息是順序發送、隨機選一筆、還是全部發送？
3. UI 互動方式如何讓使用者新增/編輯/刪除多筆訊息？

# 多選題

| 選項 | 描述 |
|--------|-------------|
| A | response_content 使用分隔符（如 `\n---\n`）儲存多筆訊息；發送時隨機選一筆 |
| B | 建立 AutoResponseMessage 關聯表（1:N），每筆訊息獨立記錄；發送時隨機選一筆 |
| C | 建立 AutoResponseMessage 關聯表（1:N），每筆訊息獨立記錄；發送時依序發送所有訊息 |
| D | response_count 僅為 UI 概念，實際每筆訊息都是獨立的 AutoResponse 記錄（共用相同觸發條件） |
| Short | 其他設計（<=5字）|

# 影響範圍

影響資料表結構設計、訊息發送邏輯、UI 互動體驗、測試案例設計、LINE API 呼叫次數。

# 優先級

Medium

---
# 解決記錄

- **回答**：C - 建立 AutoResponseMessage 關聯表（1:N），每筆訊息獨立記錄；發送時依序發送所有訊息
- **更新的規格檔**：spec/erm.dbml, spec/features/auto_response.feature
- **變更內容**：
  - erm.dbml：
    - AutoResponse 表格：移除 response_content 欄位（改為關聯表儲存）
    - AutoResponse 表格：更新 response_count 欄位說明（應與 AutoResponseMessage 記錄數量一致）
    - AutoResponse 表格：新增 created_at 欄位
    - AutoResponse 表格：更新 Note 說明訊息管理方式、依序發送邏輯
    - AutoResponse 表格：更新關係說明（1:N AutoResponseMessage, 1:N AutoResponseKeyword）
    - 新增 AutoResponseMessage 表格：
      - message_id（PK）
      - response_id（FK，關聯 AutoResponse）
      - message_content（訊息內容，純文字，建議 <= 500 字元）
      - sequence_order（UI 顯示順序與發送順序，>= 1）
      - created_at（建立時間）
      - 唯一性約束：(response_id, sequence_order) 組合唯一
      - Note：說明數量限制（最多 5 筆）、發送邏輯（依序發送）、發送間隔（1-2 秒）、順序管理（UI 拖曳排序）、使用場景
  - auto_response.feature：
    - Rule 1: 自動回應訊息透過關聯表管理（新增第一筆訊息、新增多筆訊息）
    - Rule 2: 訊息數量限制（至少 1 筆、最多 5 筆）
    - Rule 3: 支援個別訊息的新增、編輯、刪除操作（編輯特定訊息、刪除特定訊息並重新排序）
    - Rule 4: 支援訊息順序調整（拖曳排序）
    - Rule 5: 觸發時依序發送所有訊息（依序發送多筆訊息、發送間隔模擬真人節奏）
- **設計理念**：
  - 採用關聯表設計符合資料庫正規化原則，易於維護與擴展
  - 依序發送所有訊息適合教學流程、步驟說明、完整資訊傳遞、引導式對話等場景
  - 發送間隔（1-2 秒）模擬真人打字節奏，避免瞬間連續發送造成洗版感
  - UI 支援拖曳排序，直觀易用
  - sequence_order 確保訊息發送順序可控
- **UI/UX 設計**：
  - 列表式編輯介面，顯示所有訊息（最多 5 筆）
  - 支援拖曳調整順序（更新 sequence_order）
  - 支援個別訊息的新增、編輯、刪除操作
  - 刪除訊息後自動重新排序（維護 sequence_order 連續性）
  - 顯示訊息數量與上限提示（已新增 2/5）
- **發送邏輯**：
  - 觸發時讀取該 AutoResponse 的所有 AutoResponseMessage 記錄
  - 依照 sequence_order 由小到大排序
  - 依序發送每筆訊息
  - 訊息間加入 1-2 秒延遲，模擬真人回覆節奏
  - LINE API 呼叫次數 = 訊息數量（1-5 次）
