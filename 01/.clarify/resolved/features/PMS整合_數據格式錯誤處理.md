# 釐清問題

pms_integration.feature 說明欄位映射規則，但未定義 PMS 回傳格式不符預期時如何處理。欄位缺失、型別錯誤、值域超範圍時的處理邏輯為何？是否記錄錯誤並繼續處理其他記錄？還是整批失敗？

# 定位

Feature：pms_integration.feature 中 PMS 數據同步規則
已解決項目：`.clarify/resolved/data/PMS_Integration_部分同步失敗處理.md`

# 多選題

| 選項 | 描述 |
|--------|-------------|
| A | 欄位缺失或型別錯誤時跳過該筆記錄，記錄錯誤 log，繼續處理其他記錄，完成後顯示「部分同步失敗」 |
| B | 任何格式錯誤立即停止同步，回滾所有變更（事務性處理），顯示錯誤訊息並要求 PMS 修正資料 |
| C | 欄位缺失時使用預設值填充（如 NULL），型別錯誤時嘗試轉換，轉換失敗才跳過記錄 |
| D | 格式錯誤時標記為「待審核」狀態，不寫入正式表，由管理員手動修正後再匯入 |

# 影響範圍

- PMS 數據同步流程錯誤處理邏輯
- 資料驗證規則設計（欄位必填、型別、值域）
- 錯誤記錄表設計（是否需要 PMS_SyncError 表？）
- 管理員通知機制（郵件、系統通知）
- 資料修正流程（手動修正 vs. 自動重試）
- 測試案例（各種格式錯誤情境）

# 優先級

Medium
- 影響 PMS 整合穩定性
- 影響資料品質
- 影響錯誤處理設計

---

# 解決記錄

**解決日期**：2025-11-19
**選擇方案**：A（跳過錯誤記錄 + 記錄 log + 繼續處理其他記錄 + 部分同步失敗）
**解決理由**：
- 容錯性強：單筆記錄格式錯誤不影響其他正確記錄的同步
- 最大化數據同步：儘可能同步正確的記錄，提升資料完整性
- 詳細錯誤追蹤：記錄每筆失敗記錄的詳細資訊（記錄編號、欄位名稱、錯誤原因）
- 管理員可見性：完成後統計成功/失敗數量，提供「查看錯誤記錄」功能
- 不阻塞業務：避免因少數格式錯誤導致整批同步失敗
- 優點：
  • 容錯性佳（單筆錯誤不影響整批）
  • 最大化同步成功率
  • 錯誤可追溯（詳細 log）
  • 支援部分成功（partial_success 狀態）
  • 管理員可下載錯誤 log 進行修正

**規格更新**：
- 更新 `01/spec/features/pms_integration.feature`（lines 128-201）：
  - 新增 Rule「PMS 數據格式錯誤處理機制（方案 A：跳過錯誤記錄 + 記錄 log + 繼續處理）」
  - 6 個 Example 場景：
    1. 欄位缺失跳過該筆記錄 - 記錄詳細錯誤 log
    2. 型別錯誤跳過該筆記錄 - 繼續處理其他記錄
    3. 值域超範圍跳過該筆記錄 - 記錄合理性驗證失敗
    4. 完成後顯示同步結果統計 - 成功 X 筆，失敗 Y 筆
    5. 全部成功時不顯示錯誤提示 - sync_status = active
    6. 全部失敗時標記為失敗 - sync_status = failed + 通知管理員

**處理邏輯**：
```
PMS 數據同步流程：
  1. 接收 PMS 回傳的 N 筆記錄
  2. 逐筆驗證欄位（必填、型別、值域範圍）
  3. 驗證通過 → 處理該筆記錄（建立或更新會員）
  4. 驗證失敗 → 跳過該筆 + 記錄錯誤 log（記錄編號、欄位、錯誤原因）
  5. 繼續處理下一筆記錄
  6. 所有記錄處理完成 → 統計結果

結果判定：
  - 全部成功（N/N）：sync_status = active
  - 部分成功（X/N, X > 0）：sync_status = partial_success
  - 全部失敗（0/N）：sync_status = failed + 通知管理員
```

**錯誤記錄格式**：
```
錯誤 log 範例：
  Record #2: Missing required field 'id_number'
  Record #5: Invalid type for field 'phone', expected phone number format, got 'invalid_text'
  Record #7: Invalid value for field 'stay_date', date '1800/01/01' out of valid range

統計訊息：
  同步完成：成功 95 筆，失敗 5 筆（格式錯誤）
  部分同步失敗（95/100 成功）
```

**管理介面**：
- 顯示同步結果統計（成功 X 筆 / 總計 N 筆）
- 提供「查看錯誤記錄」按鈕
- 可下載錯誤 log 檔案（CSV 或 TXT 格式）
- sync_status 狀態：active（全部成功）/ partial_success（部分成功）/ failed（全部失敗）

**驗證規則**：
- 必填欄位：id_number, phone, stay_date
- 型別驗證：phone 需符合手機號碼格式（09XXXXXXXX）
- 值域驗證：stay_date 需在合理範圍（1900-2100 年）
