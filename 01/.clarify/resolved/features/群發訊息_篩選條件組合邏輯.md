# 釐清問題

篩選條件組合邏輯的完整規則為何？支援「AND」「OR」「NOT」的複雜組合，還是僅支援簡單的「包含且/排除」？

# 定位

Feature：spec/features/create_broadcast.feature Rule 關於篩選組合邏輯（約第51-63行）

# 多選題

| 選項 | 描述 |
|--------|-------------|
| A | 僅支援「包含標籤 A 且包含標籤 B」「包含標籤 A 但排除標籤 B」兩種模式 |
| B | 支援多層「且」「或」組合（如 (VIP OR 台北市) AND NOT 黑名單） |
| C | 使用視覺化查詢建構器，支援任意複雜的邏輯組合 |
| Short | 其他設計（<=5字）|

# 影響範圍

影響篩選功能前端設計、查詢 SQL 生成邏輯、查詢效能優化、使用者學習成本，以及篩選結果預覽準確性。

# 優先級

High

---
# 解決記錄

- **回答**：A - 僅支援簡單模式（包含且/排除）
- **更新的規格檔**：spec/erm.dbml、spec/features/create_broadcast.feature
- **變更內容**：
  1. 更新 Message.target_filter 欄位 note，定義 JSON 格式與邏輯規則
  2. 更新 create_broadcast.feature Rule「篩選條件組合邏輯」，包含 4 個 Example：
     - 包含多個標籤的 AND 邏輯
     - 包含條件 + 排除條件的組合
     - 僅排除條件
     - 多個包含條件的 AND 邏輯（三個條件）
- **邏輯規則定義**：
  - **包含條件**：多個標籤全部 AND（必須同時擁有所有包含標籤）
  - **排除條件**：多個標籤全部 AND NOT（必須都不擁有所有排除標籤）
  - **組合邏輯**：(包含條件全部 AND) AND (排除條件全部 AND NOT)
  - **JSON 格式**：`{"include": ["VIP", "台北市"], "exclude": ["黑名單", "已發送"]}`
  - **SQL 對應**：`WHERE 擁有VIP AND 擁有台北市 AND NOT擁有黑名單 AND NOT擁有已發送`
- **設計理由**：
  - **滿足 90% 需求**：飯店行銷大部分是「特定客群 + 排除已發送」場景
  - **實作簡單**：SQL 查詢簡單，效能好，易於優化
  - **使用者友善**：不需要學習複雜的邏輯運算符，直覺操作
  - **維護容易**：查詢邏輯清晰，易於除錯和驗證
- **典型應用場景**：
  - VIP 台北推播：包含「VIP」且包含「台北市」
  - 生日祝福（避免重複）：包含「生日8月」但排除「已發送8月生日祝福」
  - 特定客群推播：包含「26-35歲」且包含「女性」且包含「台北市」
- **未來擴充**：v0.3+ 可考慮支援 OR 邏輯（如有明確業務需求）
