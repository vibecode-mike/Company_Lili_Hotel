# 釐清問題

erm.dbml 中刪除了 MemberInteractionRecord 表，但 ComponentInteractionLog 只記錄按鈕點擊。會員主動發送訊息的記錄存哪裡？（MessageRecord？ChatLog？）互動標籤觸發事件如何與訊息記錄關聯？

# 定位

ERM：MemberInteractionRecord 表已移除，ComponentInteractionLog 表僅記錄按鈕點擊
功能：會員聊天記錄管理、互動標籤觸發追蹤

# 多選題

| 選項 | 描述 |
|--------|-------------|
| A | 建立 ChatLog 表儲存所有會員訊息（文字、圖片、Sticker），互動標籤觸發記錄於 MemberTag 表 |
| B | 沿用 MessageRecord 表儲存會員訊息，區分 message_type（broadcast/user_message），關聯 MemberTag |
| C | 不儲存會員主動訊息歷史，僅記錄最近 last_interaction_at 時間，互動標籤觸發記錄於 ComponentInteractionLog |
| D | 建立獨立 UserMessageLog 表儲存會員訊息，與 ComponentInteractionLog 平行設計 |

# 影響範圍

- 會員聊天記錄查詢功能
- 會員搜尋「需回覆會員」功能（24 小時內主動互動）
- 互動標籤觸發追蹤與統計
- Member.last_interaction_at 更新邏輯
- 資料庫設計與遷移腳本

# 優先級

High
- 阻礙會員管理核心功能定義
- 影響資料庫設計
- 影響互動標籤追蹤邏輯

---

# 解決記錄

**解決日期**：2025-11-19
**選擇方案**：B（沿用 MessageRecord 表，混合儲存廣播訊息 + 會員主動訊息）
**解決理由**：
- 使用現有的 MessageRecord 表（原本用於記錄一對一聊天記錄）
- 透過 message_source 欄位區分訊息來源：「會員主動」/「人工回覆」/「訊息推播」/「自動回應」
- 會員主動訊息透過 LINE Webhook 接收並儲存到 MessageRecord 表
- 互動標籤觸發記錄於 MemberTag 表，透過 message_id 關聯
- 優點：重用現有表，不需新增表，職責清晰
- 應用場景：會員聊天記錄查詢、「需回覆會員」功能（24 小時內主動互動）

**規格更新**：
- 更新 `01/spec/erm.dbml` - MessageRecord 表定義：
  - Line 587: 更新 message_source 欄位值域，新增「會員主動（會員發送給飯店）」選項
  - Lines 599-626: 更新 Note 段落，新增「方案 B：混合儲存設計」說明：
    - 儲存範圍：會員主動訊息 + 系統回應訊息
    - 訊息來源值域定義
    - 資料流向說明（LINE Webhook → MessageRecord → 更新 last_interaction_at）
    - 互動標籤關聯邏輯（MemberTag 表透過 message_id 關聯）
    - 應用場景：聊天記錄查詢、「需回覆會員」功能、客服回覆追蹤
