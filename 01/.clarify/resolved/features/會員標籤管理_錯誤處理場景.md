# 釐清問題

會員標籤管理功能缺乏錯誤處理場景，特別是外部系統同步失敗與資料驗證錯誤的處理策略

# 定位

Feature: 會員標籤管理 (member_tag_management.feature)
Rule: 所有標籤來源與處理規則

# 多選題

| 選項 | 描述 |
|--------|-------------|
| A | CRM/PMS 系統回傳無效標籤資料時，系統記錄錯誤 log 並跳過該筆資料，繼續處理其他資料 |
| B | 問券系統回傳的年齡超出定義區間（如：-5 歲、150 歲）時，系統拒絕該筆資料並通知管理員 |
| C | 問券系統回傳的地區不在台灣 22 縣市範圍內時，系統將該筆資料標記為「未知地區」並允許手動修正 |
| D | 後台自訂標籤名稱包含特殊字元或 Emoji 時，系統顯示錯誤訊息並拒絕新增 |
| E | 同一會員同時從多個來源（CRM、PMS、問券）獲得相同標籤時，系統保留最新來源並記錄覆蓋歷史 |
| Short | 提供其他簡短答案(<=5 字) |

# 影響範圍

影響範圍：
1. member_tag_management.feature 需補充所有來源的錯誤處理 Examples
2. MemberTag 表需定義資料驗證規則
3. 外部系統整合介面需實作錯誤處理與重試邏輯
4. 標籤管理 UI 需顯示驗證錯誤提示

# 優先級

High

理由：
- 資料完整性：外部系統同步失敗會導致標籤資料不一致
- 業務影響：標籤錯誤會影響會員篩選與群發訊息準確性
- 維護成本：未定義錯誤處理會增加後續除錯難度

---

# 解決記錄

- **回答**：選擇 A。即使前端/設定檔已限制外部系統可用的標籤值，一旦 CRM/PMS 仍回傳不在允許清單內的值，後端記錄錯誤並跳過該筆資料，其餘有效標籤照常匯入。
- **更新的規格檔**：`spec/features/member_tag_management.feature`
- **變更內容**：
  1. 新增 Rule「錯誤處理：外部來源回傳無效標籤時跳過該筆資料」。
  2. 加入 CRM 回傳未定義標籤值的 Example，說明系統記錄錯誤、跳過該筆、其餘資料續處理。
- **業務影響**：
  - 保證整體同步流程不中斷，避免單筆異常造成大批標籤無法更新。
  - 提供追蹤紀錄，利於營運人員檢查外部來源設定。
