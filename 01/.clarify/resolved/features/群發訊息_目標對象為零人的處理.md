# 釐清問題

create_broadcast.feature 只定義了配額不足的阻擋，未定義目標對象為 0 人時是否允許發送。estimated_send_count = 0 時是否阻擋發送？錯誤訊息內容為何？草稿是否允許儲存？

# 定位

Feature：create_broadcast.feature 中發送前檢查規則
ERM：Message.estimated_send_count 欄位

# 多選題

| 選項 | 描述 |
|--------|-------------|
| A | estimated_send_count = 0 時阻擋發送，顯示錯誤訊息「目標對象為 0 人，無法發送」，草稿可儲存 |
| B | estimated_send_count = 0 時顯示警告但允許發送（記錄測試發送），Message.send_status 直接改為 sent |
| C | estimated_send_count = 0 時阻擋發送與儲存草稿，強制調整篩選條件後才能操作 |
| D | estimated_send_count = 0 時僅記錄 log 不發送，Message.send_status 改為 skipped，不消耗配額 |

# 影響範圍

- 發送前檢查邏輯（estimated_send_count 驗證）
- 錯誤訊息設計與前端提示
- 草稿儲存邏輯（是否允許儲存 0 人目標的草稿）
- Message.send_status 狀態定義（是否需新增 skipped 狀態）
- 測試案例（0 人篩選條件）
- 使用者體驗（如何引導調整篩選條件）

# 優先級

Medium
- 影響邊界條件處理
- 影響使用者體驗
- 影響錯誤處理設計

---

# 解決記錄

**解決日期**：2025-11-19
**選擇方案**：A（阻擋發送 + 顯示錯誤訊息 + 允許儲存草稿）
**解決理由**：
- 防止無效操作：0 人發送沒有實際意義，應該阻擋避免浪費系統資源
- 友善的錯誤提示：明確告知「目標對象為 0 人，無法發送。請調整篩選條件。」
- 保留工作進度：允許儲存草稿，讓使用者可以稍後調整篩選條件
- 引導使用者修正：前端即時反饋，提示調整篩選條件後即可發送
- 雙重防護：前端禁用按鈕 + 後端驗證，確保無法繞過限制
- 優點：
  • 使用者體驗佳（即時反饋 + 保留草稿）
  • 避免無效操作（不發送 0 人訊息）
  • 引導使用者修正（提示調整篩選條件）
  • 不新增狀態（不需要 skipped 狀態，保持 Message 狀態簡潔）

**規格更新**：
- 更新 `01/spec/features/create_broadcast.feature`（lines 332-379）：
  - 新增 Rule「若目標對象為 0 人，前端禁用發送按鈕並阻擋發送行為，但允許儲存草稿」
  - 5 個 Example 場景：
    1. 目標對象為 0 人時前端禁用發送按鈕 - 顯示提示 + 允許儲存草稿
    2. 目標對象為 0 人時後端阻擋發送 - 防止繞過前端限制
    3. 目標對象為 0 人時允許儲存草稿 - 保留工作進度
    4. 調整篩選條件後目標對象 > 0 人 - 發送按鈕啟用
    5. 傳送對象為「所有好友」時不可能為 0 人 - 正常流程

**前端實作要點**：
```
目標對象檢查邏輯：
  estimated_send_count = 0
  → 禁用「發送」按鈕（disabled = true）
  → 顯示提示「目標對象為 0 人，無法發送。請調整篩選條件。」
  → 啟用「儲存草稿」按鈕（允許儲存草稿）

目標對象 > 0：
  estimated_send_count > 0 AND available_quota >= estimated_send_count
  → 啟用「發送」按鈕（disabled = false）
  → 允許正常發送
```

**後端驗證邏輯**：
```
發送前驗證：
  1. 檢查 estimated_send_count > 0
  2. 檢查 available_quota >= estimated_send_count

驗證失敗：
  → 回傳錯誤「目標對象為 0 人，無法發送」
  → 操作失敗

儲存草稿：
  → 允許儲存 estimated_send_count = 0 的草稿
  → Message.send_status = draft
  → Message.estimated_send_count = 0
  → 提示「草稿已儲存，目標對象為 0 人，發送前請調整篩選條件」
```

**邊界情況**：
- 「所有好友」模式：只要系統中有 >= 1 位 LINE 好友，就不會出現 0 人情況
- 「篩選受眾」模式：可能因為篩選條件過於嚴格導致 0 人（如 AND 條件過多）
- 草稿編輯：開啟草稿後調整篩選條件，人數從 0 變為 > 0 時，發送按鈕啟用
