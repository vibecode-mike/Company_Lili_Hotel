# 釐清問題

發送失敗的訊息是否支援重試？重試次數、間隔、失敗處理邏輯為何？

# 定位

Feature：spec/features/message_analytics.feature Rule 關於發送失敗（約第97-110行）

# 多選題

| 選項 | 描述 |
|--------|-------------|
| A | 自動重試 3 次（間隔 1/5/15 分鐘），失敗後記錄並通知管理員 |
| B | 不自動重試，顯示失敗原因，提供「手動重新發送」按鈕 |
| C | 依失敗原因分類：配額不足不重試，網路錯誤自動重試 |
| Short | 其他機制（<=5字）|

# 影響範圍

影響訊息發送可靠性、排程任務設計、錯誤處理機制、管理員通知系統，以及系統穩定性。

# 優先級

High

---

# 用戶決策

**決策日期：** 2025-11-12

**決策內容：** B - 不自動重試，顯示失敗原因，提供「手動重新發送」按鈕

**用戶原話：** "B"

# 規格整合

## 新增內容

### spec/features/message_analytics.feature

#### 新增 Rule：發送失敗的手動重試機制（第 112-139 行）

```gherkin
Rule: 發送失敗的訊息不自動重試，提供手動重新發送功能

  Example: 發送失敗後不自動重試
    Given 系統發送訊息「週年慶」時因網路問題失敗
    When 訊息發送失敗
    Then 系統將訊息狀態標記為「發送失敗」
    And 系統記錄失敗原因「網路連線逾時」
    And 系統不自動嘗試重新發送

  Example: 管理員查看失敗訊息並手動重新發送
    Given 系統中存在訊息「會員日活動」，發送狀態為「發送失敗」
    And 失敗原因為「LINE API 暫時無回應」
    When 行銷數據人員查看該訊息
    Then 系統顯示失敗原因「LINE API 暫時無回應」
    And 系統提供「重新發送」按鈕
    When 行銷數據人員點擊「重新發送」按鈕
    Then 系統重新執行訊息發送流程
    And 系統更新訊息狀態為「發送中」

  Example: 不同失敗原因的顯示
    Given 系統中存在以下發送失敗的訊息
      | message_name | failure_reason      |
      | 優惠活動A    | 訊息額度不足        |
      | 優惠活動B    | 會員已封鎖         |
      | 優惠活動C    | 網路連線逾時        |
    When 行銷數據人員查看訊息發送清單
    Then 系統分別顯示各訊息的失敗原因
    And 所有失敗訊息都提供「重新發送」按鈕
```

## 實作說明

### 失敗處理策略
- **不自動重試：** 系統不實作自動重試機制
- **狀態標記：** 發送失敗時立即將訊息狀態標記為「發送失敗」
- **原因記錄：** 將失敗原因詳細記錄到資料庫（包含錯誤代碼、錯誤訊息、發生時間）
- **人工判斷：** 由管理員根據失敗原因判斷是否需要重新發送

### 失敗原因分類
系統應記錄並顯示以下失敗原因類型：

1. **訊息額度不足**
   - LINE Official Account 的訊息配額用盡
   - 建議動作：升級方案或等待配額恢復

2. **會員已封鎖**
   - 會員封鎖了官方帳號
   - 建議動作：不重新發送，標記會員狀態

3. **網路連線逾時**
   - 與 LINE API 連線逾時
   - 建議動作：可嘗試重新發送

4. **LINE API 暫時無回應**
   - LINE 伺服器暫時無法服務
   - 建議動作：稍後再重新發送

5. **訊息內容違規**
   - 訊息內容不符合 LINE 規範
   - 建議動作：修改訊息內容後重新發送

6. **會員帳號異常**
   - 會員的 LINE 帳號狀態異常
   - 建議動作：不重新發送

### 手動重新發送功能

#### UI 設計要點
- **失敗狀態標示：** 使用明顯的顏色（如紅色）標示失敗訊息
- **失敗原因顯示：** 在訊息列表中直接顯示簡短的失敗原因
- **詳細資訊：** 點擊訊息可查看完整的錯誤訊息和堆疊追蹤（供技術人員除錯）
- **重新發送按鈕：** 在訊息詳情頁提供「重新發送」按鈕
- **確認對話框：** 點擊重新發送前顯示確認對話框，說明將重新發送給所有原定收件人

#### 重新發送邏輯
```
1. 管理員點擊「重新發送」按鈕
2. 系統顯示確認對話框
3. 管理員確認後：
   - 系統將訊息狀態更新為「發送中」
   - 系統重新執行原始的發送流程
   - 系統重新查詢收件人清單（根據原始篩選條件）
   - 系統嘗試發送訊息
   - 成功：更新狀態為「已發送」
   - 失敗：再次標記為「發送失敗」並記錄新的失敗原因
```

### 資料模型調整

#### Campaign 表或 Message 表需要的欄位
```sql
-- 發送狀態
status VARCHAR(20) -- 'draft', 'sending', 'sent', 'failed'

-- 失敗原因（簡短描述）
failure_reason VARCHAR(100)

-- 失敗詳細資訊（技術細節）
failure_details TEXT

-- 失敗時間
failed_at TIMESTAMP

-- 重試次數（記錄手動重試次數）
retry_count INT DEFAULT 0

-- 最後重試時間
last_retry_at TIMESTAMP
```

### 優點
- **實作簡單：** 不需要複雜的排程任務、佇列系統、重試邏輯
- **可控性高：** 管理員可根據失敗原因判斷是否重試
- **避免浪費：** 不會對無法恢復的錯誤（如配額不足、會員封鎖）進行無效重試
- **除錯友善：** 失敗原因明確顯示，方便排查問題

### 缺點
- **需人工介入：** 無法自動處理暫時性錯誤（如網路波動）
- **時效性：** 可能錯過最佳發送時機（如限時優惠）
- **工作負擔：** 管理員需要定期檢查失敗訊息並手動處理

### 建議補充功能（未來擴充）
1. **失敗通知：** 發送失敗時透過 email 或系統通知提醒管理員
2. **批次重試：** 提供批次選擇多個失敗訊息一次重新發送
3. **失敗統計：** 在儀表板顯示失敗訊息數量和失敗率趨勢
4. **失敗原因分析：** 提供失敗原因的統計圖表，幫助發現系統性問題

### 測試要點
1. **失敗狀態測試：** 模擬各種失敗情境，驗證狀態正確標記
2. **原因記錄測試：** 驗證不同失敗原因正確記錄和顯示
3. **重新發送測試：** 驗證手動重新發送功能正常運作
4. **UI 測試：** 驗證失敗訊息在列表中正確顯示
5. **邊界測試：** 測試多次重新發送的行為

# 歸檔資訊

- **歸檔時間：** 2025-11-12
- **處理狀態：** 已整合至規格
- **處理者：** Claude (SuperClaude Framework)
