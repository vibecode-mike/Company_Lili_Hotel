# 釐清問題
當多位管理員同時編輯同一則群發訊息草稿時，系統如何保證資料一致性？是否需要鎖定機制或版本控制？

# 定位
Feature：`create_broadcast.feature` 未定義多人協作時的併發控制規則

依據 `create_broadcast.feature:182-191`，系統支援「儲存為草稿」功能，但未說明多位管理員同時編輯同一草稿時的行為。

相關規則：
- `create_broadcast.feature:182-191` - 儲存草稿時允許 action_type 已設定但對應欄位未填
- `create_broadcast.feature:193-207` - 發送訊息前嚴格驗證

潛在衝突情境：
1. 管理員 A 編輯草稿 D1，修改標題為「春節優惠」
2. 管理員 B 同時編輯草稿 D1，修改標題為「新年特惠」
3. 兩人幾乎同時點擊儲存

# 多選題
| 選項 | 描述 |
|--------|-------------|
| A | 採用樂觀鎖（Optimistic Locking）：使用 version 欄位，後儲存者收到衝突提示，需重新載入最新版本 |
| B | 採用悲觀鎖（Pessimistic Locking）：編輯時鎖定草稿，其他人只能唯讀，直到編輯者儲存或取消 |
| C | 後寫覆蓋（Last Write Wins）：不做衝突檢測，最後儲存的版本直接覆蓋 |
| D | 僅允許草稿建立者編輯，其他管理員僅能檢視 |
| E | 採用即時協作模式（類似 Google Docs），多人可同時編輯並即時同步變更 |
| F | 其他方案（請說明） |

# 影響範圍
- **實體影響**：
  - Campaign 可能需新增 version 欄位（若選擇 A）
  - Campaign 可能需新增 locked_by, locked_at 欄位（若選擇 B）
- **功能影響**：
  - 群發訊息草稿編輯流程
  - 草稿列表 UI（需顯示鎖定狀態或編輯者資訊）
  - 草稿儲存與驗證邏輯
- **API 影響**：
  - PATCH /campaigns/:id 需加入併發控制檢查
  - GET /campaigns/:id 需回傳鎖定狀態或版本資訊
  - 可能需新增 POST /campaigns/:id/lock 和 DELETE /campaigns/:id/lock 端點
- **UX 影響**：
  - 需設計衝突提示 UI
  - 需設計鎖定狀態提示（若選擇 B）
- **測試影響**：需新增併發編輯測試案例

# 優先級
Medium

# 理由
此問題影響多人協作情境的資料一致性與使用者體驗，應在實作草稿功能前明確定義策略。但由於飯店管理系統的管理員數量通常較少，併發編輯機率不高，優先級為 Medium。

---
# 解決記錄

- **回答**：C - 採用後寫覆蓋（Last Write Wins）策略
- **更新的規格檔**：spec/features/create_broadcast.feature
- **變更內容**：新增規則「多位管理員同時編輯同一草稿時採用後寫覆蓋策略（Last Write Wins）」，包含兩個範例：
  1. 多位管理員同時編輯草稿，後儲存者覆蓋前者變更（系統不顯示衝突警告或版本控制提示）
  2. 後寫覆蓋不影響其他草稿的編輯（不同草稿的編輯互不影響）
- **實作影響**：
  - 不需新增 version、locked_by、locked_at 等欄位
  - API 不需實作併發控制檢查
  - 前端不需設計衝突提示 UI
  - 實作複雜度最低，適合管理員數量較少的飯店管理系統情境
