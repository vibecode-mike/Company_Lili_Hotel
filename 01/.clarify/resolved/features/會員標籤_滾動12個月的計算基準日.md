# 釐清問題

「過去 12 個月」的計算基準日為何？是從今日往前推算，還是從當月 1 日或特定日期開始計算？

# 定位

Feature：spec/features/member_tag_management.feature Example 關於滾動計算（約第34-46行、57-69行）

# 多選題

| 選項 | 描述 |
|--------|-------------|
| A | 從今日（current_date）往前推算 365 天 |
| B | 從本月 1 日往前推算 12 個完整月份 |
| C | 從上月最後一日往回推算 12 個完整月份（固定週期） |
| Short | 其他基準（<=5字）|

# 影響範圍

影響標籤判定邏輯、標籤更新頻率、會員資格變動時機、統計資料一致性，以及測試案例設計。

# 優先級

High

---

# 用戶決策

**決策日期：** 2025-11-12

**決策內容：** A - 從今日（current_date）往前推算 365 天

**用戶原話：** "A"

# 規格整合

## 新增內容

### spec/features/member_tag_management.feature

#### 1. 新增通用 Rule（第 32-39 行）

```gherkin
Rule: 滾動12個月的時間範圍計算採用從當前日期往前推算365天

  Example: 滾動12個月的計算基準日範例
    Given 今日為「2025/06/15」
    When 系統計算「過去 12 個月」的時間範圍
    Then 時間範圍為「2024/06/15 至 2025/06/15」
    And 計算公式為「current_date - 365 天至 current_date」
    And 系統每日自動更新標籤判定結果
```

## 更新內容

### spec/features/member_tag_management.feature

#### 1. 更新「消費金額達指定門檻」Rule 的 Examples（第 34-46 行）

**更新前：**
```gherkin
And 時間範圍定義為「從當前日期往前推算 12 個月」
```

**更新後：**
```gherkin
And 時間範圍定義為「從當前日期（current_date）往前推算 365 天」
```

- Example: 消費金額達指定門檻的標籤（第 37 行）
- Example: 消費金額未達門檻（第 44 行）

#### 2. 更新「訪問頻率條件」Rule 的 Examples（第 57-69 行）

**更新前：**
```gherkin
And 計算週期定義為「從當前日期往前推算 12 個月的住宿次數」
```

**更新後：**
```gherkin
And 計算週期定義為「從當前日期（current_date）往前推算 365 天的住宿次數」
```

- Example: 訪問頻率達標的標籤（第 60 行）
- Example: 訪問頻率未達標（第 67 行）

## 實作說明

### 計算邏輯
- **公式：** `current_date - 365 days` 至 `current_date`
- **範例：** 若今日為 2025/06/15，則計算範圍為 2024/06/15 00:00:00 至 2025/06/15 23:59:59

### 更新頻率
- **滾動式更新：** 系統每日自動重新計算時間範圍
- **即時性：** 最即時反映會員當前狀態
- **資格變動：** 會員標籤資格每日可能因時間範圍滾動而變動

### 影響範圍
1. **標籤判定邏輯：** 所有涉及「過去 12 個月」條件的標籤規則（消費金額、訪問頻率等）
2. **自動更新機制：** 需實作每日定時任務重新計算標籤
3. **測試案例：** 需驗證時間邊界條件（365天前的資料包含/排除邏輯）
4. **效能考量：** 每日全量重算可能影響效能，建議採用增量更新策略

### 技術建議
- 使用資料庫日期函數：`WHERE transaction_date >= CURRENT_DATE - INTERVAL '365 days'`
- 考慮時區處理：統一使用 UTC 或飯店所在時區
- 快取策略：針對高頻查詢標籤結果可暫存，設定適當過期時間

# 歸檔資訊

- **歸檔時間：** 2025-11-12
- **處理狀態：** 已整合至規格
- **處理者：** Claude (SuperClaude Framework)
