# 釐清問題

當多個自動回應同時觸發時（如歡迎訊息 vs 關鍵字觸發），執行優先順序為何？是否都回應？還是只回應第一個？觸發順序基於什麼排序（created_at？priority 欄位？trigger_type？）

# 定位

Feature：auto_response.feature 中自動回應觸發規則
已解決項目：`.clarify/resolved/features/自動回應_多個自動回應同時觸發的優先順序.md`

# 多選題

| 選項 | 描述 |
|--------|-------------|
| A | trigger_type 優先順序：welcome > time > keyword；同類型按 created_at ASC 排序，僅執行第一個 |
| B | 全部執行，依 trigger_type（welcome > time > keyword）→ created_at ASC 順序發送多筆訊息 |
| C | 新增 priority 欄位（1-10），按 priority DESC → created_at ASC 排序，僅執行第一個 |
| D | 同類型僅執行最新的（created_at DESC），不同類型都執行（welcome + keyword 都會回應） |

# 影響範圍

- AutoResponse 表是否需新增 priority 欄位
- 自動回應觸發邏輯實作（查詢排序與過濾）
- 使用者體驗（單一回應 vs. 多筆回應）
- 測試案例設計（多觸發情境）
- 自動回應管理介面（是否顯示優先順序設定）

# 優先級

High
- 阻礙自動回應核心功能實作
- 影響使用者體驗設計
- 影響 AutoResponse 表結構

---

# 解決記錄

**解決日期**：2025-11-19
**選擇方案**：A（固定優先順序，僅執行第一個）+ 修正版
**解決理由**：
- 觸發機制說明：
  • 歡迎訊息（welcome_message）：會員加入好友時立即觸發，與其他觸發類型不衝突（獨立觸發）
  • 關鍵字觸發（keyword_trigger）vs 指定時間觸發（scheduled_trigger）：會員發送訊息時同時檢查
- 優先順序（僅適用於會員發送訊息時）：關鍵字觸發（keyword_trigger）> 指定時間觸發（scheduled_trigger）
- 排序邏輯：第一層按 trigger_type 排序（關鍵字 > 時間），第二層按 created_at ASC 排序（同類型時，最早建立的優先）
- 執行策略：當多個自動回應同時觸發時，僅執行優先順序最高的 1 則（有命中關鍵字就回，不再檢查時間）
- 優點：簡單明確，避免訊息轟炸使用者，關鍵字優先符合業務需求
- 缺點：無法自訂優先順序（採用固定規則）

**規格更新**：
- 更新 `01/spec/features/auto_response.feature`（lines 461-535）：
  - 新增 Rule「多個自動回應同時觸發時的優先順序規則（方案 A：固定優先順序，僅執行第一個）」
  - 觸發機制說明：歡迎訊息獨立觸發，關鍵字與時間在會員發送訊息時檢查
  - 優先順序定義（會員發送訊息時）：關鍵字觸發（最高）> 指定時間觸發（次優先）
  - 排序邏輯：trigger_type（關鍵字 > 時間）→ created_at ASC
  - 6 個 Example 場景：
    1. 新好友加入並發送關鍵字 - 歡迎訊息與關鍵字都執行（不衝突）
    2. 關鍵字觸發與時間觸發同時滿足 - 僅執行關鍵字觸發
    3. 關鍵字未命中但時間觸發滿足 - 執行時間觸發
    4. 同類型多個觸發 - 執行最早建立的
    5. 僅一個自動回應觸發 - 正常執行
    6. 所有自動回應皆停用 - 不執行任何回應

- 更新 `01/spec/erm.dbml` - AutoResponse 表 Note（lines 653-674）：
  - 新增「多觸發優先順序規則（方案 A：固定優先順序，僅執行第一個）」段落
  - 觸發機制說明：歡迎訊息獨立觸發，關鍵字與時間在會員發送訊息時檢查
  - 優先順序定義（會員發送訊息時）：關鍵字觸發 > 指定時間觸發
  - 排序邏輯、執行策略說明
  - 範例場景與 SQL 查詢範例：
    ```sql
    SELECT * FROM AutoResponse
    WHERE (keyword_matched OR time_matched) AND is_enabled = true
    ORDER BY
      CASE trigger_type
        WHEN 'keyword_trigger' THEN 1
        WHEN 'scheduled_trigger' THEN 2
      END,
      created_at ASC
    LIMIT 1
    ```
