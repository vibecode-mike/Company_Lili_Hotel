# 釐清問題

「加入好友期間 7～29 天」的計算邏輯為何？是含頭尾（>= 7 且 <= 29）、含頭不含尾（>= 7 且 < 30），還是其他規則？

# 定位

Feature：spec/features/create_broadcast.feature Rule 關於加入好友期間（約第122-127行）

# 多選題

| 選項 | 描述 |
|--------|-------------|
| A | 含頭尾（>= 7 天 且 <= 29 天），即第 7 天到第 29 天 |
| B | 含頭不含尾（>= 7 天 且 < 30 天），與選項 A 相同 |
| C | 不含頭含尾（> 7 天 且 <= 29 天），即第 8 天到第 29 天 |
| Short | 其他計算（<=5字）|

# 影響範圍

影響會員篩選準確性、測試案例設計、邊界條件驗證，以及與行銷人員溝通的精確性。

# 優先級

Medium

---

# 用戶決策

**決策日期：** 2025-11-12

**決策內容：** A - 含頭尾（>= 7 天 且 <= 29 天），即第 7 天到第 29 天

**用戶原話：** "A"

# 規格整合

## 更新內容

### spec/features/create_broadcast.feature

#### 更新 Rule 並新增 Examples（第 130-162 行）

**原規格：**
```gherkin
Rule: 使用者可選擇訊息特定的觸發條件，如加入好友期間的 7～29天

  Example: 設定加入好友期間觸發條件
    Given 行銷人員正在建立群發訊息
    When 行銷人員設定觸發條件「加入好友 7～29 天」
    Then 系統篩選加入好友 7～29 天的會員作為目標對象
```

**更新後規格：**
```gherkin
Rule: 使用者可選擇訊息特定的觸發條件，如加入好友期間的 7～29天

  Example: 設定加入好友期間觸發條件
    Given 行銷人員正在建立群發訊息
    When 行銷人員設定觸發條件「加入好友 7～29 天」
    Then 系統篩選加入好友 7～29 天的會員作為目標對象
    And 計算邏輯為「加入天數 >= 7 且 <= 29」（含頭尾）

  Example: 加入好友期間計算邏輯（含頭尾）
    Given 今日為「2025/11/12」
    And 系統中存在以下會員及其加入日期
      | member_name | join_date  | 加入天數 |
      | 會員A       | 2025/11/05 | 7天      |
      | 會員B       | 2025/11/04 | 8天      |
      | 會員C       | 2025/10/14 | 29天     |
      | 會員D       | 2025/10/13 | 30天     |
      | 會員E       | 2025/11/06 | 6天      |
    When 行銷人員設定篩選條件「加入好友 7～29 天」
    Then 系統篩選出以下會員
      | member_name | join_date  | 加入天數 |
      | 會員A       | 2025/11/05 | 7天      |
      | 會員B       | 2025/11/04 | 8天      |
      | 會員C       | 2025/10/14 | 29天     |
    And 會員D 不符合條件（30天，超出範圍）
    And 會員E 不符合條件（6天，未達最小天數）

  Example: 邊界值測試：第 7 天和第 29 天都包含
    Given 今日為「2025/11/12」
    And 會員「張三」於「2025/11/05」加入（恰好 7 天）
    And 會員「李四」於「2025/10/14」加入（恰好 29 天）
    When 行銷人員設定篩選條件「加入好友 7～29 天」
    Then 會員「張三」符合條件（>= 7 天）
    And 會員「李四」符合條件（<= 29 天）
```

## 實作說明

### 計算邏輯定義

**數學表示：** `7 <= 加入天數 <= 29`

**SQL 實作（PostgreSQL）：**
```sql
-- 計算加入天數
SELECT
    member_id,
    member_name,
    join_date,
    CURRENT_DATE - join_date AS days_since_joined
FROM members
WHERE
    CURRENT_DATE - join_date >= 7
    AND CURRENT_DATE - join_date <= 29;
```

**SQL 實作（使用 DATEDIFF，MySQL）：**
```sql
SELECT
    member_id,
    member_name,
    join_date,
    DATEDIFF(CURRENT_DATE, join_date) AS days_since_joined
FROM members
WHERE
    DATEDIFF(CURRENT_DATE, join_date) >= 7
    AND DATEDIFF(CURRENT_DATE, join_date) <= 29;
```

### 後端實作（FastAPI + SQLAlchemy）

```python
from datetime import date
from sqlalchemy import func
from sqlalchemy.orm import Session

def filter_members_by_join_period(
    db: Session,
    min_days: int = 7,
    max_days: int = 29
) -> list:
    """
    根據加入好友期間篩選會員

    Args:
        db: 資料庫會話
        min_days: 最小天數（含）
        max_days: 最大天數（含）

    Returns:
        符合條件的會員列表
    """
    today = date.today()

    # 計算加入天數
    days_since_joined = func.julianday(today) - func.julianday(Member.join_date)

    # 篩選條件：含頭尾
    members = db.query(Member).filter(
        days_since_joined >= min_days,
        days_since_joined <= max_days
    ).all()

    return members
```

### 前端實作（React）

```typescript
// 加入好友期間篩選組件
interface JoinPeriodFilterProps {
  onFilterChange: (minDays: number, maxDays: number) => void;
}

const JoinPeriodFilter: React.FC<JoinPeriodFilterProps> = ({ onFilterChange }) => {
  const [minDays, setMinDays] = useState<number>(7);
  const [maxDays, setMaxDays] = useState<number>(29);

  const handleApplyFilter = () => {
    onFilterChange(minDays, maxDays);
  };

  return (
    <div className="join-period-filter">
      <h4>加入好友期間</h4>
      <div className="period-inputs">
        <input
          type="number"
          value={minDays}
          onChange={(e) => setMinDays(Number(e.target.value))}
          min={0}
        />
        <span>～</span>
        <input
          type="number"
          value={maxDays}
          onChange={(e) => setMaxDays(Number(e.target.value))}
          min={minDays}
        />
        <span>天</span>
      </div>
      <p className="help-text">
        包含第 {minDays} 天和第 {maxDays} 天的會員（含頭尾）
      </p>
      <button onClick={handleApplyFilter}>套用篩選</button>
    </div>
  );
};
```

### 天數計算方式

**計算公式：**
```
加入天數 = 當前日期 - 加入日期
```

**範例計算：**
- 今日：2025/11/12
- 會員加入日期：2025/11/05
- 加入天數：2025/11/12 - 2025/11/05 = 7 天

**注意事項：**
1. **日期計算單位：** 以「天」為單位，不考慮小時和分鐘
2. **當日加入：** 加入當日算第 0 天
3. **隔日開始：** 第二天開始算第 1 天
4. **時區處理：** 統一使用系統時區或 UTC

### 邊界值測試

#### 測試案例 1：最小邊界值（第 7 天）
```python
def test_min_boundary_included():
    """測試第 7 天的會員是否被包含"""
    today = date(2025, 11, 12)
    join_date = date(2025, 11, 5)  # 7 天前
    days = (today - join_date).days

    assert days == 7
    assert 7 <= days <= 29  # 應該為 True
```

#### 測試案例 2：最大邊界值（第 29 天）
```python
def test_max_boundary_included():
    """測試第 29 天的會員是否被包含"""
    today = date(2025, 11, 12)
    join_date = date(2025, 10, 14)  # 29 天前
    days = (today - join_date).days

    assert days == 29
    assert 7 <= days <= 29  # 應該為 True
```

#### 測試案例 3：小於最小值（第 6 天）
```python
def test_less_than_min_excluded():
    """測試第 6 天的會員是否被排除"""
    today = date(2025, 11, 12)
    join_date = date(2025, 11, 6)  # 6 天前
    days = (today - join_date).days

    assert days == 6
    assert not (7 <= days <= 29)  # 應該為 False
```

#### 測試案例 4：大於最大值（第 30 天）
```python
def test_greater_than_max_excluded():
    """測試第 30 天的會員是否被排除"""
    today = date(2025, 11, 12)
    join_date = date(2025, 10, 13)  # 30 天前
    days = (today - join_date).days

    assert days == 30
    assert not (7 <= days <= 29)  # 應該為 False
```

### UI 顯示說明

#### 篩選條件說明文字
```
加入好友期間：7～29 天（包含第 7 天和第 29 天）
```

#### 輔助說明
```
說明：系統會篩選出加入好友滿 7 天（含）至 29 天（含）的會員。
例如：今天是 11/12，則會包含 11/5（7天前）至 10/14（29天前）加入的會員。
```

### 常見問題處理

#### Q1: 為什麼選擇「含頭尾」而不是「含頭不含尾」？
**A:** 「含頭尾」更符合一般使用者的直覺理解。當使用者看到「7～29 天」時，通常會認為第 7 天和第 29 天都應該被包含。

#### Q2: 如何處理跨時區的情況？
**A:** 建議統一使用系統設定的時區（通常是飯店所在地的時區），在資料庫中儲存和計算時都使用同一時區。

#### Q3: 加入當天算第幾天？
**A:** 加入當天算第 0 天。隔天開始算第 1 天。

### 優點
- **直覺性：** 符合一般使用者對「7～29天」的理解
- **完整性：** 包含邊界值，不會遺漏符合條件的會員
- **明確性：** 規格清楚定義，減少歧義

### 注意事項
- **測試重要性：** 必須測試邊界值（第 7 天和第 29 天）
- **UI 說明：** 介面上應清楚說明「含頭尾」的邏輯
- **一致性：** 其他類似的期間篩選（如「30～60天」）也應採用相同邏輯

### 測試要點
1. **邊界值測試：** 驗證第 7 天和第 29 天的會員都被包含
2. **超出範圍測試：** 驗證第 6 天和第 30 天的會員被排除
3. **中間值測試：** 驗證第 15 天（中間值）的會員被包含
4. **空集合測試：** 驗證沒有符合條件的會員時正確處理
5. **跨月測試：** 驗證跨月份計算的正確性
6. **閏年測試：** 驗證閏年時日期計算的正確性

# 歸檔資訊

- **歸檔時間：** 2025-11-12
- **處理狀態：** 已整合至規格
- **處理者：** Claude (SuperClaude Framework)
