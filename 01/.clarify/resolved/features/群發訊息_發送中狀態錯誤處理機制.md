# 釐清問題

Message.send_status 定義 sending 為過渡狀態，但 feature 未定義發送過程中系統崩潰、網路錯誤的處理。發送中途系統重啟後如何處理？MessageDelivery 部分成功部分失敗如何標記？是否需要斷點續傳機制？

# 定位

ERM：Message.send_status 狀態轉換規則
Feature：create_broadcast.feature 中發送流程規則

# 多選題

| 選項 | 描述 |
|--------|-------------|
| A | 系統重啟後檢查 sending 狀態訊息，依 MessageDelivery 記錄斷點續傳（未發送的繼續發送） |
| B | sending 狀態超過 10 分鐘無更新自動改為 failed，需手動重試（全部重發） |
| C | 發送中途崩潰視為 failed，MessageDelivery 已成功的保留，失敗的標記，不自動重試 |
| D | 不處理斷點續傳，sending 狀態訊息系統重啟後改為 failed，顯示「發送中斷，請重新發送」 |

# 影響範圍

- Message.send_status 狀態轉換邏輯
- MessageDelivery 狀態追蹤與更新
- 系統啟動時的狀態恢復流程
- 發送任務的容錯與重試機制
- 錯誤訊息與使用者提示
- 測試案例（系統崩潰模擬）

# 優先級

Medium
- 影響系統穩定性與容錯能力
- 影響使用者體驗（發送失敗處理）
- 需設計錯誤恢復邏輯

---

# 解決記錄

**解決日期**：2025-11-19
**選擇方案**：C + 自動建立失敗會員草稿（方案 1：自動建立獨立草稿）
**解決理由**：
- 錯誤處理策略：發送中途崩潰視為 failed，不自動重試（避免重複發送風險）
- MessageDelivery 狀態保留：已成功的保持 delivered，未發送的標記為 failed
- 使用者友善功能：自動建立新草稿，包含失敗會員名單，方便手動檢查後重發
- 優點：
  • 避免自動重試造成的重複訊息問題
  • 保留完整發送記錄（成功 + 失敗）
  • 提供便捷的重發機制（自動篩選失敗會員）
  • 使用者可檢查失敗原因後決定是否重發

**規格更新**：
- 更新 `01/spec/features/create_broadcast.feature`（lines 467-537）：
  - 新增 Rule「發送中狀態錯誤處理機制（方案 C + 自動建立失敗會員草稿）」
  - 5 個 Example 場景：
    1. 發送中途系統崩潰 - 自動建立失敗會員草稿
    2. 檢視失敗訊息 - 顯示失敗原因與自動建立的草稿連結
    3. 編輯並重發失敗會員草稿 - 修改內容後僅發送給失敗會員
    4. 發送中途網路錯誤 - 部分成功部分失敗的處理
    5. 正常發送完成 - 不建立草稿

**錯誤恢復流程**：
```
系統重啟 → 檢測 send_status = sending
→ 將原訊息改為 failed
→ MessageDelivery 已成功的保持 delivered
→ MessageDelivery 尚未發送的標記為 failed
→ 自動建立新 Message（草稿）：
  • send_status = draft
  • template_id = 原訊息的 template_id
  • message_content = "[重發] " + 原訊息內容
  • target_type = filtered
  • target_filter = 失敗會員 member_id 列表（JSON 格式）
```
