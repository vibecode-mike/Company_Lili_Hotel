# 釐清問題

標籤統計的「觸發次數」與「觸發會員數」如何計算？同一會員多次觸發是否累計次數但會員數維持 1？

# 定位

Feature：spec/features/label_statistics.feature Rule 關於標籤統計（約第6-17行）

# 多選題

| 選項 | 描述 |
|--------|-------------|
| A | 觸發次數累計所有觸發（含重複），觸發會員數為不重複會員總數 |
| B | 觸發次數與觸發會員數皆去重（同一會員僅計一次） |
| C | 依標籤類型不同：會員標籤去重，互動標籤累計 |
| Short | 其他邏輯（<=5字）|

# 影響範圍

影響標籤統計準確性、去重邏輯實作、趨勢圖數據正確性、行銷成效分析，以及會員行為洞察。

# 優先級

High

---
# 解決記錄

- **回答**：A - 觸發次數累計所有觸發（含重複），觸發會員數為不重複會員總數
- **更新的規格檔**：
  - spec/erm.dbml（MemberTag 與 InteractionTag 的 trigger_count 與 trigger_member_count 欄位）
  - spec/features/label_statistics.feature（新增去重邏輯 Rule 與 4 個 Example）
- **變更內容**：
  - **InteractionTag.trigger_count**：更新為「累計所有不重複的 (member_id, tag_id, message_id) 組合數」，計算邏輯為 COUNT(DISTINCT member_id, tag_id, message_id)
  - **InteractionTag.trigger_member_count**：更新為「不重複會員總數」，計算邏輯為 COUNT(DISTINCT member_id)
  - **MemberTag 統計邏輯**：說明匯總層級的 trigger_count 為該標籤所有會員的累計觸發次數總和，trigger_member_count 為不重複會員數
  - **新增 Rule**：「觸發次數累計所有不重複的觸發記錄，觸發會員數為不重複會員總數」
  - **新增 4 個 Example**：
    1. 同一會員點擊不同訊息累計觸發次數
    2. 同一會員重複點擊相同訊息不累計
    3. 多個會員點擊同一訊息累計統計
    4. 綜合情境統計（涵蓋所有情況）
- **核心邏輯**：
  - **觸發次數**：以 MemberInteractionRecord 的唯一記錄為基準，每個 (member_id, tag_id, message_id) 組合算一次
  - **觸發會員數**：同一會員無論觸發多少次或多少訊息，僅計算一次
  - **去重機制**：依賴 unique_member_tag_message 索引阻擋重複插入
  - **統計範例**：會員A點擊訊息1、訊息2，會員B點擊訊息1 → trigger_count=3, trigger_member_count=2
