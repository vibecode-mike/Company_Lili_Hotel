# 釐清問題

WebSocket 即時連線的斷線重連機制為何？斷線時如何通知使用者？重連後如何補齊遺漏訊息？

# 定位

Feature：spec/features/message_history.feature Example 關於即時更新（約第24-37行）

# 多選題

| 選項 | 描述 |
|--------|-------------|
| A | 自動重連（指數退避），斷線顯示提示，重連後補齊遺漏訊息 |
| B | 自動重連（固定間隔），不顯示斷線提示，重連後重新載入 |
| C | 不自動重連，顯示「連線中斷」提示，使用者手動刷新頁面 |
| Short | 其他機制（<=5字）|

# 影響範圍

影響即時訊息可靠性、使用者體驗、訊息遺漏風險、前端錯誤處理，以及系統穩定性。

# 優先級

High

---

# 用戶決策

**決策日期：** 2025-11-12

**決策內容：** C - 不自動重連，顯示「連線中斷」提示，使用者手動刷新頁面

**用戶原話：** "C"

# 規格整合

## 新增內容

### spec/features/message_history.feature

#### 新增 Rule：WebSocket 連線中斷處理機制（第 39-54 行）

```gherkin
Rule: WebSocket 連線中斷時顯示提示，不自動重連，由使用者手動刷新頁面

  Example: WebSocket 連線中斷時顯示提示訊息
    Given 內部人員正在與會員「張三」聊天
    And 系統透過 WebSocket 建立即時連線
    When WebSocket 連線因網路問題中斷
    Then 系統偵測到連線中斷
    And 聊天介面顯示提示訊息「連線已中斷，請刷新頁面以恢復即時連線」
    And 系統不自動嘗試重新連線

  Example: 使用者手動刷新頁面後重新建立連線
    Given 聊天介面顯示「連線已中斷，請刷新頁面以恢復即時連線」
    When 使用者手動刷新頁面（F5 或重新載入）
    Then 系統重新建立 WebSocket 連線
    And 聊天介面載入最新的訊息紀錄
    And 提示訊息消失，恢復正常使用
```

## 實作說明

### 斷線偵測機制
- **偵測方式：** 監聽 WebSocket `onclose` 和 `onerror` 事件
- **偵測時機：**
  - 網路中斷
  - 伺服器重啟或維護
  - 瀏覽器休眠後恢復
  - WebSocket 連線逾時

### 使用者提示
- **提示方式：** 在聊天介面頂部顯示明顯的橫幅提示
- **提示內容：** 「連線已中斷，請刷新頁面以恢復即時連線」
- **提示樣式：** 建議使用警告色（黃色或橘色）以引起注意
- **提示位置：** 固定在聊天視窗頂部，不可關閉

### 重連機制
- **策略：** 不實作自動重連功能
- **使用者操作：** 需手動刷新頁面（F5 或點擊重新載入按鈕）
- **重連行為：** 頁面重新載入後重新建立 WebSocket 連線
- **訊息載入：** 重新載入完整的聊天紀錄（最新狀態）

### 訊息遺漏風險
- **風險說明：** 在連線中斷期間，新訊息不會即時顯示
- **風險程度：** 中等（使用者刷新後可看到完整訊息）
- **緩解措施：**
  - 明確的提示訊息提醒使用者刷新
  - 刷新後載入完整訊息紀錄，確保不遺漏訊息
  - 建議定期儲存重要對話內容

### 前端實作重點
```javascript
// WebSocket 連線中斷偵測
websocket.onclose = function(event) {
  // 顯示斷線提示橫幅
  showDisconnectBanner('連線已中斷，請刷新頁面以恢復即時連線');
  // 不嘗試自動重連
};

websocket.onerror = function(error) {
  // 記錄錯誤
  console.error('WebSocket error:', error);
  // 顯示斷線提示
  showDisconnectBanner('連線已中斷，請刷新頁面以恢復即時連線');
};
```

### 優點
- **實作簡單：** 不需要實作複雜的重連邏輯、指數退避、訊息補齊機制
- **狀態清晰：** 使用者明確知道連線狀態
- **資源節省：** 不消耗伺服器資源進行重連嘗試
- **除錯容易：** 問題排查更直接

### 缺點
- **使用者體驗：** 需要手動操作，較不便利
- **訊息延遲：** 斷線期間訊息不即時更新
- **依賴使用者操作：** 如果使用者未注意到提示，可能長時間處於斷線狀態

### 測試要點
1. **斷線偵測測試：** 模擬網路中斷，驗證是否正確顯示提示
2. **提示顯示測試：** 確認提示訊息位置、樣式、內容正確
3. **刷新恢復測試：** 驗證刷新後連線正常恢復
4. **訊息完整性測試：** 確認刷新後載入完整訊息紀錄
5. **跨瀏覽器測試：** 測試不同瀏覽器的 WebSocket 斷線行為

# 歸檔資訊

- **歸檔時間：** 2025-11-12
- **處理狀態：** 已整合至規格
- **處理者：** Claude (SuperClaude Framework)
