# 釐清問題

AutoResponse 的「指定時間觸發」支援兩種模式：passive（被動回應模式，會員發訊息時判斷時間範圍）與 active（主動推播模式，系統於時間範圍開始時主動推播）。active 模式的具體執行時機為何？是每天於 time_range_start 時間點執行一次？還是持續在時間範圍內重複推播？weekdays 週期性規則如何影響執行？

# 定位

Feature：auto_response.feature
ERM：AutoResponse 實體（scheduled_mode, time_range_start, time_range_end, weekdays 屬性）
檢查項：B2. 規則完整性（scheduled_mode = 'active' 的執行邏輯）

相關說明（erm.dbml line 637）：
```
scheduled_mode string(20) [note: '指定時間觸發模式（當 trigger_type = 指定時間觸發時使用），上限 20 字元：passive（被動回應模式）/ active（主動推播模式）。passive：會員發訊息時判斷時間是否在範圍內，符合則回應；active：系統於時間範圍開始時主動推播給所有會員']
```

# 多選題

| 選項 | 描述 |
|--------|-------------|
| A | 單次執行：每天於 time_range_start 時間點執行一次主動推播，發送給所有會員（或符合 weekdays 條件的日期） |
| B | 每日重複：每天於 time_range_start 執行一次，持續執行直到 AutoResponse 被停用（is_enabled = false） |
| C | 週期性執行：僅在符合 weekdays 條件的星期執行（如 weekdays = "1,2,3,4,5" 表示週一至週五才執行），其他日期跳過 |
| D | 範圍內持續：time_range_start 至 time_range_end 期間內，每隔 N 分鐘執行一次推播（需定義推播頻率參數） |
| Short | 提供其他簡短答案（<=5 字） |

註：執行頻率將直接影響 LINE API 配額消耗與會員推播體驗（過於頻繁可能造成騷擾）。

補充問題：
- 目標對象：主動推播時，目標對象為「所有好友」還是「所有會員」？是否支援標籤篩選？
- 重複推播控制：若每日執行，同一會員是否每天都收到相同訊息？是否需要去重機制（如 24 小時內已發送則跳過）？
- 日期範圍：date_range_start 與 date_range_end 如何影響 active 模式的執行？是否僅在日期範圍內執行？

# 影響範圍

- **AutoResponse 表**：
  - 可能需新增 push_frequency 欄位（主動推播頻率，如 'daily' / 'hourly' / 'once'）
  - 可能需新增 last_pushed_at 欄位（最後推播時間，用於去重控制）
  - 可能需新增 target_filter 欄位（目標對象篩選條件，如標籤、會員狀態）
- **自動回應執行邏輯**：
  - 排程任務設計（Cron Job 或背景任務）
  - 執行時機判斷邏輯（時間範圍、weekdays、date_range 的綜合判斷）
  - 目標對象查詢（LineFriend.is_following = true 或 Member 表）
- **LINE API 配額管理**：
  - 主動推播的配額消耗估算
  - 配額不足時的錯誤處理
- **去重機制**：
  - 避免同一會員在短時間內收到重複訊息
  - 去重窗口期的定義（如 24 小時、7 天）

影響功能：
- 自動回應設定：UI 需提供 active 模式的執行頻率設定選項
- 訊息發送：排程任務需根據 active 模式的邏輯觸發推播
- 會員體驗：推播頻率過高可能造成會員反感，需平衡推播策略

# 優先級

**High**（影響自動回應核心功能與用戶體驗）

理由：
1. 功能不明確：缺少 active 模式的執行邏輯定義，開發人員無法實作排程任務
2. 用戶體驗風險：執行頻率設計不當可能造成會員頻繁收到重複訊息，導致封鎖或取消追蹤
3. API 配額影響：主動推播的頻率直接影響 LINE API 配額消耗，需預先評估
4. 業務價值：active 模式是自動回應的重要功能（如每日早安訊息、定時提醒），需明確定義以發揮價值

建議行動：補充 active 模式的詳細執行邏輯至 auto_response.feature，包含執行頻率、目標對象、去重機制與日期範圍限制。建議採用「週期性執行」（選項 C）+ 每日單次推播（選項 A），並設計去重機制避免騷擾。
