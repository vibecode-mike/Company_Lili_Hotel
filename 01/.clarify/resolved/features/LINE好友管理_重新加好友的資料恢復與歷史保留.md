# 釐清問題

LineFriend 表的好友狀態管理規則中，重新加好友時會更新 followed_at 為當前時間並清除 unfollowed_at。但規格未明確說明：是否需要保留用戶的「取消追蹤」歷史記錄？若用戶多次取消追蹤再重新加好友，如何追蹤這些歷史行為？

# 定位

Feature：line_friends_management.feature
ERM：LineFriend 實體（好友狀態管理）
檢查項：B2. 規則完整性（重新加好友的歷史記錄保留）

相關說明（erm.dbml line 116-119）：
```
好友狀態管理：
  - 重新加好友：
    * is_following = true
    * followed_at = 當前時間（更新為最新加好友時間）
    * unfollowed_at = NULL（清除取消追蹤記錄）
```

# 多選題

| 選項 | 描述 |
|--------|-------------|
| A | 覆蓋策略：重新加好友時直接覆蓋 followed_at 並清除 unfollowed_at，不保留取消追蹤歷史（當前規格設計） |
| B | 歷史表保留：建立 LineFriendHistory 表，記錄每次加好友/取消追蹤的時間與事件類型，LineFriend 僅保留最新狀態 |
| C | 事件日誌保留：建立 LineFriendEvent 表，記錄所有好友狀態變更事件（follow / unfollow / refollow），支援完整追蹤與行為分析 |
| D | 計數器策略：新增 follow_count（加好友次數）與 unfollow_count（取消追蹤次數）欄位，僅記錄次數不保留時間歷史 |
| Short | 提供其他簡短答案（<=5 字） |

註：歷史記錄保留策略將影響用戶行為分析能力（如分析「頻繁取消追蹤」用戶特徵）、資料儲存成本與查詢複雜度。

補充問題：
- 業務需求：是否需要分析「頻繁取消追蹤再加好友」的用戶行為？這類資料對行銷決策是否有價值？
- 資料保留期限：若保留歷史記錄，應保留多久？（如 90 天、1 年、永久）
- 隱私合規：保留取消追蹤歷史是否涉及隱私問題？是否符合 GDPR / PDPA 要求？

# 影響範圍

- **LineFriend 表**：
  - 若採用選項 D（計數器策略），需新增 follow_count 與 unfollow_count 欄位
- **歷史表設計（若採用選項 B 或 C）**：
  - 新增 LineFriendHistory 或 LineFriendEvent 表
  - 歷史表欄位設計（line_uid, event_type, event_time, is_following）
  - 歷史表索引設計（line_uid, event_time）
- **好友狀態變更邏輯**：
  - follow event 處理：新增好友或重新加好友的判斷邏輯
  - unfollow event 處理：更新 is_following 與 unfollowed_at
  - 歷史記錄寫入邏輯（若保留歷史）
- **用戶行為分析**：
  - 分析「頻繁取消追蹤」用戶特徵（如取消追蹤次數 >= 3 次）
  - 分析取消追蹤原因（可能需結合問卷或客服記錄）
- **資料保留策略**：
  - 歷史記錄的保留期限（若採用選項 B 或 C）
  - 定期清理過期歷史記錄的機制

影響功能：
- LINE 好友管理：follow / unfollow 事件處理邏輯
- 用戶行為分析：追蹤用戶加好友 / 取消追蹤的行為模式
- 資料統計：統計好友流失率、重新加好友比例等指標

# 優先級

**Low**（不影響核心功能，但對行為分析有價值）

理由：
1. 核心功能不受影響：當前規格的「覆蓋策略」已足以支援基本的好友狀態管理
2. 分析價值有限：取消追蹤歷史對行銷決策的價值需進一步評估
3. 資料成本：保留歷史記錄增加資料儲存成本
4. 可延後實作：若未來有分析需求，可透過新增歷史表擴展功能，不影響既有設計

建議行動：v0 階段採用「覆蓋策略」（選項 A），不保留歷史記錄，降低系統複雜度。若未來有明確的用戶行為分析需求（如分析頻繁取消追蹤用戶），再新增「歷史表保留」（選項 B）或「事件日誌保留」（選項 C）。補充歷史記錄策略說明至 line_friends_management.feature。
