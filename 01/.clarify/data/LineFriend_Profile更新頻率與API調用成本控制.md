# 釐清問題

LineFriend 表採用智能更新策略：「距離上次更新超過 N 天才重新呼叫 API」，但未明確定義 N 的具體數值。此參數將直接影響 LINE Profile API 的調用頻率與成本，應如何平衡資料新鮮度與 API 成本？

# 定位

ERM：LineFriend 實體（Profile 同步策略）
檢查項：A3. 屬性值邊界條件（更新頻率的數值定義）

相關說明（erm.dbml line 100-106）：
```
Profile 同步策略：
  - 加好友時（FollowEvent）：立即呼叫 LINE Profile API 取得 displayName 和 pictureUrl
  - 後續互動時：智能更新策略
    * 首次互動：呼叫 LINE Profile API 補抓取（若 line_display_name 或 line_picture_url 為空）
    * 後續互動：距離上次更新超過 N 天才重新呼叫 API（避免頻繁呼叫）
  - 更新觸發事件：文字訊息、postback、圖片訊息等所有用戶互動事件
  - 錯誤處理：API 失敗時靜默失敗，記錄 log，不中斷主流程
```

# 多選題

| 選項 | 描述 |
|--------|-------------|
| A | 7 天更新週期：每 7 天更新一次 LINE Profile，平衡資料新鮮度與 API 成本（適用於中等活躍度場景） |
| B | 30 天更新週期：每 30 天更新一次 LINE Profile，降低 API 調用成本，適用於 Profile 變更不頻繁的情境 |
| C | 動態更新週期：根據會員活躍度動態調整更新頻率（高活躍會員 7 天、中活躍 14 天、低活躍 30 天） |
| D | 可配置參數：將更新週期設為系統配置參數（預設 14 天），支援管理員透過後台調整，彈性控制 API 成本 |
| Short | 提供其他簡短答案（<=5 字） |

註：LINE Profile API 調用次數將影響系統成本與效能，需根據實際業務需求選擇適當的更新頻率。

補充問題：
- API 配額限制：LINE Profile API 是否有調用次數限制？若有，每日配額為多少？
- 成本估算：預估每月 LINE Profile API 調用次數與成本（假設 10,000 會員，平均每日互動 1,000 次）
- 更新欄位記錄：是否需要新增 profile_last_updated_at 欄位，記錄上次更新 LINE Profile 的時間？

# 影響範圍

- **LineFriend 表**：
  - 可能需新增 profile_last_updated_at timestamp 欄位，記錄上次更新 LINE Profile 的時間，用於判斷是否需要重新呼叫 API
- **Profile 更新邏輯**：
  - 互動事件處理時的 API 調用判斷邏輯（檢查 profile_last_updated_at 是否超過 N 天）
  - 更新頻率參數的配置方式（硬編碼 / 環境變數 / 資料庫配置表）
- **系統配置**：
  - 若採用選項 D（可配置參數），需設計系統配置介面供管理員調整更新週期
- **API 調用監控**：
  - 監控 LINE Profile API 的調用次數與成功率
  - 調用失敗時的錯誤日誌記錄
- **成本控制**：
  - 預估每月 API 調用次數與成本
  - 調用頻率過高時的告警機制

影響功能：
- LINE 好友互動處理：每次互動事件需判斷是否更新 LINE Profile
- 系統成本：LINE Profile API 調用次數直接影響 API 成本
- 資料新鮮度：更新頻率影響會員資料的即時性（如頭像、名稱變更的反映速度）

# 優先級

**Medium**（影響 API 成本與資料新鮮度平衡）

理由：
1. 成本控制：LINE Profile API 調用次數直接影響系統運營成本，需明確定義更新頻率
2. 資料新鮮度：過長的更新週期可能導致會員資料過時（如頭像、名稱變更未及時反映）
3. 效能影響：過於頻繁的 API 調用可能影響系統效能與回應速度
4. 可維護性：硬編碼的更新週期不易調整，建議採用可配置參數

建議行動：採用「可配置參數」（選項 D），預設 14 天更新週期，並新增 profile_last_updated_at 欄位記錄上次更新時間。設計系統配置介面供管理員調整更新週期，彈性控制 API 成本。補充更新頻率參數至 ERM 註記，並設計 API 調用監控機制。
