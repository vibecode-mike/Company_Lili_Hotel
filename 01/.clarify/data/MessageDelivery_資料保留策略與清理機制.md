# 釐清問題

MessageDelivery 表用於追蹤每個會員的群發訊息發送狀態，預估資料量為「會員數 × 訊息數」（如 10,000 會員 × 100 訊息 = 1,000,000 筆）。規格建議「保留最近 90 天資料，超過則歸檔或刪除」，但未明確定義清理策略的執行時機、清理範圍（僅刪除或同時歸檔）與歸檔目標位置。應如何設計資料保留與清理機制？

# 定位

ERM：MessageDelivery 實體
檢查項：A6. 生命週期與狀態（資料保留策略與清理機制）

相關說明（erm.dbml line 427-431）：
```
資料量管理：
  - 預估資料量：會員數 × 訊息數（如 10,000 會員 × 100 訊息 = 1,000,000 筆）
  - 資料保留策略：建議保留最近 90 天資料，超過則歸檔或刪除
  - 定期清理：透過排程任務定期清理過期資料
```

# 多選題

| 選項 | 描述 |
|--------|-------------|
| A | 僅刪除策略：每日凌晨 02:00 執行清理任務，直接刪除 created_at > 90 天的 MessageDelivery 記錄，不保留歸檔 |
| B | 歸檔至外部儲存：清理前先將 90 天前的記錄匯出至外部儲存（如 S3/GCS），以 CSV 或 Parquet 格式歸檔，然後刪除資料庫記錄 |
| C | 歸檔至歷史表：建立 MessageDelivery_Archive 表，將 90 天前的記錄移動至歷史表（INSERT + DELETE），保留於資料庫但與主表分離 |
| D | 保留高價值資料：僅保留「已開啟」或「已點擊」狀態的記錄（高互動價值），「pending」或「sent」但未互動的記錄於 30 天後刪除 |
| Short | 提供其他簡短答案（<=5 字） |

註：清理策略將影響歷史資料查詢能力、儲存成本與合規要求（如 GDPR 資料保留期限）。

補充問題：
- 執行頻率：清理任務應每日執行、每週執行，還是每月執行？
- 清理範圍：是否需要同步清理關聯的 Message 記錄（若 Message 的所有 MessageDelivery 都已刪除）？
- 歷史查詢：是否需要支援查詢 90 天前的歷史發送記錄？若需要，歸檔資料的查詢介面如何設計？

# 影響範圍

- **MessageDelivery 表**：
  - 資料量控制（保持在可接受範圍，避免查詢效能劣化）
  - 索引效能（定期清理可改善索引效能）
- **歷史表設計（若採用選項 C）**：
  - 新增 MessageDelivery_Archive 表
  - 歷史表的索引設計（僅需支援時間範圍查詢）
- **清理任務設計**：
  - 排程任務執行時機（建議低峰期，如凌晨 02:00）
  - 批次刪除邏輯（避免單次刪除過多記錄影響資料庫效能）
  - 清理日誌記錄（記錄每次清理的筆數、執行時間、錯誤訊息）
- **歸檔機制（若採用選項 B 或 C）**：
  - 歸檔目標位置（外部儲存或歷史表）
  - 歸檔資料格式（CSV / Parquet / JSON）
  - 歸檔資料查詢介面（若需支援歷史查詢）
- **儲存成本**：
  - 資料庫儲存成本（主表縮小後降低）
  - 外部儲存成本（若採用選項 B）
- **合規要求**：
  - GDPR / PDPA 資料保留期限（是否需要保留 90 天以上的歷史資料）
  - 資料刪除請求（會員要求刪除個人資料時，如何處理已歸檔的 MessageDelivery 記錄）

影響功能：
- 訊息數據分析：90 天前的歷史資料查詢能力（若需要，需設計歸檔查詢介面）
- 系統效能：定期清理可改善 MessageDelivery 表的查詢效能與索引效率
- 資料合規：符合資料保留期限要求，避免過度保留個人資料

# 優先級

**Medium**（影響長期資料管理與系統效能）

理由：
1. 資料量控制：MessageDelivery 資料量快速增長（會員數 × 訊息數），不清理將影響查詢效能
2. 儲存成本：長期累積的歷史資料增加資料庫儲存成本
3. 查詢效能：過大的資料表影響索引效能與查詢速度
4. 合規要求：資料保留期限可能受 GDPR / PDPA 等法規限制，需明確定義清理策略

建議行動：採用「歸檔至外部儲存」（選項 B）或「僅刪除策略」（選項 A），每日凌晨 02:00 執行清理任務。若需支援歷史查詢，建議採用選項 B 並設計歸檔查詢介面。補充清理策略至 ERM 註記，包含執行頻率、清理範圍與歸檔機制。
